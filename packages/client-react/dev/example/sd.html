<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>Stable Diffusion</title>



    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
   img.selected { border: 2px solid red; }
  </style>
  </head>
  <body>
          <div id='root'></div>
 <script type="text/babel">
const sessionKey = 'session-id'
function MyApp() {
  const optionsRef = React.useRef({
    strength: 0.75,
    iterations: 1,
    precision: false,
    channels: 4,
    factor: 8,
    steps: 50,
    scale: 5,
    prompt: '',
  })
  const { current: options } = optionsRef
  const { sessionStorage } = globalThis.window
  const generationsRef = React.useRef([])
  const sessionIdRef = React.useRef(sessionStorage.getItem(sessionKey) || '')
  const { current: generations } = generationsRef
  const { current: sessionId } = sessionIdRef
  const timerRef = React.useRef()
  const [selectedId, setSelectedId] = React.useState('')
  const [selectedFile, setSelectedFile] = React.useState('')
  const [nonce, setNonce] = React.useState(0)
  const updateNonce = () => {
    setNonce(original => original + 1)
  }
  const getActive = () => {
    const { current: generations } = generationsRef
    return generations.filter(g => g.state !== 'generated')
  }
  const fetchStatus = async (force) => {
    const activeGenerations = getActive()
    if (!(activeGenerations.length || force)) {
      console.log("fetchFiles NOTHING ACTIVE")
      return
    }
    console.log("fetchStatus")

    const ids = activeGenerations.map(g => g.id)
    const { current: sessionId } = sessionIdRef
    const request = { sessionId, ids }
    console.log("fetchStatus", request)
    const rawResponse = await fetch(`/status`, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(request)
    })
    const response = await rawResponse.json()
    console.log("STATUS RESPONSE", response)
    const { current: generations } = generationsRef
    response.forEach(status => {
      const { id, state, files } = status
      const generator = generations.find(g => g.id === id)
      if (generator) Object.assign(generator, status)
      else generations.push(status)
    })
    timerRef.current = undefined
    updateNonce()
  }
  React.useEffect(() => {
    const fuckyou = async () => { await fetchStatus(true) }
    fuckyou()
   }, [])

   const handleInterval = async () => {
    console.log("handleInterval")
    await fetchStatus()
    console.log("handleInterval FETCHED")
    if (getActive().length) startPolling()
    else console.log("hangleInterval nothing else active")
  }
  const startPolling = () => {
    const { current: timer } = timerRef
    console.log("startPolling", !!timer)
    if (!timer) {
      timerRef.current = setTimeout(handleInterval, 5000)
      console.log("startPolling.setTimer")
    }
  }

  const onClick = async () => {
    const { current: sessionId } = sessionIdRef
    const request = { ...options, sessionId }
    if (selectedFile) request.initImage = selectedFile

    const rawResponse = await fetch('/start', {
      method: 'POST',
      headers: {
        'Accept': 'application/json', 'Content-Type': 'application/json'
      },
      body: JSON.stringify(request)
    })
    const response = await rawResponse.json()
    console.log("RESPONSE", response)

    const { id, session } = response
    const generation = { id, ...options }
    generations.unshift(generation)
    if (!sessionId) {
      sessionIdRef.current = session
      sessionStorage.setItem(sessionKey, session)
    }
    startPolling()
  }

   const inputProps = {
    onChange: event => {
      updateNonce()
      options.prompt = event.target.value
    },
    value: options.prompt,
    type: 'text',
    key: 'text',
    style: { width: '100%' }
  }
  const buttonProps = { children: 'Generate', onClick, key: 'button' }
  const children = [<input { ...inputProps } />, <button { ...buttonProps } />]
  const strengthProps = {
    onChange: event => {
      updateNonce()
      options.strength = event.target.value
     },
    value: options.strength,
    key: 'strength',
    type: 'number', max: 1.0, min: 0.0, step: 0.05
  }
  children.push(<input { ...strengthProps } />)
  const scaleProps = {
    onChange: event => {
      updateNonce()
      options.scale = event.target.value
     },
    value: options.scale,
    key: 'scale',
    type: 'number'
  }
  children.push(<input { ...scaleProps } />)

  children.push(...generations.map(generation => {
    const { id, prompt, files } = generation
    const onClick = event => {
      event.stopPropagation()
      options.prompt = prompt
      updateNonce()
    }
    const headProps = { key: 'head', children: prompt, onClick }
    const children = [<h3 { ...headProps } />]
    if (files) children.push(...files.map(file => {
      const onClick = event => {
        event.stopPropagation()
        setSelectedId(id)
        setSelectedFile(file)
      }
      const className = file === selectedFile ? 'selected' : ''
      const imgProps = { key: file, src: file, onClick, className } 
      return <img { ...imgProps } />
    }))
    const generatorProps = {
      children, key: id
    }
    return <div { ...generatorProps } />
  }))
  const divProps = {
    children, key: 'generations', onClick: () => setSelectedFile('')
  }
  return <div { ...divProps } />
}
const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(<MyApp />);
 </script>
  </body>
</html>