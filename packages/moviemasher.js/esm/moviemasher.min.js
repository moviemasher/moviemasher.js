const e=e=>e instanceof CustomEvent,t=(e,t,i="value")=>{const s=typeof e,n="object"===s?e.constructor.name:s;throw console.error("throwError",e),new Error(`${i} is "${e}" (${n}) instead of ${t}`)},i=e=>"object"==typeof e;function s(e,s){i(e)||t(e,"Object",s)}const n=e=>"string"==typeof e;function r(e,i){n(e)||t(e,"String",i)}const o=e=>void 0===e,a=e=>"number"==typeof e;function c(e,i){a(e)||t(e,"Number",i)}const u=e=>"boolean"==typeof e;function l(e,i){u(e)||t(e,"Boolean",i)}const h=e=>"function"==typeof e,d=e=>!o(e);function p(e,i){d(e)||t(e,"defined",i)}const m=e=>a(e)&&Number.isNaN(e),f=e=>a(e)&&!Number.isNaN(e),g=e=>Number.isInteger(e),v=e=>f(e)&&!g(e),y=e=>f(e)&&e>=0;function b(e,i){y(e)||t(e,">= 0",i)}const w=e=>f(e)&&e<1,F=e=>f(e)&&e>0;function x(e,i){F(e)||t(e,"> zero",i)}const I=e=>d(Array.isArray)?Array.isArray(e):e instanceof Array;function T(e,i){I(e)||t(e,"Array",i)}const S=e=>!!e.length,C=e=>n(e)&&S(String(e));function P(e,i="value"){C(e)||t(e,"populated string",i)}const E=e=>I(e)&&S(e);function V(e,i="value"){E(e)||t(e,"populated array",i)}const z=e=>i(e)&&S(Object.keys(e));function A(e,i="value"){z(e)||t(e,"populated array",i)}const k=e=>(f(e)||C(e))&&!m(Number(e));function _(e,i="value"){e||t(e,"true",i)}const O=e=>i(e)&&"r"in e&&"g"in e&&"b"in e;function R(e,i){O(e)||t(e,"Rgb",i)}const $=e=>i(e)&&"isRange"in e;function M(e,i){$(e)||t(e,"Time",i)}const N=e=>$(e)&&e.isRange;function j(e,i){N(e)||t(e,"TimeRange",i)}const D=e=>f(e)||n(e),L=e=>!!D(e)&&(k(e)?!!Number(e):C(e));function q(e,i){D(e)||t(e,"Value",i)}const B=e=>i(e)&&Object.values(e).every((e=>D(e)));function U(e,i){B(e)||t(e,"ValueObject",i)}var G,W;!function(e){e.At="at",e.After="after",e.Before="before",e.None="none"}(G||(G={})),function(e){e.Mash="mash",e.Folder="folder"}(W||(W={}));const J=Object.values(W),H=e=>J.includes(e);function K(e){if(!H(e))throw new Error("expected LayerType")}var Y,X;!function(e){e.AddClipToTrack="addClipToTrack",e.AddEffect="addEffect",e.AddLayer="addLayer",e.AddTrack="addTrack",e.Change="change",e.ChangeMultiple="changeMultiple",e.ChangeFrame="changeFrame",e.ChangeGain="changeGain",e.MoveClip="moveClip",e.MoveEffect="moveEffect",e.MoveLayer="moveLayer",e.RemoveClip="removeClip",e.RemoveLayer="removeLayer"}(Y||(Y={})),function(e){e.Mash="mash",e.Cast="cast"}(X||(X={}));const Z=Object.values(X),Q=e=>Z.includes(e);function ee(e,i){Q(e)||t(e,"EditType",i)}var te,ie;!function(e){e.Audio="audio",e.Both="both",e.Video="video"}(te||(te={})),function(e){e.Cast="cast",e.Mash="mash",e.Track="track",e.Layer="layer",e.Effect="effect",e.Clip="clip",e.Content="content",e.Container="container",e.None="none"}(ie||(ie={}));const se=Object.values(ie),ne=e=>se.includes(e);function re(e,i){ne(e)||t(e,"SelectType",i)}const oe=[ie.Content,ie.Container],ae=e=>ne(e)&&oe.includes(e);var ce,ue,le;!function(e){e.AudioConcat="wav",e.Mdash="mdash",e.Flv="flv",e.Hls="hls",e.Jpeg="jpeg",e.Mp3="mp3",e.Mp4="mp4",e.VideoConcat="yuv4mpegpipe",e.Png="image2",e.Rtmp="rtmp"}(ce||(ce={})),function(e){e.Hls="hls",e.Rtmp="rtmp",e.Mdash="mdash"}(ue||(ue={})),function(e){e.Audio="audio",e.Image="image",e.Video="video",e.ImageSequence="imagesequence",e.Waveform="waveform"}(le||(le={}));const he=Object.values(le);var de;!function(e){e.Color="color",e.Fill="fill"}(de||(de={}));const pe=Object.values(de),me=e=>pe.includes(e);var fe;!function(e){e.Svg="svg",e.SvgSequence="svgsequence",e.Txt="txt"}(fe||(fe={}));const ge=Object.values(fe),ve=e=>C(e)&&ge.includes(e);var ye;!function(e){e.Audio="audio",e.Font="font",e.Image="image",e.Video="video"}(ye||(ye={}));const be=Object.values(ye),we=e=>C(e)&&be.includes(e);function Fe(e,i){we(e)||t(e,"LoadType",i)}const xe=be.filter((e=>e!==ye.Font)),Ie=e=>we(e)&&xe.includes(e);var Te;!function(e){e.Audio="audio",e.Clip="clip",e.Container="container",e.Content="content",e.Effect="effect",e.Filter="filter",e.Font="font",e.Image="image",e.Video="video",e.VideoSequence="videosequence"}(Te||(Te={}));const Se=Object.values(Te),Ce=e=>Se.includes(e);function Pe(e,t=""){if(!Ce(e))throw new Error(`expected '${e}' to be DefinitionType ${t}`)}const Ee=[Te.Container,Te.Image,Te.Video,Te.VideoSequence],Ve=e=>Ce(e)&&Ee.includes(e),ze=[Te.Audio,Te.Video,Te.VideoSequence],Ae=e=>Ce(e)&&ze.includes(e),ke=[Te.Image,Te.Container,Te.VideoSequence],_e=e=>Ce(e)&&ke.includes(e);function Oe(e){if(!_e(e))throw new Error("expected ContainerType")}const Re=[Te.Content,Te.Image,Te.Video,Te.VideoSequence,Te.Audio],$e=e=>Ce(e)&&Re.includes(e);function Me(e){if(!$e(e))throw new Error("expected ContentType")}var Ne;!function(e){e.Boolean="boolean",e.ContainerId="containerid",e.ContentId="contentid",e.DefinitionId="definitionid",e.FontId="fontid",e.Frame="frame",e.Number="number",e.Percent="percent",e.Rgb="rgb",e.String="string",e.Timing="timing",e.Sizing="sizing"}(Ne||(Ne={}));const je=Object.values(Ne),De=e=>je.includes(e);function Le(e,i){De(e)||t(e,"DataType",i)}var qe;!function(e){e.H="H",e.V="V"}(qe||(qe={}));const Be=Object.values(qe),Ue=e=>C(e)&&Be.includes(e);var Ge;!function(e){e.E="E",e.N="N",e.S="S",e.W="W"}(Ge||(Ge={}));const We=Object.values(Ge),Je=e=>We.includes(e);function He(e,i){Je(e)||t(e,"Direction",i)}var Ke;!function(e){e.E="E",e.N="N",e.NE="NE",e.NW="NW",e.S="S",e.SE="SE",e.SW="SW",e.W="W"}(Ke||(Ke={}));const Ye=Object.values(Ke);var Xe;!function(e){e.Init="init",e.Stop="stop",e.Start="start"}(Xe||(Xe={}));const Ze=Object.values(Xe),Qe=e=>Ze.includes(e);var et,tt;!function(e){e.Scale="scale",e.Translate="translate"}(et||(et={})),function(e){e.Action="action",e.Activity="activity",e.Added="added",e.Cast="cast",e.Draw="draw",e.Duration="durationchange",e.Ended="ended",e.Fps="ratechange",e.Loaded="loadeddata",e.Mash="mash",e.Pause="pause",e.Play="play",e.Playing="playing",e.Render="render",e.Resize="resize",e.Save="save",e.Seeked="seeked",e.Seeking="seeking",e.Selection="selection",e.Time="timeupdate",e.Track="track",e.Volume="volumechange",e.Waiting="waiting"}(tt||(tt={}));const it=Object.values(tt),st=e=>it.includes(e);var nt,rt,ot,at;!function(e){e.Audio="audio",e.Effect="effect",e.Video="video"}(nt||(nt={})),function(e){e.Redo="redo",e.Remove="remove",e.Render="render",e.Save="save",e.Undo="undo"}(rt||(rt={})),function(e){e.Mash="mash",e.Cast="cast"}(ot||(ot={})),function(e){e.Api="api",e.Data="data",e.File="file",e.Rendering="rendering",e.Streaming="streaming",e.Web="web"}(at||(at={}));const ct=Object.values(at);var ut,lt;!function(e){e[e.Unknown=-1]="Unknown",e[e.Unlimited=-2]="Unlimited",e[e.None=0]="None"}(ut||(ut={})),function(e){e.Custom="custom",e.Content="content",e.Container="container"}(lt||(lt={}));const ht=Object.values(lt);var dt;!function(e){e.Preview="preview",e.Content="content",e.Container="container"}(dt||(dt={}));const pt=Object.values(dt),mt="5.1.0",ft={start:"",status:"",stop:""},gt={...ft,upload:""},vt={delete:"",get:"",put:"",retrieve:""},yt={cast:{...vt,default:""},mash:{...vt,default:""},stream:{...vt},definition:{...vt}},bt={...ft,...vt,preload:"",cut:"",webrtc:"",rtmp:"",remote:"",local:""},wt={[at.Api]:{servers:"",callbacks:""},[at.Data]:yt,[at.File]:{store:""},[at.Rendering]:gt,[at.Streaming]:bt};Object.entries(wt).forEach((([e,t])=>{i(t)&&Object.entries(t).forEach((([i,s])=>{n(s)?t[i]=`/${e}/${i}`:Object.entries(s).forEach((([t,n])=>{n||(s[t]=`/${e}/${i}/${t}`)}))}))}));const Ft={},xt=Ft,It="m3u8",Tt="ts",St="flv",Ct="dash",Pt="jpg",Et="png",Vt="json",zt="txt",At=6,kt=()=>{},_t="http://www.w3.org/2000/svg",Ot="http://www.w3.org/1999/xhtml",Rt="http://www.w3.org/1999/xlink",$t="com.moviemasher.",Mt=".default",Nt="disabled",jt="button",Dt="collapsed",Lt="selected",qt="dropping",Bt="dropping-before",Ut="dropping-after",Gt=e=>i(e)&&"id"in e&&(!e.type||Ce(e.type)),Wt=e=>i(e)&&Ce(e.type)&&"instanceFromObject"in e;function Jt(e,i){Wt(e)||t(e,"Definition",i)}class Ht{static byId=new Map;static byIdAdd(e){(Array.isArray(e)?e:[e]).forEach((e=>this.byId.set(e.id,e)))}static byType(e){const t=this.definitionsByType.get(e);if(t)return t;const i=xt[e].defaults||[];return this.definitionsByType.set(e,i),i}static define(...e){return e.map((e=>this.fromObject(e)))}static definitionDelete(e){const{type:t}=e,i=this.byType(t),s=i.indexOf(e);s<0||i.splice(s,1)}static definitionUninstall(e){if(!this.installed(e))return;const t=this.fromId(e);this.byId.delete(e),this.definitionDelete(t)}static definitionsByType=new Map;static definitionsType(e){const t=e.split(".").slice(-2).shift();return Ce(t)?t:void 0}static fromId(e){if(this.installed(e))return this.byId.get(e);const t=this.definitionsType(e);return Pe(t,`in Defined.fromId('${e}')`),xt[t].definitionFromId(e)}static fromObject(e){const{id:t,type:i}=e;if(P(t),this.installed(t)||this.predefined(t))return this.fromId(t);const s=i||this.definitionsType(t);return Pe(s),this.install(xt[s].definition(e))}static get ids(){return[...this.byId.keys()]}static install(e){const{type:t,id:i}=e;return this.installed(i)?(this.uninstall(e),this.updateDefinition(this.fromId(i),e)):(this.byIdAdd(e),this.byType(t).push(e),e)}static installed(e){return this.byId.has(e)}static predefined(e){return e.startsWith($t)}static undefineAll(){this.byId=new Map,this.definitionsByType=new Map}static updateDefinition(e,t){return this.uninstall(e),this.install(t),t}static updateDefinitionId(e,t){const i=this.byId.get(e);Jt(i),this.byId.delete(e),this.byId.set(t,i)}static uninstall(e){const{type:t,id:i}=e,s=this.definitionsByType.get(t);_(s);const n=s.indexOf(e);return b(n),s.splice(n,1),this.byId.delete(i),e}}const Kt="rgb".split(""),Yt=[...Kt,"a"],Xt="#00000000",Zt="#000000",Qt="#FFFFFF",ei="#FFFFFF00",ti="#00000000",ii="#FFFFFFFF",si="#000000FF",ni="#00FF00",ri="#FFFF00",oi="#FF0000",ai="#0000FF";var ci;!function(e){e.Transparent="#00000000",e.Black="#000000",e.White="#FFFFFF",e.WhiteTransparent="#FFFFFF00",e.BlackTransparent="#00000000",e.WhiteOpaque="#FFFFFFFF",e.BlackOpaque="#000000FF",e.Green="#00FF00",e.Yellow="#FFFF00",e.Red="#FF0000",e.Blue="#0000FF"}(ci||(ci={}));const ui=Object.values(ci),li=e=>{for(const t of Object.entries(ci)){const[i,s]=t;if(s===e)return i}return""},hi=e=>Math.min(255,Math.max(0,Math.floor(Number(e)))),di=e=>({r:hi(e.r),g:hi(e.g),b:hi(e.b)}),pi=e=>({y:hi(e.y),u:hi(e.u),v:hi(e.v)}),mi=e=>{const t=pi(e);return di({r:t.y+1.4075*(t.v-128),g:t.y-.3455*(t.u-128)-.7169*(t.v-128),b:t.y+1.779*(t.u-128)})},fi=e=>{let t=e.r.toString(16),i=e.g.toString(16),s=e.b.toString(16);return t.length<2&&(t=`0${t}`),i.length<2&&(i=`0${i}`),s.length<2&&(s=`0${s}`),`#${t}${i}${s}`},gi=e=>{let t=e.r.toString(16),i=e.g.toString(16),s=e.b.toString(16),n=Math.round(255*Number(e.a)).toString(16);return t.length<2&&(t=`0${t}`),i.length<2&&(i=`0${i}`),s.length<2&&(s=`0${s}`),n.length<2&&(n=`0${n}`),`#${t}${i}${s}${n}`},vi=(e,t,i,s)=>{const n=e.u-t.u,r=e.v-t.v,o=Math.sqrt((n*n+r*r)/65025);return s>1e-4?255*Math.min(1,Math.max(0,(o-i)/s)):o>i?255:0},yi=(e,t,i,s)=>{let n=0;const r=pi(t);return e.forEach((e=>{const t=pi(e),i=t.u-r.u,s=t.v-r.v;n+=Math.sqrt((i*i+s*s)/65025)})),n/=e.length,s>1e-4?255*Math.min(1,Math.max(0,(n-i)/s)):n>i?255:0},bi=e=>{const t=di(e);return{y:.299*t.r+.587*t.g+.114*t.b,u:-.168736*t.r+-.331264*t.g+.5*t.b+128,v:.5*t.r+-.418688*t.g+-.081312*t.b+128}},wi=/^rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)$/,Fi=/^rgba\((\d{1,3}),(\d{1,3}),(\d{1,3}),(\d*(?:\.\d+)?)\)$/,xi=/^#([A-Fa-f0-9]{3,4}){1,2}$/,Ii=e=>e.toLowerCase().replaceAll(/[\s]/g,""),Ti=e=>{const t=Ii(e);if(Si(t)||Ci(t)||Pi(t))return!0;const i=(new Option).style;i.color=e;const s=Ii(i.color);return!!s&&(!(!Ci(t)&&!Pi(t))||s===t)},Si=e=>xi.test(e),Ci=e=>Fi.test(e),Pi=e=>wi.test(e),Ei=(e,t)=>e.match(new RegExp(`.{${t}}`,"g")),Vi=e=>parseInt(e.repeat(2/e.length),16),zi=e=>y(e)?Math.max(0,Math.min(1,e/255)):1,Ai=e=>{if(!Si(e))return Di;const t=Math.floor((e.length-1)/3),i=Ei(e.slice(1),t);if(!i)return Di;const[s,n,r,o]=i.map(Vi);return{r:s,g:n,b:r,a:zi(o)}},ki=e=>{if(!Si(e))return ji;const t=Math.floor((e.length-1)/3),i=Ei(e.slice(1),t);if(!i)return ji;const[s,n,r]=i.map(Vi);return{r:s,g:n,b:r}},_i=e=>{const t=Ii(e).match(Fi);return t?{r:Number(t[1]),g:Number(t[2]),b:Number(t[3]),a:Number(t[4])}:Di},Oi=e=>{const t=Ii(e);if(Si(t))return ki(t);const i=t.match(wi);return i?{r:Number(i[1]),g:Number(i[2]),b:Number(i[3])}:ji},Ri=e=>{if(!Ti(e))return Di;const t=Ii(e);return Si(t)?Ai(t):Ci(t)?_i(t):Pi(t)?{a:1,...Oi(t)}:Di},$i=e=>{const t=Ri(e);return{alpha:t.a,color:fi(t)}},Mi=e=>{const{r:t,g:i,b:s}=e;return`rgb(${t},${i},${s})`},Ni=e=>{const{r:t,g:i,b:s,a:n}=e;return`rgb(${t},${i},${s},${n})`},ji={r:0,g:0,b:0},Di={...ji,a:1},Li={...ji,a:0},qi=e=>Si(e)?`${e.slice(0,7)}@0x${e.slice(-2)}`:e,Bi=e=>{const{r:t,g:i,b:s}=e;return{...e,r:255-t,g:255-i,b:255-s}},Ui=[Ne.Frame,Ne.Percent,Ne.Number],Gi=e=>De(e)&&Ui.includes(e),Wi=e=>e!==Ne.Boolean&&!Gi(e),Ji=e=>{if(Ce(e))return`${$t}${e}.default`;switch(e){case Ne.Boolean:return!1;case Ne.Rgb:return"#000000"}return Gi(e)?0:""},Hi=(e,t)=>{if(Ce(t))return C(e);switch(t){case Ne.Boolean:return(e=>!!u(e)||(f(e)?0===e||1===e:["true","false",""].includes(e)))(e);case Ne.Rgb:return Ti(String(e));case Ne.Frame:case Ne.Percent:case Ne.Number:return k(e);case Ne.String:return!0;case Ne.ContainerId:case Ne.ContentId:case Ne.FontId:case Ne.DefinitionId:default:return C(e)}return!1},Ki=(e,t)=>t===Ne.Boolean?u(e)?e:k(e)?!!Number(e):"true"===e:Gi(t)?k(e)?Number(e):0:String(e),Yi="End";class Xi{constructor(...e){}addProperties(e,...t){this.properties.push(...t),t.forEach((t=>{this.propertyTweenSetOrDefault(e,t)}))}properties=[];get propertiesCustom(){return this.properties.filter((e=>e.custom))}propertiesInitialize(e){s(e),this.properties.forEach((t=>this.propertyTweenSetOrDefault(e,t)))}propertyFind(e){return this.properties.find((t=>t.name===e))}propertyName(e){return e.endsWith(Yi)?e.slice(0,-Yi.length):e}propertySetOrDefault(e,t,i,s){const n=e[i],r=o(n)?s:n;this.setValue(r,i,t)}propertyTweenSetOrDefault(e,t){const{name:i,defaultValue:s,tweenable:n}=t;this.propertySetOrDefault(e,t,i,s),n&&this.propertySetOrDefault(e,t,`${i}${Yi}`)}setValue(e,t,i){if(o(e))return void delete this[t];const s=this.propertyName(t),n=i||this.propertyFind(s);_(n,`${this.constructor.name}.${s} in ${this.properties.map((e=>e.name)).join(", ")}`);const r=n.type;if(!Hi(e,r))return void(s!==t&&delete this[t]);const a=Ki(e,r);this[t]=a}setValues(e){Object.entries(e).forEach((([e,t])=>{this.setValue(t,e)}))}toJSON(){return Object.fromEntries(this.properties.flatMap((e=>{const{name:t,tweenable:i}=e,s=[[t,this.value(t)]];if(i){const e=`${t}${Yi}`;s.push([e,this.value(e)])}return s})))}value(e){return this[e]}}const Zi=e=>e instanceof Xi,Qi=e=>i(e)&&("definitionId"in e||"definition"in e),es=e=>i(e)&&"definitionIds"in e,ts=e=>es(e)&&Wt(e.definition);function is(e){if(!ts(e))throw new Error("expected Tweenable")}const ss=e=>Wt(e);function ns(e){if(!ss(e))throw new Error("expected TweenableDefinition")}const rs=`${$t}container.default`,os=`${$t}container.text`,as=e=>i(e)&&"opacity"in e;function cs(e){as(e)||t(e,"ContainerObject")}const us=e=>ss(e)&&_e(e.type),ls=e=>ts(e)&&_e(e.type);function hs(e){if(!ls(e))throw new Error("expected Container")}const ds=e=>i(e)&&f(e.x)&&f(e.y);function ps(e,i){ds(e)||t(e,"Point",i)}const ms=(e,t)=>!!ds(t)&&(e.x===t.x&&e.y===t.y),fs={x:0,y:0},gs=e=>{const{x:t,y:i}=e;return{x:t,y:i}},vs=e=>{const{x:t,y:i}=e;return{x:Math.round(t),y:Math.round(i)}},ys=e=>{const{x:t,y:i}=e;return`x=${t};y=${i}`},bs=e=>{const{x:t,y:i}=e;return`${t},${i}`},ws=e=>{const{x:t,y:i}=e;return{x:-t,y:-i}},Fs=e=>i(e)&&f(e.width)&&f(e.height);function xs(e,i){Fs(e)||t(e,"Size",i)}const Is=(e,t)=>!!Fs(t)&&(e.width===t.width&&e.height===t.height),Ts={width:0,height:0},Ss=e=>2*Math.max(1,Math.ceil(e/2)),Cs=e=>{const{width:t,height:i}=e;return{width:Ss(t),height:Ss(i)}},Ps=e=>{const{width:t,height:i}=e;return{width:Math.round(t),height:Math.round(i)}},Es=e=>{const{width:t,height:i}=e;return{width:Math.max(2,Math.ceil(t)),height:Math.max(2,Math.ceil(i))}},Vs=e=>{const{width:t,height:i}=e;return{width:Math.max(2,Math.floor(t)),height:Math.max(2,Math.floor(i))}},zs=(e,t,i)=>{const{width:s,height:n}=e;return{width:s*t,height:n*i}},As=(e,t,i=!1)=>{_s(e),xs(t);const{width:s,height:n}=e,{width:r,height:o}=t,a=r/s,c=o/n;return Es((i?a<c:a>c)?{...t,height:n*a}:{...t,width:s*c})},ks=e=>{if(!Fs(e))return!1;const{width:t,height:i}=e;return F(t)&&F(i)};function _s(e,i){ks(e)||t(e,"SizeAboveZero",i)}const Os={width:1920,height:1080},Rs=zs(Os,.25,.25),$s=zs(Rs,.5,.5),Ms=e=>{const{width:t,height:i}=e;return{width:t,height:i}},Ns=(e,t)=>{const i=Ms(e);switch(t){case qe.H:i.width=i.height;break;case qe.V:i.height=i.width}return i},js=e=>{const{width:t,height:i}=e;return`width=${t};height=${i}`},Ds=(e,t)=>{_s(e);const i=Ms(e);return t&&(t===qe.V?i.height=-1:i.width=-1),i},Ls=e=>{const t={width:Number(e.getAttribute("width")),height:Number(e.getAttribute("height"))};return _s(t),t},qs=e=>Fs(e)&&ds(e);function Bs(e,i){qs(e)||t(e,"Rect",i)}const Us=(e,t)=>!!qs(t)&&(ms(e,t)&&Is(e,t)),Gs={...fs,...Ts},Ws=(e,t)=>{const i=t||fs,{width:s,height:n}=e;return{x:i.x,y:i.y,width:s,height:n}},Js=(e,t)=>{const i=t||[fs,fs],[s,n]=e,[r,o]=i;return[Ws(s,r),Ws(n,o)]},Hs=e=>({...gs(e),...Ms(e)}),Ks=e=>({...Ps(e),...vs(e)}),Ys=(e,t)=>({x:Math.round((e.width-t.width)/2),y:Math.round((e.height-t.height)/2)}),Xs=e=>{const t=[];return Fs(e)&&t.push(js(e)),ds(e)&&t.push(ys(e)),t.join(";")},Zs=e=>e[e.length-1],Qs=(e,t)=>(e.splice(0,e.length,...t),e),en=e=>[...e].reverse(),tn=e=>[...new Set(e)];var sn;!function(e){e.Point="point",e.Size="size",e.Opacity="opacity",e.Color="color",e.Effects="effects",e.Timing="timing",e.Sizing="sizing"}(sn||(sn={}));const nn=Object.values(sn),rn=e=>nn.includes(e);function on(e,i){rn(e)||t(e,"DataGroup",i)}const an=e=>i(e)&&"type"in e&&De(e.type);function cn(e,i){an(e)||t(e,"Property",i)}const un=e=>{const{type:t,name:i,defaultValue:s,...n}=e,r=((e,t)=>o(e)?u(t)?Ne.Boolean:f(t)?Ne.Number:Ne.String:(Le(e),e))(t,s),a=((e,t)=>o(t)?Ji(e):t)(r,s),c={type:r,defaultValue:a,name:C(i)?i:r,...n};if(t===Ne.Percent)o(c.max)&&(c.max=1),o(c.min)&&(c.min=0),o(c.step)&&(c.step=.01);return c},ln="Invalid argument ",hn={eval:{sourceRect:"Invalid evaluation of source rect ",outputSize:"Invalid evaluation of output size ",inputSize:"Invalid evaluation of input size ",conditionTruth:"Expected at least one condition to evaluate to true ",conditionValue:"Expected condition to have a value ",number:"Expected evaluated number for ",get:"Expected to get evaluated value ",string:"Invalid evaluation string "},composition:{mashUndefined:"Internal Error composition.mash undefined"},audibleContext:"Expected AudioContext",mash:"Expected mash",action:"Expected Action",actions:"Expected Actions",internal:"Internal Error ",argument:"Invalid argument ",invalid:{canvas:"Invalid property canvas ",context:"Invalid property context ",duration:"Invalid duration",definition:{audio:"Invalid definition property audio|url",url:"Invalid definition property url",source:"Invalid definition property source",id:"Invalid definition property id ",object:"Invalid property definition",type:"Invalid definition property type "},size:"Invalid size ",track:"Invalid track ",trackType:"Invalid property trackType ",action:"Invalid action ",name:"Invalid property name ",value:"Invalid property value ",type:"Invalid property type ",url:"Invalid property url ",user:"Unauthenticated",property:"Invalid property ",argument:ln,object:"Invalid argument object ",factory:"Invalid factory ",volume:"Invalid argument volume"},type:"Unknown type ",selection:"Invalid selection ",unknown:{type:"Unknown type ",merger:"Unknown merger ",effect:"Unknown effect ",filter:"Unknown filter ",font:"Unknown font ",scaler:"Unknown scalar ",definition:"Unknown definition "},uncached:"Uncached URL ",object:"Invalid argument object ",array:"Invalid argument array ",media:"Invalid argument media ",id:"Invalid argument id ",frame:"Invalid argument frame ",frames:"Invalid property frames ",fps:"Invalid argument fps ",seconds:"Invalid argument seconds ",url:"Invalid argument url ",time:"Invalid argument Time",timeRange:"Invalid argument TimeRange",mainTrackOverlap:"Internal Error : main track clips overlap without transition",unknownMash:"Unknown Mash property ",unimplemented:"Expected method to be overridden ",property:"Invalid argument property ",wrongClass:"Expected instance of "};class dn{constructor({name:e,value:t,dataType:i,values:s}){if(!e)throw hn.invalid.name;if(this.values=s,this.name=e,o(t)){if(!this.values?.length)throw hn.invalid.value;this.value=this.values[0]}else this.value=t;if(i&&je.map(String).includes(i))this.dataType=i;else{let e=!1;e=Array.isArray(this.value)?this.value.every((e=>k(e.value))):k(this.value),e&&(this.dataType=Ne.Number)}}dataType=Ne.String;name;toJSON(){return{name:this.name,value:this.value}}value;values}const pn={count:0,prefix:"",countsByPrefix:{}},mn=()=>{const e=[];return pn.prefix&&e.push(pn.prefix),e.push(Date.now().toString(36)),e.push(Math.random().toString(36).slice(2)),e.join("-")},fn=e=>{pn.prefix=e},gn=()=>{const{prefix:e}=pn,t=[];return e?(t.push(e),pn.countsByPrefix[e]||=0,t.push(String(pn.countsByPrefix[e]++))):t.push(String(pn.count++)),t.join("")},vn=(e=pn.prefix)=>{const t=[];return e?(t.push(e),pn.countsByPrefix[e]||=0,t.push(String(pn.countsByPrefix[e]++))):t.push(String(pn.count++)),t.join("")},yn=e=>!!C(pn.prefix)&&e.startsWith(pn.prefix);class bn extends Xi{constructor(...e){super(...e);const[t]=e;A(t);const{definition:i}=t;Jt(i),this.definition=i,this.properties.push(...this.definition.properties),this.propertiesInitialize(t)}copy(){return this.definition.instanceFromObject(this.toJSON())}definition;get definitionId(){return this.definition.id}definitionIds(){return[this.definitionId]}_id;get id(){return this._id||=mn()}_label="";get label(){return this._label}set label(e){this._label=e}get propertyNames(){return this.properties.map((e=>e.name))}toJSON(){const e=super.toJSON(),{definitionId:t,type:i,label:s}=this;return s&&(e.label=s),e.type=i,e.definitionId=t,e}get type(){return this.definition.type}}const wn=e=>`#${e}`,Fn=e=>`url(${wn(e)})`,xn=(e,t="")=>{const i=globalThis.document.createElementNS(_t,"g");return Dn(i,t),In(i,e),i},In=(e,t)=>{if(Fs(t)){const{width:i,height:s}=t;y(i)&&Dn(e,String(i),"width"),y(s)&&Dn(e,String(s),"height")}if(ds(t)){const{x:i,y:s}=t;Dn(e,String(i),"x"),Dn(e,String(s),"y")}},Tn=(e,t)=>{ps(t);const{x:i,y:s}=t;(i||s)&&Bn(e,`translate(${i}, ${s})`)},Sn=e=>{const{width:t,height:i,x:s=0,y:n=0}=e,r={x:s,y:n},o=[];return o.push(r),o.push({x:s+t,y:n}),o.push({x:s+t,y:n+i}),o.push({x:s,y:n+i}),o.push(r),o},Cn=(e,t,i="",s)=>{const n=globalThis.document.createElementNS(_t,"polygon"),r=Sn(e).map((e=>[e.x,e.y].join(","))).join(" ");return Dn(n,r,"points"),Dn(n,i,"fill"),Ln(n,t),Dn(n,s),n},Pn=(e,t)=>{_s(t);const i=Ms(t),{width:s,height:n}=i;In(e,i);Dn(e,`0 0 ${s} ${n}`,"viewBox")},En=(e,t)=>{const i=globalThis.document.createElementNS(_t,"svg");return Dn(i,"1.1","version"),Dn(i,_t,"xmlns"),On(i,t),ks(e)?(Pn(i,e),i):i},Vn=(e,t,i)=>{_s(t),i||Dn(e,"none","preserveAspectRatio");const s={...Ds(t,i),...gs(t)};In(e,s)},zn=()=>{const e=globalThis.document.createElementNS(_t,"image");return Dn(e,"none","preserveAspectRatio"),e},An=(e,t="currentColor")=>{const i=globalThis.document.createElementNS(_t,"path");return Dn(i,e,"d"),Dn(i,t,"fill"),i},kn=(e,t,i)=>{const s=mn(),n=globalThis.document.createElementNS(_t,"mask");if(Dn(n,s),ks(e)){On(n,Cn(e,"",i?"black":"none"))}return t&&(Dn(t,Fn(s),"mask"),i&&Dn(t,"luminance","mask-mode")),n},_n=(e,t)=>{const{filter:i,...s}=e;P(i);const n=globalThis.document.createElementNS(_t,i);return In(n,t),Object.entries(s).forEach((([e,t])=>{Dn(n,String(t),e)})),n},On=(e,t)=>{if(!t)return;(I(t)?t:[t]).forEach((t=>e.appendChild(t)))},Rn=(e,t,i)=>{const s=globalThis.document.createElementNS(_t,"pattern");return Dn(s,t),Pn(s,e),Dn(s,"userSpaceOnUse","patternUnits"),On(s,i),s},$n=e=>{const t=globalThis.document.createElementNS(_t,"defs");return On(t,e),t},Mn=(e,t)=>{const i=globalThis.document.createElementNS(_t,"feImage");return C(e)&&Dn(i,wn(e),"href"),Dn(i,t,"result"),i},Nn=(e,t,i,s="userSpaceOnUse")=>{const n=globalThis.document.createElementNS(_t,"filter");if(s&&Dn(n,s,"filterUnits"),Dn(n,"sRGB","color-interpolation-filters"),On(n,e),t){const e=mn();if(Dn(n,e),t){(I(t)?t:[t]).forEach((t=>{Dn(t,Fn(e),"filter"),Ln(t,"filtered")}))}}return In(n,i),n},jn=(e,t)=>{const i=mn(),s=_n({filter:"feBlend",mode:"difference"});Dn(s,i,"in"),Dn(s,"SourceGraphic","in2");const n=Mn(e,i),r=Nn([n,s],t,fs);return Dn(r,"100%","width"),Dn(r,"100%","height"),r},Dn=(e,t,i="id")=>{C(t)&&e.setAttribute(i,t)},Ln=(e,t)=>{if(!t)return;const i=I(t)?t:t.split(" ");e.classList.add(...i)},qn=(e,t,i)=>{const s=globalThis.document.createElementNS(_t,"use");return C(e)&&Dn(s,wn(e),"href"),Dn(s,i),Ln(s,t),s},Bn=(e,t,i="top left")=>{Dn(e,t,"transform"),Dn(e,i,"transform-origin")},Un=(e,t)=>{_s(e),_s(t);const{width:i,height:s}=e,{width:n,height:r,x:o,y:a}=t,c=n/i,u=r/s,l=[];if(0===o&&0===a||l.push(`translate(${o},${a})`),1===c&&1===u||l.push(`scale(${c},${u})`),ds(e)){const{x:t,y:i}=e;0===t&&0===i||l.push(`translate(${t},${i})`)}return l.join(" ")},Gn=(e,t,i)=>{Bn(e,Un(t,i))},Wn=(e,t)=>{const i=globalThis.document.createElementNS(_t,e);return Dn(i,t,"tableValues"),Dn(i,"discrete","type"),i},Jn=(e,t)=>{if(!e.hasChildNodes())return On(e,t);const{childNodes:i}=e,s=[];i.forEach((e=>{t.includes(e)||s.push(e)})),s.forEach((t=>{e.removeChild(t)})),t.forEach((t=>e.appendChild(t)))},Hn=e=>e instanceof HTMLVideoElement,Kn=e=>e instanceof HTMLImageElement,Yn=e=>e instanceof AudioBuffer,Xn=e=>we(e)||ve(e);function Zn(e,i){Xn(e)||t(e,"LoaderType",i)}const Qn=e=>C(e)&&e.includes(":");function er(e,i){Qn(e)||t(e,"LoaderPath",i)}const tr=(e={})=>{const{baseURI:t}=globalThis.document,i=new URL(t),{protocol:s,host:n,pathname:r,port:o}=i,a=n.split(":").shift(),c={protocol:s.slice(0,-1),host:a,prefix:r,...e};return k(o)&&(c.port=Number(o)),c},ir=e=>e.startsWith("object:/"),sr=e=>e.startsWith("http"),nr=e=>e.includes(":"),rr=(e,t)=>(e.endsWith("/")?e.slice(0,-1):e)+"/"+(t.startsWith("/")?t.slice(1):t),or=e=>{const t=tr(e),{port:i,prefix:s,host:n,protocol:r}=t;P(n),P(r);const o=[];o.push(r,"://",n),k(i)&&o.push(":",String(i));const a=o.join("");return s?rr(a,s):a},ar=(e,t="")=>{if(t&&nr(t))return t;const i=or(e),s=i.endsWith("/")?i:i+"/";if(!nr(s))return s+t;const n=new URL(t,s),{href:r}=n;return r},cr=e=>"object"===e||sr(e)||!Xn(e),ur=e=>{const t=e.indexOf(":");return F(t)?e.slice(0,t):""},lr=e=>{const t=e.indexOf(":"),i=e.indexOf("/");if(!y(t)||!y(i))return[];return[e.slice(0,t),e.slice(t+1,i),e.slice(i+1)]},hr=e=>{if(!e)return[];const t=[lr(e)];let i="";for(;i=Zs(Zs(t));){const e=lr(i);if(!e.length)break;const[s,n,r]=e;if("object"===s||sr(s))break;if(t.push(e),cr(ur(r)))break}return t},dr=(e,t)=>{if(!e||cr(ur(e)))return[];const i=hr(e),s=Zs(i);if(!s)return i;const n=Zs(s);if(ir(n)||sr(n))return i;let r=ar(t,n);const{length:o}=i;for(let e=o-1;e>-1;e--){const t=i[e],[s,n]=t;t[2]=r,r=`${s}:${n}/${r}`}return i},pr=e=>{if(!C(e))return;const t=e.split(";").map((e=>{const[t,i]=e.split("=");return[t,k(i)?Number(i):i]}));return Object.fromEntries(t)},mr=e=>e?Object.entries(e).map((e=>e.join("="))).join(";"):"",fr=(e,t,i)=>t.startsWith(e)&&!i?t:`${e}:${mr(i)}/${t}`;class gr{constructor(...e){const[t]=e,{id:i,label:s,icon:n}=t;P(i,"id"),this.id=i,C(s)&&(this.label=s),C(n)&&(this.icon=n)}icon;id;urlIcon(e,t,i){const s=fr("image",e);return t.loadPromise(s).then((e=>{const{width:n,height:r}=e,o=As({width:n,height:r},i,!0),a={...o,...Ys(i,o)},c=fr("svg",s,a);return t.loadPromise(c).then((e=>En(i,e)))}))}definitionIcon(e,t){const{icon:i}=this;if(i)return this.urlIcon(i,e,t)}instanceFromObject(e={}){return new bn(this.instanceArgs(e))}instanceArgs(e={}){return{...Object.fromEntries(this.properties.map((e=>[e.name,e.defaultValue]))),...e,definition:this}}label="";properties=[];get propertiesModular(){return this.properties.filter((e=>Ce(e.type)))}toJSON(){const e={id:this.id,type:this.type};return this.icon&&(e.icon=this.icon),this.label!==this.id&&(e.label=this.label),e}toString(){return this.label}type;static fromObject(e){const{id:t,type:i}=e;return Pe(i),P(t,"id"),xt[i].definition(e)}}class vr extends bn{constructor(...e){super(...e);const[t]=e;if(!z(t))throw hn.invalid.object+"filter";const{parameters:i}=t;i?.length&&this.parameters.push(...i.map((e=>{const{name:t,dataType:i}=e;if(!i){const i=this.definition.parameters.find((e=>e.name===t));i&&(e.dataType=i.dataType)}return new dn(e)})))}commandFilters(e){return this.definition.commandFilters({...e,filter:this})}parameters=[];_parametersDefined;get parametersDefined(){if(this._parametersDefined)return this._parametersDefined;const e=[...this.parameters];return e.push(...this.definition.parameters.filter((t=>!e.find((e=>e.name===t.name))))),this._parametersDefined=e}filterSvg(e={}){return this.definition.filterDefinitionSvg({...e,filter:this})}filterSvgFilter(){const e=this.scalarObject();return this.definition.filterDefinitionSvgFilter(e)}scalarObject(e=!1){const t={},{parametersDefined:i}=this;return i.forEach((e=>{const{name:i,value:s}=e;if(C(s)){if(this.properties.find((e=>s===e.name)))return}(f(s)||n(s))&&(t[i]=s)})),this.properties.forEach((i=>{const{tweenable:s,name:n}=i;if(d(t[n]))return;if(t[n]=this.value(n),!e||!s)return;const r=`${n}${Yi}`;t[r]=this.value(r)})),t}toJSON(){const e={id:this.definitionId};return this.parameters.length&&(e.parameters=this.parameters),e}toString(){return`[Filter ${this.label}]`}}class yr extends gr{commandFilters(e){const{filter:t,duration:i,filterInput:s}=e;P(s);const n=[],r=t.scalarObject(!!i);U(r);const{ffmpegFilter:o}=this,a={inputs:[s],ffmpegFilter:o,options:r,outputs:[vn(o)]};return n.push(a),n}commandFilter(e={}){const{ffmpegFilter:t}=this;return{ffmpegFilter:t,options:e,inputs:[],outputs:[vn(t)]}}_ffmpegFilter;get ffmpegFilter(){return this._ffmpegFilter||=this.id.split(".").pop()||this.id}filterDefinitionSvg(e){throw new Error(hn.unimplemented+"initialSvgContent")}instanceFromObject(e={}){return new vr(this.instanceArgs(e))}parameters=[];populateParametersFromProperties(){this.parameters=this.properties.map((e=>{const{name:t}=e;return new dn({name:t,value:t,dataType:Ne.String})}))}filterDefinitionSvgFilter(e){throw hn.unimplemented}colorCommandFilter(e,t=0,i=0,s="#FFFFFF00"){const{width:n,height:r}=e,o="color",a=vn(o),c={color:s,size:`${n}x${r}`};t&&(c.rate=t),i&&(c.duration=i);return{inputs:[],ffmpegFilter:o,options:c,outputs:[a]}}type=Te.Filter}class br extends yr{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"color",type:Ne.String,defaultValue:"#00FF00"})),this.properties.push(un({custom:!0,name:"similarity",type:Ne.Percent,defaultValue:.9,min:.1,step:.01,max:1})),this.properties.push(un({custom:!0,name:"blend",type:Ne.Percent,defaultValue:0,step:.01,max:1})),this.populateParametersFromProperties()}filterDefinitionSvgFilter(e){const{similarity:t,color:i,blend:s}=e;c(t),c(s),P(i);const n=255,r=65025*(1-s),o=Oi(i),a=[],u={filter:"feColorMatrix",type:"matrix",values:`1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 ${1-t*(o.r/n)} ${1-t*(o.g/n)} ${1-t*(o.b/n)} -${r} ${r}`};return a.push(_n(u)),a}}const wr=(e="")=>{switch(e){case"ceil":return Math.ceil;case"floor":return Math.floor;default:return Math.round}},Fr=(e,t="")=>wr(t)(e),xr=(e,t)=>({r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]}),Ir=(e,t,i)=>{const{x:s,y:n}=t,{width:r,height:o}=i,a=((e,t)=>({x:e%t,y:Math.floor(e/t)}))(e,r);return a.x=Math.max(0,Math.min(r-1,a.x+s)),a.y=Math.max(0,Math.min(o-1,a.y+n)),((e,t)=>e.y*t+e.x)(a,r)},Tr=(e,t,i)=>((e,t)=>{const i=[],s=Math.floor(1.5);for(let n=0;n<3;n+=1)for(let r=0;r<3;r+=1){const o={x:r-s,y:n-s};i.push(Ir(e,o,t))}return i})(e,i).map((e=>((e,t)=>xr((e=>4*e)(e),t))(e,t))),Sr=e=>{const t=String(e);return"0x"===t.slice(0,2)?`#${t.slice(2)}`:t},Cr=(e,t,i=1)=>{if(!e||!t)return 0;const s=t/e,n=Math.min(1,s),r=Math.max(1,s);return 1===i?r:i?n+(r-n)*i:n},Pr=(e,t,i="ceil")=>{if(!e||!t)return 0;return Fr(e*t,i)},Er=(e,t,i="round")=>e&&t?Fr(e/t,i):0;function Vr(e,t,i=1){return Object.fromEntries(Yt.map((s=>[s,Math.round(e[s]*i+t[s]*(1-i))])))}function zr(e,t,i=1){return Object.fromEntries(Kt.map((s=>[s,Math.round(e[s]*(1-i)+t[s]*i)])))}const Ar=(e,t,i,s=0,n=0,r=!1)=>{kr(e,t,i,Li,s,n)},kr=(e,t,i,s,n=0,r=0,o=!1)=>{const a=bi(i);let c=e.length/4;for(;c--;){const i=4*c,u=xr(i,e);if(y(u.a)){const l=bi(u),h=Vr(u,s,o?yi(_r(e,c,t),a,n,r):vi(l,a,n,r));e[i+3]=h.a,h.a&&(e[i]=h.r,e[i+1]=h.g,e[i+2]=h.b)}}},_r=(e,t,i)=>Tr(4*t,e,i).map((e=>bi(e))),Or=(e,t,i,s=!1,n=!1)=>{b(i),b(t);const r=s?t:0;return(e-t+r+(n?t:0))*i-r},Rr=(e,t,i,s)=>e+(t-e)/s*i,$r=(e,t,i,s)=>{r(e),r(t);const n=i/s;if(_(Si(e),"hex color"),7===e.length||4===e.length){return fi(zr(Oi(e),Oi(t),n))}return gi(Vr(Ri(e),Ri(t),n))},Mr=(e,t,i,s)=>({x:Rr(e.x,t.x,i,s),y:Rr(e.y,t.y,i,s),width:Rr(e.width,t.width,i,s),height:Rr(e.height,t.height,i,s)}),Nr=(e,t,i)=>{P(e);const s=[e];if(C(t)&&i>1)for(let n=1;n<i;n++)s.push($r(e,t,n,i));return s},jr=(e,t,i)=>{const s=[e];if(t&&i>1)for(let n=1;n<i;n++)s.push(Mr(e,t,n,i));return s},Dr=(e,t)=>{const{width:i,height:s}=e;return!Fs(t)||Is(e,t)?{width:i,height:s}:{width:Math.max(i,t.width),height:Math.max(s,t.height)}},Lr=(e,t)=>{const{width:i,height:s}=e;return!Fs(t)||Is(e,t)?{width:i,height:s}:{width:Math.min(i,t.width),height:Math.min(s,t.height)}},qr=(e,t,i,s)=>{c(e);const n=s?Math.round(e):e;if(!f(t))return n;const r=s?Math.round(t):t;return n===r?n:(i.includes("n"),`(${n}+(${r-n}*${i}))`)},Br=(e,t)=>!!qs(t)&&(e.x!==t.x||(e.y!==t.y||(e.width!==t.width||e.height!==t.height))),Ur=(e,t,i="n")=>`(${i}/${e*t})`,Gr=e=>{if(!i(e))return{};const t=Object.entries(e).filter((([e,t])=>f(t)));return Object.fromEntries(t)},Wr=(e,t)=>({...e,...Gr(t)}),Jr=(e,t)=>({...e,...Gr(t)}),Hr=(e,t)=>d(t)?{...e,...Gr(t)}:e,Kr=(e,t,i={})=>{xs(e),Bs(t);const{width:s,height:n}=e,{x:r,y:o,width:a,height:c}=t;b(r),b(o),b(a),b(c);const u=zs(e,a,c),l=Es(u);return{...l,x:Math.round(Or(s,l.width,r,i.E,i.W)),y:Math.round(Or(n,l.height,o,i.N,i.S))}},Yr=(e,t,i)=>{const s=I(t)?t:[t,t],[n,r]=s,o=As(e,n),a=As(e,r),[c,u]=i,{width:l,height:h}=c,{width:d,height:p}=u,m=zs(o,l,h),f=zs(a,d,p);return[Es(m),Es(f)]},Xr=(e,t,i)=>{const s=I(t)?t:[t,t],[n,r]=e,[o,a]=s,[c,u]=i,{x:l,y:h}=c,{x:d,y:p}=u;return[{x:l*(n.width-o.width),y:h*(n.height-o.height)},{x:d*(r.width-a.width),y:p*(r.height-a.height)}]},Zr=(e,t)=>({...e,...Ns(e,t)}),Qr=(e,t)=>e.map((e=>Zr(e,t))),eo=(e,t,i,s)=>{if(!s)return e;const{width:n,height:r}=t,o={...e};switch(s){case qe.H:o.width=r*o.height*i/n;break;case qe.V:o.height=n*o.width/i/r}return o},to=e=>{is(e);const{clip:t}=e,{track:i}=t,{mash:s}=i,{quantize:n}=s,r=t.timeRange(n),o=e.tweenPoints(r,r);return!ms(...o)},io=(e,t,i)=>Math.min(i,Math.max(t,e)),so=(e,t,i,s,n)=>{if(s){if(!t)return i?e.startTime:e.lastTime;if(n){if(i)return e.lastTime}else if(!i)return e.startTime}};class no extends yr{constructor(...e){super(...e),this.properties.push(un({tweenable:!0,custom:!0,name:"color",type:Ne.String})),this.populateParametersFromProperties()}_ffmpegFilter="geq";commandFilters(e){const t=[],{filter:i,videoRate:s,duration:n,filterInput:r}=e;c(n,"duration"),c(s,"videoRate");const o=i.value("color");P(o,"color");let a=r;P(a,"filterInput");const u="format",l=vn(u),h={inputs:[a],ffmpegFilter:u,options:{pix_fmts:"rgba"},outputs:[l]};t.push(h),a=l;const d=i.value(`color${Yi}`)||o;P(d);const p=o.length>7,m=p?Ri(o):Oi(o),f=p?Ri(d):Oi(d),g=p?Yt:Kt,v={},y=n?Ur(s,n,"N"):0;g.forEach((e=>{const t=m[e],i=f[e];v[e]=t===i?t:`${t}+(${i-t}*${y})`})),p||(v.a="alpha(X,Y)");const b=vn("geq"),w={inputs:[a],ffmpegFilter:"geq",options:v,outputs:[b]};return t.push(w),t}}class ro extends no{constructor(...e){super(...e),this.properties.push(un({tweenable:!0,name:"color",type:Ne.String}));["width","height"].forEach((e=>{this.properties.push(un({tweenable:!0,name:e,type:Ne.Number}))})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,videoRate:s,duration:n}=e;x(s,"videoRate");const{ffmpegFilter:r}=this;let o=vn(r);const a=i.value("color");P(a);const u=n?i.value(`color${Yi}`):void 0,l=C(u)&&a!==u,h=i.scalarObject(!!n);xs(h);const{width:d,height:p}=h;let m=!1;const f={width:d,height:p},g={width:d,height:p};if(n){const{[`width${Yi}`]:e=d,[`height${Yi}`]:t=p}=h;c(e),c(t),m=!(d===e&&p===t),m&&(g.width=e,g.height=t)}const v=m?Dr(f,g):f,y={inputs:[],ffmpegFilter:r,options:{color:a,rate:s,size:Object.values(v).join("x")},outputs:[o]};if(F(n)&&(y.options.duration=n),t.push(y),l){const e="fade",i=vn(e),s={inputs:[o],ffmpegFilter:e,options:{type:"out",color:u,duration:n},outputs:[i]};t.push(s),o=i}if(m){const e="scale",i=vn(e),r=Ur(s,n),a={inputs:[o],ffmpegFilter:e,options:{eval:"frame",width:qr(f.width,g.width,r),height:qr(f.height,g.height,r)},outputs:[i]};t.push(a)}return t}_ffmpegFilter="color";filterDefinitionSvg(e){const{filter:t}=e,i=t.scalarObject(!1),{width:s,height:n,color:r}=i;P(r);const o=globalThis.document.createElementNS(_t,"rect");return o.setAttribute("width",String(s)),o.setAttribute("height",String(n)),o.setAttribute("fill",Sr(r)),o}}const oo=Yt.flatMap((e=>Yt.map((t=>`${e}${t}`))));class ao extends yr{constructor(...e){super(...e),oo.forEach((e=>{this.properties.push(un({custom:!0,name:e,type:Ne.Number,defaultValue:e[0]===e[1]?1:0,min:0,max:1}))})),this.populateParametersFromProperties()}filterDefinitionSvgFilter(e){const t={filter:"feColorMatrix",type:"matrix",values:Yt.flatMap((t=>[...Yt.map((i=>Number(e[`${t}${i}`]))),0])).join(" ")};return[_n(t)]}}var co;!function(e){e.Analyze="analyze",e.Complete="complete",e.Error="error",e.Load="load",e.Render="render"}(co||(co={}));const uo=(e,t)=>{const i=e.filter((e=>e.input)),s=i.findIndex((e=>e.inputId===t));return y(s)||console.log("commandFilesInputIndex",t,i),b(s,"commandFilesInputIndex"),s},lo=(e,t,i)=>[uo(e,t),i?"v":"a"].join(":"),ho=e=>{e.preventDefault(),e.stopPropagation()},po=e=>{const{endpoint:t,request:i}=e,s=i||{},n="Content-Type",r="application/json";switch(s.method||="POST",s.headers||={},s.headers[n]||=r,s.headers[n]){case r:s.body=JSON.stringify(s.body);break;case"multipart/form-data":{const e=new FormData;Object.entries(s.body).forEach((([t,i])=>{o(i)||e.set(t,i instanceof Blob?i:String(i))})),s.body=e,delete s.headers[n];break}}const a=ar(t);return fetch(a,s).then((e=>e.json()))},mo=e=>i(e)&&"changeHandler"in e,fo=(e,t,i)=>{const s=e.filter((e=>!!mo(e)&&(e.property.group===t&&e.selectType===i)));return Object.fromEntries(s.map((e=>{const{name:t,property:i}=e,{name:s}=i;return[t||s,e]})))},go=e=>Object.fromEntries(Object.entries(e).map((e=>[e[0],e[1].value]))),vo=(e,t)=>e.frame-t.frame,yo=(e,t)=>e.index-t.index,bo=(e,t)=>e.trackNumber-t.trackNumber,wo=(e,t)=>e.label<t.label?-1:e.label>t.label?1:0,Fo=(e,t=0,i=0)=>{const s=[];let n=2,r=3600,o=!1;const a=i||e;return a>=r&&(e>=r?(s.push(String(Math.floor(e/r)).padStart(n,"0")),o=!0,e%=r):s.push("00:")),r=60,(o||a>=r)&&(o&&s.push(":"),e>=r?(s.push(String(Math.floor(e/r)).padStart(n,"0")),o=!0,e%=r):s.push("00:")),r=1,o||a>=r?(o&&s.push(":"),e>=r?(s.push(String(Math.floor(e/r)).padStart(n,"0")),o=!0,e%=r):s.push("00")):s.push("00"),t>1&&(10===t&&(n=1),s.push("."),e?(e=1===n?Math.round(10*e)/10:Math.round(100*e)/100,e=Number(String(e).slice(2)),s.push(String(e).padEnd(n,"0"))):s.push("0".padStart(n,"0"))),s.join("")},xo=(e,t,i)=>{if(!C(e)||!F(i))return Gs;const{document:n}=globalThis,r=n.createElement("canvas").getContext("2d");s(r),r.font=`${i}px ${t}`;const o=r.measureText(e),{actualBoundingBoxAscent:a,actualBoundingBoxDescent:c,actualBoundingBoxLeft:u,actualBoundingBoxRight:l,width:h}=o;return{x:u,y:a,width:u+l,height:a+c}},Io=(e,t,i="s")=>C(t)?`${e} ${t}${1===e?"":i}`:t;class To extends yr{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"bias",defaultValue:0,min:0,max:100,step:.01})),this.properties.push(un({custom:!0,name:"matrix",defaultValue:"0 0 0 0 1 0 0 0 0"})),this.properties.push(un({custom:!0,name:"multiplier",defaultValue:1,min:0,max:100,step:.01})),this.populateParametersFromProperties()}commandFilters(e){const{filterInput:t,filter:i,duration:s}=e;P(t,"filterInput");const n=[],r=i.scalarObject(!!s);Co(r);const{ffmpegFilter:o}=this,a={inputs:[t],ffmpegFilter:o,options:_o(ko(r)),outputs:[vn(o)]};return n.push(a),n}filterDefinitionSvgFilter(e){Co(e);const{matrix:t,bias:i,multiplier:s}=e,n={filter:"feConvolveMatrix",kernelMatrix:String(t),bias:String(i)};return F(s)&&(n.divisor=String(s)),console.log(this.constructor.name,"filterDefinitionSvgFilter",n),[_n(n)]}}const So=e=>i(e)&&"matrix"in e&&"bias"in e&&"multiplier"in e;function Co(e){if(!So(e))throw new Error("expected ConvolutionServerFilter")}const Po=e=>({combined:e,r:e,g:e,b:e,a:e}),Eo=e=>(e=>({combined:e,r:e,g:e,b:e,a:e}))(String(e)),Vo=e=>{const{combined:t}=e;return(e=>({combined:e,r:e,g:e,b:e,a:e}))((String(t)||"0 0 0 0 1 0 0 0 0").split(",").map((e=>parseInt(e.trim()))))},zo=e=>{const{combined:t}=e;return Po((i=String(t))?.length?parseFloat(i.trim()):0);var i},Ao=e=>{const{combined:t}=e;return Po((e=>{if(!e?.length)return 1;if(e.includes("/")){const t=e.split("/").map((e=>parseFloat(e.trim()))),[i,s]=t;return i/s}return parseFloat(e.trim())})(String(t)))},ko=e=>{const t=Eo(e.matrix),i=Eo(e.multiplier),s=Vo(t);return{multiplier:Ao(i),matrix:s,bias:t.combined?Po(0):zo(Eo(e.bias))}},_o=e=>{const t={};return Yt.map((e=>e)).forEach(((i,s)=>{const n=e.multiplier[i],r=e.matrix[i];t[`${s}m`]=r.join(" "),t[`${s}rdiv`]=n,t[`${s}bias`]=e.bias[i]})),t};class Oo extends yr{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"width",type:Ne.String})),this.properties.push(un({custom:!0,name:"height",type:Ne.String})),this.properties.push(un({tweenable:!0,custom:!0,name:"x",type:Ne.Number,defaultValue:0,min:0,step:1})),this.properties.push(un({tweenable:!0,custom:!0,name:"y",type:Ne.Number,defaultValue:0,min:0,step:1})),this.populateParametersFromProperties()}commandFilters(e){const{filter:t,filterInput:i,duration:s,videoRate:n}=e;P(i);const r=[],o=t.scalarObject(!!s),a={exact:1},c=Ur(n,s);a.x=qr(o.x,o[`x${Yi}`],c,!0),a.y=qr(o.y,o[`y${Yi}`],c,!0);const{width:u,height:l}=o;L(u)&&(a.w=u),L(l)&&(a.h=l);const{ffmpegFilter:h}=this,d={inputs:[i],ffmpegFilter:h,options:a,outputs:[vn(h)]};return r.push(d),r}}class Ro extends yr{constructor(...e){super(...e),this.properties.push(un({tweenable:!0,custom:!0,name:"x",type:Ne.Percent,defaultValue:.5})),this.properties.push(un({tweenable:!0,custom:!0,name:"y",type:Ne.Percent,defaultValue:.5})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,filterInput:s,chainInput:n,duration:r,videoRate:o}=e;P(s,"filterInput"),P(n,"chainInput");const a=i.scalarObject(!!r),c={format:"yuv420"},u=Ur(o,r,"(n-1)"),l=qr(a.x,a[`x${Yi}`],u,!0),h=qr(a.y,a[`y${Yi}`],u,!0),d=0===h;0===l||(c.x=l),d||(c.y=h);const p={inputs:[n,s],ffmpegFilter:"overlay",options:c,outputs:[]};return t.push(p),t}}class $o extends yr{constructor(...e){super(...e),this.properties.push(un({name:"width",type:Ne.Percent,defaultValue:1,max:2})),this.properties.push(un({name:"height",type:Ne.Percent,defaultValue:1,max:2})),this.properties.push(un({name:`width${Yi}`,type:Ne.Percent,defaultValue:1,max:2})),this.properties.push(un({name:`height${Yi}`,type:Ne.Percent,defaultValue:1,max:2})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,duration:s,filterInput:n,videoRate:r}=e,o=i.scalarObject(!!s),{width:a,height:c,[`width${Yi}`]:u,[`height${Yi}`]:l}=o;P(n);const{ffmpegFilter:h}=this,d=Ur(r,s),p={width:qr(a,u,d,!0),height:qr(c,l,d,!0)};f(p.width)&&f(p.height)||(p.eval="frame");const m={inputs:[n],ffmpegFilter:h,options:p,outputs:[vn(h)]};return t.push(m),t}}class Mo extends yr{constructor(...e){super(...e),this.properties.push(un({tweenable:!0,custom:!0,name:"opacity",type:Ne.Number,defaultValue:1})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filterInput:i,filter:s,duration:n,videoRate:r}=e,o=s.value("opacity");let a=i;c(o),P(a,"filterInput");const u={lum:"lum(X,Y)",cb:"cb(X,Y)",cr:"cr(X,Y)",a:`alpha(X,Y)*${o}`};if(n){const e=s.value(`opacity${Yi}`);if(f(e)&&o!=e){const t=Ur(r,n,"N"),i=e-o;u.a=`alpha(X,Y)*(${o}+(${i}*${t}))`}}const{ffmpegFilter:l}=this,h={inputs:[a],ffmpegFilter:l,options:u,outputs:[vn(l)]};return t.push(h),t}_ffmpegFilter="geq";filterDefinitionSvgFilter(e){const{opacity:t}=e;c(t);const i=globalThis.document.createElementNS(_t,"feColorMatrix");i.setAttribute("type","matrix");const s=`1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 ${t} 0`;return console.log(this.constructor.name,"filterDefinitionSvgFilters",s),Dn(i,s,"values"),[i]}}class No extends yr{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"sar",type:Ne.String,defaultValue:"0"})),this.properties.push(un({custom:!0,name:"max",type:Ne.Number,defaultValue:100})),this.populateParametersFromProperties()}}class jo extends yr{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"fps",type:Ne.Number})),this.populateParametersFromProperties()}}class Do extends yr{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"expr",type:Ne.String,defaultValue:"PTS-STARTPTS"})),this.populateParametersFromProperties()}}class Lo extends yr{commandFilters(e){const t=[],{chainInput:i,filterInput:s}=e;P(i,"chainInput"),P(s,"filterInput");const{ffmpegFilter:n}=this,r={inputs:[i,s],ffmpegFilter:n,options:{},outputs:[vn(n)]};return t.push(r),t}}class qo extends yr{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"start",type:Ne.Number,defaultValue:0})),this.populateParametersFromProperties()}}class Bo extends no{constructor(...e){super(...e),this.properties.push(un({custom:!0,type:Ne.String,name:"fontfile"})),this.properties.push(un({custom:!0,type:Ne.String,name:"textfile"})),this.properties.push(un({custom:!0,type:Ne.Boolean,name:"stretch"})),this.properties.push(un({tweenable:!0,custom:!0,type:Ne.Number,name:"height"})),this.properties.push(un({tweenable:!0,custom:!0,type:Ne.Number,name:"width"})),this.properties.push(un({custom:!0,type:Ne.Number,name:"intrinsicHeight"})),this.properties.push(un({custom:!0,type:Ne.Number,name:"intrinsicWidth"})),this.properties.push(un({tweenable:!0,custom:!0,type:Ne.Number,name:"x"})),this.properties.push(un({tweenable:!0,custom:!0,type:Ne.Number,name:"y"})),this.properties.push(un({tweenable:!0,custom:!0,type:Ne.String,name:"color"})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,duration:s,videoRate:n,filterInput:r}=e,o=i.value("color"),a=i.value("x"),u=i.value("y"),l=i.value("textfile"),h=i.value("fontfile"),d=i.value("height"),p=i.value("width"),m=!!i.value("stretch"),g=i.value("intrinsicWidth"),v=i.value("intrinsicHeight");P(l),P(h),c(d),c(p),c(g),c(v),c(a),c(u),P(o,"color");const y=i.value(`x${Yi}`),b=i.value(`y${Yi}`),w=s?i.value(`color${Yi}`):void 0,x=C(w)&&o!==w,{ffmpegFilter:I}=this,T=vn(I),S=x||r?Qt:o;let E="#000000";r||(E=x?"#00000000":"#FFFFFF00");const V={width:p,height:d},z={...V};if(s){const e=i.value(`height${Yi}`)||0,t=i.value(`width${Yi}`)||0;F(t)&&(z.width=t),F(e)&&(z.height=e)}const A=g/v,k=Dr(V,z),_=Math.round(A*k.height);_>k.width&&(k.width=_);let O=m||!Is(V,z);const R={},$={fontsize:k.height,fontfile:h,textfile:l,x:Math.ceil(f(y)?Math.max(a,y):a),y:Math.ceil(f(b)?Math.max(u,b):u)},M=Ur(n,s);if(x){const e=o.length>7,t=e?Ri(o):Oi(o),i=e?Ri(w):Oi(w),s=(e?Yt:Kt).map((e=>{const s=t[e],n=i[e];return s===n?s:`${s}+(${n-s}*${M})`})).map((e=>["eif",e,"x",2].join(":"))).map((e=>`%{${e}}`));$.fontcolor_expr=`#${s.join("")}`}else $.fontcolor=S;const N=this.colorCommandFilter(k,n,s,E);t.push(N);let j=Zs(N.outputs);O&&(R.width=m?qr(p,z.width,M,!0):-1,R.height=qr(d,z.height,M,!0),f(R.width)&&f(R.height)||(R.eval="frame"));const D={inputs:[j],ffmpegFilter:I,options:$,outputs:[T]};if(t.push(D),j=T,!r){const e="format",i=vn(e),s={inputs:[j],ffmpegFilter:e,options:{pix_fmts:"yuva420p"},outputs:[i]};t.push(s),j=i}if(O){const e="scale",i=vn(e),s={inputs:[j],ffmpegFilter:e,options:R,outputs:[i]};t.push(s),j=i}return t}_ffmpegFilter="drawtext"}const Uo=`${$t}filter.`,Go=[new Lo({id:`${Uo}alphamerge`}),new br({id:`${Uo}chromakey`}),new ao({id:`${Uo}colorchannelmixer`}),new ro({id:`${Uo}color`}),new no({id:`${Uo}colorize`}),new To({id:`${Uo}convolution`}),new Oo({id:`${Uo}crop`}),new jo({id:`${Uo}fps`}),new Mo({id:`${Uo}opacity`}),new Ro({id:`${Uo}overlay`}),new $o({id:`${Uo}scale`}),new Do({id:`${Uo}setpts`}),new No({id:`${Uo}setsar`}),new qo({id:`${Uo}trim`}),new Bo({id:`${Uo}text`})],Wo=e=>{const{id:t}=e;return P(t),new yr(e)},Jo=e=>{const t=e.includes(".")?e:`${Uo}${e}`,i=Go.find((e=>e.id===t));return i||Wo({id:t})},Ho=e=>{const{id:t}=e;if(!t)throw hn.invalid.definition.id;return Jo(t).instanceFromObject(e)},Ko=e=>Jo(e).instanceFromObject({id:e});function Yo(e){return class extends e{constructor(...e){super(...e);const[t]=e;this.addProperties(t,un({name:"x",type:Ne.Percent,defaultValue:.5,group:sn.Point,tweenable:!0})),this.addProperties(t,un({name:"y",type:Ne.Percent,defaultValue:.5,group:sn.Point,tweenable:!0})),We.forEach((e=>{this.addProperties(t,un({name:`off${e}`,type:Ne.Boolean,group:sn.Point}))})),this.addProperties(t,un({tweenable:!0,name:"opacity",type:Ne.Percent,defaultValue:1,group:sn.Opacity}))}_colorizeFilter;get colorizeFilter(){return this._colorizeFilter||=Ko("colorize")}colorizeCommandFilters(e){const{contentColors:t,videoRate:i,filterInput:s,time:n}=e;V(t);const r=N(n)?n.lengthSeconds:0,{colorizeFilter:o}=this,a={videoRate:i,duration:r,filterInput:s},[c,u]=t;return o.setValue(c,"color"),o.setValue(u,`color${Yi}`),o.commandFilters(a)}colorMaximize=!1;containerColorCommandFilters(e){const t=[],{contentColors:i,containerRects:s,track:n}=e,{colorMaximize:r}=this;if(!r)return super.containerColorCommandFilters(e);V(i);const o=!Us(...s)?Dr(...s):s[0],a={...e,outputSize:o};return t.push(...this.colorBackCommandFilters(a,`content-${n}`)),t}containerCommandFilters(e,t){const i=[],{contentColors:s,filterInput:n}=e;let r=n;return P(r,"filterInput"),s?.length||(i.push(...this.alphamergeCommandFilters({...e,filterInput:r})),r=Zs(Zs(i).outputs)),i.push(...this.containerFinalCommandFilters({...e,filterInput:r})),i}containerFinalCommandFilters(e){const t=[],{filterInput:i}=e;let s=i;P(s,"filterInput");const n=this.opacityCommandFilters(e);return n.length&&(t.push(...n),s=Zs(Zs(n).outputs)),t.push(...this.translateCommandFilters({...e,filterInput:s})),t}containerRects(e,t){const{size:i,time:s,timeRange:n}=e,{lock:r}=this,o=this.tweenRects(s,n),a=Qr(o,r),{width:c,height:u}=t,l=(c||i.width)/(u||i.height),[h,d]=a,p=eo(h,i,l,r),{directionObject:m}=this,f=Kr(i,p,m);if(!!Us(h,d))return[f,f];const g=eo(d,i,l,r),v=Wr(p,g);return[f,Kr(i,v,m)]}containerPreviewItemPromise(e,t,i,s){return Promise.resolve(this.pathElement(e))}containerSvgFilter(e,t,i,s,n){const[r]=this.tweenValues("opacity",s,n);if(!w(r))return;const{opacityFilter:o}=this;return o.setValue(r,"opacity"),Nn(o.filterSvgFilter(),e)}get directions(){return Ye}get directionObject(){return Object.fromEntries(We.map((e=>[e,!!this.value(`off${e}`)])))}get isDefault(){return this.definitionId===rs}opacityCommandFilters(e){const{outputSize:t,filterInput:i,clipTime:s,time:n,videoRate:r}=e;j(s);const o=[],a={dimensions:t,filterInput:i,videoRate:r,duration:N(n)?n.lengthSeconds:0},[c,u]=this.tweenValues("opacity",n,s);if(w(c)||d(u)&&w(u)){const{opacityFilter:e}=this;e.setValues({opacity:c,opacityEnd:u}),o.push(...e.commandFilters(a))}return o}_opacityFilter;get opacityFilter(){return this._opacityFilter||=Ko("opacity")}pathElement(e,t="none"){return Cn(e,"",t)}translateCommandFilters(e){const t=[],{outputSize:i,time:s,containerRects:n,chainInput:r,filterInput:o,videoRate:a}=e;if(!r)return t;V(n);const[c,u]=n,l=u||{},h=N(s)?s.lengthSeconds:0,{overlayFilter:d}=this;d.setValue(c.x,"x"),d.setValue(c.y,"y"),h&&(d.setValue(l.x,`x${Yi}`),d.setValue(l.y,`y${Yi}`));const p={dimensions:i,filterInput:o,videoRate:a,duration:h,chainInput:r};return t.push(...d.commandFilters(p)),t}}}function Xo(e){return class extends e{constructor(...e){super(...e),this.properties.push(un({name:"lock",type:Ne.String,defaultValue:qe.H,group:sn.Size}))}type=Te.Container}}Ft[Te.Filter]={definition:Wo,definitionFromId:Jo,fromId:Ko,instance:Ho,defaults:Go};const Zo=e=>ls(e)&&"path"in e,Qo=(e,t,i="")=>{if(e.fps===t.fps)return[e,t];const s=(n=e.fps,r=t.fps,n*r/((e,t)=>{let i=e,s=t,n=0;for(;0!==s;)n=s,s=i%s,i=n;return i})(n,r));var n,r;return[e.scale(s,i),t.scale(s,i)]};class ea{constructor(e=0,t=1){if(!g(e)||e<0)throw hn.frame+e;if(!g(t)||t<1)throw hn.fps;this.frame=e,this.fps=t}add(e){const[t,i]=Qo(this,e);return new ea(t.frame+i.frame,t.fps)}addFrame(e){const t=this.copy;return t.frame+=e,t}closest(e){const t=e.frame+Math.round(e.frames/2),i=new ea(t,e.fps),[s,n]=Qo(i,this);return s.frame<n.frame?e.lastTime:e.startTime}get copy(){return new ea(this.frame,this.fps)}get description(){return`${this.frame}@${this.fps}`}divide(e,t=""){return x(e),1===e?this:this.withFrame(Fr(this.frame/e,t))}equalsTime(e){const[t,i]=Qo(this,e);return t.frame===i.frame}fps;frame;durationFrames(e,t=0){const i=t||this.fps,s=[],n=Math.floor(i*e)-2,r=Math.min(n,this.scale(i,"floor").frame);if(this.isRange){const e=this.timeRange.endTime.scale(i,"ceil").frame,t=Math.min(n+1,e);for(let e=r;e<t;e+=1)s.push(e)}else s.push(r);return s}isRange=!1;get lengthSeconds(){return 0}min(e){const[t,i]=Qo(this,e);return new ea(Math.min(t.frame,i.frame),t.fps)}scale(e,t=""){if(this.fps===e)return this;const i=Number(this.frame)/Number(this.fps)*Number(e);return new ea(Fr(i,t),e)}scaleToFps(e){return this.scaleToTime(new ea(0,e))}scaleToTime(e){return Qo(this,e)[0]}get seconds(){return Number(this.frame)/Number(this.fps)}get startTime(){return this}subtract(e){const[t,i]=Qo(this,e);let s=i.frame;return s>t.frame&&(s-=s-t.frame),new ea(t.frame-s,t.fps)}subtractFrames(e){const t=this.copy;return t.frame-=e,t}get timeRange(){throw hn.timeRange}toString(){return`[${this.description}]`}withFrame(e){const t=this.copy;return t.frame=e,t}}class ta extends ea{frames;constructor(e=0,t=1,i=1){if(super(e,t),!(g(i)&&i>=0))throw console.trace(this.constructor.name),hn.timeRange+" frames";this.frames=i}addFrames(e){const t=this.copy;return t.frames+=e,t}get copy(){return new ta(this.frame,this.fps,this.frames)}get description(){return`${this.frame}-${this.frames}@${this.fps}`}get end(){return this.frame+this.frames}get endTime(){return new ea(this.end,this.fps)}equalsTimeRange(e){const[t,i]=Qo(this,e);return t.frame===i.frame&&t.frames===i.frames}get frameTimes(){const{frames:e,frame:t,fps:i}=this;return Array.from({length:e},((e,s)=>new ea(t,i)))}includes(e){return e>=this.frame&&e<=this.end}includesTime(e){const[t,i]=Qo(this,e),s=t,{frame:n,end:r}=s,o=i.frame;return o>=n&&o<r}intersects(e){if(!e.isRange)return this.includesTime(e);const[t,i]=Qo(e,this);return!(t.frame>=i.end)&&t.end>i.frame}isRange=!0;get last(){return this.frame+this.frames-1}get lastTime(){return new ea(this.last,this.fps)}get lengthSeconds(){return Number(this.frames)/Number(this.fps)}get position(){return Number(this.frame)/Number(this.frames)}positionTime(e,t=""){const i=Fr((this.frames-this.frame)*e,t);return new ea(this.frame+i,this.fps)}get startTime(){return new ea(this.frame,this.fps)}scale(e=1,t=""){if(this.fps===e)return this.copy;const i=Number(this.frames)/(Number(this.fps)/Number(e)),s=super.scale(e,t),n=Math.max(1,Fr(i,t));return new ta(s.frame,s.fps,n)}get timeRange(){return this}get times(){const e=[this.startTime];return this.frames>1&&e.push(this.endTime),e}minEndTime(e){const[t,i]=Qo(this,e);return t.frames=Math.min(t.frames,i.frame),t}withFrame(e){const t=this.copy;return t.frame=e,t}withFrames(e){const t=this.copy;return t.frames=e,t}}const ia=(e=0,t=1,i=1)=>new ta(e,t,i),sa=(e=0,t=1)=>ia(e,1,t),na=(e,t=1)=>ia(e.frame,e.fps,t),ra=(e,t)=>{if(!t)return na(e);const[i,s]=Qo(e,t);if(s.frame<=i.frame)throw console.trace("fromTimes"),hn.argument+"fromTimes "+i+" "+s;const n=s.frame-i.frame;return ia(i.frame,i.fps,n)},oa=(e=0,t=1)=>new ea(e,t),aa=(e=0,t=1,i="")=>{if(!f(e)||e<0)throw hn.seconds;if(!g(t)||t<1)throw hn.fps;const s=Fr(e*t,i);return oa(s,t)},ca={duration:3,label:"Unlabeled",editor:{buffer:10,fps:30,loop:!0,volume:.75,precision:3,autoplay:!1},cast:{label:"Cast",quantize:10,color:"#000000",gain:.75,buffer:10},mash:{label:"Mash",quantize:10,color:"#000000",gain:.75,buffer:10},definition:{image:{duration:2},textcontainer:{duration:3},shape:{duration:3},visible:{duration:3},video:{fps:0},videosequence:{pattern:"%.jpg",fps:10,increment:1,begin:1,padding:0},videostream:{duration:10}}};function ua(e){return class extends e{constructor(...e){super(...e);const[t]=e,{container:i}=t;i&&(this.container=!0)}alphamergeCommandFilters(e){const t=[],{videoRate:i,outputSize:s,track:n,filterInput:r}=e;P(r),x(i),xs(s);const o={videoRate:0,duration:0,filterInput:r,chainInput:`content-${n}`},{alphamergeFilter:a}=this;return t.push(...a.commandFilters(o)),t}_alphamergeFilter;get alphamergeFilter(){return this._alphamergeFilter||=Ko("alphamerge")}amixCommandFilters(e){const{chainInput:t,filterInput:i}=e;P(t),P(i);const s=[],n={inputs:[t,i],ffmpegFilter:"amix",options:{normalize:0},outputs:[]};return s.push(n),s}canColor(e){return!1}canColorTween(e){return!1}_clip;get clip(){return this._clip}set clip(e){this._clip=e}get clipped(){return!!this._clip}colorBackCommandFilters(e,t){const{contentColors:i=[],videoRate:s,outputSize:n,duration:r}=e;xs(n);const o=Cs(n),[a=si,c=si]=i,u=t||vn(li(a)||"back"),{colorFilter:l}=this,h={videoRate:s,duration:r};l.setValue(a,"color"),l.setValue(c,`color${Yi}`),l.setValue(o.width,"width"),l.setValue(o.height,"height"),l.setValue(o.width,`width${Yi}`),l.setValue(o.height,`height${Yi}`);const d=l.commandFilters(h);if(Is(o,n))Zs(d).outputs=[u];else{const e=Zs(Zs(d).outputs);P(e,"crop input");const t={inputs:[e],ffmpegFilter:"crop",options:{w:n.width,h:n.height,exact:1},outputs:[u]};d.push(t)}return d}_colorFilter;get colorFilter(){return this._colorFilter||=Ko("color")}visibleCommandFiles(e){const t={...e,audible:!1,visible:!0};return this.fileCommandFiles(t)}commandFilters(e,t,i=!1){const s=[],{filterInput:n=""}=e;let r=n;const o=this.initialCommandFilters(e,t,i);return o.length&&(s.push(...o),r=Zs(Zs(o).outputs)),i?s.push(...this.containerCommandFilters({...e,filterInput:r},t)):s.push(...this.contentCommandFilters({...e,filterInput:r},t)),s}container=!1;containerColorCommandFilters(e){const t=[],{contentColors:i=[],containerRects:s,videoRate:n,duration:r}=e;T(s,"containerRects");const[o,a]=s,c={videoRate:n,duration:r},{colorFilter:u}=this,[l,h]=i;return u.setValue(l||Qt,"color"),u.setValue(h,`color${Yi}`),u.setValue(o.width,"width"),u.setValue(o.height,"height"),u.setValue(a.width,`width${Yi}`),u.setValue(a.height,`height${Yi}`),t.push(...u.commandFilters(c)),t}containerCommandFilters(e,t){return[]}containerFinalCommandFilters(e){return[]}contentCommandFilters(e,t){return[]}copyCommandFilter(e,t,i="content"){return{inputs:[e],ffmpegFilter:"copy",options:{},outputs:[`${i}-${t}`]}}_cropFilter;get cropFilter(){return this._cropFilter||=Ko("crop")}definitionTime(e,t){const{fps:i}=t,s=e.scaleToFps(i),{startTime:n,endTime:r}=t,o=Math.max(Math.min(s.frame,r.frame),n.frame);return s.withFrame(o-n.frame)}frames(e){return oa(ca.duration,e).frame}fileCommandFiles(e){const t=[],i=this.fileUrls(e);let s=0;return t.push(...i.map(((e,t)=>{const{input:i}=e,n=t&&i?`${this.id}-${s}`:this.id,r={...e,inputId:n};return i&&s++,r}))),t}fileUrls(e){return[]}hasIntrinsicSizing=!1;hasIntrinsicTiming=!1;initialCommandFilters(e,t,i=!1){throw new Error(hn.unimplemented)}intrinsicRect(e=!1){throw new Error(hn.unimplemented)}intrinsicsKnown(e){return!0}intrinsicGraphFile(e){const{editing:t,size:i,duration:n}=e,r=ia(),o={editing:t,time:r.startTime,clipTime:r,quantize:r.fps,visible:i,audible:n},[a]=this.fileUrls(o);return s(a),a}get isDefault(){return!1}mutable(){return!1}overlayCommandFilters(e,t){P(e,"bottomInput"),P(t,"topInput");const i=[],s={filterInput:t,chainInput:e,videoRate:0,duration:0},{overlayFilter:n}=this;n.setValue(0,"x"),n.setValue(0,"y"),i.push(...n.commandFilters(s));return Zs(i).outputs=[vn(t)],i}_overlayFilter;get overlayFilter(){return this._overlayFilter||=Ko("overlay")}scaleCommandFilters(e){const{time:t,containerRects:i,filterInput:s,videoRate:n}=e;let r=s;P(r,"filterInput"),T(i,"containerRects");const[o,a]=i;Bs(o),Bs(a);const c=N(t)?t.lengthSeconds:0,u=[],{scaleFilter:l}=this,h={duration:c,videoRate:n,filterInput:r};return l.setValue(o.width,"width"),l.setValue(o.height,"height"),l.setValue(a.width,`width${Yi}`),l.setValue(a.height,`height${Yi}`),u.push(...l.commandFilters(h)),u}_scaleFilter;get scaleFilter(){return this._scaleFilter||=Ko("scale")}selectables(){return[this,...this.clip.selectables()]}selectType=ie.None;selectedItems(e){const t=[],{container:i,clip:s,selectType:n,definition:r}=this,{id:o}=r,{timing:a,sizing:c}=s,u=i?Ne.ContainerId:Ne.ContentId,l=s.properties.find((e=>e.type===u));cn(l);const{name:h}=l,d={timing:a,sizing:c,[h]:o},p={...d},m=i?lt.Container:lt.Content,f=i?dt.Container:dt.Content,g=a===m,v=c===f;t.push({selectType:n,property:l,value:o,changeHandler:(t,n)=>{P(n);const r={...p,[h]:n};if(g||v){const e=Ht.fromId(n),{type:t}=e;g&&!Ae(t)&&(r.timing=lt.Custom),v&&!Ve(t)&&(r.sizing=i?dt.Content:dt.Container)}const o={type:Y.ChangeMultiple,property:t,target:s,redoValues:r,undoValues:d};e.create(o)}});const{properties:y}=this,b=y.filter((e=>this.selectedProperty(e)));return b.forEach((i=>{t.push(...this.selectedProperties(e,i))})),t}selectedProperties(e,t){const i=[],{name:s,tweenable:n,type:r}=t,{selectType:o}=this,a=this.value(s),c=this,u=r===Ne.Frame?Y.ChangeFrame:Y.Change,l={selectType:o,property:t,value:a,changeHandler:(t,i)=>{P(t),e.create({type:u,property:t,target:c,redoValue:i,undoValue:a})}};if(i.push(l),n){const n=[s,Yi].join(""),r=this,a=this.value(n),c={selectType:o,property:t,value:a,name:n,changeHandler:(t,i)=>{e.create({property:t,target:r,redoValue:i,undoValue:a})}};i.push(c)}return i}selectedProperty(e){const{name:t}=e;switch(t){case"muted":return this.mutable();case"opacity":return this.container}return!0}tween(e,t,i){const s=this.value(e),n=this.value(`${e}${Yi}`);if(o(n))return s;const{frame:r,frames:a}=i,{frame:u}=t,l=u-r;return f(s)?(c(n),Rr(s,n,l,a)):(P(s),P(n),$r(s,n,l,a))}tweenPoints(e,t){const[i,s]=this.tweenValues("x",e,t),[n,r]=this.tweenValues("y",e,t);c(i),c(n);const o={x:i,y:n};return[o,Jr(o,{x:s,y:r})]}tweenRects(e,t){const[i,s]=this.tweenSizes(e,t),[n,r]=this.tweenPoints(e,t);return[{...n,...i},{...r,...s}]}tweenSizes(e,t){const[i,s]=this.tweenValues("width",e,t),[n,r]=this.tweenValues("height",e,t);c(i),c(n);const o={width:i,height:n};return[o,Hr(o,{width:s,height:r})]}tweenValues(e,t,i){const s=[],n=N(t);return s.push(this.tween(e,n?t.startTime:t,i)),n&&s.push(this.tween(e,t.endTime,i)),s}}}const la=Yo(ua(bn));class ha extends la{constructor(...e){super(...e);const[t]=e;this.addProperties(t,un({tweenable:!0,name:"width",type:Ne.Percent,group:sn.Size,defaultValue:1,max:2})),this.addProperties(t,un({tweenable:!0,name:"height",type:Ne.Percent,group:sn.Size,defaultValue:1,max:2}))}canColor(e){const{isDefault:t}=this;return!t&&!this.isTweeningColor(e)}visibleCommandFiles(e){const t=[],{isDefault:i,id:s}=this,n=this.requiresAlpha(e),r=this.isTweeningColor(e);if(i&&!n)return t;const{definition:o}=this,{path:a}=o,{contentColors:c=[],containerRects:u,time:l,videoRate:h}=e;V(u,"containerRects");const d=N(l)?l.lengthSeconds:0,[p,m]=u,f={...fs,...Dr(p,m)},{width:g,height:v}=f;let[y]=c;n?y=Qt:r&&(y="#000000");let b="none";i?b=Qt:n&&(b="#000000");const w=i?f:this.intrinsicRect(),{width:F,height:x}=w,I=`width="${F}" height="${x}"`,T=Un(w,f),S=[];S.push(`<svg viewBox="0 0 ${g} ${v}" xmlns="${_t}">`),S.push(`<g ${I} transform="${T}" >`),S.push(`<rect ${I} fill="${b}"/>`),i||S.push(`<path d="${a}" fill="${y}"/>`),S.push("</g>"),S.push("</svg>");const C=S.join(""),P={};d&&(P.loop=1,P.framerate=h,P.t=d);const E={type:fe.Svg,file:s,content:C,input:!0,inputId:s,definition:o,options:P};return t.push(E),t}containerColorCommandFilters(e){const t=[],{colorFilter:i,isDefault:s}=this,{contentColors:n,containerRects:r,videoRate:o,duration:a}=e;V(n,"contentColors");const[c,u]=r,[l,h]=n,d=s?c:Dr(...r),p={videoRate:o,duration:a};i.setValue(l||Qt,"color"),i.setValue(h,`color${Yi}`),i.setValue(d.width,"width"),i.setValue(d.height,"height");const m=s;return i.setValue(m?u.width:void 0,`width${Yi}`),i.setValue(m?u.height:void 0,`height${Yi}`),t.push(...i.commandFilters(p)),t}containerCommandFilters(e,t){const i=[],{contentColors:s,commandFiles:n,filterInput:r}=e;let o=r;const a=E(s);if(this.requiresAlpha(e,!!t.size)){P(o,"container input");const{contentColors:s,...n}=e,r={...n,filterInput:o};i.push(...super.containerCommandFilters(r,t))}else if(this.isDefault||a){const{id:t}=this;o||console.log(this.constructor.name,"containerCommandFilters calling commandFilesInput",t),o||=lo(n,t,!0),P(o,"final input"),i.push(...this.containerFinalCommandFilters({...e,filterInput:o}))}return i}hasIntrinsicSizing=!0;initialCommandFilters(e,t,i=!1){const s=[],{contentColors:n,...r}=e,{commandFiles:o,upload:a,track:c,filterInput:u,containerRects:l,videoRate:h}=r;if(a)return s;let d=u;const p=this.requiresAlpha(e,!!t.size),{isDefault:m}=this,f=t.size?Dr(...l):l[0],g=Cs(f),v=`content-${c}`,y=`container-${c}`;if(!t.canColor&&C(d)&&!m)if(p){const e="format",t=vn(e),i={inputs:[d],ffmpegFilter:e,options:{pix_fmts:"yuv420p"},outputs:[t]};s.push(i),d=t}else if(!Is(g,f)){const t={...e,contentColors:[si,si],outputSize:g};s.push(...this.colorBackCommandFilters(t,`${v}-back`));const i=Zs(Zs(s).outputs);P(d,"overlay input"),s.push(...this.overlayCommandFilters(i,d)),d=Zs(Zs(s).outputs)}if(s.length?Zs(s).outputs=[v]:C(d)&&v!==d&&s.push(this.copyCommandFilter(d,c)),p){const{id:t}=this,i=lo(o,t,!0);P(i,"scale input");const n={...e,contentColors:[si,si],outputSize:f};s.push(...this.colorBackCommandFilters(n,`${y}-back`));const r=Zs(Zs(s).outputs);s.push(...this.scaleCommandFilters({...e,filterInput:i})),d=Zs(Zs(s).outputs),P(d,"overlay input"),s.push(...this.overlayCommandFilters(r,d)),d=Zs(Zs(s).outputs);const a={duration:0,videoRate:h};P(d,"crop input");const{cropFilter:c}=this;c.setValue(f.width,"width"),c.setValue(f.height,"height"),c.setValue(0,"x"),c.setValue(0,"y"),s.push(...c.commandFilters({...a,filterInput:d})),d=Zs(Zs(s).outputs),P(d,"format input");const u={inputs:[d],ffmpegFilter:"format",options:{pix_fmts:p?"yuv420p":"yuva420p"},outputs:[y]};s.push(u)}return s}intrinsicRect(e=!1){const{pathHeight:t,pathWidth:i}=this.definition;return{width:i,height:t,...fs}}isTweeningColor(e){const{contentColors:t}=e;if(!E(t))return!1;let[i,s]=t;return i!==s}isTweeningSize(e){const{containerRects:t}=e;if(!E(t))return!1;return!Us(...t)}pathElement(e){const{definition:t}=this,i=this.intrinsicRect(!0);if(!ks(i)){return Cn(e,"","")}const{path:s}=t,n=An(s,"");return Gn(n,i,e),n}requiresAlpha(e,t){const{contentColors:i}=e,s=E(i);return this.isDefault?!s&&(u(t)?t:this.isTweeningSize(e)):!s||this.isTweeningColor(e)}}function da(e){return class extends e{constructor(...e){super(...e),this.properties.push(un({name:"muted",type:Ne.Boolean}))}}}const pa=Xo(da(gr));class ma extends pa{constructor(...e){super(...e);const[t]=e,{path:i,pathHeight:s,pathWidth:n}=t;i&&(this.path=i),F(n)&&(this.pathWidth=n),F(s)&&(this.pathHeight=s)}definitionIcon(e,t){const i=super.definitionIcon(e,t);if(i)return i;const{pathHeight:s,pathWidth:n,path:r}=this,o={width:n,height:s};if(!ks(o)||!C(r))return;const a=As(o,t,!0),c={...a,...Ys(t,a)},u=An(r);return Gn(u,o,c),Promise.resolve(En(t,u))}instanceFromObject(e={}){return new ha(this.instanceArgs(e))}path="";pathHeight=0;pathWidth=0;toJSON(){const e=super.toJSON();return this.path&&(e.path=this.path),F(this.pathHeight)&&(e.pathHeight=this.pathHeight),F(this.pathWidth)&&(e.pathWidth=this.pathWidth),e}}const fa=e=>ls(e)&&"fontId"in e;function ga(e){if(!fa(e))throw new Error("expected TextContainer")}const va=Yo(ua(bn));class ya extends va{constructor(...e){const[t]=e;t.lock||="",super(...e);const{intrinsic:i}=t;qs(i)&&(this._intrinsicRect=i)}canColor(e){return!0}canColorTween(e){return!0}_colorFilter;get colorFilter(){return this._colorFilter||=Ko("color")}visibleCommandFiles(e){const t=super.visibleCommandFiles(e),{string:i}=this,s={definition:this.font,type:fe.Txt,file:this.id,content:i,inputId:this.id};return t.push(s),t}definitionIds(){return[...super.definitionIds(),this.fontId]}_font;get font(){return this._font||=Ht.fromId(this.fontId)}fileUrls(e){return this.font.fileUrls(e)}hasIntrinsicSizing=!0;initialCommandFilters(e,t){const i=[],{contentColors:s=[],outputSize:n,track:r,filterInput:o,containerRects:a,videoRate:c,commandFiles:u,duration:l}=e;let h=o;h&&i.push(this.copyCommandFilter(h,r));const[d,p]=a,{height:m,width:f}=d,g=Dr(...a);let v="";const y=!!h||t.size;if(y){const t=h?"#000000":"#00000000",s={...e,contentColors:[t,t],outputSize:g};i.push(...this.colorBackCommandFilters(s)),v=Zs(Zs(i).outputs)}const b=u.find((e=>e.inputId===this.id&&e.type===fe.Txt));_(b,"text file");const{resolved:w}=b;P(w,"textfile");const F=u.find((e=>e.inputId===this.id&&e.type===ye.Font));_(F,"font file");const{resolved:x}=F;P(x,"fontfile");const{textFilter:I,lock:T}=this,S=this.intrinsicRect(),C=S.x*(d.width/S.width),[E=Qt,V]=s;P(E);const z=S.x*(p.width/S.width),A=1e3/S.height,k=Math.round(m*A),O=Math.round(p.height*A),R={x:C,y:0,width:f,height:k,color:E,textfile:w,fontfile:x,stretch:!Ue(T),intrinsicHeight:S.height,intrinsicWidth:S.width,[`x${Yi}`]:z,[`y${Yi}`]:0,[`color${Yi}`]:V,[`height${Yi}`]:O,[`width${Yi}`]:p.width};I.setValues(R);const $={dimensions:n,videoRate:c,duration:l,filterInput:h};if(i.push(...I.commandFilters($)),y){h=Zs(Zs(i).outputs),P(h,"overlay filterInput"),i.push(...this.overlayCommandFilters(v,h)),h=Zs(Zs(i).outputs),P(h,"crop filterInput");const e={duration:0,videoRate:c,filterInput:h},{cropFilter:t}=this;t.setValue(g.width,"width"),t.setValue(g.height,"height"),t.setValue(0,"x"),t.setValue(0,"y"),i.push(...t.commandFilters(e))}return i}_intrinsicRect;intrinsicRect(e=!1){return this._intrinsicRect||=this.intrinsicRectInitialize()}intrinsicRectInitialize(){const{family:e}=this.font;P(e);const t=this.string,i={width:0,height:1e3,...fs};if(!t)return i;return xo(t,e,1e3)}intrinsicsKnown(e){const{size:t}=e;return!t||(qs(this._intrinsicRect)||!!this.font?.family)}pathElement(e){const{string:t,font:i}=this,{family:s}=i,n=globalThis.document.createElementNS(_t,"text");return n.setAttribute("font-family",s),n.setAttribute("font-size",String(1e3)),n.append(t),Gn(n,this.intrinsicRect(!0),e),n}setValue(e,t,i){if(super.setValue(e,t,i),!i)switch(t){case"fontId":delete this._font,delete this._intrinsicRect;break;case"string":delete this._intrinsicRect}}_textFilter;get textFilter(){return this._textFilter||=Ko("text")}toJSON(){const e=super.toJSON();return e.intrinsic=this.intrinsicRect(!0),e}}class ba extends bn{fileUrls(e){return this.definition.fileUrls(e)}}class wa extends gr{constructor(...e){super(...e);const[t]=e,{source:i,url:s}=t,n=i||s||"";this.source=i||n,this.url=s||n}family="";fileUrls(e){const{visible:t,editing:i}=e;if(!t)return[];const{url:s,source:n}=this,r=i?s:n;return[{type:ye.Font,file:r,definition:this}]}instanceFromObject(e={}){return new ba(this.instanceArgs(e))}loadType=ye.Font;toJSON(){const e=super.toJSON(),{url:t,source:i}=this;return e.url=t,e.source=i,e}source="";type=Te.Font;url=""}var Fa={label:"Butcherman",id:"com.moviemasher.font.butcherman",type:"font",source:"https://fonts.googleapis.com/css2?family=Butcherman"};var xa={label:"Croissant One",id:"com.moviemasher.font.croissant-one",type:"font",source:"https://fonts.googleapis.com/css2?family=Croissant+One"};var Ia={label:"League Spartan",id:"com.moviemasher.font.default",type:"font",source:"https://fonts.googleapis.com/css2?family=League+Spartan"};var Ta={label:"Germania One",id:"com.moviemasher.font.germania-one",type:"font",source:"https://fonts.googleapis.com/css2?family=Germania+One"};var Sa={label:"Kenia",id:"com.moviemasher.font.kenia",type:"font",source:"https://fonts.googleapis.com/css2?family=Kenia"};var Ca={label:"Luckiest Guy",id:"com.moviemasher.font.luckiest-guy",type:"font",source:"https://fonts.googleapis.com/css2?family=Luckiest+Guy"};var Pa={label:"Monoton",id:"com.moviemasher.font.monoton",type:"font",source:"https://fonts.googleapis.com/css2?family=Monoton"};var Ea={label:"Oleo Script",id:"com.moviemasher.font.oleo-script",type:"font",source:"https://fonts.googleapis.com/css2?family=Oleo+Script"};var Va={label:"Shojumaru",id:"com.moviemasher.font.shojumaru",type:"font",source:"https://fonts.googleapis.com/css2?family=Shojumaru"};var za={label:"Rubik+Dirt",id:"com.moviemasher.font.rubik-dirt",type:"font",source:"https://fonts.googleapis.com/css2?family=Rubik+Dirt"};const Aa=Ia.id,ka=e=>{const{id:t}=e,i=t&&C(t)?t:Aa;return new wa({...e,type:Te.Font,id:i})},_a=ka(Ia),Oa=[_a,ka(Fa),ka(xa),ka(Sa),ka(Ta),ka(Ca),ka(Pa),ka(Ea),ka(Va),ka(za)],Ra=e=>{const t=Oa.find((t=>t.id===e));return t||ka({id:e})},$a=e=>{const{definitionId:t=""}=e;return Ra(t).instanceFromObject(e)},Ma=e=>Ra(e).instanceFromObject();Ft[Te.Font]={definition:ka,definitionFromId:Ra,fromId:Ma,instance:$a,defaults:Oa};const Na=Xo(da(gr));class ja extends Na{constructor(...e){super(...e),this.properties.push(un({name:"string",custom:!0,type:Ne.String,defaultValue:"Text"})),this.properties.push(un({name:"fontId",custom:!0,type:Ne.FontId,defaultValue:_a.id})),this.properties.push(un({name:"height",tweenable:!0,custom:!0,type:Ne.Percent,defaultValue:.3,max:2,group:sn.Size})),this.properties.push(un({name:"width",tweenable:!0,custom:!0,type:Ne.Percent,defaultValue:.8,max:2,group:sn.Size}))}instanceArgs(e){const t=e||{};return o(t.lock)&&(t.lock=qe.V),super.instanceArgs(t)}instanceFromObject(e={}){return new ya(this.instanceArgs(e))}}var Da={label:"Chat",type:"container",id:"com.moviemasher.container.chat",pathWidth:24,pathHeight:24,path:"M4.929 19.071A9.969 9.969 0 0 1 2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10H2l2.929-2.929zM11 6v12h2V6h-2zM7 9v6h2V9H7zm8 0v6h2V9h-2z"};var La={label:"Broadcast",type:"container",id:"com.moviemasher.container.broadcast",pathWidth:24,pathHeight:24,path:"M4.929 2.929l1.414 1.414A7.975 7.975 0 0 0 4 10c0 2.21.895 4.21 2.343 5.657L4.93 17.07A9.969 9.969 0 0 1 2 10a9.969 9.969 0 0 1 2.929-7.071zm14.142 0A9.969 9.969 0 0 1 22 10a9.969 9.969 0 0 1-2.929 7.071l-1.414-1.414A7.975 7.975 0 0 0 20 10c0-2.21-.895-4.21-2.343-5.657L19.07 2.93zM7.757 5.757l1.415 1.415A3.987 3.987 0 0 0 8 10c0 1.105.448 2.105 1.172 2.828l-1.415 1.415A5.981 5.981 0 0 1 6 10c0-1.657.672-3.157 1.757-4.243zm8.486 0A5.981 5.981 0 0 1 18 10a5.981 5.981 0 0 1-1.757 4.243l-1.415-1.415A3.987 3.987 0 0 0 16 10a3.987 3.987 0 0 0-1.172-2.828l1.415-1.415zM12 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 2c.58 0 1.077.413 1.184.983L14.5 22h-5l1.316-7.017c.107-.57.604-.983 1.184-.983z"};var qa={label:"Music",type:"container",id:"com.moviemasher.container.music",pathWidth:24,pathHeight:24,path:"M12 13.535V3h8v2h-6v12a4 4 0 1 1-2-3.465zM10 19a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"};var Ba={label:"Test",type:"container",id:"com.moviemasher.container.test",pathWidth:1920,pathHeight:1080,path:"M 358.00 980.00 C 215.51 980.00 100.00 864.49 100.00 722.00 L 100.00 358.00 C 100.00 215.51 215.51 100.00 358.00 100.00 L 1562.00 100.00 C 1704.49 100.00 1820.00 215.51 1820.00 358.00 L 1820.00 722.00 C 1820.00 864.49 1704.49 980.00 1562.00 980.00 Z M 358.00 980.00"};var Ua={label:"Text",type:"text",id:"com.moviemasher.container.text",fontId:"com.moviemasher.font.default"};const Ga=[new ma({id:rs,...{label:"Rectangle",type:"container"}}),new ja(Ua),new ma(Da),new ma(La),new ma(qa),new ma(Ba)],Wa=e=>{const{id:t}=e;throw P(t,"containerDefinition id"),"containerDefinition"},Ja=e=>{const t=Ga.find((t=>t.id===e));return t||Wa({id:e})},Ha=e=>{const{definitionId:t}=e;if(!t)throw hn.id;return Ja(t).instanceFromObject(e)},Ka=e=>Ja(e).instanceFromObject({definitionId:e});Ft[Te.Container]={definition:Wa,definitionFromId:Ja,fromId:Ka,instance:Ha,defaults:Ga};const Ya=`${$t}content.default`,Xa=e=>ts(e)&&$e(e.type);function Za(e,i){Xa(e)||t(e,"Content",i)}const Qa=e=>ss(e)&&$e(e.type);function ec(e){return class extends e{type=Te.Content}}function tc(e){return class extends e{commandFilters(e){const t=[],{videoRate:i,filterInput:s,time:n}=e;P(s);const r=N(n)?n.lengthSeconds:0,{filters:o}=this.definition,a={videoRate:i,duration:r,filterInput:s};return t.push(...o.flatMap((e=>{this.setFilterValues(e);const t=e.commandFilters(a);return t.length&&(a.filterInput=Zs(Zs(t).outputs)),t}))),t}setFilterValues(e){const t=e.properties.map((e=>e.name));this.properties.map((e=>e.name)).filter((e=>t.includes(e))).forEach((t=>{const i=this.properties.find((e=>e.name===t));cn(i);const{tweenable:s}=i;if(e.setValue(this.value(t),t),s){const i=`${t}${Yi}`;e.setValue(this.value(i),i)}}))}svgFilters(e,t,i,s){const n=[],{filters:r}=this.definition;return n.push(...r.flatMap((e=>(this.setFilterValues(e),e.filterSvgFilter())))),n}}}const ic=tc(bn);class sc extends ic{_tweenable;get tweenable(){return this._tweenable}set tweenable(e){this._tweenable=e}selectables(){return[this,...this.tweenable.selectables()]}selectType=ie.None;selectedItems(e){return this.properties.map((t=>{const i=this.value(t.name),s=this;return{value:i,selectType:ie.None,property:t,changeHandler:(t,n)=>{P(t);const r={target:s,property:t,redoValue:n,undoValue:i};e.create(r)}}}))}}function nc(e){return class extends e{constructor(...e){super(...e);const[t]=e,{properties:i,filters:s,initializeFilter:n,finalizeFilter:r}=t;i?.length&&this.properties.push(...i.map((e=>un({...e,custom:!0})))),n&&(this.initializeFilter=Ho(n)),r&&(this.finalizeFilter=Ho(r)),s&&this.filters.push(...s.map((e=>Ho(e))))}filters=[];finalizeFilter;initializeFilter;toJSON(){const e=super.toJSON(),t=this.properties.filter((e=>e.custom));return t.length&&(e.properties=t),this.filters.length&&(e.filters=this.filters),e}}}const rc=nc(gr);class oc extends rc{constructor(...e){super(...e),this.properties.push(un({name:"label",defaultValue:""}))}instanceArgs(e){const t=super.instanceArgs(e);return t.label||=this.label,t}instanceFromObject(e={}){return new sc(this.instanceArgs(e))}type=Te.Effect}var ac={label:"Chromakey",type:"effect",id:"com.moviemasher.effect.chromakey",properties:[{name:"blend",defaultValue:0,step:.01,min:0,max:1},{name:"similarity",defaultValue:.9,step:.01,min:0,max:1},{name:"color",type:"rgb",defaultValue:"#00FF00"}],filters:[{id:"com.moviemasher.filter.chromakey",parameters:[{name:"color",value:"color",dataType:"string"},{name:"blend",value:"blend",dataType:"string"},{name:"similarity",value:"similarity",dataType:"string"}]}]};var cc={label:"Emboss",type:"effect",id:"com.moviemasher.effect.emboss",properties:[],filters:[{id:"com.moviemasher.filter.convolution",parameters:[{name:"matrix",value:"-2,-1,0,-1,1,1,0,1,2"}]}]};var uc={label:"Grayscale",type:"effect",id:"com.moviemasher.effect.grayscale",filters:[{id:"com.moviemasher.filter.colorchannelmixer",parameters:[{name:"rr",value:.3},{name:"rg",value:.4},{name:"rb",value:.3},{name:"ra",value:0},{name:"gr",value:.3},{name:"gg",value:.4},{name:"gb",value:.3},{name:"ga",value:0},{name:"br",value:.3},{name:"bg",value:.4},{name:"bb",value:.3},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]};var lc={label:"Sepia",type:"effect",id:"com.moviemasher.effect.sepia",filters:[{id:"com.moviemasher.filter.colorchannelmixer",parameters:[{name:"rr",value:.393},{name:"rg",value:.769},{name:"rb",value:.189},{name:"gr",value:.349},{name:"gg",value:.686},{name:"gb",value:.168},{name:"br",value:.272},{name:"bg",value:.534},{name:"bb",value:.131}]}]};var hc={label:"Sharpen",type:"effect",id:"com.moviemasher.effect.sharpen",properties:[],filters:[{id:"com.moviemasher.filter.convolution",parameters:[{name:"matrix",value:"0,-1,0,-1,5,-1,0,-1,0"}]}]};const dc=e=>{const{id:t}=e;return P(t),new oc({...e,type:Te.Effect})},pc=[dc({label:"Blur",type:"effect",id:"com.moviemasher.effect.blur",filters:[{id:"com.moviemasher.filter.convolution",parameters:[{name:"matrix",value:"1,1,1,1,1,1,1,1,1"},{name:"multiplier",value:"0.11"}]}]}),dc(ac),dc(cc),dc(uc),dc(lc),dc(hc)],mc=e=>{const t=pc.find((t=>t.id===e));return t||dc({id:e})},fc=e=>{const{definitionId:t=""}=e;return mc(t).instanceFromObject(e)},gc=e=>mc(e).instanceFromObject();function vc(e){return class extends e{constructor(...e){super(...e);const[t]=e,{isDefaultOrAudio:i}=this;i||(this.addProperties(t,un({name:"x",type:Ne.Percent,defaultValue:.5,group:sn.Point,tweenable:!0})),this.addProperties(t,un({name:"y",type:Ne.Percent,defaultValue:.5,group:sn.Point,tweenable:!0})),this.addProperties(t,un({name:"lock",type:Ne.String,defaultValue:qe.H,group:sn.Size})));const{effects:s}=t;s&&this.effects.push(...s.map((e=>{const t=fc(e);return t.tweenable=this,t})))}audibleCommandFiles(e){const t={...e,audible:!0,visible:!1};return this.fileCommandFiles(t)}audibleCommandFilters(e){const t=[],{time:i,quantize:s,commandFiles:n,clipTime:r}=e,o=i.isRange?i.lengthSeconds:0,a=o?Math.min(o,r.lengthSeconds):0,{id:c}=this;let u=lo(n,c,!1);const l="atrim",h=vn(l),d={},{frame:p}=this.definitionTime(i,r);a&&(d.duration=a),p&&(d.start=oa(p,s).seconds);const m={inputs:[u],ffmpegFilter:l,options:d,outputs:[h]};t.push(m),u=h;const f=1e3*(r.seconds-i.seconds);if(f){const e="adelay",i=vn(e),s={ffmpegFilter:e,options:{delays:f,all:1},inputs:[u],outputs:[i]};t.push(s),u=i}return t.push(...this.amixCommandFilters({...e,filterInput:u})),t}contentCommandFilters(e,t){return this.effectsCommandFilters(e)}contentSvgFilter(e,t,i,s,n){const{effects:r}=this;if(!r.length)return;const o=this.effects.flatMap((e=>e.svgFilters(t,i,s,n))),a=Nn(o,e);return Dn(a,"200%","width"),Dn(a,"200%","height"),a}contentRects(e){const{containerRects:t,time:i,timeRange:s,loading:n,editing:r}=e;if(n&&!this.intrinsicsKnown({editing:r,size:!0}))return I(t)?t:[t,t];const{lock:o}=this,a=this.tweenRects(i,s),c=Qr(a,o),u=this.intrinsicRect(r),l=Yr(u,t,c),[h,d]=l,p=Xr(l,t,c),[m,f]=p;return[Ws(h,m),Ws(d,f)]}contentRect(e,t,i){const s={containerRects:e,time:t,timeRange:i,editing:!0},[n]=this.contentRects(s),{x:r,y:o}=n,a={x:e.x-r,y:e.y-o};return Ws(n,a)}contentPreviewItemPromise(e,t,i,s){return this.itemPromise(e,t,i,s)}definitionIds(){return[...super.definitionIds(),...this.effects.flatMap((e=>e.definitionIds()))]}effectsCommandFilters(e){const t=[],{filterInput:i}=e;let s=i;P(s);const{effects:n}=this;return t.push(...n.flatMap((t=>{const i=t.commandFilters({...e,filterInput:s});return i.length&&(s=Zs(Zs(i).outputs)),i}))),t}effects=[];intrinsicRect(e=!1){return Gs}get isDefault(){return"com.moviemasher.content.default"===this.definitionId}get isDefaultOrAudio(){return this.isDefault||this.type===Te.Audio}itemPromise(e,t,i,s){throw new Error(hn.unimplemented)}selectedItems(e){const t=super.selectedItems(e);if(this.isDefaultOrAudio)return t;const{effects:i,selectType:s}=this,n=[...i],r=this,o={selectType:s,value:this.effects,removeHandler:t=>{const s={redoSelection:{...e.selection,effect:void 0},effects:i,undoEffects:n,redoEffects:i.filter((e=>e!==t)),type:Y.MoveEffect};e.create(s)},moveHandler:(t,s=0)=>{b(s,"index");const o=n.filter((e=>e!==t)),a=n.indexOf(t)<s?s-1:s;o.splice(a,0,t);const c={effects:i,undoEffects:n,redoEffects:o,type:Y.MoveEffect,effectable:r};e.create(c)},addHandler:(t,s=0)=>{b(s,"index");const r=[...i];r.splice(s,0,t),t.tweenable=this;const o={effects:i,undoEffects:n,redoEffects:r,redoSelection:{...e.selection,effect:t},type:Y.MoveEffect};e.create(o)}};return t.push(o),t}selectedProperty(e){const{name:t}=e,{isDefaultOrAudio:i}=this;switch(t){case"effects":case"lock":case"width":case"height":case"x":case"y":return!i}return super.selectedProperty(e)}toJSON(){const e=super.toJSON();return e.effects=this.effects,e}}}Ft[Te.Effect]={definition:dc,definitionFromId:mc,fromId:gc,instance:fc,defaults:pc};const yc=e=>Xa(e)&&"color"in e,bc=vc(ua(bn));class wc extends bc{constructor(...e){super(...e);const[t]=e;this.addProperties(t,un({tweenable:!0,name:"color",type:Ne.Rgb,defaultValue:this.definition.color,group:sn.Color}))}_colorFilter;get colorFilter(){return this._colorFilter||=Ko("color")}contentColors(e,t){const[i,s]=this.tweenValues("color",e,t);P(i);return[i,C(s)?s:i]}contentPreviewItemPromise(e,t,i,s){const{colorFilter:n}=this,[r]=this.tweenValues("color",t,i),{x:o,y:a,width:c,height:u}=e;n.setValues({width:c,height:u,color:r});const l=n.filterSvg();return l.setAttribute("x",String(o)),l.setAttribute("y",String(a)),Promise.resolve(l)}}const Fc=ec(da(gr));class xc extends Fc{constructor(...e){super(...e);const[t]=e,{color:i}=t;C(i)&&(this.color=i)}color="#000000";instanceFromObject(e={}){return new wc(this.instanceArgs(e))}}const Ic=[new xc({...{label:"Color",type:"color",id:"com.moviemasher.content.default",color:"#FFFFFF"},id:Ya})],Tc=e=>{const{id:t}=e;throw P(t,"contentDefinition id"),"contentDefinition"},Sc=e=>{const t=Ic.find((t=>t.id===e));return t||Tc({id:e})},Cc=e=>{const{definitionId:t}=e;if(!t)throw hn.id;return Sc(t).instanceFromObject(e)},Pc=e=>Sc(e).instanceFromObject({definitionId:e});Ft[Te.Content]={definition:Tc,definitionFromId:Sc,fromId:Pc,instance:Cc,defaults:Ic};class Ec{addSource(e,t){this.sourcesById.set(e,t)}_context;get context(){if(!this._context){const e=AudioContext||window.webkitAudioContext;if(!e)throw hn.audibleContext;this._context=new e}return this._context}createBuffer(e){const t=44100*e;return this.context.createBuffer(2,t,44100)}createBufferSource(e){const t=this.context.createBufferSource();return e&&(t.buffer=e),t}createGain(){return this.context.createGain()}get currentTime(){return this.context.currentTime}decode(e){return new Promise(((t,i)=>this.context.decodeAudioData(e,(e=>t(e)),(e=>i(e)))))}deleteSource(e){const t=this.getSource(e);if(!t)return;this.sourcesById.delete(e);const{gainSource:i,gainNode:s}=t;s.disconnect(this.destination),i.disconnect(s),i.stop()}get destination(){return this.context.destination}getSource(e){return this.sourcesById.get(e)}hasSource(e){return this.sourcesById.has(e)}sourcesById=new Map;startAt(e,t,i,s,n,r=!1){const o=this.createGain();t.loop=r,t.connect(o),o.connect(this.destination),t.start(this.currentTime+i,n,s),this.addSource(e,{gainSource:t,gainNode:o})}}const Vc=new Ec,zc={audible:()=>new Ec},Ac=e=>i(e)&&"mashObject"in e&&"definitionObjects"in e,kc=e=>i(e)&&"composition"in e;function _c(e,i){kc(e)||t(e,"Mash",i)}class Oc extends Xi{constructor(e){super();const{createdAt:t,id:i,icon:s,preloader:n,quantize:r}=e;n&&(this._preloader=n),C(i)&&(this._id=i),C(s)&&(this.icon=s),C(t)&&(this.createdAt=t),F(r)&&(this.quantize=r),this.properties.push(un({name:"label",type:Ne.String,defaultValue:""})),this.properties.push(un({name:"color",type:Ne.Rgb,defaultValue:"#000000"})),this.propertiesInitialize(e)}get buffer(){throw new Error(hn.unimplemented+"get buffer")}set buffer(e){throw new Error(hn.unimplemented+"set buffer")}createdAt="";data={};dataPopulate(e){const t=this.properties.map((e=>e.name));Object.entries(e).forEach((([e,i])=>{t.find((t=>t===e))||(this.data[e]=i)}))}destroy(){}_editor;get editor(){return this._editor}set editor(e){this._editor=e}_emitter;get emitter(){return this._emitter}set emitter(e){this._emitter=e,this.emitterChanged()}emitterChanged(){}editedGraphFiles(e){return[]}icon="";_id="";get id(){return this._id||=gn()}set id(e){this._id=e,this.emitter?.emit(tt.Save)}_imageSize={...Ts};get imageSize(){return this._imageSize}set imageSize(e){_s(e),this._imageSize=e}loadPromise(e){throw hn.unimplemented}get loading(){return!1}get mashes(){throw hn.unimplemented}_preloader;get preloader(){return this._preloader}putPromise(){throw new Error(hn.unimplemented)}quantize=ca.mash.quantize;reload(){}selectables(){return[]}selectType=ie.None;selectedItems(e){return[]}svgItems(e){throw hn.unimplemented}toJSON(){const e=super.toJSON();return e.createdAt=this.createdAt,e.quantize=this.quantize,e.id=this.id,this.icon&&(e.icon=this.icon),Object.entries(this.data).forEach((([t,i])=>{o(e[t])&&(e[t]=i)})),e}}const Rc=e=>Qi(e),$c=e=>es(e)&&"contentId"in e;function Mc(e,i){$c(e)||t(e,"Clip",i)}const Nc=e=>i(e)&&"frameForClipNearFrame"in e;function jc(e,i){Nc(e)||t(e,"Track",i)}const Dc=e=>Qa(e)&&"loadType"in e;function Lc(e){if(!Dc(e))throw new Error("expected PreloadableDefinition")}const qc=e=>Xa(e)&&Dc(e.definition);function Bc(e){if(!qc(e))throw new Error("expected Preloadable")}function Uc(e){return class extends e{constructor(...e){super(...e);const[t]=e,{source:i,url:s,bytes:n,mimeType:r}=t,o=i||s||"";this.source=i||o,this.url=s||o,n&&(this.bytes=n),r&&(this.mimeType=r)}bytes=0;loadType;mimeType="";source;toJSON(){const e=super.toJSON();return this.url&&(e.url=this.url),this.source&&(e.source=this.source),this.bytes&&(e.bytes=this.bytes),this.mimeType&&(e.mimeType=this.mimeType),e}url}}function Gc(e){return class extends e{}}const Wc=[Te.Image,Te.Video,Te.VideoSequence],Jc=e=>qc(e);function Hc(e){Jc(e)||t(e,"UpdatableSize")}const Kc=e=>Ce(e)&&Wc.includes(e),Yc=e=>Dc(e);function Xc(e){Yc(e)||t(e,"UpdatableSizeDefinition")}function Zc(e){return class extends e{constructor(...e){super(...e);const[t]=e,{container:i}=t,s=i?0:1;this.addProperties(t,un({tweenable:!0,name:"width",type:Ne.Percent,group:sn.Size,defaultValue:1,max:2,min:s})),this.addProperties(t,un({tweenable:!0,name:"height",type:Ne.Percent,group:sn.Size,defaultValue:1,max:2,min:s}))}colorMaximize=!0;containerCommandFilters(e,t){const i=[],{commandFiles:s,containerRects:n,filterInput:r,videoRate:o,track:a}=e;let c=r;const u=t.size?Dr(...n):n[0],l={...e,contentColors:[si,si],outputSize:u};i.push(...this.colorBackCommandFilters(l,`container-${a}-back`));const h=Zs(Zs(i).outputs),{id:d}=this,p=lo(s,d,!0);i.push(...this.scaleCommandFilters({...e,filterInput:p})),c=Zs(Zs(i).outputs),t.size&&(P(c,"overlay input"),i.push(...this.overlayCommandFilters(h,c)),c=Zs(Zs(i).outputs));const m={duration:0,videoRate:o};P(c,"crop input");const{cropFilter:f}=this;return f.setValue(u.width,"width"),f.setValue(u.height,"height"),f.setValue(0,"x"),f.setValue(0,"y"),i.push(...f.commandFilters({...m,filterInput:c})),c=Zs(Zs(i).outputs),t.size||(P(c,"overlay input"),i.push(...this.overlayCommandFilters(h,c)),c=Zs(Zs(i).outputs)),P(c,"alphamerge input"),i.push(...this.alphamergeCommandFilters({...e,filterInput:c})),c=Zs(Zs(i).outputs),i.push(...this.containerFinalCommandFilters({...e,filterInput:c})),i}containerPreviewItemPromise(e,t,i,s){return this.itemPromise(e,t,i,s)}contentCommandFilters(e,t){const i=[],{containerRects:s,visible:n,time:r,videoRate:o,clipTime:a,commandFiles:c,filterInput:u,track:l,upload:h}=e;if(!n)return i;j(a),V(s,"containerRects");const{id:d}=this;let p=u||lo(c,d,n);const m={containerRects:s,time:r,timeRange:a},f=this.contentRects(m),g=!Us(...s),[v,y]=f,b=N(r)?r.lengthSeconds:0,w=g?Dr(...s):s[0],F=`content-${l}-back`;if(!h){const t={...e,contentColors:["#000000","#000000"],outputSize:w};i.push(...this.colorBackCommandFilters(t,F))}const x={...e,filterInput:p,containerRects:f};if(i.push(...this.scaleCommandFilters(x)),h)return i;p=Zs(Zs(i).outputs),t.size&&(i.push(...this.overlayCommandFilters(F,p)),p=Zs(Zs(i).outputs));const I={duration:b,videoRate:o},{cropFilter:T}=this;return T.setValue(w.width,"width"),T.setValue(w.height,"height"),T.setValue(v.x,"x"),T.setValue(v.y,"y"),T.setValue(y.x,`x${Yi}`),T.setValue(y.y,`y${Yi}`),i.push(...T.commandFilters({...I,filterInput:p})),p=Zs(Zs(i).outputs),t.size||(i.push(...this.overlayCommandFilters(F,p)),p=Zs(Zs(i).outputs)),i.push(...super.contentCommandFilters({...e,filterInput:p},t)),i}hasIntrinsicSizing=!0;iconUrl(e,t,i){return this.definition.url}initialCommandFilters(e,t,i=!1){const s=[],{filterInput:n,track:r}=e;return i&&(P(n),s.push(this.copyCommandFilter(n,r))),s}intrinsicRect(e=!1){const t=e?"previewSize":"sourceSize",{[t]:i}=this.definition;_s(i,t);return{...fs,...i}}intrinsicsKnown(e){const{editing:t,size:i}=e;if(!i)return!0;const s=t?"previewSize":"sourceSize",{[s]:n}=this.definition;return ks(n)}itemIconPromise(e,t,i,s){const{clip:n}=this,{preloader:r}=n.track.mash,o=this.iconUrl(Ms(e),t,i),a=fr("image",o),c=fr("svg",a,{...e}),u=s?this.definition:void 0;return r.loadPromise(c,u)}itemPreviewPromise(e,t,i){return this.itemIconPromise(e,t,i,!0)}itemPromise(e,t,i,s){const{container:n}=this,r=n?e:this.contentRect(e,t,i);return s?this.itemIconPromise(r,t,i):this.itemPreviewPromise(r,t,i).then((e=>(In(e,r),e)))}}}function Qc(e){return class extends e{constructor(...e){super(...e);const[t]=e,{sourceSize:i,previewSize:s}=t;ks(s)&&(this.previewSize=s),ks(i)&&(this.sourceSize=i)}previewSize;sourceSize;toJSON(){const e=super.toJSON(),{sourceSize:t,previewSize:i}=this;return t&&(e.sourceSize=this.sourceSize),i&&(e.previewSize=this.previewSize),e}}}const eu=[Te.Audio,Te.Video,Te.VideoSequence],tu=e=>qc(e)&&"startOptions"in e;function iu(e,i){tu(e)||t(e,"Updatable",i)}const su=e=>Ce(e)&&eu.includes(e),nu=e=>Dc(e)&&"audibleSource"in e;function ru(e,i){nu(e)||t(e,"UpdatableDefinition",i)}function ou(e){return class extends e{constructor(...e){super(...e);const[t]=e,{gain:i}=t;if(d(i))if(n(i))if(i.includes(",")){const e=i.split(",").map((e=>parseFloat(e))),t=e.length/2;for(let i=0;i<t;i+=1)this.gainPairs.push([e[2*i],e[2*i+1]]);this.gain=-1}else this.gain=Number(i);else y(i)&&(this.gain=i)}definitionTime(e,t){const i=super.definitionTime(e,t),{startTrim:s,endTrim:n,definition:r}=this,{duration:o}=r,a=aa(o,t.fps).frame-(s+n),c=i.frame%a;return i.withFrame(c+s).divide(this.speed)}frames(e){const{definition:t,startTrim:i,endTrim:s}=this;return t.frames(e)-(i+s)}gain=1;gainPairs=[];fileUrls(e){const{editing:t,audible:i,time:s}=e;if(!i||t&&!s.isRange)return[];if(!this.mutable()||this.muted)return[];const{definition:n}=this,r=n.urlAudible(t);return[{type:ye.Audio,file:r,definition:n,input:!0}]}hasGain(){if(0===this.gain)return!0;if(y(this.gain))return!1;if(2!==this.gainPairs.length)return!1;const[e,t]=this.gainPairs;if(2!==e.length)return!1;if(2!==t.length)return!1;if(Math.max(...e))return!1;const[i,s]=t;return 1===i&&0===s}hasIntrinsicTiming=!0;initialCommandFilters(e,t,i=!1){const s=[],{time:n,quantize:r,commandFiles:o,clipTime:a,videoRate:c,duration:u}=e,{id:l}=this;let h=lo(o,l,!0);P(h,"filterInput");const d="trim",p=vn(d),m={};u&&(m.duration=u);const{frame:f}=this.definitionTime(n,a);f&&(m.start=oa(f,r).seconds);const g={inputs:[h],ffmpegFilter:d,options:m,outputs:[p]};if(s.push(g),h=p,u){const e="fps",t=vn(e),i={ffmpegFilter:e,options:{fps:c},inputs:[h],outputs:[t]};s.push(i),h=t}const v="setpts",y={ffmpegFilter:v,options:{expr:"PTS-STARTPTS"},inputs:[h],outputs:[vn(v)]};return s.push(y),s}intrinsicsKnown(e){if(!super.intrinsicsKnown(e))return!1;const{duration:t}=e;return!t||F(this.definition.duration)}mutable(){return this.definition.audio}selectedProperty(e){const{name:t}=e;return"gain"===t?this.mutable()&&!this.muted:super.selectedProperty(e)}setValue(e,t,i){if(super.setValue(e,t,i),!i)switch(t){case"startTrim":case"endTrim":case"speed":this.clip.resetTiming(this)}}startOptions(e,t){let i=t.withFrame(this.startTrim).seconds,s=t.seconds-e,n=t.lengthSeconds;return s<0&&(i-=s,n+=s,s=0),{start:s,offset:i,duration:n}}toJSON(){const e=super.toJSON(),{speed:t,gain:i}=this;return 1!==t&&(e.speed=t),1!==i&&(e.gain=i),e}_trimFilter;get trimFilter(){return this._trimFilter||=Ko("trim")}}}function au(e){return class extends e{constructor(...e){super(...e);const[t]=e,{audioUrl:i,audio:s,loop:n,duration:r,waveform:o,loadedAudio:a}=t;(s||i||a)&&(this.audio=!0,C(i)&&(this.audioUrl=i),o&&(this.waveform=o),a&&(this.loadedAudio=a)),F(r)&&(this.duration=r),n&&(this.loop=n,this.properties.push(un({name:"loops",defaultValue:1}))),this.properties.push(un({name:"gain",defaultValue:1,type:Ne.Percent,min:0,max:2,step:.01})),this.properties.push(un({name:"speed",defaultValue:1,type:Ne.Percent,min:.1,max:2,step:.1,group:sn.Timing})),this.properties.push(un({name:"startTrim",defaultValue:0,type:Ne.Frame,step:1,min:0,group:sn.Timing})),this.properties.push(un({name:"endTrim",defaultValue:0,type:Ne.Frame,step:1,min:0,group:sn.Timing}))}audibleSource(e){const{loadedAudio:t}=this;if(t)return Vc.createBufferSource(t);const{audioUrl:i}=this;if(!C(i))return void(this.audio=!1);const s=e.getCache(fr("audio",i));if(!s)return;const{error:n,result:r}=s;return n||!Yn(r)?(this.audio=!1,void(this.audioUrl="")):(this.loadedAudio=r,Vc.createBufferSource(r))}audio=!1;audioUrl="";duration=0;frames(e){const{duration:t}=this;return t?aa(this.duration,e,"floor").frame:ut.Unknown}loadedAudio;loop=!1;toJSON(){const e=super.toJSON(),{duration:t,audio:i,loop:s,waveform:n,audioUrl:r,url:o}=this;return t&&(e.duration=t),i&&(e.audio=i),s&&(e.loop=s),n&&(e.waveform=n),o?e.url=o:r&&(e.audioUrl=r),e}urlAudible(e=!1){return e?this.audioUrl||this.url:this.source}waveform}}class cu{constructor(e){const{buffer:t,gain:i,preloader:s}=e;y(i)&&(this.gain=i),F(t)&&(this.buffer=t),this.preloader=s}adjustClipGain(e,t){const i=e.timeRange(t);this.clipSources(e).forEach((e=>{this.adjustSourceGain(e,i)}))}adjustSourceGain(e,t){const i=Vc.getSource(e.id);if(!i)return;const{gainNode:s}=i;if(0===this.gain)return void(s.gain.value=0);const n=e.gain;if(y(n))return void(s.gain.value=this.gain*n);const r=N(t)?e.startOptions(this.seconds,t):t,{start:o,duration:a}=r;s.gain.cancelScheduledValues(0),e.gainPairs.forEach((e=>{const[t,i]=e;s.gain.linearRampToValueAtTime(this.gain*i,o+t*a)}))}buffer=ca.mash.buffer;bufferClips(e,t){return!!this.createSources(e,t)&&(this.destroySources(e),!0)}bufferSource;clear(){}clipSources(e){const t=[],{container:i,content:s}=e;return tu(i)&&!i.muted&&t.push(i),tu(s)&&!s.muted&&t.push(s),t}createSources(e,t,i){if(!this.playing&&!i)return!1;const s=e.filter((e=>!this.playingClips.includes(e)));if(!s.length)return!0;let n=!0;return s.forEach((e=>{const s=this.clipSources(e),r=e.timeRange(t),o=s.filter((e=>!Vc.hasSource(e.id)));n&&=o.every((e=>{const t=this.playing?this.seconds:i?.seconds||0,s=e.startOptions(t,r),{start:n,duration:o,offset:a}=s;if(y(n)&&F(o)){const{definition:t,id:i}=e;ru(t);const r=t.audibleSource(this.preloader);if(!r)return!!n;const{loop:c}=t;Vc.startAt(i,r,n,o,a,c),this.adjustSourceGain(e,s)}else console.error(this.constructor.name,"createSources",s);return!0}))})),this.playingClips.push(...s),n}destroySources(e=[]){[...this.playingClips].filter((t=>!e.includes(t))).forEach((e=>{this.clipSources(e).forEach((e=>Vc.deleteSource(e.id)))})),this.playingClips=e}gain=ca.mash.gain;setGain(e,t){this.gain!==e&&(this.gain=e,this.playing&&this.playingClips.forEach((e=>this.adjustClipGain(e,t))))}playing=!1;playingClips=[];preloader;get seconds(){return Vc.currentTime-this.contextSecondsWhenStarted+this.startedMashAt}startContext(){if(this.bufferSource)throw hn.internal+"bufferSource startContext";if(this.playing)throw hn.internal+"playing";const e=Vc.createBuffer(this.buffer);this.bufferSource=Vc.createBufferSource(e),this.bufferSource.loop=!0,this.bufferSource.connect(Vc.destination),this.bufferSource.start(0)}startPlaying(e,t,i){if(!this.bufferSource)throw hn.internal+"bufferSource startPlaying";if(this.playing)throw hn.internal+"playing";const{seconds:s}=e;return this.playing=!0,this.startedMashAt=s,this.contextSecondsWhenStarted=Vc.currentTime,!!this.createSources(t,i,e)||(this.stopPlaying(),!1)}startedMashAt=0;contextSecondsWhenStarted=0;stopContext(){this.bufferSource&&(this.bufferSource.stop(),this.bufferSource.disconnect(Vc.destination),delete this.bufferSource)}stopPlaying(){this.playing&&(this.playing=!1,this.destroySources(),this.startedMashAt=0,this.contextSecondsWhenStarted=0)}}const uu="BACKCOLOR",lu="SILENCE";class hu{constructor(e){const{upload:t,mash:i,background:s,size:n,time:r,streaming:o,videoRate:a,visible:c}=e;_c(i),this.mash=i,this.time=r,this.videoRate=a,this.background=s,this.upload=t,console.log(this.constructor.name,"upload",e.upload),this.size=n,c&&(this.visible=!0),o&&(this.streaming=!0),_(F(this.videoRate),"videoRate"),_(this.time.fps===this.quantize,"time is in mash rate")}_id;get id(){return this._id||=vn("filtergraph")}get avType(){return this.visible?te.Video:te.Audio}background;get commandFilterVisible(){const{duration:e,videoRate:t,background:i,size:s}=this;console.log(this.constructor.name,this.id,"commandFilterVisible size",s);const n={ffmpegFilter:"color",options:{color:i||"#00000000",rate:t,size:`${s.width}x${s.height}`},inputs:[],outputs:["BACKCOLOR"]};return e&&(n.options.duration=e),n}get commandFilterAudible(){const{duration:e}=this,t={ffmpegFilter:"aevalsrc",options:{exprs:0,duration:e},inputs:[],outputs:["SILENCE"]};return e&&(t.options.duration=e),t}_clips;get clips(){return this._clips||=this.clipsInitialize}get clipsInitialize(){const{time:e,mash:t,avType:i}=this;return t.clipsInTimeOfType(e,i).sort(bo)}get commandInputs(){return this.inputCommandFiles.map((e=>{const{options:t}=e;return{source:this.preloader.key(e),options:t}}))}_commandFiles;get filterGraphCommandFiles(){return this._commandFiles||=this.commandFilesInitialize}get commandFilesInitialize(){const{time:e,videoRate:t,quantize:i,size:s,clips:n,visible:r,preloader:o}=this,a=n.flatMap((n=>{const o=n.timeRange(i),a={time:e,quantize:i,visible:r,outputSize:s,videoRate:t,clipTime:o};return n.clipCommandFiles(a)}));return a.forEach((e=>{e.resolved=o.key(e)})),a}get commandFilters(){const e=[],{time:t,quantize:i,size:s,clips:n,visible:r,videoRate:o,filterGraphCommandFiles:a,upload:c}=this;console.log(this.constructor.name,"commandFilters upload",c);const u={videoRate:o,time:t,quantize:i,visible:r,outputSize:s,commandFiles:a,chainInput:"",clipTime:na(t),track:0,upload:c};r?c||(e.push(this.commandFilterVisible),u.chainInput="BACKCOLOR"):(e.push(this.commandFilterAudible),u.chainInput="SILENCE");const{length:l}=n;return n.forEach(((t,s)=>{u.clipTime=t.timeRange(i),u.track=s,e.push(...t.commandFilters(u));const n=Zs(e);s<l-1&&(n.outputs.length||n.outputs.push(vn("clip"))),u.chainInput=Zs(n.outputs)})),e}get duration(){return this.time.lengthSeconds}get inputCommandFiles(){return this.filterGraphCommandFiles.filter((e=>e.input))}mash;get preloader(){return this.mash.preloader}get quantize(){return this.mash.quantize}size;streaming=!1;time;upload;visible=!1;videoRate}class du{args;constructor(e){this.args=e;const{avType:t,times:i,mash:s,...n}=e;console.log(this.constructor.name,"upload",e.upload);const{length:r}=i;if(!r)return void(this.time=oa());const[o]=i,a=[],c=[],u=[];if(i.forEach((e=>{u.push(e.fps),a.push(e.frame),e.isRange&&c.push(e.timeRange.end)})),c.length){const e=Math.max(...u);if(e!==Math.min(...u))throw hn.internal+"timeranges fps";const t=Math.min(...a),i=Math.max(...c);this.time=ia(t,e,i)}else _(1===r,"just one time"),this.time=o;if(t!==te.Video){_(1===r||t!==te.Audio,"single time for avtype audio");const e={...n,time:this.time,mash:s,visible:!1};this.filterGraphAudible=new hu(e)}t!==te.Audio&&this.filterGraphsVisible.push(...i.map((e=>{const t={...n,time:e,mash:s,visible:!0};return new hu(t)})))}assureDuration(){}assureSize(){}get duration(){return this.time.lengthSeconds}filterGraphsVisible=[];filterGraphAudible;get filterGraphVisible(){return this.filterGraphsVisible[0]}_graphFiles;get fileUrls(){const e=[...this.filterGraphsVisible];return this.filterGraphAudible&&e.push(this.filterGraphAudible),this._graphFiles||=e.flatMap((e=>e.filterGraphCommandFiles))}get graphFilesInput(){return this.fileUrls.filter((e=>e.input))}get loadPromise(){return this.args.mash.preloader.loadFilesPromise(this.fileUrls)}time}const pu=8,mu=2;class fu{args;constructor(e){this.args=e}get clip(){return this.args.clip}get container(){return this.clip.container}get editor(){return this.preview.editor}get icon(){return!!this.args.icon}get id(){return this.clip.id}pointerDown(){const e={...fs},{editor:t,container:i,timeRange:s,rect:n,clip:r}=this,{rect:o}=t,a=()=>{globalThis.window.removeEventListener("pointermove",l),globalThis.window.removeEventListener("pointermove",u),globalThis.window.removeEventListener("pointerup",c),globalThis.window.removeEventListener("pointerup",h)},c=e=>{ho(e),a(),t.dragging=!1,t.redraw()},u=r=>{ho(r);const{offE:a,offN:c,offS:u,offW:l}=i,{x:h,y:d,width:p,height:m}=n;let f=o.width-p,g=o.height-m,v=0,y=0;a&&(v-=p,f+=p),l&&(f+=p),c&&(y-=m,g+=m),u&&(g+=m);const{clientX:b,clientY:w}=r,F=b-o.x,x=w-o.y,I=e.x-o.x,T=x-(e.y-o.y-d),S=io(F-(I-h),v,v+f),C=io(T,y,y+g),P=to(i),{lastTime:E}=s,V=t.time.equalsTime(E),z=P&&V,A=z?`x${Yi}`:"x",k=z?`y${Yi}`:"y",_={[A]:i.value(A),[k]:i.value(k)},O={[A]:f?S/f:_[A],[k]:g?C/g:_[k]},R={property:sn.Point,target:i,type:Y.ChangeMultiple,redoValues:O,undoValues:_};t.actions.create(R)},l=n=>{ho(n);const{clientX:r,clientY:o}=n;if(!ms({x:r,y:o},e)){if(to(i)){const{time:e}=t,i=e.closest(s);if(!e.equalsTime(i))return a(),void t.goToTime(i)}t.dragging=!0,globalThis.window.removeEventListener("pointermove",l),globalThis.window.addEventListener("pointermove",u),u(n)}},h=i=>{if(ho(i),!(i instanceof PointerEvent))return;const{clientX:s,clientY:n}=i;e.x=s,e.y=n,globalThis.window.addEventListener("pointermove",l),globalThis.window.addEventListener("pointerup",c),t.selection.clip!==r&&t.selection.set(r)};return h}get preview(){return this.args.preview}get quantize(){return this.preview.quantize}_rect;get rect(){return this._rect||this.rectInitialize}get rectInitialize(){const{time:e,timeRange:t,clip:i,size:s}=this;_s(s,`${this.constructor.name}.rectInitialize size`);const n={size:s,time:e,timeRange:t,editing:!0},r=i.rects(n);return _(Us(...r)),r[0]}get size(){return this.preview.size}editingSvgItem(e,t){const{container:i,rect:s}=this,n=i.pathElement(s);return n.setAttribute("vector-effect","non-scaling-stroke"),Ln(n,e),t||n.addEventListener("pointerdown",this.pointerDown()),n}svgBoundsElement(e,t){const i=[],{rect:s,container:n}=this,{directions:r}=n,{width:o,height:a,x:c,y:u}=s,l={x:c-1,y:u-1,width:o,height:2};i.push(Cn(l,e)),l.y=u+a-1,i.push(Cn(l,e)),l.x=c+o-1,l.height=a,l.width=2,l.y=u,i.push(Cn(l,e)),l.x=c-1,i.push(Cn(l,e));const h={width:o,height:a};return r.forEach((s=>{const n=this.svgHandlePoint(h,s),r={x:c+n.x,y:u+n.y,width:8,height:8},o=Cn(r,[...e,s.toLowerCase()]);i.push(o),t||o.addEventListener("pointerdown",(e=>{console.log("pointerdown",s),this.editor.selection.set(this.clip),ho(e)}))})),i}svgHandlePoint(e,t){const{width:i,height:s}=e,n={...fs},[r,o]=String(t).split("");He(r,t);const a=o||r;switch(He(a),a){case Ge.W:n.x=-4;break;case Ge.E:n.x=i-4;break;default:n.x=Math.round(i/2)-4}switch(r){case Ge.N:n.y=-4;break;case Ge.S:n.y=s-4;break;default:n.y=Math.round(s/2)-4}return n}get time(){return this.preview.time}_timeRange;get timeRange(){return this._timeRange||=this.clip.timeRange(this.quantize)}}class gu{constructor(e){const{selectedClip:t,editor:s,time:n,mash:r,background:o,onlyClip:a,size:c}=e;this.mash=r,this.size=c||r.imageSize,this.time=n,this.background=o,this.selectedClip=t,this.onlyClip=a,i(s)&&(this.editor=s)}audible=!1;background;_clips;get clips(){return this._clips||=this.clipsInitialize}get clipsInitialize(){const{mash:e,time:t,onlyClip:i}=this;return i?[i]:e.clipsInTimeOfType(t,te.Video).sort(bo)}combine=!1;get duration(){return this.time.lengthSeconds}get editing(){return i(this.editor)}editor;get intrinsicSizePromise(){const{clips:e,preloader:t}=this,i={editing:!0,size:!0},s=e.filter((e=>!e.intrinsicsKnown(i))).flatMap((e=>e.intrinsicGraphFiles(i)));return t.loadFilesPromise(s)}get itemsPromise(){const{clips:e,size:t,time:i,onlyClip:s}=this;let n=Promise.resolve([]);const r=!!s;return e.forEach((e=>{n=n.then((s=>e.previewItemsPromise(t,i,r).then((e=>[...s,e]))))})),n}mash;onlyClip;get preloader(){return this.mash.preloader}get quantize(){return this.mash.quantize}size;selectedClip;streaming=!1;_svgItems;time;_trackPreviews;get trackPreviews(){return this._trackPreviews||=this.trackPreviewsInitialize}get trackPreviewsInitialize(){const e=[],{time:t,quantize:i,clips:s}=this,n=t.isRange?void 0:t.scale(i);return s.forEach((s=>{const r=s.timeRange(i).scale(t.fps),o=Math.max(0,t.frame-r.frame),a=r.withFrame(o),c={clip:s,preview:this,tweenTime:n,timeRange:a,icon:!!this.onlyClip};e.push(new fu(c))})),e}get svgItemPromise(){return this.svgItemsPromise.then((e=>{const{length:t}=e;if(1===t)return e[0];const{size:i}=this,s=En(i);return e.forEach((e=>s.appendChild(e))),s}))}get svgItemsPromise(){if(this._svgItems)return Promise.resolve(this._svgItems);return this.intrinsicSizePromise.then((()=>this.itemsPromise.then((e=>this._svgItems=this.tupleItems(e)))))}tupleItems(e){const{clips:t,size:i,editing:n,background:r,selectedClip:o,editor:a}=this,c=[...e];if(r){const e=Cn(i,"",r),t=En(i,e);c.unshift(t)}if(!n||!t.length)return c;s(a);const{dragging:u}=a,{trackPreviews:l}=this,h=l.find((e=>e.clip===o)),d=l.map((e=>{const t=["outline"];return u||e===h||t.push("animate"),e.editingSvgItem(t)}));if(c.push(En(i,d)),!h)return c;const p=["bounds","back"];return c.push(En(i,h.svgBoundsElement(p))),p[1]="fore",c.push(En(i,h.svgBoundsElement(p,!0))),c}visible=!0}const vu=e=>Xa(e)&&tu(e),yu=e=>Wt(e)&&e.type===Te.Audio;class bu extends bn{constructor(...e){super(...e);const[t]=e,{container:i,content:s}=t;this.containerInitialize(i||{}),this.contentInitialize(s||{})}assureTimingAndSizing(e,t,i){const{timing:s,sizing:n,containerId:r}=this;let o=s!==e,a=n!==t;return o||=i.hasIntrinsicTiming,a||=i.hasIntrinsicSizing,o||(e===lt.Content&&r?this.timing=lt.Container:this.timing=lt.Custom),a||(t===dt.Content&&r?this.sizing=dt.Container:this.sizing=dt.Preview),!(a&&o)}get audible(){return this.mutable}clipFileUrls(e){const t=[],{quantize:i}=e,{content:s,container:n,frames:r}=this;return F(r)&&(e.clipTime||=this.timeRange(i)),n&&t.push(...n.fileUrls(e)),t.push(...s.fileUrls(e)),t}clipIcon(e,t,i=1){const{container:s}=this;if(!s)return;const{track:n}=this,{quantize:r,imageSize:o}=n.mash;_s(o,"track.mash.imageSize");const a=Cs(As(o,e,!0));_s(a,`${this.constructor.name}.clipIcon containedSize`);const c=a.width+i,u=Math.ceil(e.width/c),l=this.timeRange(r),{startTime:h}=l,d=[],{mash:p}=n;let m=0;for(let e=0;e<u;e++){const{copy:e}=h,i=new gu({mash:p,time:e,onlyClip:this,size:a});d.push(i),m+=c,h.frame=l.frame+Er(m,t,"floor")}let f=Promise.resolve([]);return d.forEach((e=>{f=f.then((t=>e.svgItemPromise.then((e=>[...t,e]))))})),f.then((t=>{const i={...fs},s=En(e);return t.forEach((e=>{In(e,i),On(s,e),i.x+=c})),s}))}clipCommandFiles(e){const t=[],{visible:i,quantize:s,outputSize:n,time:r}=e,o=this.timeRange(s),{content:a,container:c}=this,u={...e,clipTime:o};if(i){_s(n),hs(c);const e={size:n,time:r,timeRange:o,loading:!0},i=this.rects(e);u.containerRects=i;const s=yc(a)?a.contentColors(r,o):void 0,l={...u,outputSize:n,contentColors:s,containerRects:i};if(!s){const e=a.visibleCommandFiles(l);t.push(...e)}const h=c.visibleCommandFiles(l);t.push(...h)}else _(!i,"outputSize && container"),t.push(...this.content.audibleCommandFiles(u));return t}commandFilters(e){const t=[],{visible:i,quantize:s,outputSize:n,time:r}=e,o=this.timeRange(s),a={...e,clipTime:o},{content:c,container:u}=this;if(!i)return this.content.audibleCommandFilters(a);_s(n),hs(u);const l={size:n,time:r,timeRange:o},h=this.rects(l);a.containerRects=h;const d={point:!ms(...h),size:!Is(...h)},p=yc(c)?c.contentColors(r,o):void 0,m=E(p);m&&(d.color=p[0]!==p[1],d.canColor=d.color?u.canColorTween(e):u.canColor(e));const f=r.isRange?r.lengthSeconds:0,g=f?Math.min(f,o.lengthSeconds):0,v={...a,contentColors:p,outputSize:n,containerRects:h,duration:g};return m?d.canColor||(t.push(...u.containerColorCommandFilters(v)),v.filterInput=Zs(Zs(t).outputs)):(t.push(...c.commandFilters(v,d)),v.filterInput=Zs(Zs(t).outputs)),t.push(...u.commandFilters(v,d,!0)),t}_container;get container(){return this._container||this.containerInitialize()}containerInitialize(e={}){const{containerId:t}=this,i=t||e.definitionId;if(!C(i))return;const s=Ht.fromId(i),n={...e,definitionId:i,container:!0},r=s.instanceFromObject(n);return hs(r),this.assureTimingAndSizing(lt.Container,dt.Container,r),r.clip=this,this.timing===lt.Container&&this._track&&this.resetTiming(r),this._container=r}_content;get content(){return this._content||this.contentInitialize()}contentInitialize(e={}){const{contentId:t}=this,i=t||e.definitionId;P(i);const s=Ht.fromId(i),n={...e,definitionId:i},r=s.instanceFromObject(n);if(Za(r),this.assureTimingAndSizing(lt.Content,dt.Content,r)){const{container:e}=this;e&&this.assureTimingAndSizing(lt.Container,dt.Container,e)}return r.clip=this,this.timing===lt.Content&&this._track&&this.resetTiming(r),this._content=r}copy(){const e={...this.toJSON(),id:""};return this.definition.instanceFromObject(e)}definitionIds(){const e=[...super.definitionIds(),...this.content.definitionIds()];return this.container&&e.push(...this.container.definitionIds()),e}get endFrame(){return this.frame+this.frames}endTime(e){return oa(this.endFrame,e)}intrinsicsKnown(e){const{content:t,container:i}=this;let s=t.intrinsicsKnown(e);return i&&(s&&=i.intrinsicsKnown(e)),s}intrinsicGraphFiles(e){const{content:t,container:i}=this,s=[];return t.intrinsicsKnown(e)||s.push(t.intrinsicGraphFile(e)),i&&!i.intrinsicsKnown(e)&&s.push(i.intrinsicGraphFile(e)),s}maxFrames(e,t){return 0}get mutable(){const{content:e}=this;if(e.mutable())return!0;const{container:t}=this;if(!t)return!1;return t.mutable()}get notMuted(){const{content:e,muted:t}=this;if(t)return!1;if(e.mutable()&&!e.muted)return!0;const{container:i}=this;return!i?.mutable()||!i.muted}previewItemsPromise(e,t,i){_s(e);const n=this.timeRange(this.track.mash.quantize),r=t||n.startTime,{container:o,content:a}=this;hs(o);const c={size:e,time:r,timeRange:n,editing:!0},u=this.rects(c);_(Us(...u));const[l]=u;return o.containerPreviewItemPromise(l,r,n,i).then((t=>{const c=[t];let u=mn();const h=Jc(o),d=Jc(a)&&!i;if(h&&!i){const e=Cn(l,"","transparent",u);e.setAttribute("vector-effect","non-scaling-stroke;"),c.push(e),u=mn()}return t.setAttribute("id",u),a.contentPreviewItemPromise(l,r,n,i).then((i=>{s(i);const p=xn();On(p,[Cn(l,"","transparent"),i]);const m=[p];Ln(p,"contained");const f=kn(void 0,p,true);c.push(f);const g=qn(u);f.appendChild(g),h||(t.setAttribute("vector-effect","non-scaling-stroke;"),g.setAttribute("fill",Qt));const v=o.containerSvgFilter(t,e,l,r,n);v?c.push(v):t.removeAttribute("filter");const y=a.contentSvgFilter(i,e,l,r,n);y?c.push(y):i.removeAttribute("filter");const b=d?this.svgElement:En();return Jn(b,[$n(c),...m]),In(b,e),b}))}))}rectIntrinsic(e,t,i){const s={...e,...fs},{sizing:n}=this;if(t||n===dt.Preview)return s;const r=n===dt.Container?this.container:this.content;if(is(r),!r.intrinsicsKnown({editing:i,size:!0}))return s;return r.intrinsicRect(i)}rects(e){const{size:t,loading:i,editing:s}=e,n=this.rectIntrinsic(t,i,s),{container:r}=this;return hs(r),r.containerRects(e,n)}resetTiming(e,t){const{timing:i}=this,s=this._track;switch(i){case lt.Custom:if(y(this.frames))break;this.frames=ca.duration*(t||s.mash.quantize);break;case lt.Container:{const i=ls(e)?e:this.container;if(!i)break;this.frames=i.frames(t||s.mash.quantize);break}case lt.Content:{const i=Xa(e)?e:this.content;if(!i)break;this.frames=i.frames(t||s.mash.quantize);break}}}selectType=ie.Clip;selectables(){return[this,...this.track.selectables()]}selectedItems(e){const t=[],{properties:i}=this;return i.filter((e=>this.selectedProperty(e))).forEach((i=>{const{name:s}=i,n="frames"===s||"frame"===s,r=this.value(s),o=this;t.push({value:r,selectType:ie.Clip,property:i,changeHandler:(t,i)=>{P(t);const s={property:t,target:o,redoValue:i,undoValue:r,type:n?Y.ChangeFrame:Y.Change};e.create(s)}})})),t}selectedProperty(e){const{name:t,type:i}=e;switch(i){case Ne.ContainerId:case Ne.ContentId:return!1}switch(t){case"sizing":return!vu(this.content);case"timing":if(this.content.hasIntrinsicTiming)break;return!!this.container?.hasIntrinsicSizing;case"frame":return!this.track.dense;case"frames":return this.timing===lt.Custom}return!0}setValue(e,t,i){switch(super.setValue(e,t,i),t){case"containerId":this._container&&this.containerInitialize(this._container.toJSON());break;case"contentId":this._content&&this.contentInitialize(this._content.toJSON())}}_svgElement;get svgElement(){return this._svgElement||=En()}updateSvg(e){In(this.svgElement,e)}time(e){return oa(this.frame,e)}timeRange(e){const{frame:t,frames:i}=this;return b(t,"timeRange frame"),x(i,"timeRange frames"),ia(this.frame,e,this.frames)}timeRangeRelative(e,t){const i=this.timeRange(t).scale(e.fps),s=Math.max(0,e.frame-i.frame);return e.withFrame(s)}toJSON(){const e=super.toJSON(),{container:t,content:i}=this;return e.content=i,e.contentId=i.definitionId,t?(e.container=t,e.containerId=t.definitionId):e.containerId="",e}toString(){return`[Clip ${this.label}]`}_track;get track(){return this._track}set track(e){this._track=e}get trackNumber(){const{track:e}=this;return e?e.index:-1}set trackNumber(e){e<0&&delete this._track}get visible(){return!!this.containerId}}class wu extends gr{constructor(...e){super(...e),this.properties.push(un({name:"containerId",type:Ne.ContainerId,defaultValue:rs})),this.properties.push(un({name:"contentId",type:Ne.ContentId,defaultValue:Ya})),this.properties.push(un({name:"label",type:Ne.String})),this.properties.push(un({name:"sizing",type:Ne.Sizing,defaultValue:dt.Content})),this.properties.push(un({name:"timing",type:Ne.Timing,defaultValue:lt.Content,group:sn.Timing})),this.properties.push(un({type:Ne.Frame,group:sn.Timing,defaultValue:ut.None,min:0,step:1})),this.properties.push(un({name:"frames",type:Ne.Frame,defaultValue:ut.Unknown,min:1,step:1,group:sn.Timing}))}audible=!1;instanceArgs(e={}){const t=super.instanceArgs(e),{containerId:i,contentId:s}=t,n=o(s)||s===Ya;let r=o(i)||i===rs;return t.sizing===dt.Content&&n&&(t.sizing=dt.Container),t.sizing===dt.Container&&r&&(t.sizing=dt.Preview),t.timing===lt.Content&&n&&(t.timing=lt.Container),t.timing===lt.Container&&r&&(t.timing=lt.Custom),t}instanceFromObject(e={}){return new bu(this.instanceArgs(e))}streamable=!1;type=Te.Clip;visible=!1}const Fu=new wu({label:"Visible",type:"visible",id:"com.moviemasher.clip.default",containerId:"com.moviemasher.container.default",contentId:"com.moviemasher.content.default"}),xu=Fu.id,Iu=[Fu],Tu=e=>{const{id:t}=e;return P(t),new wu({...e,type:Te.Clip})},Su=e=>{const t=Iu.find((t=>t.id===e));return t||Tu({id:e})},Cu=(e={})=>{const{definitionId:t=xu}=e;if(!t)throw hn.id;return Su(t).instanceFromObject(e)},Pu=e=>Su(e).instanceFromObject({definitionId:e});Ft[Te.Clip]={definition:Tu,definitionFromId:Su,fromId:Pu,instance:Cu,defaults:Iu};class Eu extends Xi{constructor(e){super();const{clips:t,index:i,dense:s}=e;y(i)&&(this.index=i),this.dense=d(s)?!!s:!this.index,this.properties.push(un({name:"dense",defaultValue:!1})),this.propertiesInitialize(e),t&&this.clips.push(...t.map((e=>{const t=Cu(e);return t.track=this,t})))}addClips(e,t=0){let i=t||0;this.dense||(i=0);const s=i,n=this.clips.filter(((t,n)=>{const r=e.includes(t);return s&&r&&n<s&&(i-=1),!r}));n.splice(i,0,...e),this.sortClips(n),Qs(this.clips,n)}assureFrame(e){const t=e||this.clips;let i=!1,s=0;const n=[],{dense:r}=this;return t.forEach((e=>{const{frame:t}=e;(r?t!==s:n.some((e=>e.includes(t))))&&(i=!0,e.frame=s),s=e.frame+e.frames,r||n.push(e.timeRange(1))})),i}assureFrames(e,t){const i=d(t);(t||this.clips).forEach((t=>{const{frames:s}=t;F(s)||(t.resetTiming(void 0,e),!F(t.frames)&&i&&(t.frames=Math.floor(ca.duration*e)))}))}clips=[];dense=!1;frameForClipNearFrame(e,t=0){if(this.dense)return t;const i=this.clips.filter((i=>e!==i&&i.endFrame>t));if(!i.length)return t;const s=e.frame,n=e.endFrame-s;let r=t;return i.find((e=>{if(e.frame>=r+n)return!0;r=e.endFrame})),r}get frames(){const{clips:e}=this,{length:t}=e;if(!t)return ut.None;for(const t of e){const{frames:e}=t;switch(e){case ut.Unknown:case ut.Unlimited:return e}}const i=Zs(e),{frame:s,frames:n}=i;return s+n}_identifier;get identifier(){return this._identifier||=vn("track")}index=0;_mash;get mash(){const{_mash:e}=this;return _c(e),e}set mash(e){this._mash=e}removeClips(e){const t=this.clips.filter((t=>!e.includes(t)));_(t.length!==this.clips.length),e.forEach((e=>e.trackNumber=-1)),this.sortClips(t),Qs(this.clips,t)}selectType=ie.Track;selectables(){return[this,...this.mash.selectables()]}selectedItems(e){return this.properties.map((t=>{const i=this.value(t.name),s=this;return{value:i,property:t,selectType:ie.Track,changeHandler:(t,n)=>{P(t);const r={target:s,property:t,redoValue:n,undoValue:i};e.create(r)}}}))}sortClips(e){const t=e||this.clips,i=this.assureFrame(t);return t.sort(vo),i}toJSON(){const e=super.toJSON();return e.clips=this.clips,e}}const Vu=e=>new Eu(e),zu={instance:Vu};class Au extends gu{get clips(){return[]}}class ku extends Oc{constructor(e){super(e);const{createdAt:t,icon:i,id:s,label:n,frame:r,preloader:o,rendering:a,tracks:c,...u}=e;this.dataPopulate(u),C(a)&&(this._rendering=a),C(t)&&(this.createdAt=t),F(r)&&(this._frame=r),E(c)&&c.forEach(((e,t)=>{const i={dense:!t,...e,index:t},s=Vu(i);s.mash=this,s.assureFrames(this.quantize),s.sortClips(),this.tracks.push(s)})),this.assureTrack(),this.tracks.sort(yo),this._preview=new Au({mash:this,time:oa()})}addClipToTrack(e,t=0,i=0,s){const n=I(e)?e:[e],r=this.trackClips(n,t);this.emitIfFramesChange((()=>{r.forEach((e=>{const[t,n]=e,r=this.tracks[t];jc(r,"track"),n.forEach((e=>{const i=e.trackNumber;y(i)&&i!==t&&e.track.removeClips([e]),y(s)&&(e.frame=s),e.track=r})),r.assureFrames(this.quantize,n),r.addClips(n,i)}))}))}addTrack(e={}){y(e.index)||(e.index=this.tracks.length);const t=Vu(e);return t.mash=this,this.tracks.push(t),this.tracks.sort(yo),this.emitter?.emit(tt.Track),t}assureTrack(){if(!this.tracks.length){const e=Vu({dense:!0});e.mash=this,this.tracks.push(e)}}_buffer=ca.mash.buffer;get buffer(){return this._buffer}set buffer(e){if(!F(e))throw hn.invalid.argument+"buffer "+e;this._buffer!==e&&(this._buffer=e,this._composition&&(this.composition.buffer=e))}bufferStart(){this._bufferTimer||(this._bufferTimer=setInterval((()=>{if(this._paused)return;this.loadPromiseUnlessBuffered({editing:!0,audible:!0});const e=this.clipsAudibleInTime(this.timeToBuffer);this.composition.bufferClips(e,this.quantize)}),Math.round(1e3*this.buffer/2)))}bufferStop(){this._bufferTimer&&(clearInterval(this._bufferTimer),delete this._bufferTimer)}_bufferTimer;changeTiming(e,t,i){this.emitIfFramesChange((()=>{e.setValue(i,t)}))}clearDrawInterval(){this.drawInterval&&(clearInterval(this.drawInterval),this.drawInterval=void 0)}clearPreview(){delete this._preview}clipIntersects(e,t){return!e.frames||e.timeRange(this.quantize).intersects(t)}get clips(){return this.tracks.map((e=>e.clips)).flat()}clipsAudibleInTime(e){const{clips:t}=this,i=t.filter((e=>e.mutable&&e.notMuted));return this.filterIntersecting(i,e)}clipsInTime(e){return this.filterIntersecting(this.clips,e)}clipsInTimeOfType(e,t=te.Both){switch(t){case te.Both:return this.clipsInTime(e);case te.Audio:return this.clipsAudibleInTime(e);case te.Video:return this.clipsVisibleInTime(e)}}get clipsVisible(){return this.clips.filter((e=>e.container))}clipsVisibleInTime(e){return this.filterIntersecting(this.clipsVisible,e)}compositeVisible(e){this.drawingTime=e,this.clearPreview(),this.emitter?.emit(tt.Draw)}compositeVisibleRequest(e){requestAnimationFrame((()=>{this.compositeVisible(e)}))}_composition;get composition(){if(!this._composition){const e={buffer:this.buffer,gain:this.gain,preloader:this.preloader};this._composition=new cu(e)}return this._composition}get definitionIds(){const{clips:e}=this,t=e.flatMap((e=>e.definitionIds()));return[...new Set(t)]}destroy(){this.paused=!0,this.clearDrawInterval()}draw(){const{time:e}=this;this.compositeVisible(e)}drawInterval;drawRequest(){const{time:e}=this;this.compositeVisibleRequest(e)}drawTime(e){const t=e!==this.time;this.drawnTime=e,this.drawRequest(),this.emitter?.emit(t?tt.Time:tt.Loaded)}drawWhilePlayerNotPlaying(){const e=performance.now();if(e-this.drawnSeconds<1/this.quantize)return;this.drawnSeconds=e;const{time:t}=this;if(!this.clipsVisibleInTime(t).filter((e=>e.definition.streamable)).length)return;this.graphFilesUnloaded({time:t,editing:!0,visible:!0}).length||this.drawRequest()}drawingTime;drawnSeconds=0;drawnTime;get duration(){return this.endTime.seconds}emitIfFramesChange(e){const t=this.frames;e();const{frames:i}=this;t!==i&&(this.emitter?.emit(tt.Duration),this.frame>i&&this.seekToTime(oa(i,this.quantize)))}get endTime(){return oa(this.frames,this.quantize)}filterGraphs(e={}){const{background:t,time:i,avType:s,graphType:n,size:r,videoRate:o,...a}=e,c=i||this.time,u=s||(c.isRange?te.Both:te.Video),l={...a,times:this.timeRanges(u,c),avType:u,graphType:n||ot.Mash,size:r||this.imageSize,videoRate:o||c.fps,mash:this,background:t||this.color};return console.log(this.constructor.name,"filterGraphs filterGraphsOptions",l.upload,e.upload),new du(l)}filterIntersecting(e,t){const i=t.scale(this.quantize);return e.filter((e=>this.clipIntersects(e,i)))}_frame=0;get frame(){return this.time.scale(this.quantize,"floor").frame}get frames(){const{tracks:e}=this;if(e.length){const e=this.tracks.map((e=>e.frames));return y(Math.min(...e))?Math.max(0,...e):ut.Unknown}return ut.None}_gain=ca.mash.gain;get gain(){return this._gain}set gain(e){if(!y(e))throw hn.invalid.argument+"gain "+e;this._gain!==e&&(this._gain=e,this._composition&&this.composition.setGain(e,this.quantize))}graphFileOptions(e={}){const{time:t,audible:i,visible:s,editing:n,streaming:r}=e,o=t||this.time,{isRange:a}=o,c=s||!a,u=a&&i,l={editing:n,streaming:r,audible:u,visible:c,time:o,quantize:this.quantize};return _(c||u,"audible || visible"),l}editedGraphFiles(e){const t=this.graphFileOptions(e),{time:i,audible:s,visible:n}=t,{quantize:r}=this;M(i);const o=i.scale(this.quantize),a=s&&n?te.Both:s?te.Audio:te.Video;return this.clipsInTimeOfType(o,a).flatMap((e=>{const s=e.timeRange(r),n={...t,clipTime:s,quantize:r,time:i};return e.clipFileUrls(n)}))}graphFilesUnloaded(e){const t=this.editedGraphFiles(e);if(!t.length)return[];const{preloader:i}=this;return t.filter((e=>!i.loadedFile(e)))}handleDrawInterval(){const{seconds:e}=this.composition,t=this.time.withFrame(this.time.frame);if(e>=this.endTime.seconds)this.loop?this.seekToTime(this.time.withFrame(0)):(this.paused=!0,this.emitter?.emit(tt.Ended));else if(e>=t.seconds){const t=aa(e,this.time.fps);this.drawTime(t)}}_layer;get layer(){return this._layer}set layer(e){this._layer=e}loadPromise(e={}){return this.loadPromiseUnlessBuffered(e)||Promise.resolve()}loadingPromises=[];get loading(){return!!this.loadingPromises.length}loadPromiseUnlessBuffered(e={}){e.time||=this.timeToBuffer;const t=this.graphFilesUnloaded(e);if(!t.length)return;const i=this.preloader.loadFilesPromise(t),s=i.then((()=>{const e=this.loadingPromises.indexOf(i);if(e<0)throw hn.internal+"couldn't find promise~";this.loadingPromises.splice(e,1)}));return this.loadingPromises.push(i),s}loop=!1;get mashes(){return[this]}_paused=!0;get paused(){return this._paused}set paused(e){const t=e||!this.frames;if(this._paused!==t)if(this._paused=t,t)this.playing=!1,this.bufferStop(),this._bufferTimer&&(clearInterval(this._bufferTimer),delete this._bufferTimer),this.composition.stopContext(),this.emitter?.emit(tt.Pause);else{this.composition.startContext(),this.bufferStart();const e=this.loadPromiseUnlessBuffered({editing:!0,audible:!0,visible:!0});e?e.then((()=>{this.playing=!0})):this.playing=!0,this.emitter?.emit(tt.Play)}}_playing=!1;get playing(){return this._playing}set playing(e){if(this._playing!==e)if(this._playing=e,e){const{quantize:e,time:t}=this,i=this.clipsAudibleInTime(this.timeToBuffer);if(!this.composition.startPlaying(t,i,e)){const i=this.clipsAudibleInTime(this.timeToBuffer);if(!this.composition.startPlaying(t,i,e))return void(this._playing=!1)}this.emitter?.emit(tt.Playing),this.setDrawInterval()}else this.composition.stopPlaying(),this.clearDrawInterval()}_preview;preview(e){return this._preview||=this.previewInitialize(e)}previewInitialize(e){return new gu(this.previewArgs(e))}previewArgs(e={}){const{editor:t}=e,i=t?.selection.clip,s=$c(i)?i:void 0,{drawingTime:n,time:r,quantize:a}=this,c={selectedClip:s,time:(n||r).scale(a),mash:this,...e};return o(e.background)&&(c.background=this.color),c}putPromise(){const{quantize:e,preloader:t}=this,i=this.clips.flatMap((t=>{const{container:i}=t;if(fa(i)&&!i.intrinsicsKnown({editing:!0,size:!0})){const s={editing:!0,visible:!0,quantize:e,time:t.time(e),clipTime:t.timeRange(e)};return i.fileUrls(s)}return[]}));return t.loadFilesPromise(i)}removeClipFromTrack(e){const t=I(e)?e:[e];this.emitIfFramesChange((()=>{t.forEach((e=>{e.track.removeClips([e])}))}))}removeTrack(e){const t=y(e)?e:this.tracks.length-1;b(t),this.emitIfFramesChange((()=>{this.tracks.splice(t,1)})),this.emitter?.emit(tt.Track)}_rendering="";get rendering(){return this._rendering}set rendering(e){this._rendering=e,this.emitter?.emit(tt.Render)}restartAfterStop(e,t,i){e.equalsTime(this.time)&&(i&&(delete this.seekTime,this.emitter?.emit(tt.Seeked)),this.drawTime(e),t||(this.playing=!0))}reload(){return this.stopLoadAndDraw()}seekTime;seekToTime(e){return this.seekTime!==e&&(this.seekTime=e,this.emitter?.emit(tt.Seeking),this.emitter?.emit(tt.Time)),this.stopLoadAndDraw(!0)}selectType=ie.Mash;selectables(){const e=[this];return this._layer&&e.push(...this.layer.selectables()),e}selectedItems(e){return this.properties.map((t=>{const i=this.value(t.name),s=this;return{value:i,selectType:ie.Mash,property:t,changeHandler:(t,n)=>{P(t);const r={property:t,target:s,redoValue:n,undoValue:i};e.create(r)}}}))}setDrawInterval(){this.drawInterval||(this.clearDrawInterval(),this.drawInterval=setInterval((()=>{this.handleDrawInterval()}),500/this.time.fps))}stopLoadAndDraw(e){const{time:t,paused:i,playing:s}=this;s&&(this.playing=!1);const n=this.loadPromiseUnlessBuffered({editing:!0,visible:!0,audible:s});if(n)return n.then((()=>{this.restartAfterStop(t,i,e)}));this.restartAfterStop(t,i,e)}svgItems(e){return this.preview(e).svgItemsPromise}get time(){return this.seekTime||this.drawnTime||oa(this._frame,this.quantize)}get timeRange(){const{endTime:e,time:t}=this,i=e.scale(t.fps);return na(t,i.frame)}timeRanges(e,t){const i=t||this.time,{quantize:s}=this,n=i.scale(this.quantize,"floor"),r=n.isRange?n.timeRange.endTime:void 0,o=this.clipsInTimeOfType(i,e),{length:a}=o;if(!a)return[];if(1===a||!n.isRange||e===te.Audio)return[i];const c=new Set;o.forEach((e=>{c.add(Math.max(e.frame,n.frame)),c.add(Math.min(e.frame+e.frames,r.frame))}));const u=[...c].sort(((e,t)=>e-t));let l=u.shift();return u.map((e=>{const t=ia(l,s,e-l);return l=e,t}))}get timeToBuffer(){const{time:e,quantize:t,buffer:i,paused:s}=this;return s?oa(e.scale(t,"floor").frame,t):ra(e,aa(i+e.seconds,e.fps))}toJSON(){const e=super.toJSON();return e.tracks=this.tracks,this._rendering&&(e.rendering=this.rendering),e}trackClips(e,t){if(y(t))return[[t,e]];let i=this.tracks.length-e.length;return e.map((e=>[i++,[e]]))}tracks=[]}const _u=(e={})=>new ku(e),Ou=e=>e instanceof ku;function Ru(e){if(!Ou(e))throw new Error("expected MashClass")}class $u extends Xi{constructor(e){super(),this.properties.push(un({name:"label",type:Ne.String})),this.propertiesInitialize(e)}_cast;get cast(){return this._cast}set cast(e){this._cast=e}_id;get id(){return this._id||=vn("layer")}get mashes(){throw hn.unimplemented+"mashes"}selectType=ie.Layer;selectables(){return[this,...this.cast.selectables()]}selectedItems(e){return this.properties.map((t=>{const i=this.value(t.name),s=this;return{value:i,selectType:ie.Layer,property:t,changeHandler:(t,n)=>{P(t);const r={property:t,target:s,redoValue:n,undoValue:i};e.create(r)}}}))}toJSON(){const e=super.toJSON();return e.type=this.type,e.triggers=this.triggers,e}triggers=[];type}class Mu extends $u{constructor(e){super(e);const{label:t,layers:i,collapsed:s}=e;t||(this.label=ca.label),this.collapsed=s,this.layers=i}collapsed;layers;get mashes(){return this.layers.flatMap((e=>e.mashes))}toJSON(){const e=super.toJSON();return e.layers=this.layers,e.collapsed=this.collapsed,e}type=W.Folder}const Nu=["top","right","bottom","left","top right","bottom right","bottom left","top left"];class ju extends $u{constructor(e){super(e);const{mash:t}=e;console.log("LayerMashClass",this.label,t.label),this.label||(this.label=t.label),this.mash=t,t.layer=this}get mashes(){return[this.mash]}mash;toJSON(){const e=super.toJSON();return e.mash=this.mash,e}type=W.Mash}const Du=e=>i(e)&&"type"in e&&H(e.type),Lu=e=>Du(e)&&e.type===W.Folder,qu=e=>Du(e)&&e.type===W.Mash;W.Folder,W.Mash;const Bu=(e,t)=>{const{preloader:i}=e;e.layers||=[];const s={...e,layers:e.layers.map((e=>Gu({preloader:i,...e})))};return new Mu(s)},Uu=(e,t)=>{const{preloader:i}=e;e.mash||={};const s=_u({preloader:i,...e.mash}),n={...e,mash:s};return new ju(n)},Gu=(e,t)=>{if(qu(e))return Uu(e);if(Lu(e))return Bu(e);throw new Error("expected LayerObject")},Wu=e=>e instanceof $u;function Ju(e){if(!Wu(e))throw"expected Layer"}const Hu=e=>e instanceof ju;function Ku(e){if(!Hu(e))throw"expected LayerMash"}const Yu=e=>e instanceof Mu;function Xu(e){if(!Yu(e))throw"expected LayerFolder"}const Zu=e=>e.flatMap((e=>Yu(e)?[e,...Zu(e.layers)]:[])),Qu=(e,t)=>t===G.After?e+1:e,el=(e,t)=>{if(t.includes(e))return;return Zu(t).find((t=>t.layers.includes(e)))};class tl extends Oc{constructor(e){super(e);const{createdAt:t,icon:i,id:s,label:n,definitions:r,layers:o,preloader:a,...c}=e;this.dataPopulate(c),E(o)&&this.layers.push(...o.map((e=>this.createLayer(e))))}addLayer(e,t={}){const{layers:i,index:s}=((e,t)=>{const{layer:i,position:s=G.At}=t,n=f(s),r=!!i,o=r&&Yu(i),a=n?s:0;if(!r||n)return{index:a,layers:o?i.layers:e};if(o&&s===G.At)return{index:0,layers:i.layers};const c=el(i,e);if(!c)return{index:a,layers:e};const{layers:u}=c,l=u.indexOf(i);if(l<0)throw new Error(hn.internal);return{layers:u,index:Qu(l,s)}})(this.layers,t);i.splice(s,0,e)}_buffer=ca.cast.buffer;get buffer(){return this._buffer}set buffer(e){if(!F(e))throw hn.invalid.argument+"buffer "+e;this._buffer!==e&&(this._buffer=e,this.mashes.forEach((t=>{t.buffer=e})))}createLayer(e){const{preloader:t}=this,i={preloader:t,...e},s=Gu(i);return Ju(s),s.cast=this,s}destroy(){this.mashes.forEach((e=>e.destroy()))}emitterChanged(){this.mashes.forEach((e=>e.emitter=this.emitter))}editedGraphFiles(e){return this.mashes.flatMap((t=>t.editedGraphFiles(e)))}get imageSize(){return super.imageSize}set imageSize(e){super.imageSize=e;const{imageSize:t}=this;this.mashes.forEach((e=>{e.imageSize=t}))}layers=[];get layerFolders(){return Zu(this.layers)}loadPromise(e){return Promise.all(this.mashes.map((t=>t.loadPromise(e)))).then(kt)}get loading(){return this.mashes.some((e=>e.loading))}get mashes(){return this.layers.flatMap((e=>e.mashes))}moveLayer(e,t){const i=this.removeLayer(e);return this.addLayer(e,t),i}putPromise(){return Promise.all(this.mashes.map((e=>e.putPromise()))).then(kt)}reload(){}removeLayer(e){const t=el(e,this.layers),i=t?.layers||this.layers,s=i.indexOf(e);if(s<0)throw console.error("removeLayer",s,i.length,e.label,t?.label),new Error(hn.internal);return i.splice(s,1),{position:s,layer:t}}selectType=ie.Cast;selectables(){return[this]}selectedItems(e){return this.properties.map((t=>{const i=this.value(t.name),s=this;return{value:i,selectType:ie.Cast,property:t,changeHandler:(t,n)=>{P(t);const r={property:t,target:s,redoValue:n,undoValue:i};e.create(r)}}}))}setValue(e,t,i){if(super.setValue(e,t,i),!i&&"color"===t)this.mashes.forEach((s=>s.setValue(e,t,i)))}svgItems(e){const{mashes:t,imageSize:i}=this,s=[],{background:n=this.color}=e,r={...e,color:""},o=Cn(i,"",n);let a=Promise.resolve([o]);return en(t).forEach((e=>{a=a.then((t=>(s.push(...t),e.svgItems(r))))})),a.then((e=>(s.push(...e),s)))}toJSON(){const e=super.toJSON();return e.layers=this.layers,e}}const il=(e={},t)=>{const i={...e,preloader:t};return new tl(i)},sl=e=>e instanceof tl;function nl(e){if(!sl(e))throw new Error("expected Cast")}const rl=e=>kc(e)||sl(e);function ol(e){rl(e)||t(e,"Edited")}class al{constructor(e){const{redoSelection:t,type:i,undoSelection:s}=e;this.redoSelection=t,this.type=i,this.undoSelection=s}get cast(){const{cast:e}=this.redoSelection;if(sl(e))return e;const{cast:t}=this.undoSelection;return nl(t),t}done=!1;get mash(){const{mash:e}=this.redoSelection;if(kc(e))return e;const{mash:t}=this.undoSelection;return _c(t),t}redo(){this.redoAction(),this.done=!0}redoAction(){throw hn.unimplemented+"redoAction"}redoSelection;get selection(){return this.done?this.redoSelection:this.undoSelection}type;undo(){this.undoAction(),this.done=!1}undoAction(){throw hn.unimplemented+"undoAction"}undoSelection}const cl=e=>e instanceof al;function ul(e){if(!cl(e))throw new Error("expected Action")}const ll=e=>cl(e.action),hl=t=>e(t)&&t.detail;class dl extends al{constructor(e){super(e);const{createTracks:t}=e;this.createTracks=t}createTracks;redoAction(){for(let e=0;e<this.createTracks;e+=1)this.mash.addTrack()}undoAction(){for(let e=0;e<this.createTracks;e+=1)this.mash.removeTrack()}}class pl extends dl{constructor(e){super(e);const{clips:t,insertIndex:i,trackIndex:s,redoFrame:n,undoFrame:r}=e;this.clips=t,this.insertIndex=i,this.trackIndex=s,this.redoFrame=n,this.undoFrame=r}clips;insertIndex;trackIndex;get track(){return this.mash.tracks[this.trackIndex]}redoAction(){super.redoAction();const{mash:e,redoFrame:t,trackIndex:i,insertIndex:s,clips:n}=this;e.addClipToTrack(n,i,s,t)}redoFrame;undoAction(){const{mash:e,clips:t}=this;e.removeClipFromTrack(t),super.undoAction()}undoFrame}class ml extends al{constructor(e){super(e);const{effect:t,effects:i,index:s}=e;this.effect=t,this.effects=i,this.index=s}effect;effects;index;redoAction(){this.effects.splice(this.index,0,this.effect)}undoAction(){this.effects.splice(this.index,1)}}const fl=e=>i(e)&&"target"in e&&"property"in e;class gl extends al{constructor(e){super(e);const{property:t,redoValue:i,target:s,undoValue:n}=e;this.property=t,this.redoValue=i,this.target=s,this.undoValue=n}property;redoValue;target;undoValue;get redoValueNumeric(){return Number(this.redoValue)}get undoValueNumeric(){return Number(this.undoValue)}redoAction(){this.target.setValue(this.redoValue,this.property)}undoAction(){this.target.setValue(this.undoValue,this.property)}updateAction(e){const{redoValue:t}=e;this.redoValue=t,this.redo()}}const vl=e=>e instanceof gl;function yl(e){if(!vl(e))throw new Error("expected ChangeAction")}class bl extends gl{constructor(e){super(e)}redoAction(){this.mash.changeTiming(this.target,this.property,this.redoValueNumeric)}undoAction(){this.mash.changeTiming(this.target,this.property,this.undoValueNumeric)}}class wl extends dl{constructor(e){super(e);const{clip:t,insertIndex:i,redoFrame:s,trackIndex:n,undoFrame:r,undoInsertIndex:o,undoTrackIndex:a}=e;this.clip=t,this.insertIndex=i,this.redoFrame=s,this.trackIndex=n,this.undoFrame=r,this.undoInsertIndex=o,this.undoTrackIndex=a}clip;insertIndex;trackIndex;undoTrackIndex;undoInsertIndex;undoFrame;redoFrame;addClip(e,t,i){this.mash.addClipToTrack(this.clip,e,t,i)}redoAction(){super.redoAction(),this.addClip(this.trackIndex,this.insertIndex,this.redoFrame)}undoAction(){this.addClip(this.undoTrackIndex,this.undoInsertIndex,this.undoFrame),super.undoAction()}}class Fl extends al{constructor(e){super(e);const{effects:t,redoEffects:i,undoEffects:s}=e;this.effects=t,this.redoEffects=i,this.undoEffects=s}effects;redoEffects;redoAction(){this.effects.splice(0,this.effects.length,...this.redoEffects)}undoAction(){this.effects.splice(0,this.effects.length,...this.undoEffects)}undoEffects}class xl extends al{constructor(e){super(e);const{clip:t,index:i,track:s}=e;this.clip=t,this.index=i,this.track=s}track;clip;index;get trackIndex(){return this.track.index}redoAction(){this.mash.removeClipFromTrack(this.clip)}undoAction(){this.mash.addClipToTrack(this.clip,this.trackIndex,this.index)}}class Il extends al{constructor(e){super(e);const{layerAndPosition:t}=e;t&&(this.layerAndPosition=t)}layerAndPosition;get layer(){const{layer:e}=this.redoSelection;return Ju(e),e}redoAction(){this.cast.addLayer(this.layer,this.layerAndPosition)}undoAction(){this.cast.removeLayer(this.layer)}}class Tl extends al{get layer(){const{layer:e}=this.redoSelection;return Ju(e),e}layerAndPosition;redoAction(){this.layerAndPosition=this.cast.removeLayer(this.layer)}undoAction(){this.cast.addLayer(this.layer,this.layerAndPosition)}}class Sl extends Il{get layer(){const{layer:e}=this.redoSelection;return Ju(e),e}undoLayerAndPosition;redoAction(){this.undoLayerAndPosition=this.cast.moveLayer(this.layer,this.layerAndPosition)}undoAction(){this.cast.moveLayer(this.layer,this.undoLayerAndPosition)}}class Cl extends gl{constructor(e){const{redoValues:t,undoValues:i}=e;super(e),this.undoValues=i,this.redoValues=t}redoAction(){const{target:e,redoValues:t}=this;Object.entries(t).forEach((([t,i])=>{e.setValue(i,t)}))}redoValues;undoAction(){const{target:e,undoValues:t}=this;Object.entries(t).forEach((([t,i])=>{e.setValue(i,t)}))}updateAction(e){const{redoValues:t}=e;this.redoValues=t,this.redo()}undoValues}const Pl=e=>{const{type:t}=e;if(!C(t))throw hn.type+JSON.stringify(e);switch(t){case Y.AddClipToTrack:return new pl(e);case Y.AddEffect:return new ml(e);case Y.AddLayer:return new Il(e);case Y.AddTrack:return new dl(e);case Y.Change:return new gl(e);case Y.ChangeFrame:return new bl(e);case Y.ChangeMultiple:return new Cl(e);case Y.MoveClip:return new wl(e);case Y.MoveEffect:return new Fl(e);case Y.MoveLayer:return new Sl(e);case Y.RemoveClip:return new xl(e);case Y.RemoveLayer:return new Tl(e);default:throw hn.type+t}},El={createFromObject:Pl};class Vl{editor;constructor(e){this.editor=e}add(e){const t=this.instances.length-(this.index+1);y(t)&&this.instances.splice(this.index+1,t),this.instances.push(e)}get canRedo(){return this.index<this.instances.length-1}get canSave(){return this.canUndo}get canUndo(){return this.index>-1}create(e){const{editor:t}=this,{undoSelection:i,redoSelection:s,type:n=Y.Change,...r}=e,o={...r,type:n,undoSelection:i||{...t.selection.object},redoSelection:s||{...t.selection.object}};if(fl(e)&&this.currentActionLast){const{currentAction:i}=this;if(vl(i)){const{target:s,property:n}=e;if(i.target===s&&i.property===n)return i.updateAction(e),void t.handleAction(i)}}const a=Pl(o);this.add(a),t.handleAction(this.redo())}get currentAction(){return this.instances[this.index]}get currentActionLast(){return this.canUndo&&!this.canRedo}destroy(){this.index=-1,this.instances.splice(0,this.instances.length)}index=-1;instances=[];redo(){this.index+=1;const e=this.currentAction;return ul(e),e.redo(),e}reusableChangeAction(e,t){if(!this.currentActionLast)return;const i=this.currentAction;return vl(i)&&i.target===e&&i.property===t?i:void 0}save(){this.instances.splice(0,this.index+1),this.index=-1}get selection(){return this.editor.selection}undo(){const e=this.currentAction;return ul(e),this.index-=1,e.undo(),e}}const zl=e=>i(e)&&"cast"in e,Al=e=>i(e)&&"mash"in e;function kl(e,i){Al(e)||t(e,"MashData",i)}class _l extends EventTarget{dispatch(e,t){this.dispatchEvent(this.event(e,t))}emit(e,t){if(!this.trapped.has(e))return void this.dispatch(e,t);const i=this.trapped.get(e);i&&i(this.event(e,t))}event(e,t){return new CustomEvent(e,t?{detail:t}:void 0)}trap(e,t){this.trapped.has(e)||this.trapped.set(e,t||null)}trapped=new Map}const Ol=e=>es(e)&&e.type===Te.Effect;function Rl(e){if(!Ol(e))throw new Error("expected Effect")}const $l=e=>Wt(e)&&e.type===Te.Effect,Ml=e=>Wt(e)&&e.type===Te.Font;function Nl(e){if(!Ml(e))throw new Error("expected FontDefinition")}class jl{constructor(e){this.endpoint=e||{}}absoluteUrl(e){return e}browsing=!0;cacheGet(e,t){const i=this.key(e),s=this.cacheKey(e),n=this.loaderCache.get(s);if(n||!t)return n;const{definition:r,type:o}=e,a=[];Wt(r)&&a.push(r);const c={loaded:!1,definitions:a};return this.cacheSet(s,c),c.promise=this.cachePromise(i,e,c).then((e=>(c.loaded=!0,c.result=e,e))).catch((e=>(c.error=e,c.loaded=!0,e))),c}cacheKey(e){const{type:t}=e;return`${t}:/${this.key(e)}`}cachePromise(e,t,i){const s={loaderPath:this.cacheKey(t),urlOrLoaderPath:e,loaderType:t.type};return this.filePromise(s)}cacheSet(e,t){const i=n(e)?e:this.cacheKey(e);this.loaderCache.set(i,t)}endpoint;filePromise(e){throw hn.unimplemented+"filePromise"}flushFilesExcept(e=[]){const t=e.map((e=>this.cacheKey(e)));[...this.loaderCache.keys()].filter((e=>!t.includes(e))).forEach((e=>{this.loaderCache.get(e)&&this.loaderCache.delete(e)}))}getCache(e){const t=this.parseUrlPath(e).pop();return s(t),this.loaderCache.get(t.loaderPath)}getError(e){return this.cacheGet(e)?.error}getFile(e){const t=this.cacheGet(e),i=t?.result;if(i)return i;{const{type:i}=e,s=`${i}-${this.key(e)}`;t?console.trace(this.constructor.name,`getFile NO RESULT files.${s} for`,e.definition?.label):console.trace(this.constructor.name,`getFile NOTHING AT files.${s} for`,e.definition?.label,this.loaderCache.keys())}}getLoaderCache(e,t,i){const{loaderPath:s,loaderType:n}=e,r=this.loaderCache.get(s);if(r||!t)return r;const o=[];Wt(i)&&o.push(i);const a={loaded:!1,definitions:o};return n!==fe.Svg&&this.setLoaderCache(s,a),a.promise=this.filePromise(e).then((e=>(a.loaded=!0,a.result=e,e))).catch((e=>(a.error=e,a.loaded=!0,e))),a}imagePromise(e){const t=new Image;return t.src=e,t.decode().then((()=>t))}info(e){e||console.trace(this.constructor.name,"info NO loaderPath");const t=this.parseUrlPath(e);t.reverse();for(const e of t){const t=this.loaderCache.get(e.urlOrLoaderPath);if(!t)continue;const{loadedInfo:i}=t;if(z(i))return i}}key(e){throw hn.unimplemented+"key"}lastCssUrl(e){const t=[...e.matchAll(/url\(([^)]+)\)(?!.*\1)/g)];return Zs(Zs(t))}loadFilesPromise(e){const t=e.map((e=>this.loadGraphFilePromise(e)));return Promise.all(t).then(kt)}loadPromise(e,t){const i=this.loaderCache.get(e);if(i){const{promise:e,result:t,loaded:n,error:r}=i;return n||r?Promise.resolve(t):(s(e),e)}const n=this.parseUrlPath(e);n.reverse();const r=n.shift();s(r);let o=this.loaderFilePromise(r,t);return n.forEach((e=>{o=o.then((()=>this.loaderFilePromise(e)))})),o.then((e=>e))}loadGraphFilePromise(e){const{type:t,file:i,definition:s}=e,n=`${t}:/${i}`;return this.loadPromise(n,s)}loadedFile(e){return!!this.cacheGet(e)?.loaded}loaderCache=new Map;loaderFilePromise(e,t){let i=this.getLoaderCache(e,!0,t);s(i);const{promise:n,result:r,loaded:o,error:a}=i;return r&&o&&!a?Promise.resolve(r):(s(n),n)}media(e){const t=this.loaderCache.get(e);if(t){const{result:e,loaded:i,error:s}=t;if(i||s)return e}}parseUrlPath(e){P(e);return dr(e,this.endpoint).map((e=>{const[t,i,s]=e,n=`${t}:${i}/${s}`;Zn(t);return{loaderPath:n,urlOrLoaderPath:s,loaderType:t,options:pr(i)}}))}setLoaderCache(e,t){this.loaderCache.set(e,t)}sourceUrl(e){const t=this.cacheGet(e);if(!t?.loaded)return this.key(e);const{type:i}=e,{result:n}=t;switch(s(n),i){case ye.Image:case ye.Video:return n.src}return""}updateDefinitionDuration(e,t,i){const{duration:s}=e;F(s)||(e.duration=t),i&&(e.audio=!0)}updateDefinitionSize(e,t){const i=this.browsing?"previewSize":"sourceSize",{[i]:s}=e;Is(t,s)||(e[i]=t)}updateDefinitionFamily(e,t){const{family:i}=e;i||(e.family=t)}updateCache(e,t){e.loadedInfo||={};const{definitions:i,loadedInfo:s}=e,{duration:n,width:r,height:o,audible:a,family:c}=t,u={width:r,height:o},l=F(n),h=ks(u);h&&(s.width||=u.width,s.height||=u.height),l&&(a&&(s.audible=!0),s.duration||=n),c&&(s.family||=c),i.forEach((e=>{h&&Yc(e)&&this.updateDefinitionSize(e,u),l&&nu(e)&&this.updateDefinitionDuration(e,n,a),c&&Ml(e)&&this.updateDefinitionFamily(e,c)}))}updateLoaderFile(e,t){const i=this.getLoaderCache(e);s(i),this.updateCache(i,t)}updateDefinitions(e,t){const i=this.cacheGet(e);s(i),this.updateCache(i,t)}videoPromise(e){return new Promise(((t,i)=>{const s=this.videoFromUrl(e);s.oncanplay=()=>{s.oncanplay=null,s.onerror=null;const{videoWidth:e,clientWidth:i,videoHeight:n,clientHeight:r}=s,o=e||i,a=n||r;s.width=o,s.height=a,t(s)},s.onerror=i,s.autoplay=!1,s.load()}))}videoFromUrl(e){if(!globalThis.document)throw"wrong environment";const t=globalThis.document.createElement("video");return t.src=e,t}}class Dl extends jl{constructor(e){super(e);const[t,i]=this.canvasContext({width:1,height:1});i.fillRect(0,0,1,1),this.svgImagePromise(t.toDataURL()).then((()=>{this.svgImageEmitsLoadEvent=!0}))}absoluteUrl(e){return ar(this.endpoint,e)}arrayBufferPromise(e){return fetch(e).then((e=>e.arrayBuffer()))}audioBufferPromise(e){return Vc.decode(e)}audioInfo(e){const{duration:t}=e;return{duration:t,audible:!0}}audioPromise(e){P(e,"url");return(e.startsWith("blob:")?this.blobAudioPromise(e):this.arrayBufferPromise(e)).then((e=>this.audioBufferPromise(e)))}blobAudioPromise(e){return fetch(e).then((e=>e.blob())).then((e=>new Promise(((t,i)=>{const s=new FileReader;s.onload=()=>{t(s.result)},s.onerror=i,s.readAsArrayBuffer(e)}))))}svgImageEmitsLoadEvent=!1;canvas(e){const{width:t,height:i}=e,s=document.createElement("canvas");return s.height=i,s.width=t,s}canvasContext(e){const t=this.canvas(e),i=t.getContext("2d");return _(i),[t,i]}filePromise(e){const{loaderType:t}=e;switch(t){case ye.Audio:return this.requestAudio(e);case ye.Font:return this.requestFont(e);case ye.Image:return this.requestImage(e);case ye.Video:return this.requestVideo(e);case fe.Svg:return this.requestSvgImage(e)}throw hn.invalid.type+t}filePromises(e,t){return e.map((e=>{const{name:i,type:s}=e,n=s.split("/").shift(),r={label:i,error:""};if(!Ie(n))return Promise.resolve({...r,error:"import.type",value:n});const o=mn(),a=fr("object",o),c=URL.createObjectURL(e),u={type:n,label:i,url:fr(n,a),source:c,id:gn()},l=n===ye.Audio,h=n===ye.Image,d=l||n===ye.Video,p=n===ye.Image||n===ye.Video;return this.mediaPromise(n,c).then((e=>{const i=this.mediaInfo(e);if(d){const{duration:e}=i;if(!F(e))return{...r,error:"import.duration",value:e};u.audio=!0,u.duration=e,u.audioUrl=p?fr("video",a):a}if(p){const s=Ms(i);if(!ks(s))return{...r,error:"import.size",value:js(s)};const n=t?As(s,t,!0):s,{width:o,height:c}=n;u.previewSize=n,h?(u.icon=fr("image",a,{width:o,height:c}),u.loadedImage=e):(u.icon=fr("video",a,{fps:10}),u.loadedVideo=e)}else u.loadedAudio=e;return this.loadLocalFile(e,a,i),u}))}))}fontFamily(e){return e.replaceAll(/[^a-z0-9]/gi,"_")}imageInfo(e){return Ms(e)}key(e){const{file:t,type:i}=e;return we(i)?ar(this.endpoint,t):t}loadLocalFile(e,t,i){const s={definitions:[],result:e,loadedInfo:i,promise:Promise.resolve(e),loaded:!0};this.setLoaderCache(t,s)}mediaInfo(e){return Hn(e)?this.videoInfo(e):Kn(e)?this.imageInfo(e):this.audioInfo(e)}mediaPromise(e,t){switch(Fe(e),P(t,"url"),e){case ye.Audio:return this.audioPromise(t);case ye.Image:return this.imagePromise(t);case ye.Video:return this.videoPromise(t)}throw hn.internal}requestAudio(e){const{urlOrLoaderPath:t,options:i}=e;return P(t,"urlOrLoaderPath"),sr(t)?this.audioPromise(t).then((t=>(s(t),this.updateLoaderFile(e,this.audioInfo(t)),t))):t.startsWith("video:")?this.requestVideoAudio(e):this.loadPromise(t)}requestFont(e){const{urlOrLoaderPath:t}=e,i=fetch(t).then((e=>{const t=e.headers.get("content-type");return!C(t)||t.startsWith(ye.Font)?e.arrayBuffer():(_(t.startsWith("text/css")),e.text().then((e=>this.arrayBufferPromise(this.lastCssUrl(e)))))})),s=this.fontFamily(t);return i.then((e=>new FontFace(s,e).load())).then((t=>{const{fonts:i}=globalThis.document;return i.add(t),i.ready.then((()=>{const i={family:s};return this.updateLoaderFile(e,i),t}))}))}requestImage(e){const{urlOrLoaderPath:t}=e;return sr(t)?this.imagePromise(t).then((t=>{const{width:i,height:s}=t,n={width:i,height:s};return this.updateLoaderFile(e,n),t})):this.requestLoadedImage(e)}requestLoadedImage(e){const{urlOrLoaderPath:t,options:i}=e,s=this.loadPromise(t);return t.split(":").shift()===ye.Video||i?s.then((e=>{const t=Ms(e),s=ks(i)?As(t,i):t,{width:n,height:r}=s,[o,a]=this.canvasContext(s);return a.drawImage(e,0,0,n,r),this.imagePromise(o.toDataURL())})):s}requestSvgImage(e){const{urlOrLoaderPath:t,options:i}=e;return this.sourcePromise(t).then((e=>{const t=this.svgImagePromise(e);return i?t.then((e=>{const{lock:t,...s}=i,n=Ue(t)?t:void 0;return Vn(e,s,n),e})):t}))}requestVideo(e){const{urlOrLoaderPath:t,options:i}=e;ir(t);const s=sr(t);return i?this.seekingVideoPromise(t,i):s?this.videoPromise(t).then((t=>{const i=this.videoInfo(t);return this.updateLoaderFile(e,i),t})):this.loadPromise(t)}requestVideoAudio(e){const{urlOrLoaderPath:t}=e;return this.loadPromise(t).then((e=>{const{src:t}=e;return P(t),this.audioPromise(t)}))}seek(e,t){if(!t)throw hn.internal+"seek";t.currentTime=e.seconds}seekNeeded(e,t){const{currentTime:i}=t;if(!i&&!e.frame)return!0;return!aa(i,e.fps).equalsTime(e)}seekPromise(e,t,i){const s=new Promise((s=>{if(!this.seekNeeded(t,i))return this.seekingPromises.delete(e),s(i);i.onseeked=()=>{i.onseeked=null,this.seekingPromises.delete(e),s(i)},this.seek(t,i)})),n=this.seekingPromises.get(e);return this.seekingPromises.set(e,s),n?n.then((()=>s)):s}copyVideoPromise(e,t){s(t);const i=e.split(":").pop();P(i);const n=this.seekingVideos.get(i);if(n)return Promise.resolve(n);const r=this.seekingVideoPromises.get(i);if(r)return r;const o=this.sourcePromise(e).then((e=>this.videoPromise(e).then((e=>this.seekPromise(i,aa(1),e).then((()=>(this.seekingVideos.set(i,e),e)))))));return this.seekingVideoPromises.set(i,o),o}seekingVideoPromise=(e,t)=>{s(t);const i=e.split(":").pop();return P(i),this.copyVideoPromise(e,t).then((e=>{const{frame:s=0,fps:n}=t;b(s),b(n);const r=oa(s,n);return this.seekPromise(i,r,e)}))};seekingVideoPromises=new Map;seekingPromises=new Map;seekingVideos=new Map;sourcePromise(e){return sr(e)?Promise.resolve(e):this.loadPromise(e).then((e=>{s(e);const{src:t}=e;return P(t),t}))}_svgElement;get svgElement(){return this._svgElement||=En()}set svgElement(e){this._svgElement=e}svgImagePromise(e){return new Promise(((t,i)=>{const s=zn(),n=()=>{s.removeEventListener("error",r),s.removeEventListener("load",o)},r=e=>{n(),i(e)},o=()=>{n(),t(s)};s.addEventListener("error",r,{once:!0}),s.addEventListener("load",o,{once:!0}),this.svgImageEmitsLoadEvent||this.svgElement.appendChild(s),Dn(s,e,"href")}))}videoInfo(e){const{duration:t,videoWidth:i,clientWidth:s,videoHeight:n,clientHeight:r}=e,o=i||s,a=n||r,c=e;let u=c.mozHasAudio;u||=Boolean(c.webkitAudioDecodedByteCount),u||=Boolean(c.audioTracks?.length),u||console.log(Object.values(e));return{width:o,height:a,duration:t,audible:u}}}class Ll{get[ie.None](){}get[ie.Cast](){const{cast:e}=this._object;if(sl(e))return e}get[ie.Clip](){const{clip:e}=this._object;if($c(e))return e}get[ie.Layer](){const{layer:e}=this._object;if(Wu(e))return e}get[ie.Mash](){const{mash:e}=this._object;if(kc(e))return e;const{layer:t}=this;return Hu(t)?t.mash:void 0}get[ie.Track](){const{clip:e,track:t}=this._object;return Nc(t)?t:$c(e)?e.track:void 0}get[ie.Container](){const{clip:e}=this._object;if($c(e))return e.container}get[ie.Content](){const{clip:e}=this._object;if($c(e))return e.content}get[ie.Effect](){const{effect:e}=this._object;if(Ol(e))return e}_editor;get editor(){return this._editor}set editor(e){this._editor=e}_focus=ie.Mash;get focus(){return this._focus}set focus(e){this._focus=e}get(e){return this[e]}unset(e){const t=this.object[e];if(!t)return;const i=t.selectables();_(i[0]===t),i.shift(),this.object=this.selectionFromSelectables(i)}set(e){const{selectType:t}=e;this.object={[t]:e}}_object={};get object(){return Object.fromEntries(se.map((e=>[e,this.get(e)])))}set object(e){const t=this.selectionPopulated(e),{object:i}=this;this.clear(),Object.assign(this._object,t);const{object:s}=this,{mash:n,cast:r,clip:o}=i,{mash:a,cast:c,clip:u}=s;u!==o&&($c(u)&&y(u.trackNumber)&&u.track.mash.clearPreview(),$c(o)&&y(o.trackNumber)&&o.track.mash.clearPreview()),Object.assign(this._object,t),this.editor.eventTarget.emit(tt.Selection),c!==r&&this.editor.eventTarget.emit(tt.Cast),a!==n&&(this.editor.eventTarget.emit(tt.Mash),this.editor.eventTarget.emit(tt.Track),this.editor.eventTarget.emit(tt.Duration))}clear(){se.forEach((e=>{delete this._object[e]}))}selectionFromSelectables(e){return Object.fromEntries(e.map((e=>[e.selectType,e])))}selectionPopulated(e){const{mash:t,object:i}=this,{cast:s}=i,{clip:n,track:r,layer:o,cast:a,mash:c,effect:u}=e,l=u||n||r||c||o||a||s||t;return _(l,"target"),this.selectionFromSelectables(l.selectables())}get selectTypes(){const e=[],{mash:t,object:i}=this,{clip:s,track:n,cast:r,layer:o,effect:a}=i;return r&&(e.push(ie.Cast),o&&e.push(ie.Layer)),t?(r||e.push(ie.Mash),n?(e.push(ie.Track),$c(s)?(e.push(ie.Clip),e.push(ie.Content),Ol(a)&&e.push(ie.Effect),C(s.containerId)&&e.push(ie.Container),e):e):e):e}selectedItems(e=se){const{selectTypes:t,object:i}=this,{clip:s}=i,n=t.filter((t=>e.includes(t)));return n.flatMap((e=>{let t=i[e];return ae(e)&&$c(s)&&(t=s[e]),_(t,e),t.selectedItems(this.editor.actions)}))}}const ql=()=>new Ll,Bl=e=>Wt(e)&&e.type===Te.Video,Ul=e=>es(e)&&e.definition.type===Te.Video;function Gl(e){if(!Ul(e))throw new Error("expected Video")}const Wl=e=>Wt(e)&&e.type===Te.Image;class Jl{constructor(e){const{autoplay:t,precision:i,loop:s,fps:n,volume:r,buffer:o,endpoint:a,preloader:c,editType:l,readOnly:h,dimensions:d,edited:p}=e;Q(l)&&(this._editType=l),h&&(this.readOnly=!0),this.editing=!this.readOnly,u(t)&&(this.autoplay=t),f(i)&&(this.precision=i),u(s)&&(this._loop=s),f(n)&&(this._fps=n),f(r)&&(this._volume=r),f(o)&&(this._buffer=o),ks(d)&&(this._rect={...fs,...d}),this.actions=new Vl(this),this.preloader=c||new Dl(a),p&&this.load(p)}actions;add(e,t){const i=I(e)?e:[e];if(!i.length)return Promise.resolve([]);const s=i.map((e=>(A(e),Ht.fromObject(e))));if(!t)return Promise.resolve(s);const n=s.map((e=>{const{id:t,type:i}=e,s={};return Qa(e)?s.contentId=t:s.containerId=t,i===Te.Audio&&(s.containerId=""),Fu.instanceFromObject(s)})),r={editing:!0,duration:!0},o=n.filter((e=>e.intrinsicsKnown(r))).flatMap((e=>e.intrinsicGraphFiles(r))),{preloader:a}=this;return a.loadFilesPromise(o).then((()=>this.addClip(n,t).then((()=>s))))}addClip(e,t){const{clip:i=0,track:s=0}=t,n=I(e)?e:[e],[r]=n;if(!r)return Promise.resolve();return this.assureMash(e).then((()=>{const{mash:e}=this.selection;_c(e);const{tracks:t}=e,{length:o}=t;x(o);const a=y(s),c=a?t[s]:void 0,u=c?.clips||[],l=c?.dense,h={...this.selection.object,clip:r},d=a?0:n.length,p={clips:n,type:Y.AddClipToTrack,trackIndex:s,redoSelection:h,createTracks:d};if(l){const e=y(i)?i:u.length;p.insertIndex=e}else if(d)p.redoFrame=y(i)?i:0;else{jc(c);const e=y(i)?i:c.frames;p.redoFrame=c.frameForClipNearFrame(r,e)}return this.actions.create(p),this.loadMashAndDraw()}))}addEffect(e,t=0){const{clip:i}=this.selection;if(!$c(i))throw console.error(this.constructor.name,"addEffect expected effectable selection"),hn.selection+"effectable";const{content:s}=i;Za(s);const{effects:n}=s;if(!n)throw hn.selection;const r=[...n],o=[...n];o.splice(t,0,e);const a={effects:n,undoEffects:r,redoEffects:o,redoSelection:{...this.selection.object,effect:e},type:Y.MoveEffect};return this.actions.create(a),this.loadMashAndDraw()}addFiles(e,t){const{preloader:i,eventTarget:n,rect:r}=this;let o=Promise.resolve([]);return i.filePromises(e,r).forEach((e=>{o=o.then((t=>{const r={id:vn("activity"),type:co.Analyze};return n.emit(tt.Activity,r),e.then((e=>{const o={...r},{label:a}=e;if(o.label=a,Gt(e)){t.push(e);const{url:n,type:r}=e;P(n);const a=i.info(n);s(a),o.type=co.Complete,o.value=a}else{const{error:t,value:i}=e;o.type=co.Error,o.error=t,o.value=i}return n.emit(tt.Activity,o),t}))}))})),o.then((e=>this.add(e,t).then((e=>{if(e.length){const t=tn(e.map((e=>e.type)));this.eventTarget.emit(tt.Added,{definitionTypes:t})}return e}))))}addFolder(e,t){const{cast:i}=this.selection;nl(i);const s=i.createLayer({type:W.Folder,label:e});Xu(s);const n={cast:i,layer:s},r={type:Y.AddLayer,redoSelection:n,layerAndPosition:t};this.actions.create(r)}addMash(e,t){const{cast:i}=this.selection;nl(i);const s=e?.mashObject||{},n=e?.definitionObjects||[];Ht.define(...n);const r={type:W.Mash,mash:s},o=i.createLayer(r);Ku(o);const{mash:a}=o;this.configureMash(a);const c={cast:i,layer:o,mash:a},u={type:Y.AddLayer,redoSelection:c,layerAndPosition:t};this.actions.create(u)}addTrack(){const{mash:e,cast:t}=this.selection,i={mash:e,cast:t};this.actions.create({redoSelection:i,type:Y.AddTrack,createTracks:1})}assureMash(e){const{selection:t,editType:i}=this,{mash:s}=t;if(!kc(s)){const t=I(e)?e[0]:e,{label:s}=t.content.definition,n={label:s};if(i===X.Mash)return this.load({mash:n});this.addMash({mashObject:n,definitionObjects:[]})}return Promise.resolve()}autoplay=ca.editor.autoplay;_buffer=ca.editor.buffer;get buffer(){return this._buffer}set buffer(e){const t=Number(e);if(this._buffer!==t){this._buffer=t;const{edited:e}=this;e&&(e.buffer=t)}}can(e){const{selection:t}=this,{track:i,clip:s,mash:n,layer:r}=t;switch(e){case rt.Save:return this.actions.canSave;case rt.Undo:return this.actions.canUndo;case rt.Redo:return this.actions.canRedo;case rt.Remove:return!!(s||i||r);case rt.Render:return!!n?.id;default:throw hn.argument+"can"}}castDestroy(){const{cast:e}=this.selection;return!!e&&(e.destroy(),this.preloader.flushFilesExcept(),!0)}clearActions(){this.actions.instances.length&&(this.actions=new Vl(this),this.eventTarget.emit(tt.Action))}get clips(){return this.selection.mash.clips}configureCast(e){return this.configureEdited(e),e.loadPromise({editing:!0,visible:!0}).then((()=>{this.selection.set(e),this.handleDraw()}))}configureEdited(e){e.editor=this;const{rect:t}=this;ks(t)&&(e.imageSize=Ms(t)),e.emitter=this.eventTarget}configureMash(e){return e.buffer=this.buffer,e.gain=this.gain,e.loop=this.loop,this.configureEdited(e),e.loadPromise({editing:!0,visible:!0}).then((()=>{this.selection.set(e),this.handleDraw()}))}create(){this.load({[this.editType]:{}})}get currentTime(){const{mash:e}=this.selection;return e&&e.drawnTime?e.drawnTime.seconds:0}dataPutRequest(){const{edited:e,editType:t}=this;s(e),ee(t);const{label:i}=e;if(!C(i)){const i=ca[t].label;P(i,"defaultLabel"),e.setValue(i,"label")}return e.putPromise().then((()=>{if(kc(e))return{mash:e.toJSON(),definitionIds:e.definitionIds};if(sl(e))return{cast:e.toJSON(),definitionIds:Object.fromEntries(e.mashes.map((e=>[e.id,e.definitionIds])))};throw new Error(hn.internal)}))}define(e){(Array.isArray(e)?e:[e]).forEach((e=>{const{id:t,type:i}=e;if(P(t,"define id"),Ht.fromId(t))return void console.warn(this.constructor.name,"define NOT redefining",t);Pe(i);const s=xt[i].definition(e);Ht.install(s)}))}get definitions(){const{mashes:e}=this,t=[...new Set(e.flatMap((e=>e.definitionIds)))].map((e=>Ht.fromId(e)));return t}get definitionsUnsaved(){const{definitions:e}=this;return e.filter((e=>{const{type:t,id:i}=e;return!!we(t)&&yn(i)}))}destroy(){this.castDestroy()||this.mashDestroy()}dragging=!1;drawTimeout;get duration(){return this.selection.mash?.duration||0}_editType;get editType(){return this._editType||(this._editType=this.editingCast?X.Cast:X.Mash),this._editType}get edited(){return this.selection.cast||this.selection.mash}editedData;editing;get editingCast(){return!!this.selection.cast}get endTime(){const{mash:e}=this.selection;return e?e.endTime.scale(this.fps,"floor"):oa()}eventTarget=new _l;_fps=ca.editor.fps;get fps(){return this._fps||this.selection.mash?.quantize||ca.editor.fps}set fps(e){const t=Number(e);this._fps!==t&&(this._fps=t,this.eventTarget.emit(tt.Fps),this.time=this.time.scale(this.fps))}get frame(){return this.time.frame}set frame(e){this.goToTime(oa(Number(e),this.fps))}get frames(){return this.endTime.frame}get gain(){return this.muted?0:this.volume}goToTime(e){const{fps:t,time:i}=this,{frame:s}=i,n=e?e.scaleToFps(t):oa(0,t),{frame:r}=n,{frame:o}=this.endTime,a=o-1,c=a<1?0:Math.min(r,a);if(e&&s===c)return Promise.resolve();const u=this.selection.mash?.seekToTime(oa(c,t));return u||Promise.resolve()}handleAction(e){const{edited:t}=this;_(t);const{selection:i}=e,{mash:s}=i;if(kc(s)&&(s.clearPreview(),e instanceof gl)){const{property:t,target:i}=e;if("gain"===t)$c(i)&&s.composition.adjustClipGain(i,s.quantize)}this.selection.object=i;(t.reload()||Promise.resolve()).then((()=>{s||this.handleDraw(),this.eventTarget.emit(tt.Action,{action:e})}))}handleDraw(e){!this.drawTimeout&&this.edited?.loading&&(this.drawTimeout=setTimeout((()=>{this.eventTarget.dispatch(tt.Draw),delete this.drawTimeout}),10))}load(e){return this.editedData=e,this.loadEditedData()}loadCastData(e={}){const{cast:t={},definitions:i=[]}=e;Ht.undefineAll(),Ht.define(...i),this.eventTarget.trap(tt.Draw,this.handleDraw.bind(this));const s=il(t,this.preloader);return this.configureCast(s)}loadEditedData(){const{rect:e,editedData:t}=this;return ks(e)?(s(t),delete this.editedData,this.destroy(),this.paused=!0,this.clearActions(),this.selection.clear(),zl(t)?this.loadCastData(t):(kl(t),this.loadMashData(t).then((()=>this.goToTime().then((()=>{const{edited:e}=this;kc(e)&&e.clearPreview(),this.autoplay&&(this.paused=!1)})))))):Promise.resolve()}loadMashAndDraw(){const{mash:e}=this.selection;if(!e)throw new Error(hn.selection);const t={editing:!0,visible:!0};return this.paused||(t.audible=!0),e.loadPromise(t).then((()=>{e.draw()}))}loadMashData(e={}){const{mash:t={},definitions:i=[]}=e;Ht.undefineAll(),Ht.define(...i);const s=_u({...t,preloader:this.preloader});return this.mashDestroy(),this.configureMash(s)}_loop=ca.editor.loop;get loop(){return this._loop}set loop(e){const t=!!e;this._loop=t;const{mash:i}=this.selection;i&&(i.loop=t)}mashDestroy(){const{mash:e}=this.selection;return!!e&&(e.destroy(),this.preloader.flushFilesExcept(),!0)}get mashes(){const{edited:e}=this;return e?sl(e)?e.mashes:[e]:[]}move(e,t={}){if(A(e,"clip"),$c(e))return void this.moveClip(e,t);Rl(e);const{clip:i=0}=t;this.moveEffect(e,i)}moveClip(e,t={}){Mc(e);const{clip:i=0,track:s=0}=t;b(i);const{mash:n}=this.selection;_c(n);const{tracks:r}=n,{trackNumber:o}=e,a={clip:e,trackIndex:s,undoTrackIndex:o,type:Y.MoveClip},c=!y(s);c&&(a.createTracks=1);const u=y(o)&&r[o].dense,l=y(s)&&r[s].dense,h=c?-1:r[s].clips.indexOf(e);if(l&&(a.insertIndex=i),u&&(a.undoInsertIndex=h,i<h&&(a.undoInsertIndex+=1)),!l||!u){const{frame:t}=e,n=(c?0:r[s].frameForClipNearFrame(e,i))-t;if(!n&&s===o)return;a.undoFrame=t,a.redoFrame=t+n}this.actions.create(a)}moveEffect(e,t=0){if(!y(t))throw hn.argument+"index";const{clip:i}=this.selection;if(!i)throw hn.selection;Mc(i);const s=i.content;Za(s);const{effects:n}=s,r=[...n],o=r.filter((t=>t!==e)),a=r.indexOf(e)<t?t-1:t;o.splice(a,0,e);const c={effects:n,undoEffects:r,redoEffects:o,type:Y.MoveEffect,effectable:s};this.actions.create(c)}moveLayer(e,t){const{cast:i}=this.selection;nl(i),Ju(e);const s={cast:i,layer:e},n={type:Y.MoveLayer,redoSelection:s,layerAndPosition:t};this.actions.create(n)}moveTrack(){console.debug(this.constructor.name,"moveTrack coming soon...")}_muted=!1;get muted(){return this._muted}set muted(e){const t=!!e;if(this._muted!==t){this._muted=t;const{mash:e}=this.selection;e&&(e.gain=this.gain)}}pause(){this.paused=!0}get paused(){const{mash:e}=this.selection;return!e||e.paused}set paused(e){const{mash:t}=this.selection;t&&(t.paused=e),e&&this.redraw()}play(){this.paused=!1}get position(){let e=0;return this.time.frame&&(e=this.time.seconds/this.duration,1!==e&&(e=parseFloat(e.toFixed(this.precision)))),e}set position(e){this.goToTime(aa(this.duration*Number(e),this.fps))}get positionStep(){return parseFloat(`0.${"0".repeat(this.precision-1)}1`)}precision=ca.editor.precision;preloader;readOnly=!1;_rect={...Gs};get rect(){return this._rect}set rect(e){_s(e);const{editedData:t,rect:i}=this;if(Us(i,e))return;this._rect=e;(t?this.loadEditedData():Promise.resolve()).then((()=>{const{edited:t,rect:i,eventTarget:s}=this;rl(t)&&(t.imageSize=Ms(i),s.emit(tt.Resize,{rect:e}),this.redraw())}))}redo(){this.actions.canRedo&&this.handleAction(this.actions.redo())}redraw(){const{edited:e}=this;e&&(e.mashes.forEach((e=>{e.clearPreview()})),this.eventTarget.dispatch(tt.Draw))}removeClip(e){const{mash:t}=this.selection;if(!t)throw new Error(hn.selection);const{track:i}=e,s={redoSelection:{...this.selection,clip:void 0},clip:e,track:i,index:i.clips.indexOf(e),type:Y.RemoveClip};this.actions.create(s)}removeEffect(e){const{clip:t}=this.selection;if(!t)throw hn.selection;Mc(t);const{content:i}=t;Za(i);const{effects:s}=i,n=[...s],r=s.filter((t=>t!==e)),o={...this.selection.object};delete o.effect;const a={redoSelection:o,effects:s,undoEffects:n,redoEffects:r,type:Y.MoveEffect};this.actions.create(a)}removeLayer(e){const{cast:t}=this.selection;nl(t);const i={cast:t,layer:e};this.actions.create({type:Y.RemoveLayer,redoSelection:i})}removeTrack(e){console.debug(this.constructor.name,"removeTrack coming soon...")}saved(e){if(e){const{edited:t}=this;_(t),Object.entries(e).forEach((([e,i])=>{if(t.id===e)return void(t.id=i);if(Ht.installed(e))return void Ht.updateDefinitionId(e,i);nl(t);const s=t.mashes.find((t=>t.id===e));_c(s),s.id=i}))}this.actions.save(),this.eventTarget.emit(tt.Action)}_selection;get selection(){if(this._selection)return this._selection;const e=ql();return e.editor=this,this._selection=e}get svgElement(){return this.preloader.svgElement}set svgElement(e){this.preloader.svgElement=e}svgItems(e){const{edited:t}=this;if(!t)return Promise.resolve([En(this.rect)]);const i={};return e&&this.paused&&(i.editor=this),t.svgItems(i)}get time(){return this.selection.mash?.time||oa(0,this.fps)}set time(e){this.goToTime(e)}get timeRange(){return this.selection.mash?.timeRange||ia(0,this.fps)}undo(){const{canUndo:e}=this.actions;e&&this.handleAction(this.actions.undo())}updateDefinition(e,t){const{id:i,type:s}=e,n=e.id||t.id;P(n);const r=t||Ht.fromId(i),{id:o,type:a}=r,c=o!==n,u=Ce(s)&&a!==s;if(u){const t=xt[s].definition(e);Ht.updateDefinition(r,t)}else c&&(Ht.updateDefinitionId(r.id,n),Object.assign(r,e),Bl(r)?delete r.loadedVideo:nu(r)?delete r.loadedAudio:Wl(r)&&delete r.loadedImage);const{edited:l}=this;if(!l||!u&&!c)return Promise.resolve();return this.mashes.flatMap((e=>e.tracks)).flatMap((e=>e.clips)).forEach((e=>{e.containerId===o&&e.setValue(i,"containerId"),e.contentId===o&&e.setValue(i,"contentId")})),this.loadMashAndDraw()}_volume=ca.editor.volume;get volume(){return this._volume}set volume(e){const t=Number(e);if(this._volume!==t){if(!y(t))throw hn.invalid.volume;this._volume=t,F(t)&&(this.muted=!1);const{mash:e}=this.selection;e&&(e.gain=this.gain),this.eventTarget.emit(tt.Volume)}}}let Hl;const Kl=(e={})=>({autoplay:ca.editor.autoplay,precision:ca.editor.precision,loop:ca.editor.loop,fps:ca.editor.fps,volume:ca.editor.volume,buffer:ca.editor.buffer,...e}),Yl=(e={})=>Hl=new Jl(Kl(e)),Xl={abs:Math.abs,ceil:Math.ceil,eq:(e,t)=>Number(e)===Number(t),floor:Math.floor,gt:(e,t)=>Number(e)>Number(t),gte:(e,t)=>Number(e)>=Number(t),if:(e,t,i)=>e?t:i,includes:(e,...t)=>t.includes(e),lt:(e,t)=>Number(e)<Number(t),lte:(e,t)=>Number(e)<=Number(t),max:Math.max,min:Math.min,number:Number,rgb:(e,t,i)=>fi({r:e,g:t,b:i}),rgba:(e,t,i,s)=>gi({r:e,g:t,b:i,a:s}),round:Math.round,string:String},Zl=Object.keys(Xl),Ql=/\\b[a-z]\\b/i,eh=e=>new RegExp(`\\b${e}\\b`,"g");class th{constructor(e,t){this.expressions.push(e),this.evaluation=t}args={};execute(e){if(this.resolved)return;const{expression:t,args:i}=this;let s=(e=>{let t=e.replaceAll(" or ","||").replaceAll(" and ","&&");return t=t.replaceAll(" ",""),t})(t);if(s.match(Ql))throw hn.eval.string+s;const r=[],o=[];Object.entries(i).forEach((([e,t])=>{r.push(e),o.push(t)}));const a=`return ${s}`;try{const t=new Function(...r,a)(...o);if(this.expressions.push(String(t)),k(t))this.resolved=!0,this._result=Number(t),this.log(e||"executed");else if(!n(t))throw hn.eval.string}catch(e){r.filter((e=>e.startsWith("_"))).forEach((e=>{s=s.replaceAll(eh(e),e.slice(1))})),this.expressions.push(s),this.log("execute failure")}}get expression(){const{expressions:e}=this,{length:t}=e;return e[t-1]}expressions=[];evaluation;evaluations=[];log(e,t){const i=[this.resolved?"* ":"- "];i.push(e),t&&i.push(`${t}:`);const[s,n]=this.expressions.slice(-2);i.push(s," -> ",n),this._logs.push(i.join(" "))}_logs=[];get logs(){return this.logsIndented()}logsIndented(e=0){const t=" ".repeat(2*e);return[`${t}Evaluation: ${this.expressions[0]}`,...this._logs.map((e=>`${t}${e}`)),...this.evaluations.flatMap((t=>t.logsIndented(e+1)))]}get rootExpression(){return this.evaluation?this.evaluation.rootExpression:this.expressions[0]}replaceAll(e,t,i){if(this.resolved)return!0;const{expression:s}=this,n=s===e,r=n?void 0:eh(e);if(n||r.test(s)){const o=t(this),a=String(o);if(k(o)&&n)return this.expressions.push(a),this.resolved=!0,this._result=Number(o),this.log(i||"resolved",e),!0;const c=n?a:s.replaceAll(r,a);this.expressions.push(c),this.log(i||"evaluated",e)}return!1}replaceMethods(e){if(this.resolved)return;const{args:t}=this;Zl.forEach((i=>{const s=(e=>new RegExp(`\\b${e}\\b\\(`,"g"))(i),{expression:n}=this;if(s.test(n)){const s=`_${i}`;t[s]=Xl[i];const r=eh(i);this.expressions.push(n.replaceAll(r,s)),this.log(e||"method",i)}}))}resolved=!1;_result;get result(){return D(this._result)?this._result:this.expression}}const ih=e=>{const{condition:t}=e;if(d(e.is))return`${t}==${e.is}`;const i=e.in;if(o(i))return String(t).trim();const s=(e=>n(e)?String(e).split(","):e)(i),r=n(s[0]),a=s.map((e=>r?`"${e}"`:e));return`(includes(${r?"string":"number"}(${t}),${a.join(",")}))`},sh={out_height_scaled:"if(gt(out_width, out_height), scale * out_height, out_height + ((scale - 1.0) * out_width))",out_width_scaled:"if(gt(out_height, out_width), scale * out_width, out_width + ((scale - 1.0) * out_height))"};class nh{constructor(e){const{tweenTime:t,timeRange:i,instance:s,editing:n,filter:r}=e;this.tweenTime=t,this.outputSize=e.outputSize,this.editing=!!n,Object.entries(sh).forEach((([e,t])=>{this.setExpression(e,t)}));const{height:o,width:a}=this.outputSize;this.setExpression("out_size",`${a}x${o}`),i&&(this.timeRange=i),s&&(this.instance=s),r&&(this.filter=r)}get customProperties(){const e={};return this.filterCustomProperties.forEach((t=>{e[t.name]=t})),this.instanceCustomProperties.forEach((t=>{e[t.name]=t})),Object.values(e)}evaluateBooleanValue(e){if(u(e))return e;if(f(e))return!!e;switch(e){case"true":return!0;case"false":case"":return!1}return!1}evaluateConditionals(e,t,i){const s=t.find((t=>{const s=ih(t);if(k(s))return!!Number(s);switch(s){case"true":return!0;case"false":case"":return!1}const n=new th(s,e);this.evaluateEvaluation(n,i);const{result:r}=n;return i&&this.logDebug(n),this.evaluateBooleanValue(r)}));U(s,hn.eval.conditionTruth);const{value:n}=s;if(o(n))throw hn.eval.conditionValue;return n}evaluateEvaluation(e,t){this.expandEvaluation(e,t),e.execute()}expandParameter(e,t,i){let s=!1;const{name:n}=t;return e.replaceAll(n,(e=>(s=!0,this.parameterConditionalValue(e,t,i))),"expandParameter"),s&&this.expandEvaluationProperties(e),s}expandEvaluation(e,t){this.exampleEvaluationParameters(e,t),this.expandEvaluationExpressions(e),this.expandEvaluationNumbers(e),this.populateEvaluationArgs(e),this.expandEvaluationMethods(e)}expandEvaluationExpressions(e){if(!e.resolved)for(const t of this.expressions.entries()){const[i,s]=t;e.replaceAll(i,(()=>s),"expandEvaluationExpressions")}}expandEvaluationMethods(e){e.resolved||e.replaceMethods()}expandEvaluationNumbers(e){if(!e.resolved){for(const t of this.customProperties){const{name:i,type:s}=t;if(!Wi(s)&&e.replaceAll(i,(()=>this.instanceCustomProperties.includes(t)?this.instance.value(i):this.filter.value(i)),"expandEvaluationNumbers.properties"))break}for(const t of this.numbers.entries()){const[i,s]=t;if(e.replaceAll(i,(()=>s),"expandEvaluationNumbers.numbers"))break}}}exampleEvaluationParameters(e,t){if(e.resolved)return;const i=[];for(const s of this.parameterInstances){const{name:n}=s;e.rootExpression!==n&&!i.includes(n)&&this.expandParameter(e,s,t)&&i.push(n)}}expandEvaluationProperties(e){for(const t of this.customProperties){const{name:i}=t;e.replaceAll(i,(()=>this.instanceCustomProperties.includes(t)?this.instance.value(i):this.filter.value(i)),"expandEvaluationProperties")}}expressions=new Map;_filter;get filter(){return this._filter}set filter(e){e&&(this._filter=e,this.parameterInstances=this.filter.parametersDefined,this.filterCustomProperties=[...this.filter.propertiesCustom],this.numbersInitialize())}editing;filterCustomProperties=[];get(e){return this.numbers.has(e)?this.numbers.get(e):""}logDebug(e){console.debug(this.filter.definitionId,`\n${e.logs.join("\n")}`)}label="createVisibleContext";_instance;get instance(){return this._instance}set instance(e){this._instance=e,this.instanceCustomProperties=[...this.instance.propertiesCustom]}numbers=new Map;numbersInitialize(){this.numbers.clear();const{height:e,width:t}=this.outputSize,{lengthSeconds:i,fps:s}=this.timeRange;this.setNumber("out_height",e),this.setNumber("out_width",t),this.setNumber("out_duration",i),this.setNumber("out_rate",s),this.editing&&this.setNumber("t",this.position)}outputSize;parameterInstance(e){return this.parameterInstances.find((t=>t.name===e))}parameterNumber(e,t){const i=this.parameter(e,t),s=Number(i);if(m(s))throw hn.eval.number+`${e} ≠ ${i}`;return s}parameter(e,t){const i=this.parameterInstance(e);if(!i)throw hn.eval.string+e;const s=new th(e);return this.expandParameter(s,i,t),this.evaluateEvaluation(s,t),t&&this.logDebug(s),s.result}parameterValue(e,t){const i=this.parameterInstance(e);if(!i)throw hn.eval.string+e;const s=new th(e);return this.expandParameter(s,i,t),t&&this.logDebug(s),s.result}get parameters(){const e={};return this.parameterInstances.forEach((t=>{const{name:i}=t;e[i]=this.parameter(i)})),e}get parameterValues(){const e={};return this.parameterInstances.forEach((t=>{const{name:i}=t;e[i]=this.parameterValue(i)})),e}parameterConditionalValue(e,t,i){let s=t.value;if(Array.isArray(s)&&(s=this.evaluateConditionals(e,s,i)),k(s))return Number(s);if(!s)return s;const{values:n}=t,r=n?.find((e=>e===s));return r||s}parameterInstances=[];populateEvaluationArgs(e){if(e.resolved)return;const{args:t}=e;for(const i of this.customProperties){const{name:s}=i;e.replaceAll(s,(()=>{const e=`_${s}`;return this.instanceCustomProperties.includes(i)?t[e]=this.instance.value(s):t[e]=this.filter.value(s),e}),"populateEvaluationArgs.properties")}}get position(){return this.timeRange.position}instanceCustomProperties=[];propertyValue(e){const t=this.instance.value(e);return p(t,e),u(t)?t?1:0:t}setExpression(e,t){this.expressions.set(e,t)}setNumber(e,t){this.numbers.set(e,t)}_timeRange;get timeRange(){return this._timeRange}set timeRange(e){this._timeRange=e}tweenTime}const rh=ou(Gc(vc(ua(bn))));class oh extends rh{contentPreviewItemPromise(e,t,i,s){return Promise.resolve(Cn(e,"","currentColor"))}mutable(){return!0}}const ah=au(Uc(ec(da(gr))));class ch extends ah{constructor(...e){super(...e);const[t]=e,{audioUrl:i,url:s}=t;!i&&s&&(this.audioUrl=s)}instanceFromObject(e={}){return new oh(this.instanceArgs(e))}type=Te.Audio;loadType=ye.Audio}const uh=e=>{const{id:t}=e;if(!t)throw hn.id;return new ch(e)},lh=e=>uh({id:e}),hh=e=>uh(e).instanceFromObject(e),dh=e=>hh({id:e});Ft[Te.Audio]={definition:uh,definitionFromId:lh,fromId:dh,instance:hh};const ph=Zc(Gc(vc(Yo(ua(bn)))));class mh extends ph{visibleCommandFiles(e){const t=[],{visible:i,time:s,videoRate:n}=e;if(!i)return t;const r=this.fileUrls(e),[o]=r,a=N(s)?s.lengthSeconds:0,c={loop:1,framerate:n};a&&(c.t=a);const{id:u}=this,l={...o,inputId:u,options:c};return t.push(l),t}fileUrls(e){const{visible:t,editing:i}=e,s=[];if(!t)return s;const{definition:n}=this,{url:r,source:o}=n,a=i?r:o;P(a,i?"url":"source");const c={input:!0,type:ye.Image,file:a,definition:n};return s.push(c),s}}const fh=Qc(Uc(ec(Xo(da(gr)))));class gh extends fh{constructor(...e){super(...e);const[t]=e,{loadedImage:i}=t;i&&(this.loadedImage=i)}definitionIcon(e,t){const i=super.definitionIcon(e,t);if(i)return i;const{url:s}=this;return this.urlIcon(s,e,t)}instanceFromObject(e={}){return new mh(this.instanceArgs(e))}loadType=ye.Image;loadedImage;type=Te.Image}const vh=e=>{const{id:t}=e;return P(t,"imageDefinition id"),new gh(e)},yh=e=>vh({id:e}),bh=e=>vh(e).instanceFromObject(e),wh=e=>bh({id:e});Ft[Te.Image]={definition:vh,definitionFromId:yh,fromId:wh,instance:bh};const Fh=ou(Zc(Gc(vc(ua(bn)))));class xh extends Fh{_foreignElement;get foreignElement(){return this._foreignElement||=this.foreignElementInitialize}get foreignElementInitialize(){return globalThis.document.createElementNS(_t,"foreignObject")}fileUrls(e){const t=[],{editing:i,time:s,audible:n,visible:r,icon:o}=e,{definition:a}=this,{url:c,source:u}=a,l=i?c:u;if(P(l,i?"url":"source"),r&&!o){const e={input:!0,type:ye.Video,file:l,definition:a};t.push(e)}if(n){if((!a.duration||this.mutable())&&!this.muted){const e={input:!0,type:ye.Audio,definition:a,file:this.definition.urlAudible(i)};t.push(e)}}return t}itemPreviewPromise(e,t,i){const{_foreignElement:s,_loadedVideo:n}=this,r=!!s;return r||n?(this.updateForeignElement(e,t,i,r),Promise.resolve(this.foreignElement)):this.loadVideoPromise.then((()=>(this.updateForeignElement(e,t,i),Promise.resolve(this.foreignElement))))}iconUrl(e,t,i){const s=Ms(this.intrinsicRect(!0)),n=As(s,e),{width:r,height:o}=n,a=this.definitionTime(t,i),{frame:c}=a,{fps:u}=i,{definition:l}=this,{url:h}=l,d=fr("video",h,{frame:c,fps:u});return fr("image",d,{width:r,height:o})}_loadedVideo;get loadedVideo(){return this._loadedVideo}get loadVideoPromise(){const{_loadedVideo:e}=this;if(e)return Promise.resolve(e);const{definition:t}=this,{loadedVideo:i}=t;if(i)return this._loadedVideo=i.cloneNode(),Promise.resolve(this._loadedVideo);const{preloader:s}=this.clip.track.mash,n=this.intrinsicGraphFile({editing:!0,size:!0}),{file:r}=n,o=fr("video",r);return s.loadPromise(o).then((e=>(t.loadedVideo=e,this._loadedVideo=e.cloneNode())))}updateVideo(e,t,i){const{loadedVideo:s}=this,{currentTime:n}=s,r=this.definitionTime(t,i),o=t.isRange?1:1/t.fps,{seconds:a}=r;Math.abs(a-n)>o&&(s.currentTime=a);const{width:c,height:u}=e;return s.width=c,s.height=u,s}updateForeignElement(e,t,i,s){const{foreignElement:n,loadedVideo:r}=this;s||n.appendChild(r),In(n,e),this.updateVideo(e,t,i)}}const Ih=au(Qc(Uc(ec(da(gr)))));class Th extends Ih{constructor(...e){super(...e);const[t]=e,{loadedVideo:i}=t;i&&(this.loadedVideo=i)}instanceFromObject(e={}){return new xh(this.instanceArgs(e))}loadType=ye.Video;loadedVideo;pattern="%.jpg";toJSON(){const e=super.toJSON();return e.url=this.url,this.source&&(e.source=this.source),e}type=Te.Video}const Sh=e=>{const{id:t}=e;return P(t),new Th(e)},Ch=e=>Sh({id:e}),Ph=e=>Sh(e).instanceFromObject(e),Eh=e=>Ph({id:e});Ft[Te.Video]={definition:Sh,definitionFromId:Ch,fromId:Eh,instance:Ph};const Vh=ou(Zc(Gc(vc(Yo(ua(bn))))));class zh extends Vh{visibleCommandFiles(e){const t=super.visibleCommandFiles(e),{streaming:i,visible:s}=e;return s&&i?(t.forEach((e=>{const{options:t={}}=e;t.loop=1,t.re="",e.options=t})),t):t}fileUrls(e){const{time:t,clipTime:i,editing:s,visible:n}=e,r=this.definitionTime(t,i),o={...e,time:r},a=super.fileUrls(o);if(n){const{definition:e}=this;if(s){const t=e.framesArray(r).map((t=>({type:ye.Image,file:e.urlForFrame(t),input:!0,definition:e})));t.push(...t)}else{const t={type:ye.Video,file:e.source,definition:e,input:!0};a.push(t)}}return a}iconUrl(e,t,i){const s=this.definitionTime(t,i),{definition:n}=this,r=n.framesArray(s),[o]=r;return n.urlForFrame(o)}speed=1;toJSON(){const e=super.toJSON();return 1!==this.speed&&(e.speed=this.speed),e}}const Ah=au(Qc(Uc(ec(da(gr)))));class kh extends Ah{constructor(...e){super(...e);const[t]=e,{padding:i,begin:s,fps:n,increment:r,pattern:o}=t;if(y(s)&&(this.begin=s),n&&(this.fps=n),r&&(this.increment=r),o&&(this.pattern=o),i)this.padding=i;else{const e=this.begin+(this.increment*this.framesMax-this.begin);this.padding=String(e).length}}begin=ca.definition.videosequence.begin;fps=ca.definition.videosequence.fps;framesArray(e){const{duration:t,fps:i}=this;return e.durationFrames(t,i)}get framesMax(){const{fps:e,duration:t}=this;return Math.floor(e*t)-2}increment=ca.definition.videosequence.increment;instanceFromObject(e={}){return new zh(this.instanceArgs(e))}loadType=ye.Image;padding;pattern="%.jpg";toJSON(){const e=super.toJSON(),{videosequence:t}=ca.definition,{pattern:i,increment:s,begin:n,fps:r,padding:o}=this;return i!==t.pattern&&(e.pattern=i),s!==t.increment&&(e.increment=s),n!==t.begin&&(e.begin=n),r!==t.fps&&(e.fps=r),o!==t.padding&&(e.padding=o),e}type=Te.VideoSequence;urlForFrame(e){const{increment:t,begin:i,padding:s,url:n,pattern:r}=this;let o=String(e*t+i);return s&&(o=o.padStart(s,"0")),(n+r).replaceAll("%",o)}}const _h=e=>{const{id:t}=e;return P(t),new kh(e)},Oh=e=>_h({id:e}),Rh=e=>_h(e).instanceFromObject(e),$h=e=>Rh({id:e});Ft[Te.VideoSequence]={definition:_h,definitionFromId:Oh,fromId:$h,instance:Rh};class Mh{args;constructor(e){this.args=e,console.log(this.constructor.name,"upload",this.args.upload)}assureClipFrames(){const{durationClips:e,args:t}=this,{quantize:i}=t.mash;e.forEach((e=>{const{content:t}=e,{definition:s}=t;if(nu(s)){const t=s.frames(i);t&&(e.frames=t)}}))}_avType=te.Both;get avType(){return this._avType}get avTypeNeededForClips(){const{avType:e}=this;if(e!==te.Both)return e;const{renderingClips:t}=this,i=new Set;if(t.forEach((e=>{e.audible&&i.add(te.Audio),e.visible&&i.add(te.Video)})),2===i.size)return e;const[s]=i;return s}_commandOutput;get commandOutput(){if(this._commandOutput)return this._commandOutput;const e={...this.args.commandOutput.options},t={...this.args.commandOutput,options:e};return this._commandOutput=t}get duration(){return this.timeRange.lengthSeconds}_durationClips;get durationClips(){return this._durationClips||=this.durationClipsInitialize}get durationClipsInitialize(){const{mash:e}=this.args,{frames:t}=e;if(y(t))return[];const{clips:i}=e,s={duration:!0};return i.filter((e=>!e.intrinsicsKnown(s)))}get endTime(){return this.args.endTime||this.args.mash.endTime}get filterGraphs(){const{filterGraphsOptions:e}=this;return console.log(this.constructor.name,"filterGraphs",e.upload),this.args.mash.filterGraphs(e)}get filterGraphsOptions(){const{timeRange:e,graphType:t,videoRate:i,args:s}=this,{upload:n}=s,r={time:e,graphType:t,videoRate:i,size:this.sizeCovered(),avType:this.avTypeNeededForClips,upload:n};return console.log(this.constructor.name,"filterGraphsOptions upload",n,r.upload),r}graphType=ot.Mash;get mashDurationPromise(){const e=this.durationClips;if(!e.length)return console.log(this.constructor.name,"mashDurationPromise no durationClips"),Promise.resolve();const{mash:t}=this.args,i={duration:!0},s=e.flatMap((e=>e.intrinsicGraphFiles(i))),{preloader:n}=t;return console.log(this.constructor.name,"mashDurationPromise files",s.map((e=>e.file))),n.loadFilesPromise(s)}get mashSize(){const{visibleGraphFiles:e}=this,t=e.map((e=>e.definition)).filter((e=>Yc(e))),i=[...new Set(t)].filter((e=>e.sourceSize));if(!i.length)return;const s=i.map((e=>e.sourceSize));return{width:Math.max(...s.map((e=>e.width))),height:Math.max(...s.map((e=>e.height)))}}get outputCover(){return!!this.args.commandOutput.cover}get outputSize(){const{width:e,height:t}=this.args.commandOutput;if(!e||!t){if(this.avType===te.Audio)return{width:0,height:0};throw console.error(this.constructor.name,"outputSize",this.args.commandOutput),hn.invalid.size+this.outputType+".outputSize for avType "+this.avType}return{width:e,height:t}}outputType;get preloadPromise(){return this.filterGraphs.loadPromise}get renderingClips(){return this.args.mash.clipsInTimeOfType(this.timeRange,this.avType)}renderingDescriptionPromise(e){let t=this.mashDurationPromise;return t=t.then((()=>{this.assureClipFrames()})),t=t.then((()=>this.sizePromise)),t=t.then((()=>this.preloadPromise)),t.then((()=>{this.assureClipFrames();const{commandOutput:e}=this,t={commandOutput:e},i=this.avTypeNeededForClips,{filterGraphs:s}=this;if(i!==te.Audio){const{filterGraphsVisible:e}=s,i=e.map((e=>{const{commandFilters:t,commandInputs:i,duration:s}=e;return{inputs:i,commandFilters:t,duration:s,avType:te.Video}}));t.visibleCommandDescriptions=i}if(i!==te.Video){const{filterGraphAudible:e,duration:i}=s;if(e){const{commandFilters:s,commandInputs:n}=e,r={inputs:n,commandFilters:s,duration:i,avType:te.Audio};t.audibleCommandDescription=r}}return t}))}get renderingDescription(){const{commandOutput:e}=this,t={commandOutput:e},i=this.avTypeNeededForClips,{filterGraphs:s}=this;if(i!==te.Audio){const{filterGraphsVisible:e}=s,i=e.map((e=>{const{commandFilters:t,commandInputs:i,duration:s}=e;return{inputs:i,commandFilters:t,duration:s,avType:te.Video}}));t.visibleCommandDescriptions=i}if(i!==te.Video){const{filterGraphAudible:e,duration:i}=s;if(e){const{commandFilters:s,commandInputs:n}=e,r={inputs:n,commandFilters:s,duration:i,avType:te.Audio};t.audibleCommandDescription=r}}return t}get startTime(){if(this.args.startTime)return this.args.startTime;const{quantize:e,frame:t}=this.args.mash;return oa(t,e)}sizeCovered(){const{outputSize:e,outputCover:t}=this;if(!t)return e;const{mashSize:i}=this;if(!Fs(i))return e;const{width:s,height:n}=i;return x(s),x(n),As(i,e)}get sizePromise(){if(this.avType===te.Audio||!this.outputCover)return Promise.resolve();const{visibleGraphFiles:e}=this;if(!e.length)return Promise.resolve();const{preloader:t}=this.args.mash;return t.loadFilesPromise(e)}get timeRange(){return ra(this.startTime,this.endTime)}get videoRate(){return this.args.commandOutput.videoRate||0}get visibleGraphFiles(){const{timeRange:e,args:t}=this,{mash:i}=t,s=i.clipsInTimeOfType(e,te.Video),n={size:!0};return s.filter((e=>!e.intrinsicsKnown(n))).flatMap((e=>e.intrinsicGraphFiles(n)))}}class Nh extends Mh{_avType=te.Audio;outputType=le.Audio;get renderingDescription(){const{renderingClips:e}=this;return e.some((e=>!e.mutable))?{commandOutput:this.commandOutput}:super.renderingDescription}}class jh extends Mh{_avType=te.Video;get endTime(){}get filterGraphsOptions(){const{args:e,graphType:t,avType:i,startTime:s}=this,{mash:n,upload:r}=e,{quantize:o}=n;return{time:s,graphType:t,videoRate:o,size:this.sizeCovered(),avType:i,upload:r}}outputType=le.Image;get startTime(){const{commandOutput:e,mash:t}=this.args,{offset:i}=e;return i||t.frames<0?oa(0,t.quantize):t.timeRange.positionTime(Number(i||0),"ceil")}}class Dh extends Nh{_avType=te.Video;outputType=le.ImageSequence}class Lh extends Nh{get avType(){return this.args.commandOutput.mute?te.Video:te.Both}get outputCover(){return!!this.args.commandOutput.cover}outputType=le.Video}class qh extends Mh{_avType=te.Audio;outputType=le.Waveform;get sizePromise(){return Promise.resolve()}}const Bh=e=>new Nh(e),Uh=e=>new jh(e),Gh=e=>new Lh(e),Wh=e=>new Dh(e),Jh=e=>new qh(e),Hh={[le.Audio]:Bh,[le.Image]:Uh,[le.Video]:Gh,[le.ImageSequence]:Wh,[le.Waveform]:Jh};class Kh{constructor(e){this.args=e}args;streamingDescription(e){const{mashes:t}=this.args,i=t.map((e=>e.preloader.loadFilesPromise(e.editedGraphFiles({audible:!0,visible:!0,streaming:!0}))));let s=Promise.all(i).then((()=>{const e=[],i=[],s=[],n=te.Both;t.forEach((t=>{const r={size:this.outputSize,videoRate:this.args.commandOutput.videoRate,graphType:ot.Cast,avType:n},o=t.filterGraphs(r),{filterGraphVisible:a}=o;s.push(...a.commandInputs),e.push(...o.fileUrls.filter((e=>e.input))),i.push(...a.commandFilters)}));const r={...this.args.commandOutput.options},o={...this.args.commandOutput,options:r};return{inputs:s,commandFilters:i,commandOutput:o,avType:n}}));return s}mashes=[];get outputSize(){const{width:e,height:t}=this.args.commandOutput;return{width:e,height:t}}}class Yh extends Kh{}var Xh={options:{},audioBitrate:160,audioCodec:"libmp3lame",audioChannels:2,audioRate:44100,extension:"mp3",outputType:"audio"};var Zh={options:{},width:320,height:240,extension:"jpg",outputType:"image",cover:!0,offset:0};var Qh={options:{g:60,level:41,movflags:"faststart"},width:1920,height:1080,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,g:0,format:"mp4",extension:"mp4",outputType:"video",cover:!1};var ed={options:{},format:"image2",width:320,height:240,videoRate:10,extension:"jpg",outputType:"imagesequence",cover:!1};var td={options:{},width:320,height:240,forecolor:"#000000",backcolor:"#00000000",audioBitrate:160,audioCodec:"aac",audioChannels:2,audioRate:44100,extension:"png",outputType:"waveform"};var id={width:320,height:240,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,format:"mdash",extension:"dash",streamingFormat:"mdash",options:{hls_delete_threshold:10,g:60}};var sd={width:320,height:240,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,format:"hls",extension:"m3u8",streamingFormat:"hls",options:{hls_segment_filename:"%06d.ts",hls_time:6,hls_list_size:10,hls_flags:"delete_segments",hls_delete_threshold:10,g:60}};var nd={width:320,height:240,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,format:"flv",extension:"flv",streamingFormat:"rtmp",options:{g:60}};const rd=e=>({...Xh,...e||{}}),od=e=>({...Qh,...e||{}}),ad=e=>({...ed,...e||{}}),cd=e=>({...td,...e||{}}),ud=e=>{const t=e||{};return{...Zh,...t,format:ce.Png}},ld=e=>{const t=e||{};return{...Zh,...t}},hd=e=>{const{outputType:t}=e;switch(t){case le.Audio:return rd(e);case le.Image:return ld(e);case le.Video:return od(e);case le.ImageSequence:return ad(e);case le.Waveform:return cd(e)}},dd=(e,t)=>hd({...t,outputType:e}),pd={[ce.AudioConcat]:le.Audio,[ce.Mdash]:le.Video,[ce.Flv]:le.Video,[ce.Hls]:le.Video,[ce.Jpeg]:le.Image,[ce.Mp3]:le.Audio,[ce.Mp4]:le.Video,[ce.Png]:le.Image,[ce.Rtmp]:le.Video,[ce.VideoConcat]:le.Video},md={[le.Audio]:ce.Mp3,[le.Image]:ce.Png,[le.Video]:ce.Mp4,[le.ImageSequence]:ce.Jpeg,[le.Waveform]:ce.Png},fd=e=>{const{format:t}=e;switch(t){case ce.Mdash:return vd(e);case ce.Rtmp:return yd(e);case ce.Hls:default:return gd(e)}},gd=e=>({...sd,...e||{}}),vd=e=>({...id,...e||{}}),yd=e=>({...nd,...e||{}});export{te as AVType,al as Action,El as ActionFactory,Y as ActionType,Vl as Actions,co as ActivityType,pl as AddClipToTrackAction,ml as AddEffectAction,Il as AddLayerAction,dl as AddTrackAction,Lo as AlphamergeFilter,Ke as Anchor,Ye as Anchors,mt as ApiVersion,Ec as AudibleContext,Vc as AudibleContextInstance,oh as AudioClass,ch as AudioDefinitionClass,Nh as AudioOutputClass,cu as AudioPreview,Dl as BrowserLoaderClass,tl as CastClass,gl as ChangeAction,bl as ChangeFramesAction,Cl as ChangeMultipleAction,br as ChromaKeyFilter,jt as ClassButton,Dt as ClassCollapsed,Nt as ClassDisabled,qt as ClassDropping,Ut as ClassDroppingAfter,Bt as ClassDroppingBefore,Lt as ClassSelected,bu as ClipClass,wu as ClipDefinitionClass,oe as ClipSelectTypes,ci as Color,ao as ColorChannelMixerFilter,wc as ColorContentClass,xc as ColorContentDefinitionClass,ro as ColorFilter,no as ColorizeFilter,ui as Colors,Xo as ContainerDefinitionMixin,Yo as ContainerMixin,ke as ContainerTypes,ec as ContentDefinitionMixin,vc as ContentMixin,Re as ContentTypes,zc as ContextFactory,To as ConvolutionFilter,Oo as CropFilter,sn as DataGroup,nn as DataGroups,Ne as DataType,je as DataTypes,ca as Default,rs as DefaultContainerId,Ya as DefaultContentId,Ht as Defined,gr as DefinitionBase,Te as DefinitionType,Se as DefinitionTypes,Ge as Direction,Nu as DirectionLabels,We as Directions,G as DroppingPosition,ut as Duration,X as EditType,Z as EditTypes,Oc as EditedClass,Jl as EditorClass,Ll as EditorSelectionClass,sc as EffectClass,oc as EffectDefinitionClass,_l as Emitter,kt as EmptyMethod,wt as Endpoints,hn as Errors,th as Evaluation,nh as Evaluator,tt as EventType,it as EventTypes,Ct as ExtDash,It as ExtHls,Pt as ExtJpeg,Vt as ExtJson,Et as ExtPng,St as ExtRtmp,zt as ExtText,Tt as ExtTs,Ft as Factories,xt as Factory,de as FillType,pe as FillTypes,vr as FilterClass,yr as FilterDefinitionClass,hu as FilterGraphClass,lu as FilterGraphInputAudible,uu as FilterGraphInputVisible,du as FilterGraphsClass,Uo as FilterIdPrefix,ba as FontClass,wa as FontDefinitionClass,jo as FpsFilter,fe as GraphFileType,ge as GraphFileTypes,ot as GraphType,$t as IdPrefix,Mt as IdSuffix,mh as ImageClass,gh as ImageDefinitionClass,jh as ImageOutputClass,Dh as ImageSequenceOutputClass,bn as InstanceBase,$u as LayerClass,Mu as LayerFolderClass,ju as LayerMashClass,W as LayerType,J as LayerTypes,ye as LoadType,be as LoadTypes,jl as LoaderClass,ku as MashClass,rt as MasherAction,nc as ModularDefinitionMixin,tc as ModularMixin,wl as MoveClipAction,Fl as MoveEffectAction,Sl as MoveLayerAction,nt as MoveType,Rt as NamespaceLink,_t as NamespaceSvg,Ot as NamespaceXhtml,Au as NonePreview,Mo as OpacityFilter,qe as Orientation,Be as Orientations,Hh as OutputFactory,At as OutputFilterGraphPadding,ce as OutputFormat,le as OutputType,he as OutputTypes,Ro as OverlayFilter,dn as Parameter,fs as PointZero,Uc as PreloadableDefinitionMixin,Gc as PreloadableMixin,gu as PreviewClass,Xi as PropertiedClass,Yi as PropertyTweenSuffix,Ui as PropertyTypesNumeric,Gs as RectZero,xl as RemoveClipAction,Tl as RemoveLayerAction,Mh as RenderingOutputClass,$o as ScaleFilter,ie as SelectType,se as SelectTypes,at as ServerType,ct as ServerTypes,Do as SetptsFilter,No as SetsarFilter,ha as ShapeContainerClass,ma as ShapeContainerDefinitionClass,$s as SizeIcon,Os as SizeOutput,Rs as SizePreview,Ts as SizeZero,dt as Sizing,Ee as SizingDefinitionTypes,pt as Sizings,ue as StreamingFormat,Kh as StreamingOutputClass,ya as TextContainerClass,ja as TextContainerDefinitionClass,os as TextContainerId,Bo as TextFilter,ea as TimeClass,ta as TimeRangeClass,lt as Timing,ze as TimingDefinitionTypes,ht as Timings,Eu as TrackClass,zu as TrackFactory,fu as TrackPreviewClass,pu as TrackPreviewHandleSize,mu as TrackPreviewLineSize,et as TransformType,Xe as TriggerType,Ze as TriggerTypes,qo as TrimFilter,da as TweenableDefinitionMixin,ua as TweenableMixin,au as UpdatableDurationDefinitionMixin,eu as UpdatableDurationDefinitionTypes,ou as UpdatableDurationMixin,Qc as UpdatableSizeDefinitionMixin,Wc as UpdatableSizeDefinitionType,Zc as UpdatableSizeMixin,xe as UploadTypes,xh as VideoClass,Th as VideoDefinitionClass,Lh as VideoOutputClass,zh as VideoSequenceClass,kh as VideoSequenceDefinitionClass,Yh as VideoStreamOutputClass,qh as WaveformOutputClass,Pl as actionInstance,Zs as arrayLast,en as arrayReversed,Qs as arraySet,tn as arrayUnique,x as assertAboveZero,ul as assertAction,T as assertArray,l as assertBoolean,nl as assertCast,yl as assertChangeAction,Mc as assertClip,hs as assertContainer,cs as assertContainerObject,Oe as assertContainerType,Za as assertContent,Me as assertContentType,Co as assertConvolutionServerFilter,on as assertDataGroup,Le as assertDataType,p as assertDefined,Jt as assertDefinition,Pe as assertDefinitionType,He as assertDirection,ee as assertEditType,ol as assertEdited,Rl as assertEffect,Nl as assertFontDefinition,Ju as assertLayer,Xu as assertLayerFolder,Ku as assertLayerMash,K as assertLayerType,Fe as assertLoadType,er as assertLoaderPath,Zn as assertLoaderType,_c as assertMash,Ru as assertMashClass,kl as assertMashData,c as assertNumber,s as assertObject,ps as assertPoint,V as assertPopulatedArray,A as assertPopulatedObject,P as assertPopulatedString,b as assertPositive,Bc as assertPreloadable,Lc as assertPreloadableDefinition,cn as assertProperty,Bs as assertRect,R as assertRgb,re as assertSelectType,xs as assertSize,_s as assertSizeAboveZero,r as assertString,ga as assertTextContainer,M as assertTime,j as assertTimeRange,jc as assertTrack,_ as assertTrue,is as assertTweenable,ns as assertTweenableDefinition,iu as assertUpdatableDuration,ru as assertUpdatableDurationDefinition,Hc as assertUpdatableSize,Xc as assertUpdatableSizeDefinition,q as assertValue,U as assertValueObject,Gl as assertVideo,uh as audioDefinition,lh as audioDefinitionFromId,dh as audioFromId,hh as audioInstance,il as castInstance,Ys as centerPoint,Fu as clipDefault,xu as clipDefaultId,Iu as clipDefaults,Tu as clipDefinition,Su as clipDefinitionFromId,Pu as clipFromId,Cu as clipInstance,zi as colorAlpha,$i as colorAlphaColor,Zt as colorBlack,si as colorBlackOpaque,ti as colorBlackTransparent,ai as colorBlue,Mi as colorFromRgb,Ni as colorFromRgba,ni as colorGreen,xi as colorHexRegex,ki as colorHexToRgb,Ai as colorHexToRgba,li as colorName,oi as colorRed,ji as colorRgb,Bi as colorRgbDifference,Kt as colorRgbKeys,wi as colorRgbRegex,fi as colorRgbToHex,bi as colorRgbToYuv,Di as colorRgba,Yt as colorRgbaKeys,Fi as colorRgbaRegex,gi as colorRgbaToHex,_i as colorRgbaToRgba,Li as colorRgbaTransparent,qi as colorServer,Ii as colorStrip,Oi as colorToRgb,Ri as colorToRgba,Xt as colorTransparent,Ti as colorValid,Si as colorValidHex,Pi as colorValidRgb,Ci as colorValidRgba,Qt as colorWhite,ii as colorWhiteOpaque,ei as colorWhiteTransparent,ri as colorYellow,yi as colorYuvBlend,vi as colorYuvDifference,mi as colorYuvToRgb,lo as commandFilesInput,uo as commandFilesInputIndex,Ga as containerDefaults,Wa as containerDefinition,Ja as containerDefinitionFromId,Ka as containerFromId,Ha as containerInstance,Ic as contentDefaults,Tc as contentDefinition,Sc as contentDefinitionFromId,Pc as contentFromId,Cc as contentInstance,Kl as editorArgs,Yl as editorInstance,ql as editorSelectionInstance,Hl as editorSingleton,pc as effectDefaults,dc as effectDefinition,mc as effectDefinitionFromId,gc as effectFromId,fc as effectInstance,ho as eventStop,po as fetchCallback,Go as filterDefaults,Wo as filterDefinition,Jo as filterDefinitionFromId,Ko as filterFromId,Ho as filterInstance,_a as fontDefault,Oa as fontDefaults,ka as fontDefinition,Ra as fontDefinitionFromId,Ma as fontFromId,$a as fontInstance,Ei as getChunksFromString,Vi as hex256,vn as idGenerate,mn as idGenerateString,yn as idIsTemporary,fn as idPrefixSet,gn as idTemporary,vh as imageDefinition,yh as imageDefinitionFromId,wh as imageFromId,bh as imageInstance,F as isAboveZero,cl as isAction,hl as isActionEvent,ll as isActionInit,I as isArray,vu as isAudio,yu as isAudioDefinition,w as isBelowOne,u as isBoolean,sl as isCast,zl as isCastData,vl as isChangeAction,fl as isChangeActionObject,$c as isClip,Rc as isClipObject,ae as isClipSelectType,yc as isColorContent,ls as isContainer,us as isContainerDefinition,as as isContainerObject,_e as isContainerType,Xa as isContent,Qa as isContentDefinition,$e as isContentType,So as isConvolutionServerFilter,e as isCustomEvent,rn as isDataGroup,De as isDataType,d as isDefined,Wt as isDefinition,Gt as isDefinitionObject,Ce as isDefinitionType,Je as isDirection,Q as isEditType,rl as isEdited,Ol as isEffect,$l as isEffectDefinition,st as isEventType,me as isFillType,v as isFloat,Ml as isFontDefinition,ve as isGraphFileType,Wl as isImageDefinition,es as isInstance,Qi as isInstanceObject,g as isInteger,Wu as isLayer,Yu as isLayerFolder,Lu as isLayerFolderObject,Hu as isLayerMash,qu as isLayerMashObject,Du as isLayerObject,H as isLayerType,we as isLoadType,Yn as isLoadedAudio,Kn as isLoadedImage,Hn as isLoadedVideo,Qn as isLoaderPath,Xn as isLoaderType,kc as isMash,Ac as isMashAndDefinitionsObject,Ou as isMashClass,Al as isMashData,h as isMethod,m as isNan,f as isNumber,a as isNumberOrNaN,k as isNumeric,i as isObject,Ue as isOrientation,ds as isPoint,E as isPopulatedArray,z as isPopulatedObject,C as isPopulatedString,y as isPositive,qc as isPreloadable,Dc as isPreloadableDefinition,Zi as isPropertied,an as isProperty,qs as isRect,O as isRgb,ne as isSelectType,mo as isSelectedProperty,Zo as isShapeContainer,Fs as isSize,Ve as isSizingDefinitionType,n as isString,fa as isTextContainer,$ as isTime,N as isTimeRange,Ae as isTimingDefinitionType,Nc as isTrack,Qe as isTriggerType,L as isTrueValue,ts as isTweenable,ss as isTweenableDefinition,o as isUndefined,tu as isUpdatableDuration,nu as isUpdatableDurationDefinition,su as isUpdatableDurationType,Jc as isUpdatableSize,Yc as isUpdatableSizeDefinition,Kc as isUpdatableSizeType,Ie as isUploadType,D as isValue,B as isValueObject,Ul as isVideo,Bl as isVideoDefinition,Bu as layerFolderInstance,Gu as layerInstance,Uu as layerMashInstance,_u as mashInstance,rd as outputDefaultAudio,vd as outputDefaultDash,md as outputDefaultFormatByType,gd as outputDefaultHls,ld as outputDefaultImage,ad as outputDefaultImageSequence,ud as outputDefaultPng,hd as outputDefaultPopulate,dd as outputDefaultRendering,yd as outputDefaultRtmp,fd as outputDefaultStreaming,pd as outputDefaultTypeByFormat,od as outputDefaultVideo,cd as outputDefaultWaveform,Bh as outputInstanceAudio,Uh as outputInstanceImage,Gh as outputInstanceVideo,Wh as outputInstanceVideoSequence,Jh as outputInstanceWaveform,Sr as pixelColor,Pr as pixelFromFrame,Tr as pixelNeighboringRgbas,Cr as pixelPerFrame,xr as pixelRgbaAtIndex,Er as pixelToFrame,zr as pixelsMixRbg,Vr as pixelsMixRbga,Ar as pixelsRemoveRgba,kr as pixelsReplaceRgba,gs as pointCopy,ws as pointNegate,vs as pointRound,ys as pointString,bs as pointValueString,ms as pointsEqual,un as propertyInstance,Ki as propertyTypeCoerce,Ji as propertyTypeDefault,Wi as propertyTypeIsString,Hi as propertyTypeValid,Hs as rectCopy,Ws as rectFromSize,Ks as rectRound,Xs as rectString,Us as rectsEqual,Js as rectsFromSizes,di as rgbNumeric,hi as rgbValue,wr as roundMethod,Fr as roundWithMethod,go as selectedPropertiesScalarObject,fo as selectedPropertyObject,ks as sizeAboveZero,Es as sizeCeil,Ms as sizeCopy,As as sizeCover,Cs as sizeEven,Vs as sizeFloor,Ls as sizeFromElement,Ns as sizeLock,Ds as sizeLockNegative,Ps as sizeRound,zs as sizeScale,js as sizeString,Ss as sizedEven,Is as sizesEqual,vo as sortByFrame,yo as sortByIndex,wo as sortByLabel,bo as sortByTrack,xo as stringFamilySizeRect,Io as stringPluralize,Fo as stringSeconds,Ln as svgAddClass,On as svgAppend,$n as svgDefsElement,jn as svgDifferenceDefs,En as svgElement,Mn as svgFeImageElement,_n as svgFilter,Nn as svgFilterElement,Wn as svgFunc,xn as svgGroupElement,wn as svgId,zn as svgImageElement,kn as svgMaskElement,An as svgPathElement,Rn as svgPatternElement,Cn as svgPolygonElement,Sn as svgRectPoints,Dn as svgSet,Pn as svgSetBox,Jn as svgSetChildren,In as svgSetDimensions,Vn as svgSetDimensionsLock,Bn as svgSetTransform,Tn as svgSetTransformPoint,Gn as svgSetTransformRects,Un as svgTransform,Fn as svgUrl,qn as svgUseElement,t as throwError,Qo as timeEqualizeRates,oa as timeFromArgs,aa as timeFromSeconds,ia as timeRangeFromArgs,sa as timeRangeFromSeconds,na as timeRangeFromTime,ra as timeRangeFromTimes,Vu as trackInstance,$r as tweenColorStep,Nr as tweenColors,Xr as tweenCoverPoints,Yr as tweenCoverSizes,so as tweenInputTime,Dr as tweenMaxSize,io as tweenMinMax,Lr as tweenMinSize,Gr as tweenNumberObject,Rr as tweenNumberStep,qr as tweenOption,Jr as tweenOverPoint,Wr as tweenOverRect,Hr as tweenOverSize,Or as tweenPad,Ur as tweenPosition,Zr as tweenRectLock,jr as tweenRects,Qr as tweenRectsLock,eo as tweenScaleSizeRatioLock,Kr as tweenScaleSizeToRect,Br as tweenableRects,to as tweeningPoints,rr as urlCombine,tr as urlEndpoint,ar as urlForEndpoint,or as urlFromEndpoint,nr as urlHasProtocol,sr as urlIsHttp,ir as urlIsObject,cr as urlIsRootProtocol,mr as urlOptions,pr as urlOptionsObject,lr as urlParse,fr as urlPrependProtocol,ur as urlProtocol,dr as urlsAbsolute,hr as urlsParsed,Sh as videoDefinition,Ch as videoDefinitionFromId,Eh as videoFromId,Ph as videoInstance,_h as videoSequenceDefinition,Oh as videoSequenceDefinitionFromId,$h as videoSequenceFromId,Rh as videoSequenceInstance,pi as yuvNumeric};
