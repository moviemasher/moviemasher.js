!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MovieMasher={})}(this,(function(e){"use strict";const t=e=>e instanceof CustomEvent,i=(e,t,i="value")=>{const n=typeof e,s="object"===n?e.constructor.name:n;throw console.error("throwError",e),new Error(`${i} is "${e}" (${s}) instead of ${t}`)},n=e=>"object"==typeof e;function s(e,t){n(e)||i(e,"Object",t)}const r=e=>"string"==typeof e;function o(e,t){r(e)||i(e,"String",t)}const a=e=>void 0===e,c=e=>"number"==typeof e;function l(e,t){c(e)||i(e,"Number",t)}const u=e=>"boolean"==typeof e;const h=e=>!a(e);function d(e,t){h(e)||i(e,"defined",t)}const p=e=>c(e)&&Number.isNaN(e),m=e=>c(e)&&!Number.isNaN(e),f=e=>Number.isInteger(e),g=e=>m(e)&&e>=0;function y(e,t){g(e)||i(e,">= 0",t)}const v=e=>m(e)&&e<1,T=e=>m(e)&&e>0;function b(e,t){T(e)||i(e,"> zero",t)}const w=e=>h(Array.isArray)?Array.isArray(e):e instanceof Array;function F(e,t){w(e)||i(e,"Array",t)}const S=e=>!!e.length,I=e=>r(e)&&S(String(e));function x(e,t="value"){I(e)||i(e,"populated string",t)}const C=e=>w(e)&&S(e);function D(e,t="value"){C(e)||i(e,"populated array",t)}const P=e=>n(e)&&S(Object.keys(e));function A(e,t="value"){P(e)||i(e,"populated array",t)}const E=e=>(m(e)||I(e))&&!p(Number(e));function V(e,t="value"){e||i(e,"true",t)}const z=e=>n(e)&&"r"in e&&"g"in e&&"b"in e;const O=e=>n(e)&&"isRange"in e;function R(e,t){O(e)||i(e,"Time",t)}const k=e=>O(e)&&e.isRange;function _(e,t){k(e)||i(e,"TimeRange",t)}const M=e=>m(e)||r(e),N=e=>!!M(e)&&(E(e)?!!Number(e):I(e));const $=e=>n(e)&&Object.values(e).every((e=>M(e)));function j(e,t){$(e)||i(e,"ValueObject",t)}var L,q;e.DroppingPosition=void 0,(L=e.DroppingPosition||(e.DroppingPosition={})).At="at",L.After="after",L.Before="before",L.None="none",e.LayerType=void 0,(q=e.LayerType||(e.LayerType={})).Mash="mash",q.Folder="folder";const G=Object.values(e.LayerType),B=e=>G.includes(e);var U,W;e.ActionType=void 0,(U=e.ActionType||(e.ActionType={})).AddClipToTrack="addClipToTrack",U.AddEffect="addEffect",U.AddLayer="addLayer",U.AddTrack="addTrack",U.Change="change",U.ChangeMultiple="changeMultiple",U.ChangeFrame="changeFrame",U.ChangeGain="changeGain",U.MoveClip="moveClip",U.MoveEffect="moveEffect",U.MoveLayer="moveLayer",U.RemoveClip="removeClip",U.RemoveLayer="removeLayer",e.EditType=void 0,(W=e.EditType||(e.EditType={})).Mash="mash",W.Cast="cast";const H=Object.values(e.EditType),J=e=>H.includes(e);function K(e,t){J(e)||i(e,"EditType",t)}var Y,X;e.AVType=void 0,(Y=e.AVType||(e.AVType={})).Audio="audio",Y.Both="both",Y.Video="video",e.SelectType=void 0,(X=e.SelectType||(e.SelectType={})).Cast="cast",X.Mash="mash",X.Track="track",X.Layer="layer",X.Effect="effect",X.Clip="clip",X.Content="content",X.Container="container",X.None="none";const Z=Object.values(e.SelectType),Q=e=>Z.includes(e);const ee=[e.SelectType.Content,e.SelectType.Container],te=e=>Q(e)&&ee.includes(e);var ie,ne,se;e.OutputFormat=void 0,(ie=e.OutputFormat||(e.OutputFormat={})).AudioConcat="wav",ie.Mdash="mdash",ie.Flv="flv",ie.Hls="hls",ie.Jpeg="jpeg",ie.Mp3="mp3",ie.Mp4="mp4",ie.VideoConcat="yuv4mpegpipe",ie.Png="image2",ie.Rtmp="rtmp",e.StreamingFormat=void 0,(ne=e.StreamingFormat||(e.StreamingFormat={})).Hls="hls",ne.Rtmp="rtmp",ne.Mdash="mdash",e.OutputType=void 0,(se=e.OutputType||(e.OutputType={})).Audio="audio",se.Image="image",se.Video="video",se.ImageSequence="imagesequence",se.Waveform="waveform";const re=Object.values(e.OutputType);var oe;e.FillType=void 0,(oe=e.FillType||(e.FillType={})).Color="color",oe.Fill="fill";const ae=Object.values(e.FillType);var ce;e.GraphFileType=void 0,(ce=e.GraphFileType||(e.GraphFileType={})).Svg="svg",ce.SvgSequence="svgsequence",ce.Txt="txt";const le=Object.values(e.GraphFileType),ue=e=>I(e)&&le.includes(e);var he;e.LoadType=void 0,(he=e.LoadType||(e.LoadType={})).Audio="audio",he.Font="font",he.Image="image",he.Video="video";const de=Object.values(e.LoadType),pe=e=>I(e)&&de.includes(e);function me(e,t){pe(e)||i(e,"LoadType",t)}const fe=de.filter((t=>t!==e.LoadType.Font)),ge=e=>pe(e)&&fe.includes(e);var ye;e.DefinitionType=void 0,(ye=e.DefinitionType||(e.DefinitionType={})).Audio="audio",ye.Clip="clip",ye.Container="container",ye.Content="content",ye.Effect="effect",ye.Filter="filter",ye.Font="font",ye.Image="image",ye.Video="video",ye.VideoSequence="videosequence";const ve=Object.values(e.DefinitionType),Te=e=>ve.includes(e);function be(e,t=""){if(!Te(e))throw new Error(`expected '${e}' to be DefinitionType ${t}`)}const we=[e.DefinitionType.Container,e.DefinitionType.Image,e.DefinitionType.Video,e.DefinitionType.VideoSequence],Fe=e=>Te(e)&&we.includes(e),Se=[e.DefinitionType.Audio,e.DefinitionType.Video,e.DefinitionType.VideoSequence],Ie=e=>Te(e)&&Se.includes(e),xe=[e.DefinitionType.Image,e.DefinitionType.Container,e.DefinitionType.VideoSequence],Ce=e=>Te(e)&&xe.includes(e);const De=[e.DefinitionType.Content,e.DefinitionType.Image,e.DefinitionType.Video,e.DefinitionType.VideoSequence,e.DefinitionType.Audio],Pe=e=>Te(e)&&De.includes(e);var Ae;e.DataType=void 0,(Ae=e.DataType||(e.DataType={})).Boolean="boolean",Ae.ContainerId="containerid",Ae.ContentId="contentid",Ae.DefinitionId="definitionid",Ae.FontId="fontid",Ae.Frame="frame",Ae.Number="number",Ae.Percent="percent",Ae.Rgb="rgb",Ae.String="string",Ae.Timing="timing",Ae.Sizing="sizing";const Ee=Object.values(e.DataType),Ve=e=>Ee.includes(e);function ze(e,t){Ve(e)||i(e,"DataType",t)}var Oe;e.Orientation=void 0,(Oe=e.Orientation||(e.Orientation={})).H="H",Oe.V="V";const Re=Object.values(e.Orientation),ke=e=>I(e)&&Re.includes(e);var _e;e.Direction=void 0,(_e=e.Direction||(e.Direction={})).E="E",_e.N="N",_e.S="S",_e.W="W";const Me=Object.values(e.Direction),Ne=e=>Me.includes(e);function $e(e,t){Ne(e)||i(e,"Direction",t)}var je;e.Anchor=void 0,(je=e.Anchor||(e.Anchor={})).E="E",je.N="N",je.NE="NE",je.NW="NW",je.S="S",je.SE="SE",je.SW="SW",je.W="W";const Le=Object.values(e.Anchor);var qe;e.TriggerType=void 0,(qe=e.TriggerType||(e.TriggerType={})).Init="init",qe.Stop="stop",qe.Start="start";const Ge=Object.values(e.TriggerType);var Be,Ue;e.TransformType=void 0,(Be=e.TransformType||(e.TransformType={})).Scale="scale",Be.Translate="translate",e.EventType=void 0,(Ue=e.EventType||(e.EventType={})).Action="action",Ue.Activity="activity",Ue.Added="added",Ue.Cast="cast",Ue.Draw="draw",Ue.Duration="durationchange",Ue.Ended="ended",Ue.Fps="ratechange",Ue.Loaded="loadeddata",Ue.Mash="mash",Ue.Pause="pause",Ue.Play="play",Ue.Playing="playing",Ue.Render="render",Ue.Resize="resize",Ue.Save="save",Ue.Seeked="seeked",Ue.Seeking="seeking",Ue.Selection="selection",Ue.Time="timeupdate",Ue.Track="track",Ue.Volume="volumechange",Ue.Waiting="waiting";const We=Object.values(e.EventType);var He,Je,Ke,Ye;e.MoveType=void 0,(He=e.MoveType||(e.MoveType={})).Audio="audio",He.Effect="effect",He.Video="video",e.MasherAction=void 0,(Je=e.MasherAction||(e.MasherAction={})).Redo="redo",Je.Remove="remove",Je.Render="render",Je.Save="save",Je.Undo="undo",e.GraphType=void 0,(Ke=e.GraphType||(e.GraphType={})).Mash="mash",Ke.Cast="cast",e.ServerType=void 0,(Ye=e.ServerType||(e.ServerType={})).Api="api",Ye.Data="data",Ye.File="file",Ye.Rendering="rendering",Ye.Streaming="streaming",Ye.Web="web";const Xe=Object.values(e.ServerType);var Ze,Qe;e.Duration=void 0,(Ze=e.Duration||(e.Duration={}))[Ze.Unknown=-1]="Unknown",Ze[Ze.Unlimited=-2]="Unlimited",Ze[Ze.None=0]="None",e.Timing=void 0,(Qe=e.Timing||(e.Timing={})).Custom="custom",Qe.Content="content",Qe.Container="container";const et=Object.values(e.Timing);var tt;e.Sizing=void 0,(tt=e.Sizing||(e.Sizing={})).Preview="preview",tt.Content="content",tt.Container="container";const it=Object.values(e.Sizing),nt={start:"",status:"",stop:""},st={...nt,upload:""},rt={delete:"",get:"",put:"",retrieve:""},ot={cast:{...rt,default:""},mash:{...rt,default:""},stream:{...rt},definition:{...rt}},at={...nt,...rt,preload:"",cut:"",webrtc:"",rtmp:"",remote:"",local:""},ct={[e.ServerType.Api]:{servers:"",callbacks:""},[e.ServerType.Data]:ot,[e.ServerType.File]:{store:""},[e.ServerType.Rendering]:st,[e.ServerType.Streaming]:at};Object.entries(ct).forEach((([e,t])=>{n(t)&&Object.entries(t).forEach((([i,n])=>{r(n)?t[i]=`/${e}/${i}`:Object.entries(n).forEach((([t,s])=>{s||(n[t]=`/${e}/${i}/${t}`)}))}))}));const lt={},ut=lt,ht=()=>{},dt="http://www.w3.org/2000/svg",pt="com.moviemasher.",mt=".default",ft=e=>n(e)&&"id"in e&&(!e.type||Te(e.type)),gt=e=>n(e)&&Te(e.type)&&"instanceFromObject"in e;function yt(e,t){gt(e)||i(e,"Definition",t)}class vt{static byId=new Map;static byIdAdd(e){(Array.isArray(e)?e:[e]).forEach((e=>this.byId.set(e.id,e)))}static byType(e){const t=this.definitionsByType.get(e);if(t)return t;const i=ut[e].defaults||[];return this.definitionsByType.set(e,i),i}static define(...e){return e.map((e=>this.fromObject(e)))}static definitionDelete(e){const{type:t}=e,i=this.byType(t),n=i.indexOf(e);n<0||i.splice(n,1)}static definitionUninstall(e){if(!this.installed(e))return;const t=this.fromId(e);this.byId.delete(e),this.definitionDelete(t)}static definitionsByType=new Map;static definitionsType(e){const t=e.split(".").slice(-2).shift();return Te(t)?t:void 0}static fromId(e){if(this.installed(e))return this.byId.get(e);const t=this.definitionsType(e);return be(t,`in Defined.fromId('${e}')`),ut[t].definitionFromId(e)}static fromObject(e){const{id:t,type:i}=e;if(x(t),this.installed(t)||this.predefined(t))return this.fromId(t);const n=i||this.definitionsType(t);return be(n),this.install(ut[n].definition(e))}static get ids(){return[...this.byId.keys()]}static install(e){const{type:t,id:i}=e;return this.installed(i)?(this.uninstall(e),this.updateDefinition(this.fromId(i),e)):(this.byIdAdd(e),this.byType(t).push(e),e)}static installed(e){return this.byId.has(e)}static predefined(e){return e.startsWith(pt)}static undefineAll(){this.byId=new Map,this.definitionsByType=new Map}static updateDefinition(e,t){return this.uninstall(e),this.install(t),t}static updateDefinitionId(e,t){const i=this.byId.get(e);yt(i),this.byId.delete(e),this.byId.set(t,i)}static uninstall(e){const{type:t,id:i}=e,n=this.definitionsByType.get(t);V(n);const s=n.indexOf(e);return y(s),n.splice(s,1),this.byId.delete(i),e}}const Tt="rgb".split(""),bt=[...Tt,"a"],wt="#00000000",Ft="#000000",St="#FFFFFF",It="#FFFFFF00",xt="#00000000",Ct="#000000FF",Dt="#00FF00";var Pt;e.Color=void 0,(Pt=e.Color||(e.Color={})).Transparent="#00000000",Pt.Black="#000000",Pt.White="#FFFFFF",Pt.WhiteTransparent="#FFFFFF00",Pt.BlackTransparent="#00000000",Pt.WhiteOpaque="#FFFFFFFF",Pt.BlackOpaque="#000000FF",Pt.Green="#00FF00",Pt.Yellow="#FFFF00",Pt.Red="#FF0000",Pt.Blue="#0000FF";const At=Object.values(e.Color),Et=t=>{for(const i of Object.entries(e.Color)){const[e,n]=i;if(n===t)return e}return""},Vt=e=>Math.min(255,Math.max(0,Math.floor(Number(e)))),zt=e=>({r:Vt(e.r),g:Vt(e.g),b:Vt(e.b)}),Ot=e=>({y:Vt(e.y),u:Vt(e.u),v:Vt(e.v)}),Rt=e=>{let t=e.r.toString(16),i=e.g.toString(16),n=e.b.toString(16);return t.length<2&&(t=`0${t}`),i.length<2&&(i=`0${i}`),n.length<2&&(n=`0${n}`),`#${t}${i}${n}`},kt=e=>{let t=e.r.toString(16),i=e.g.toString(16),n=e.b.toString(16),s=Math.round(255*Number(e.a)).toString(16);return t.length<2&&(t=`0${t}`),i.length<2&&(i=`0${i}`),n.length<2&&(n=`0${n}`),s.length<2&&(s=`0${s}`),`#${t}${i}${n}${s}`},_t=(e,t,i,n)=>{const s=e.u-t.u,r=e.v-t.v,o=Math.sqrt((s*s+r*r)/65025);return n>1e-4?255*Math.min(1,Math.max(0,(o-i)/n)):o>i?255:0},Mt=(e,t,i,n)=>{let s=0;const r=Ot(t);return e.forEach((e=>{const t=Ot(e),i=t.u-r.u,n=t.v-r.v;s+=Math.sqrt((i*i+n*n)/65025)})),s/=e.length,n>1e-4?255*Math.min(1,Math.max(0,(s-i)/n)):s>i?255:0},Nt=e=>{const t=zt(e);return{y:.299*t.r+.587*t.g+.114*t.b,u:-.168736*t.r+-.331264*t.g+.5*t.b+128,v:.5*t.r+-.418688*t.g+-.081312*t.b+128}},$t=/^rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)$/,jt=/^rgba\((\d{1,3}),(\d{1,3}),(\d{1,3}),(\d*(?:\.\d+)?)\)$/,Lt=/^#([A-Fa-f0-9]{3,4}){1,2}$/,qt=e=>e.toLowerCase().replaceAll(/[\s]/g,""),Gt=e=>{const t=qt(e);if(Bt(t)||Ut(t)||Wt(t))return!0;const i=(new Option).style;i.color=e;const n=qt(i.color);return!!n&&(!(!Ut(t)&&!Wt(t))||n===t)},Bt=e=>Lt.test(e),Ut=e=>jt.test(e),Wt=e=>$t.test(e),Ht=(e,t)=>e.match(new RegExp(`.{${t}}`,"g")),Jt=e=>parseInt(e.repeat(2/e.length),16),Kt=e=>g(e)?Math.max(0,Math.min(1,e/255)):1,Yt=e=>{if(!Bt(e))return ii;const t=Math.floor((e.length-1)/3),i=Ht(e.slice(1),t);if(!i)return ii;const[n,s,r,o]=i.map(Jt);return{r:n,g:s,b:r,a:Kt(o)}},Xt=e=>{if(!Bt(e))return ti;const t=Math.floor((e.length-1)/3),i=Ht(e.slice(1),t);if(!i)return ti;const[n,s,r]=i.map(Jt);return{r:n,g:s,b:r}},Zt=e=>{const t=qt(e).match(jt);return t?{r:Number(t[1]),g:Number(t[2]),b:Number(t[3]),a:Number(t[4])}:ii},Qt=e=>{const t=qt(e);if(Bt(t))return Xt(t);const i=t.match($t);return i?{r:Number(i[1]),g:Number(i[2]),b:Number(i[3])}:ti},ei=e=>{if(!Gt(e))return ii;const t=qt(e);return Bt(t)?Yt(t):Ut(t)?Zt(t):Wt(t)?{a:1,...Qt(t)}:ii},ti={r:0,g:0,b:0},ii={...ti,a:1},ni={...ti,a:0},si=[e.DataType.Frame,e.DataType.Percent,e.DataType.Number],ri=e=>Ve(e)&&si.includes(e),oi=t=>t!==e.DataType.Boolean&&!ri(t),ai=t=>{if(Te(t))return`${pt}${t}.default`;switch(t){case e.DataType.Boolean:return!1;case e.DataType.Rgb:return Ft}return ri(t)?0:""},ci=(t,i)=>{if(Te(i))return I(t);switch(i){case e.DataType.Boolean:return(e=>!!u(e)||(m(e)?0===e||1===e:["true","false",""].includes(e)))(t);case e.DataType.Rgb:return Gt(String(t));case e.DataType.Frame:case e.DataType.Percent:case e.DataType.Number:return E(t);case e.DataType.String:return!0;case e.DataType.ContainerId:case e.DataType.ContentId:case e.DataType.FontId:case e.DataType.DefinitionId:default:return I(t)}return!1},li=(t,i)=>i===e.DataType.Boolean?u(t)?t:E(t)?!!Number(t):"true"===t:ri(i)?E(t)?Number(t):0:String(t),ui="End";class hi{constructor(...e){}addProperties(e,...t){this.properties.push(...t),t.forEach((t=>{this.propertyTweenSetOrDefault(e,t)}))}properties=[];get propertiesCustom(){return this.properties.filter((e=>e.custom))}propertiesInitialize(e){s(e),this.properties.forEach((t=>this.propertyTweenSetOrDefault(e,t)))}propertyFind(e){return this.properties.find((t=>t.name===e))}propertyName(e){return e.endsWith(ui)?e.slice(0,-ui.length):e}propertySetOrDefault(e,t,i,n){const s=e[i],r=a(s)?n:s;this.setValue(r,i,t)}propertyTweenSetOrDefault(e,t){const{name:i,defaultValue:n,tweenable:s}=t;this.propertySetOrDefault(e,t,i,n),s&&this.propertySetOrDefault(e,t,`${i}${ui}`)}setValue(e,t,i){if(a(e))return void delete this[t];const n=this.propertyName(t),s=i||this.propertyFind(n);V(s,`${this.constructor.name}.${n} in ${this.properties.map((e=>e.name)).join(", ")}`);const r=s.type;if(!ci(e,r))return void(n!==t&&delete this[t]);const o=li(e,r);this[t]=o}setValues(e){Object.entries(e).forEach((([e,t])=>{this.setValue(t,e)}))}toJSON(){return Object.fromEntries(this.properties.flatMap((e=>{const{name:t,tweenable:i}=e,n=[[t,this.value(t)]];if(i){const e=`${t}${ui}`;n.push([e,this.value(e)])}return n})))}value(e){return this[e]}}const di=e=>n(e)&&("definitionId"in e||"definition"in e),pi=e=>n(e)&&"definitionIds"in e,mi=e=>pi(e)&&gt(e.definition);function fi(e){if(!mi(e))throw new Error("expected Tweenable")}const gi=e=>gt(e);const yi=`${pt}container.default`,vi=`${pt}container.text`,Ti=e=>n(e)&&"opacity"in e;const bi=e=>mi(e)&&Ce(e.type);function wi(e){if(!bi(e))throw new Error("expected Container")}const Fi=e=>n(e)&&m(e.x)&&m(e.y);function Si(e,t){Fi(e)||i(e,"Point",t)}const Ii=(e,t)=>!!Fi(t)&&(e.x===t.x&&e.y===t.y),xi={x:0,y:0},Ci=e=>{const{x:t,y:i}=e;return{x:t,y:i}},Di=e=>{const{x:t,y:i}=e;return{x:Math.round(t),y:Math.round(i)}},Pi=e=>{const{x:t,y:i}=e;return`x=${t};y=${i}`},Ai=e=>n(e)&&m(e.width)&&m(e.height);function Ei(e,t){Ai(e)||i(e,"Size",t)}const Vi=(e,t)=>!!Ai(t)&&(e.width===t.width&&e.height===t.height),zi={width:0,height:0},Oi=e=>2*Math.max(1,Math.ceil(e/2)),Ri=e=>{const{width:t,height:i}=e;return{width:Oi(t),height:Oi(i)}},ki=e=>{const{width:t,height:i}=e;return{width:Math.round(t),height:Math.round(i)}},_i=e=>{const{width:t,height:i}=e;return{width:Math.max(2,Math.ceil(t)),height:Math.max(2,Math.ceil(i))}},Mi=(e,t,i)=>{const{width:n,height:s}=e;return{width:n*t,height:s*i}},Ni=(e,t,i=!1)=>{ji(e),Ei(t);const{width:n,height:s}=e,{width:r,height:o}=t,a=r/n,c=o/s;return _i((i?a<c:a>c)?{...t,height:s*a}:{...t,width:n*c})},$i=e=>{if(!Ai(e))return!1;const{width:t,height:i}=e;return T(t)&&T(i)};function ji(e,t){$i(e)||i(e,"SizeAboveZero",t)}const Li={width:1920,height:1080},qi=Mi(Li,.25,.25),Gi=Mi(qi,.5,.5),Bi=e=>{const{width:t,height:i}=e;return{width:t,height:i}},Ui=(t,i)=>{const n=Bi(t);switch(i){case e.Orientation.H:n.width=n.height;break;case e.Orientation.V:n.height=n.width}return n},Wi=e=>{const{width:t,height:i}=e;return`width=${t};height=${i}`},Hi=(t,i)=>{ji(t);const n=Bi(t);return i&&(i===e.Orientation.V?n.height=-1:n.width=-1),n},Ji=e=>Ai(e)&&Fi(e);function Ki(e,t){Ji(e)||i(e,"Rect",t)}const Yi=(e,t)=>!!Ji(t)&&(Ii(e,t)&&Vi(e,t)),Xi={...xi,...zi},Zi=(e,t)=>{const i=t||xi,{width:n,height:s}=e;return{x:i.x,y:i.y,width:n,height:s}},Qi=(e,t)=>({x:Math.round((e.width-t.width)/2),y:Math.round((e.height-t.height)/2)}),en=e=>e[e.length-1],tn=(e,t)=>(e.splice(0,e.length,...t),e),nn=e=>[...e].reverse(),sn=e=>[...new Set(e)];var rn;e.DataGroup=void 0,(rn=e.DataGroup||(e.DataGroup={})).Point="point",rn.Size="size",rn.Opacity="opacity",rn.Color="color",rn.Effects="effects",rn.Timing="timing",rn.Sizing="sizing";const on=Object.values(e.DataGroup),an=e=>on.includes(e);const cn=e=>n(e)&&"type"in e&&Ve(e.type);function ln(e,t){cn(e)||i(e,"Property",t)}const un=t=>{const{type:i,name:n,defaultValue:s,...r}=t,o=((t,i)=>a(t)?u(i)?e.DataType.Boolean:m(i)?e.DataType.Number:e.DataType.String:(ze(t),t))(i,s),c=((e,t)=>a(t)?ai(e):t)(o,s),l={type:o,defaultValue:c,name:I(n)?n:o,...r};if(i===e.DataType.Percent)a(l.max)&&(l.max=1),a(l.min)&&(l.min=0),a(l.step)&&(l.step=.01);return l},hn="Invalid argument ",dn="Invalid property ",pn="Internal Error ",mn={eval:{sourceRect:"Invalid evaluation of source rect ",outputSize:"Invalid evaluation of output size ",inputSize:"Invalid evaluation of input size ",conditionTruth:"Expected at least one condition to evaluate to true ",conditionValue:"Expected condition to have a value ",number:"Expected evaluated number for ",get:"Expected to get evaluated value ",string:"Invalid evaluation string "},composition:{mashUndefined:`${pn}composition.mash undefined`},audibleContext:"Expected AudioContext",mash:"Expected mash",action:"Expected Action",actions:"Expected Actions",internal:pn,argument:"Invalid argument ",invalid:{canvas:"Invalid property canvas ",context:"Invalid property context ",duration:"Invalid duration",definition:{audio:"Invalid definition property audio|url",url:"Invalid definition property url",source:"Invalid definition property source",id:"Invalid definition property id ",object:"Invalid property definition",type:"Invalid definition property type "},size:"Invalid size ",track:"Invalid track ",trackType:"Invalid property trackType ",action:"Invalid action ",name:"Invalid property name ",value:"Invalid property value ",type:"Invalid property type ",url:"Invalid property url ",user:"Unauthenticated",property:dn,argument:hn,object:"Invalid argument object ",factory:"Invalid factory ",volume:"Invalid argument volume"},type:"Unknown type ",selection:"Invalid selection ",unknown:{type:"Unknown type ",merger:"Unknown merger ",effect:"Unknown effect ",filter:"Unknown filter ",font:"Unknown font ",scaler:"Unknown scalar ",definition:"Unknown definition "},uncached:"Uncached URL ",object:"Invalid argument object ",array:"Invalid argument array ",media:"Invalid argument media ",id:"Invalid argument id ",frame:"Invalid argument frame ",frames:"Invalid property frames ",fps:"Invalid argument fps ",seconds:"Invalid argument seconds ",url:"Invalid argument url ",time:"Invalid argument Time",timeRange:"Invalid argument TimeRange",mainTrackOverlap:`${pn}: main track clips overlap without transition`,unknownMash:"Unknown Mash property ",unimplemented:"Expected method to be overridden ",property:"Invalid argument property ",wrongClass:"Expected instance of "};class fn{constructor({name:t,value:i,dataType:n,values:s}){if(!t)throw mn.invalid.name;if(this.values=s,this.name=t,a(i)){if(!this.values?.length)throw mn.invalid.value;this.value=this.values[0]}else this.value=i;if(n&&Ee.map(String).includes(n))this.dataType=n;else{let t=!1;t=Array.isArray(this.value)?this.value.every((e=>E(e.value))):E(this.value),t&&(this.dataType=e.DataType.Number)}}dataType=e.DataType.String;name;toJSON(){return{name:this.name,value:this.value}}value;values}const gn={count:0,prefix:"",countsByPrefix:{}},yn=()=>{const e=[];return gn.prefix&&e.push(gn.prefix),e.push(Date.now().toString(36)),e.push(Math.random().toString(36).slice(2)),e.join("-")},vn=()=>{const{prefix:e}=gn,t=[];return e?(t.push(e),gn.countsByPrefix[e]||=0,t.push(String(gn.countsByPrefix[e]++))):t.push(String(gn.count++)),t.join("")},Tn=(e=gn.prefix)=>{const t=[];return e?(t.push(e),gn.countsByPrefix[e]||=0,t.push(String(gn.countsByPrefix[e]++))):t.push(String(gn.count++)),t.join("")},bn=e=>!!I(gn.prefix)&&e.startsWith(gn.prefix);class wn extends hi{constructor(...e){super(...e);const[t]=e;A(t);const{definition:i}=t;yt(i),this.definition=i,this.properties.push(...this.definition.properties),this.propertiesInitialize(t)}copy(){return this.definition.instanceFromObject(this.toJSON())}definition;get definitionId(){return this.definition.id}definitionIds(){return[this.definitionId]}_id;get id(){return this._id||=yn()}_label="";get label(){return this._label}set label(e){this._label=e}get propertyNames(){return this.properties.map((e=>e.name))}toJSON(){const e=super.toJSON(),{definitionId:t,type:i,label:n}=this;return n&&(e.label=n),e.type=i,e.definitionId=t,e}get type(){return this.definition.type}}const Fn=e=>`#${e}`,Sn=e=>`url(${Fn(e)})`,In=(e,t="")=>{const i=globalThis.document.createElementNS(dt,"g");return $n(i,t),xn(i,e),i},xn=(e,t)=>{if(Ai(t)){const{width:i,height:n}=t;g(i)&&$n(e,String(i),"width"),g(n)&&$n(e,String(n),"height")}if(Fi(t)){const{x:i,y:n}=t;$n(e,String(i),"x"),$n(e,String(n),"y")}},Cn=e=>{const{width:t,height:i,x:n=0,y:s=0}=e,r={x:n,y:s},o=[];return o.push(r),o.push({x:n+t,y:s}),o.push({x:n+t,y:s+i}),o.push({x:n,y:s+i}),o.push(r),o},Dn=(e,t,i="",n)=>{const s=globalThis.document.createElementNS(dt,"polygon"),r=Cn(e).map((e=>[e.x,e.y].join(","))).join(" ");return $n(s,r,"points"),$n(s,i,"fill"),jn(s,t),$n(s,n),s},Pn=(e,t)=>{ji(t);const i=Bi(t),{width:n,height:s}=i;xn(e,i);$n(e,`0 0 ${n} ${s}`,"viewBox")},An=(e,t)=>{const i=globalThis.document.createElementNS(dt,"svg");return $n(i,"1.1","version"),$n(i,dt,"xmlns"),kn(i,t),$i(e)?(Pn(i,e),i):i},En=(e,t,i)=>{ji(t),i||$n(e,"none","preserveAspectRatio");const n={...Hi(t,i),...Ci(t)};xn(e,n)},Vn=()=>{const e=globalThis.document.createElementNS(dt,"image");return $n(e,"none","preserveAspectRatio"),e},zn=(e,t="currentColor")=>{const i=globalThis.document.createElementNS(dt,"path");return $n(i,e,"d"),$n(i,t,"fill"),i},On=(e,t,i)=>{const n=yn(),s=globalThis.document.createElementNS(dt,"mask");if($n(s,n),$i(e)){kn(s,Dn(e,"",i?"black":"none"))}return t&&($n(t,Sn(n),"mask"),i&&$n(t,"luminance","mask-mode")),s},Rn=(e,t)=>{const{filter:i,...n}=e;x(i);const s=globalThis.document.createElementNS(dt,i);return xn(s,t),Object.entries(n).forEach((([e,t])=>{$n(s,String(t),e)})),s},kn=(e,t)=>{if(!t)return;(w(t)?t:[t]).forEach((t=>e.appendChild(t)))},_n=e=>{const t=globalThis.document.createElementNS(dt,"defs");return kn(t,e),t},Mn=(e,t)=>{const i=globalThis.document.createElementNS(dt,"feImage");return I(e)&&$n(i,Fn(e),"href"),$n(i,t,"result"),i},Nn=(e,t,i,n="userSpaceOnUse")=>{const s=globalThis.document.createElementNS(dt,"filter");if(n&&$n(s,n,"filterUnits"),$n(s,"sRGB","color-interpolation-filters"),kn(s,e),t){const e=yn();if($n(s,e),t){(w(t)?t:[t]).forEach((t=>{$n(t,Sn(e),"filter"),jn(t,"filtered")}))}}return xn(s,i),s},$n=(e,t,i="id")=>{I(t)&&e.setAttribute(i,t)},jn=(e,t)=>{if(!t)return;const i=w(t)?t:t.split(" ");e.classList.add(...i)},Ln=(e,t,i)=>{const n=globalThis.document.createElementNS(dt,"use");return I(e)&&$n(n,Fn(e),"href"),$n(n,i),jn(n,t),n},qn=(e,t,i="top left")=>{$n(e,t,"transform"),$n(e,i,"transform-origin")},Gn=(e,t)=>{ji(e),ji(t);const{width:i,height:n}=e,{width:s,height:r,x:o,y:a}=t,c=s/i,l=r/n,u=[];if(0===o&&0===a||u.push(`translate(${o},${a})`),1===c&&1===l||u.push(`scale(${c},${l})`),Fi(e)){const{x:t,y:i}=e;0===t&&0===i||u.push(`translate(${t},${i})`)}return u.join(" ")},Bn=(e,t,i)=>{qn(e,Gn(t,i))},Un=(e,t)=>{if(!e.hasChildNodes())return kn(e,t);const{childNodes:i}=e,n=[];i.forEach((e=>{t.includes(e)||n.push(e)})),n.forEach((t=>{e.removeChild(t)})),t.forEach((t=>e.appendChild(t)))},Wn=e=>e instanceof HTMLVideoElement,Hn=e=>e instanceof HTMLImageElement,Jn=e=>e instanceof AudioBuffer,Kn=e=>pe(e)||ue(e);function Yn(e,t){Kn(e)||i(e,"LoaderType",t)}const Xn=e=>I(e)&&e.includes(":");const Zn=(e={})=>{const{baseURI:t}=globalThis.document,i=new URL(t),{protocol:n,host:s,pathname:r,port:o}=i,a=s.split(":").shift(),c={protocol:n.slice(0,-1),host:a,prefix:r,...e};return E(o)&&(c.port=Number(o)),c},Qn=e=>e.startsWith("object:/"),es=e=>e.startsWith("http"),ts=e=>e.includes(":"),is=(e,t)=>(e.endsWith("/")?e.slice(0,-1):e)+"/"+(t.startsWith("/")?t.slice(1):t),ns=e=>{const t=Zn(e),{port:i,prefix:n,host:s,protocol:r}=t;x(s),x(r);const o=[];o.push(r,"://",s),E(i)&&o.push(":",String(i));const a=o.join("");return n?is(a,n):a},ss=(e,t="")=>{if(t&&ts(t))return t;const i=ns(e),n=i.endsWith("/")?i:i+"/";if(!ts(n))return n+t;const s=new URL(t,n),{href:r}=s;return r},rs=e=>"object"===e||es(e)||!Kn(e),os=e=>{const t=e.indexOf(":");return T(t)?e.slice(0,t):""},as=e=>{const t=e.indexOf(":"),i=e.indexOf("/");if(!g(t)||!g(i))return[];return[e.slice(0,t),e.slice(t+1,i),e.slice(i+1)]},cs=e=>{if(!e)return[];const t=[as(e)];let i="";for(;i=en(en(t));){const e=as(i);if(!e.length)break;const[n,s,r]=e;if("object"===n||es(n))break;if(t.push(e),rs(os(r)))break}return t},ls=(e,t)=>{if(!e||rs(os(e)))return[];const i=cs(e),n=en(i);if(!n)return i;const s=en(n);if(Qn(s)||es(s))return i;let r=ss(t,s);const{length:o}=i;for(let e=o-1;e>-1;e--){const t=i[e],[n,s]=t;t[2]=r,r=`${n}:${s}/${r}`}return i},us=e=>{if(!I(e))return;const t=e.split(";").map((e=>{const[t,i]=e.split("=");return[t,E(i)?Number(i):i]}));return Object.fromEntries(t)},hs=e=>e?Object.entries(e).map((e=>e.join("="))).join(";"):"",ds=(e,t,i)=>t.startsWith(e)&&!i?t:`${e}:${hs(i)}/${t}`;class ps{constructor(...e){const[t]=e,{id:i,label:n,icon:s}=t;x(i,"id"),this.id=i,I(n)&&(this.label=n),I(s)&&(this.icon=s)}icon;id;urlIcon(e,t,i){const n=ds("image",e);return t.loadPromise(n).then((e=>{const{width:s,height:r}=e,o=Ni({width:s,height:r},i,!0),a={...o,...Qi(i,o)},c=ds("svg",n,a);return t.loadPromise(c).then((e=>An(i,e)))}))}definitionIcon(e,t){const{icon:i}=this;if(i)return this.urlIcon(i,e,t)}instanceFromObject(e={}){return new wn(this.instanceArgs(e))}instanceArgs(e={}){return{...Object.fromEntries(this.properties.map((e=>[e.name,e.defaultValue]))),...e,definition:this}}label="";properties=[];get propertiesModular(){return this.properties.filter((e=>Te(e.type)))}toJSON(){const e={id:this.id,type:this.type};return this.icon&&(e.icon=this.icon),this.label!==this.id&&(e.label=this.label),e}toString(){return this.label}type;static fromObject(e){const{id:t,type:i}=e;return be(i),x(t,"id"),ut[i].definition(e)}}class ms extends wn{constructor(...e){super(...e);const[t]=e;if(!P(t))throw mn.invalid.object+"filter";const{parameters:i}=t;i?.length&&this.parameters.push(...i.map((e=>{const{name:t,dataType:i}=e;if(!i){const i=this.definition.parameters.find((e=>e.name===t));i&&(e.dataType=i.dataType)}return new fn(e)})))}commandFilters(e){return this.definition.commandFilters({...e,filter:this})}parameters=[];_parametersDefined;get parametersDefined(){if(this._parametersDefined)return this._parametersDefined;const e=[...this.parameters];return e.push(...this.definition.parameters.filter((t=>!e.find((e=>e.name===t.name))))),this._parametersDefined=e}filterSvg(e={}){return this.definition.filterDefinitionSvg({...e,filter:this})}filterSvgFilter(){const e=this.scalarObject();return this.definition.filterDefinitionSvgFilter(e)}scalarObject(e=!1){const t={},{parametersDefined:i}=this;return i.forEach((e=>{const{name:i,value:n}=e;if(I(n)){if(this.properties.find((e=>n===e.name)))return}(m(n)||r(n))&&(t[i]=n)})),this.properties.forEach((i=>{const{tweenable:n,name:s}=i;if(h(t[s]))return;if(t[s]=this.value(s),!e||!n)return;const r=`${s}${ui}`;t[r]=this.value(r)})),t}toJSON(){const e={id:this.definitionId};return this.parameters.length&&(e.parameters=this.parameters),e}toString(){return`[Filter ${this.label}]`}}class fs extends ps{commandFilters(e){const{filter:t,duration:i,filterInput:n}=e;x(n);const s=[],r=t.scalarObject(!!i);j(r);const{ffmpegFilter:o}=this,a={inputs:[n],ffmpegFilter:o,options:r,outputs:[Tn(o)]};return s.push(a),s}commandFilter(e={}){const{ffmpegFilter:t}=this;return{ffmpegFilter:t,options:e,inputs:[],outputs:[Tn(t)]}}_ffmpegFilter;get ffmpegFilter(){return this._ffmpegFilter||=this.id.split(".").pop()||this.id}filterDefinitionSvg(e){throw new Error(mn.unimplemented+"initialSvgContent")}instanceFromObject(e={}){return new ms(this.instanceArgs(e))}parameters=[];populateParametersFromProperties(){this.parameters=this.properties.map((t=>{const{name:i}=t;return new fn({name:i,value:i,dataType:e.DataType.String})}))}filterDefinitionSvgFilter(e){throw mn.unimplemented}colorCommandFilter(e,t=0,i=0,n="#FFFFFF00"){const{width:s,height:r}=e,o="color",a=Tn(o),c={color:n,size:`${s}x${r}`};t&&(c.rate=t),i&&(c.duration=i);return{inputs:[],ffmpegFilter:o,options:c,outputs:[a]}}type=e.DefinitionType.Filter}class gs extends fs{constructor(...t){super(...t),this.properties.push(un({custom:!0,name:"color",type:e.DataType.String,defaultValue:Dt})),this.properties.push(un({custom:!0,name:"similarity",type:e.DataType.Percent,defaultValue:.9,min:.1,step:.01,max:1})),this.properties.push(un({custom:!0,name:"blend",type:e.DataType.Percent,defaultValue:0,step:.01,max:1})),this.populateParametersFromProperties()}filterDefinitionSvgFilter(e){const{similarity:t,color:i,blend:n}=e;l(t),l(n),x(i);const s=255,r=65025*(1-n),o=Qt(i),a=[],c={filter:"feColorMatrix",type:"matrix",values:`1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 ${1-t*(o.r/s)} ${1-t*(o.g/s)} ${1-t*(o.b/s)} -${r} ${r}`};return a.push(Rn(c)),a}}const ys=(e="")=>{switch(e){case"ceil":return Math.ceil;case"floor":return Math.floor;default:return Math.round}},vs=(e,t="")=>ys(t)(e),Ts=(e,t)=>({r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]}),bs=(e,t,i)=>{const{x:n,y:s}=t,{width:r,height:o}=i,a=((e,t)=>({x:e%t,y:Math.floor(e/t)}))(e,r);return a.x=Math.max(0,Math.min(r-1,a.x+n)),a.y=Math.max(0,Math.min(o-1,a.y+s)),((e,t)=>e.y*t+e.x)(a,r)},ws=(e,t,i)=>((e,t)=>{const i=[],n=Math.floor(1.5);for(let s=0;s<3;s+=1)for(let r=0;r<3;r+=1){const o={x:r-n,y:s-n};i.push(bs(e,o,t))}return i})(e,i).map((e=>((e,t)=>Ts((e=>4*e)(e),t))(e,t))),Fs=e=>{const t=String(e);return"0x"===t.slice(0,2)?`#${t.slice(2)}`:t},Ss=(e,t,i="round")=>e&&t?vs(e/t,i):0;function Is(e,t,i=1){return Object.fromEntries(bt.map((n=>[n,Math.round(e[n]*i+t[n]*(1-i))])))}function xs(e,t,i=1){return Object.fromEntries(Tt.map((n=>[n,Math.round(e[n]*(1-i)+t[n]*i)])))}const Cs=(e,t,i,n,s=0,r=0,o=!1)=>{const a=Nt(i);let c=e.length/4;for(;c--;){const i=4*c,l=Ts(i,e);if(g(l.a)){const u=Nt(l),h=Is(l,n,o?Mt(Ds(e,c,t),a,s,r):_t(u,a,s,r));e[i+3]=h.a,h.a&&(e[i]=h.r,e[i+1]=h.g,e[i+2]=h.b)}}},Ds=(e,t,i)=>ws(4*t,e,i).map((e=>Nt(e))),Ps=(e,t,i,n=!1,s=!1)=>{y(i),y(t);const r=n?t:0;return(e-t+r+(s?t:0))*i-r},As=(e,t,i,n)=>e+(t-e)/n*i,Es=(e,t,i,n)=>{o(e),o(t);const s=i/n;if(V(Bt(e),"hex color"),7===e.length||4===e.length){return Rt(xs(Qt(e),Qt(t),s))}return kt(Is(ei(e),ei(t),s))},Vs=(e,t,i,n)=>({x:As(e.x,t.x,i,n),y:As(e.y,t.y,i,n),width:As(e.width,t.width,i,n),height:As(e.height,t.height,i,n)}),zs=(e,t)=>{const{width:i,height:n}=e;return!Ai(t)||Vi(e,t)?{width:i,height:n}:{width:Math.max(i,t.width),height:Math.max(n,t.height)}},Os=(e,t,i,n)=>{l(e);const s=n?Math.round(e):e;if(!m(t))return s;const r=n?Math.round(t):t;return s===r?s:(i.includes("n"),`(${s}+(${r-s}*${i}))`)},Rs=(e,t,i="n")=>`(${i}/${e*t})`,ks=e=>{if(!n(e))return{};const t=Object.entries(e).filter((([e,t])=>m(t)));return Object.fromEntries(t)},_s=(e,t)=>({...e,...ks(t)}),Ms=(e,t)=>({...e,...ks(t)}),Ns=(e,t)=>h(t)?{...e,...ks(t)}:e,$s=(e,t,i={})=>{Ei(e),Ki(t);const{width:n,height:s}=e,{x:r,y:o,width:a,height:c}=t;y(r),y(o),y(a),y(c);const l=Mi(e,a,c),u=_i(l);return{...u,x:Math.round(Ps(n,u.width,r,i.E,i.W)),y:Math.round(Ps(s,u.height,o,i.N,i.S))}},js=(e,t,i)=>{const n=w(t)?t:[t,t],[s,r]=n,o=Ni(e,s),a=Ni(e,r),[c,l]=i,{width:u,height:h}=c,{width:d,height:p}=l,m=Mi(o,u,h),f=Mi(a,d,p);return[_i(m),_i(f)]},Ls=(e,t,i)=>{const n=w(t)?t:[t,t],[s,r]=e,[o,a]=n,[c,l]=i,{x:u,y:h}=c,{x:d,y:p}=l;return[{x:u*(s.width-o.width),y:h*(s.height-o.height)},{x:d*(r.width-a.width),y:p*(r.height-a.height)}]},qs=(e,t)=>({...e,...Ui(e,t)}),Gs=(e,t)=>e.map((e=>qs(e,t))),Bs=(t,i,n,s)=>{if(!s)return t;const{width:r,height:o}=i,a={...t};switch(s){case e.Orientation.H:a.width=o*a.height*n/r;break;case e.Orientation.V:a.height=r*a.width/n/o}return a},Us=e=>{fi(e);const{clip:t}=e,{track:i}=t,{mash:n}=i,{quantize:s}=n,r=t.timeRange(s),o=e.tweenPoints(r,r);return!Ii(...o)},Ws=(e,t,i)=>Math.min(i,Math.max(t,e));class Hs extends fs{constructor(...t){super(...t),this.properties.push(un({tweenable:!0,custom:!0,name:"color",type:e.DataType.String})),this.populateParametersFromProperties()}_ffmpegFilter="geq";commandFilters(e){const t=[],{filter:i,videoRate:n,duration:s,filterInput:r}=e;l(s,"duration"),l(n,"videoRate");const o=i.value("color");x(o,"color");let a=r;x(a,"filterInput");const c="format",u=Tn(c),h={inputs:[a],ffmpegFilter:c,options:{pix_fmts:"rgba"},outputs:[u]};t.push(h),a=u;const d=i.value(`color${ui}`)||o;x(d);const p=o.length>7,m=p?ei(o):Qt(o),f=p?ei(d):Qt(d),g=p?bt:Tt,y={},v=s?Rs(n,s,"N"):0;g.forEach((e=>{const t=m[e],i=f[e];y[e]=t===i?t:`${t}+(${i-t}*${v})`})),p||(y.a="alpha(X,Y)");const T=Tn("geq"),b={inputs:[a],ffmpegFilter:"geq",options:y,outputs:[T]};return t.push(b),t}}class Js extends Hs{constructor(...t){super(...t),this.properties.push(un({tweenable:!0,name:"color",type:e.DataType.String}));["width","height"].forEach((t=>{this.properties.push(un({tweenable:!0,name:t,type:e.DataType.Number}))})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,videoRate:n,duration:s}=e;b(n,"videoRate");const{ffmpegFilter:r}=this;let o=Tn(r);const a=i.value("color");x(a);const c=s?i.value(`color${ui}`):void 0,u=I(c)&&a!==c,h=i.scalarObject(!!s);Ei(h);const{width:d,height:p}=h;let m=!1;const f={width:d,height:p},g={width:d,height:p};if(s){const{[`width${ui}`]:e=d,[`height${ui}`]:t=p}=h;l(e),l(t),m=!(d===e&&p===t),m&&(g.width=e,g.height=t)}const y=m?zs(f,g):f,v={inputs:[],ffmpegFilter:r,options:{color:a,rate:n,size:Object.values(y).join("x")},outputs:[o]};if(T(s)&&(v.options.duration=s),t.push(v),u){const e="fade",i=Tn(e),n={inputs:[o],ffmpegFilter:e,options:{type:"out",color:c,duration:s},outputs:[i]};t.push(n),o=i}if(m){const e="scale",i=Tn(e),r=Rs(n,s),a={inputs:[o],ffmpegFilter:e,options:{eval:"frame",width:Os(f.width,g.width,r),height:Os(f.height,g.height,r)},outputs:[i]};t.push(a)}return t}_ffmpegFilter="color";filterDefinitionSvg(e){const{filter:t}=e,i=t.scalarObject(!1),{width:n,height:s,color:r}=i;x(r);const o=globalThis.document.createElementNS(dt,"rect");return o.setAttribute("width",String(n)),o.setAttribute("height",String(s)),o.setAttribute("fill",Fs(r)),o}}const Ks=bt.flatMap((e=>bt.map((t=>`${e}${t}`))));class Ys extends fs{constructor(...t){super(...t),Ks.forEach((t=>{this.properties.push(un({custom:!0,name:t,type:e.DataType.Number,defaultValue:t[0]===t[1]?1:0,min:0,max:1}))})),this.populateParametersFromProperties()}filterDefinitionSvgFilter(e){const t={filter:"feColorMatrix",type:"matrix",values:bt.flatMap((t=>[...bt.map((i=>Number(e[`${t}${i}`]))),0])).join(" ")};return[Rn(t)]}}var Xs;e.ActivityType=void 0,(Xs=e.ActivityType||(e.ActivityType={})).Analyze="analyze",Xs.Complete="complete",Xs.Error="error",Xs.Load="load",Xs.Render="render";const Zs=(e,t)=>{const i=e.filter((e=>e.input)),n=i.findIndex((e=>e.inputId===t));return g(n)||console.log("commandFilesInputIndex",t,i),y(n,"commandFilesInputIndex"),n},Qs=(e,t,i)=>[Zs(e,t),i?"v":"a"].join(":"),er=e=>{e.preventDefault(),e.stopPropagation()},tr=e=>n(e)&&"changeHandler"in e,ir=(e,t)=>e.frame-t.frame,nr=(e,t)=>e.index-t.index,sr=(e,t)=>e.trackNumber-t.trackNumber,rr=(e,t,i)=>{if(!I(e)||!T(i))return Xi;const{document:n}=globalThis,r=n.createElement("canvas").getContext("2d");s(r),r.font=`${i}px ${t}`;const o=r.measureText(e),{actualBoundingBoxAscent:a,actualBoundingBoxDescent:c,actualBoundingBoxLeft:l,actualBoundingBoxRight:u,width:h}=o;return{x:l,y:a,width:l+u,height:a+c}};class or extends fs{constructor(...e){super(...e),this.properties.push(un({custom:!0,name:"bias",defaultValue:0,min:0,max:100,step:.01})),this.properties.push(un({custom:!0,name:"matrix",defaultValue:"0 0 0 0 1 0 0 0 0"})),this.properties.push(un({custom:!0,name:"multiplier",defaultValue:1,min:0,max:100,step:.01})),this.populateParametersFromProperties()}commandFilters(e){const{filterInput:t,filter:i,duration:n}=e;x(t,"filterInput");const s=[],r=i.scalarObject(!!n);cr(r);const{ffmpegFilter:o}=this,a={inputs:[t],ffmpegFilter:o,options:fr(mr(r)),outputs:[Tn(o)]};return s.push(a),s}filterDefinitionSvgFilter(e){cr(e);const{matrix:t,bias:i,multiplier:n}=e,s={filter:"feConvolveMatrix",kernelMatrix:String(t),bias:String(i)};return T(n)&&(s.divisor=String(n)),console.log(this.constructor.name,"filterDefinitionSvgFilter",s),[Rn(s)]}}const ar=e=>n(e)&&"matrix"in e&&"bias"in e&&"multiplier"in e;function cr(e){if(!ar(e))throw new Error("expected ConvolutionServerFilter")}const lr=e=>({combined:e,r:e,g:e,b:e,a:e}),ur=e=>(e=>({combined:e,r:e,g:e,b:e,a:e}))(String(e)),hr=e=>{const{combined:t}=e;return(e=>({combined:e,r:e,g:e,b:e,a:e}))((String(t)||"0 0 0 0 1 0 0 0 0").split(",").map((e=>parseInt(e.trim()))))},dr=e=>{const{combined:t}=e;return lr((i=String(t))?.length?parseFloat(i.trim()):0);var i},pr=e=>{const{combined:t}=e;return lr((e=>{if(!e?.length)return 1;if(e.includes("/")){const t=e.split("/").map((e=>parseFloat(e.trim()))),[i,n]=t;return i/n}return parseFloat(e.trim())})(String(t)))},mr=e=>{const t=ur(e.matrix),i=ur(e.multiplier),n=hr(t);return{multiplier:pr(i),matrix:n,bias:t.combined?lr(0):dr(ur(e.bias))}},fr=e=>{const t={};return bt.map((e=>e)).forEach(((i,n)=>{const s=e.multiplier[i],r=e.matrix[i];t[`${n}m`]=r.join(" "),t[`${n}rdiv`]=s,t[`${n}bias`]=e.bias[i]})),t};class gr extends fs{constructor(...t){super(...t),this.properties.push(un({custom:!0,name:"width",type:e.DataType.String})),this.properties.push(un({custom:!0,name:"height",type:e.DataType.String})),this.properties.push(un({tweenable:!0,custom:!0,name:"x",type:e.DataType.Number,defaultValue:0,min:0,step:1})),this.properties.push(un({tweenable:!0,custom:!0,name:"y",type:e.DataType.Number,defaultValue:0,min:0,step:1})),this.populateParametersFromProperties()}commandFilters(e){const{filter:t,filterInput:i,duration:n,videoRate:s}=e;x(i);const r=[],o=t.scalarObject(!!n),a={exact:1},c=Rs(s,n);a.x=Os(o.x,o[`x${ui}`],c,!0),a.y=Os(o.y,o[`y${ui}`],c,!0);const{width:l,height:u}=o;N(l)&&(a.w=l),N(u)&&(a.h=u);const{ffmpegFilter:h}=this,d={inputs:[i],ffmpegFilter:h,options:a,outputs:[Tn(h)]};return r.push(d),r}}class yr extends fs{constructor(...t){super(...t),this.properties.push(un({tweenable:!0,custom:!0,name:"x",type:e.DataType.Percent,defaultValue:.5})),this.properties.push(un({tweenable:!0,custom:!0,name:"y",type:e.DataType.Percent,defaultValue:.5})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,filterInput:n,chainInput:s,duration:r,videoRate:o}=e;x(n,"filterInput"),x(s,"chainInput");const a=i.scalarObject(!!r),c={format:"yuv420"},l=Rs(o,r,"(n-1)"),u=Os(a.x,a[`x${ui}`],l,!0),h=Os(a.y,a[`y${ui}`],l,!0),d=0===h;0===u||(c.x=u),d||(c.y=h);const p={inputs:[s,n],ffmpegFilter:"overlay",options:c,outputs:[]};return t.push(p),t}}class vr extends fs{constructor(...t){super(...t),this.properties.push(un({name:"width",type:e.DataType.Percent,defaultValue:1,max:2})),this.properties.push(un({name:"height",type:e.DataType.Percent,defaultValue:1,max:2})),this.properties.push(un({name:`width${ui}`,type:e.DataType.Percent,defaultValue:1,max:2})),this.properties.push(un({name:`height${ui}`,type:e.DataType.Percent,defaultValue:1,max:2})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,duration:n,filterInput:s,videoRate:r}=e,o=i.scalarObject(!!n),{width:a,height:c,[`width${ui}`]:l,[`height${ui}`]:u}=o;x(s);const{ffmpegFilter:h}=this,d=Rs(r,n),p={width:Os(a,l,d,!0),height:Os(c,u,d,!0)};m(p.width)&&m(p.height)||(p.eval="frame");const f={inputs:[s],ffmpegFilter:h,options:p,outputs:[Tn(h)]};return t.push(f),t}}class Tr extends fs{constructor(...t){super(...t),this.properties.push(un({tweenable:!0,custom:!0,name:"opacity",type:e.DataType.Number,defaultValue:1})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filterInput:i,filter:n,duration:s,videoRate:r}=e,o=n.value("opacity");let a=i;l(o),x(a,"filterInput");const c={lum:"lum(X,Y)",cb:"cb(X,Y)",cr:"cr(X,Y)",a:`alpha(X,Y)*${o}`};if(s){const e=n.value(`opacity${ui}`);if(m(e)&&o!=e){const t=Rs(r,s,"N"),i=e-o;c.a=`alpha(X,Y)*(${o}+(${i}*${t}))`}}const{ffmpegFilter:u}=this,h={inputs:[a],ffmpegFilter:u,options:c,outputs:[Tn(u)]};return t.push(h),t}_ffmpegFilter="geq";filterDefinitionSvgFilter(e){const{opacity:t}=e;l(t);const i=globalThis.document.createElementNS(dt,"feColorMatrix");i.setAttribute("type","matrix");const n=`1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 ${t} 0`;return console.log(this.constructor.name,"filterDefinitionSvgFilters",n),$n(i,n,"values"),[i]}}class br extends fs{constructor(...t){super(...t),this.properties.push(un({custom:!0,name:"sar",type:e.DataType.String,defaultValue:"0"})),this.properties.push(un({custom:!0,name:"max",type:e.DataType.Number,defaultValue:100})),this.populateParametersFromProperties()}}class wr extends fs{constructor(...t){super(...t),this.properties.push(un({custom:!0,name:"fps",type:e.DataType.Number})),this.populateParametersFromProperties()}}class Fr extends fs{constructor(...t){super(...t),this.properties.push(un({custom:!0,name:"expr",type:e.DataType.String,defaultValue:"PTS-STARTPTS"})),this.populateParametersFromProperties()}}class Sr extends fs{commandFilters(e){const t=[],{chainInput:i,filterInput:n}=e;x(i,"chainInput"),x(n,"filterInput");const{ffmpegFilter:s}=this,r={inputs:[i,n],ffmpegFilter:s,options:{},outputs:[Tn(s)]};return t.push(r),t}}class Ir extends fs{constructor(...t){super(...t),this.properties.push(un({custom:!0,name:"start",type:e.DataType.Number,defaultValue:0})),this.populateParametersFromProperties()}}class xr extends Hs{constructor(...t){super(...t),this.properties.push(un({custom:!0,type:e.DataType.String,name:"fontfile"})),this.properties.push(un({custom:!0,type:e.DataType.String,name:"textfile"})),this.properties.push(un({custom:!0,type:e.DataType.Boolean,name:"stretch"})),this.properties.push(un({tweenable:!0,custom:!0,type:e.DataType.Number,name:"height"})),this.properties.push(un({tweenable:!0,custom:!0,type:e.DataType.Number,name:"width"})),this.properties.push(un({custom:!0,type:e.DataType.Number,name:"intrinsicHeight"})),this.properties.push(un({custom:!0,type:e.DataType.Number,name:"intrinsicWidth"})),this.properties.push(un({tweenable:!0,custom:!0,type:e.DataType.Number,name:"x"})),this.properties.push(un({tweenable:!0,custom:!0,type:e.DataType.Number,name:"y"})),this.properties.push(un({tweenable:!0,custom:!0,type:e.DataType.String,name:"color"})),this.populateParametersFromProperties()}commandFilters(e){const t=[],{filter:i,duration:n,videoRate:s,filterInput:r}=e,o=i.value("color"),a=i.value("x"),c=i.value("y"),u=i.value("textfile"),h=i.value("fontfile"),d=i.value("height"),p=i.value("width"),f=!!i.value("stretch"),g=i.value("intrinsicWidth"),y=i.value("intrinsicHeight");x(u),x(h),l(d),l(p),l(g),l(y),l(a),l(c),x(o,"color");const v=i.value(`x${ui}`),b=i.value(`y${ui}`),w=n?i.value(`color${ui}`):void 0,F=I(w)&&o!==w,{ffmpegFilter:S}=this,C=Tn(S),D=F||r?St:o;let P=Ft;r||(P=F?xt:It);const A={width:p,height:d},E={...A};if(n){const e=i.value(`height${ui}`)||0,t=i.value(`width${ui}`)||0;T(t)&&(E.width=t),T(e)&&(E.height=e)}const V=g/y,z=zs(A,E),O=Math.round(V*z.height);O>z.width&&(z.width=O);let R=f||!Vi(A,E);const k={},_={fontsize:z.height,fontfile:h,textfile:u,x:Math.ceil(m(v)?Math.max(a,v):a),y:Math.ceil(m(b)?Math.max(c,b):c)},M=Rs(s,n);if(F){const e=o.length>7,t=e?ei(o):Qt(o),i=e?ei(w):Qt(w),n=(e?bt:Tt).map((e=>{const n=t[e],s=i[e];return n===s?n:`${n}+(${s-n}*${M})`})).map((e=>["eif",e,"x",2].join(":"))).map((e=>`%{${e}}`));_.fontcolor_expr=`#${n.join("")}`}else _.fontcolor=D;const N=this.colorCommandFilter(z,s,n,P);t.push(N);let $=en(N.outputs);R&&(k.width=f?Os(p,E.width,M,!0):-1,k.height=Os(d,E.height,M,!0),m(k.width)&&m(k.height)||(k.eval="frame"));const j={inputs:[$],ffmpegFilter:S,options:_,outputs:[C]};if(t.push(j),$=C,!r){const e="format",i=Tn(e),n={inputs:[$],ffmpegFilter:e,options:{pix_fmts:"yuva420p"},outputs:[i]};t.push(n),$=i}if(R){const e="scale",i=Tn(e),n={inputs:[$],ffmpegFilter:e,options:k,outputs:[i]};t.push(n),$=i}return t}_ffmpegFilter="drawtext"}const Cr=`${pt}filter.`,Dr=[new Sr({id:`${Cr}alphamerge`}),new gs({id:`${Cr}chromakey`}),new Ys({id:`${Cr}colorchannelmixer`}),new Js({id:`${Cr}color`}),new Hs({id:`${Cr}colorize`}),new or({id:`${Cr}convolution`}),new gr({id:`${Cr}crop`}),new wr({id:`${Cr}fps`}),new Tr({id:`${Cr}opacity`}),new yr({id:`${Cr}overlay`}),new vr({id:`${Cr}scale`}),new Fr({id:`${Cr}setpts`}),new br({id:`${Cr}setsar`}),new Ir({id:`${Cr}trim`}),new xr({id:`${Cr}text`})],Pr=e=>{const{id:t}=e;return x(t),new fs(e)},Ar=e=>{const t=e.includes(".")?e:`${Cr}${e}`,i=Dr.find((e=>e.id===t));return i||Pr({id:t})},Er=e=>{const{id:t}=e;if(!t)throw mn.invalid.definition.id;return Ar(t).instanceFromObject(e)},Vr=e=>Ar(e).instanceFromObject({id:e});function zr(t){return class extends t{constructor(...t){super(...t);const[i]=t;this.addProperties(i,un({name:"x",type:e.DataType.Percent,defaultValue:.5,group:e.DataGroup.Point,tweenable:!0})),this.addProperties(i,un({name:"y",type:e.DataType.Percent,defaultValue:.5,group:e.DataGroup.Point,tweenable:!0})),Me.forEach((t=>{this.addProperties(i,un({name:`off${t}`,type:e.DataType.Boolean,group:e.DataGroup.Point}))})),this.addProperties(i,un({tweenable:!0,name:"opacity",type:e.DataType.Percent,defaultValue:1,group:e.DataGroup.Opacity}))}_colorizeFilter;get colorizeFilter(){return this._colorizeFilter||=Vr("colorize")}colorizeCommandFilters(e){const{contentColors:t,videoRate:i,filterInput:n,time:s}=e;D(t);const r=k(s)?s.lengthSeconds:0,{colorizeFilter:o}=this,a={videoRate:i,duration:r,filterInput:n},[c,l]=t;return o.setValue(c,"color"),o.setValue(l,`color${ui}`),o.commandFilters(a)}colorMaximize=!1;containerColorCommandFilters(e){const t=[],{contentColors:i,containerRects:n,track:s}=e,{colorMaximize:r}=this;if(!r)return super.containerColorCommandFilters(e);D(i);const o=!Yi(...n)?zs(...n):n[0],a={...e,outputSize:o};return t.push(...this.colorBackCommandFilters(a,`content-${s}`)),t}containerCommandFilters(e,t){const i=[],{contentColors:n,filterInput:s}=e;let r=s;return x(r,"filterInput"),n?.length||(i.push(...this.alphamergeCommandFilters({...e,filterInput:r})),r=en(en(i).outputs)),i.push(...this.containerFinalCommandFilters({...e,filterInput:r})),i}containerFinalCommandFilters(e){const t=[],{filterInput:i}=e;let n=i;x(n,"filterInput");const s=this.opacityCommandFilters(e);return s.length&&(t.push(...s),n=en(en(s).outputs)),t.push(...this.translateCommandFilters({...e,filterInput:n})),t}containerRects(e,t){const{size:i,time:n,timeRange:s}=e,{lock:r}=this,o=this.tweenRects(n,s),a=Gs(o,r),{width:c,height:l}=t,u=(c||i.width)/(l||i.height),[h,d]=a,p=Bs(h,i,u,r),{directionObject:m}=this,f=$s(i,p,m);if(!!Yi(h,d))return[f,f];const g=Bs(d,i,u,r),y=_s(p,g);return[f,$s(i,y,m)]}containerPreviewItemPromise(e,t,i,n){return Promise.resolve(this.pathElement(e))}containerSvgFilter(e,t,i,n,s){const[r]=this.tweenValues("opacity",n,s);if(!v(r))return;const{opacityFilter:o}=this;return o.setValue(r,"opacity"),Nn(o.filterSvgFilter(),e)}get directions(){return Le}get directionObject(){return Object.fromEntries(Me.map((e=>[e,!!this.value(`off${e}`)])))}get isDefault(){return this.definitionId===yi}opacityCommandFilters(e){const{outputSize:t,filterInput:i,clipTime:n,time:s,videoRate:r}=e;_(n);const o=[],a={dimensions:t,filterInput:i,videoRate:r,duration:k(s)?s.lengthSeconds:0},[c,l]=this.tweenValues("opacity",s,n);if(v(c)||h(l)&&v(l)){const{opacityFilter:e}=this;e.setValues({opacity:c,opacityEnd:l}),o.push(...e.commandFilters(a))}return o}_opacityFilter;get opacityFilter(){return this._opacityFilter||=Vr("opacity")}pathElement(e,t="none"){return Dn(e,"",t)}translateCommandFilters(e){const t=[],{outputSize:i,time:n,containerRects:s,chainInput:r,filterInput:o,videoRate:a}=e;if(!r)return t;D(s);const[c,l]=s,u=l||{},h=k(n)?n.lengthSeconds:0,{overlayFilter:d}=this;d.setValue(c.x,"x"),d.setValue(c.y,"y"),h&&(d.setValue(u.x,`x${ui}`),d.setValue(u.y,`y${ui}`));const p={dimensions:i,filterInput:o,videoRate:a,duration:h,chainInput:r};return t.push(...d.commandFilters(p)),t}}}function Or(t){return class extends t{constructor(...t){super(...t),this.properties.push(un({name:"lock",type:e.DataType.String,defaultValue:e.Orientation.H,group:e.DataGroup.Size}))}type=e.DefinitionType.Container}}lt[e.DefinitionType.Filter]={definition:Pr,definitionFromId:Ar,fromId:Vr,instance:Er,defaults:Dr};const Rr=(e,t,i="")=>{if(e.fps===t.fps)return[e,t];const n=(s=e.fps,r=t.fps,s*r/((e,t)=>{let i=e,n=t,s=0;for(;0!==n;)s=n,n=i%n,i=s;return i})(s,r));var s,r;return[e.scale(n,i),t.scale(n,i)]};class kr{constructor(e=0,t=1){if(!f(e)||e<0)throw mn.frame+e;if(!f(t)||t<1)throw mn.fps;this.frame=e,this.fps=t}add(e){const[t,i]=Rr(this,e);return new kr(t.frame+i.frame,t.fps)}addFrame(e){const t=this.copy;return t.frame+=e,t}closest(e){const t=e.frame+Math.round(e.frames/2),i=new kr(t,e.fps),[n,s]=Rr(i,this);return n.frame<s.frame?e.lastTime:e.startTime}get copy(){return new kr(this.frame,this.fps)}get description(){return`${this.frame}@${this.fps}`}divide(e,t=""){return b(e),1===e?this:this.withFrame(vs(this.frame/e,t))}equalsTime(e){const[t,i]=Rr(this,e);return t.frame===i.frame}fps;frame;durationFrames(e,t=0){const i=t||this.fps,n=[],s=Math.floor(i*e)-2,r=Math.min(s,this.scale(i,"floor").frame);if(this.isRange){const e=this.timeRange.endTime.scale(i,"ceil").frame,t=Math.min(s+1,e);for(let e=r;e<t;e+=1)n.push(e)}else n.push(r);return n}isRange=!1;get lengthSeconds(){return 0}min(e){const[t,i]=Rr(this,e);return new kr(Math.min(t.frame,i.frame),t.fps)}scale(e,t=""){if(this.fps===e)return this;const i=Number(this.frame)/Number(this.fps)*Number(e);return new kr(vs(i,t),e)}scaleToFps(e){return this.scaleToTime(new kr(0,e))}scaleToTime(e){return Rr(this,e)[0]}get seconds(){return Number(this.frame)/Number(this.fps)}get startTime(){return this}subtract(e){const[t,i]=Rr(this,e);let n=i.frame;return n>t.frame&&(n-=n-t.frame),new kr(t.frame-n,t.fps)}subtractFrames(e){const t=this.copy;return t.frame-=e,t}get timeRange(){throw mn.timeRange}toString(){return`[${this.description}]`}withFrame(e){const t=this.copy;return t.frame=e,t}}class _r extends kr{frames;constructor(e=0,t=1,i=1){if(super(e,t),!(f(i)&&i>=0))throw console.trace(this.constructor.name),mn.timeRange+" frames";this.frames=i}addFrames(e){const t=this.copy;return t.frames+=e,t}get copy(){return new _r(this.frame,this.fps,this.frames)}get description(){return`${this.frame}-${this.frames}@${this.fps}`}get end(){return this.frame+this.frames}get endTime(){return new kr(this.end,this.fps)}equalsTimeRange(e){const[t,i]=Rr(this,e);return t.frame===i.frame&&t.frames===i.frames}get frameTimes(){const{frames:e,frame:t,fps:i}=this;return Array.from({length:e},((e,n)=>new kr(t,i)))}includes(e){return e>=this.frame&&e<=this.end}includesTime(e){const[t,i]=Rr(this,e),n=t,{frame:s,end:r}=n,o=i.frame;return o>=s&&o<r}intersects(e){if(!e.isRange)return this.includesTime(e);const[t,i]=Rr(e,this);return!(t.frame>=i.end)&&t.end>i.frame}isRange=!0;get last(){return this.frame+this.frames-1}get lastTime(){return new kr(this.last,this.fps)}get lengthSeconds(){return Number(this.frames)/Number(this.fps)}get position(){return Number(this.frame)/Number(this.frames)}positionTime(e,t=""){const i=vs((this.frames-this.frame)*e,t);return new kr(this.frame+i,this.fps)}get startTime(){return new kr(this.frame,this.fps)}scale(e=1,t=""){if(this.fps===e)return this.copy;const i=Number(this.frames)/(Number(this.fps)/Number(e)),n=super.scale(e,t),s=Math.max(1,vs(i,t));return new _r(n.frame,n.fps,s)}get timeRange(){return this}get times(){const e=[this.startTime];return this.frames>1&&e.push(this.endTime),e}minEndTime(e){const[t,i]=Rr(this,e);return t.frames=Math.min(t.frames,i.frame),t}withFrame(e){const t=this.copy;return t.frame=e,t}withFrames(e){const t=this.copy;return t.frames=e,t}}const Mr=(e=0,t=1,i=1)=>new _r(e,t,i),Nr=(e,t=1)=>Mr(e.frame,e.fps,t),$r=(e,t)=>{if(!t)return Nr(e);const[i,n]=Rr(e,t);if(n.frame<=i.frame)throw console.trace("fromTimes"),mn.argument+"fromTimes "+i+" "+n;const s=n.frame-i.frame;return Mr(i.frame,i.fps,s)},jr=(e=0,t=1)=>new kr(e,t),Lr=(e=0,t=1,i="")=>{if(!m(e)||e<0)throw mn.seconds;if(!f(t)||t<1)throw mn.fps;const n=vs(e*t,i);return jr(n,t)},qr={duration:3,label:"Unlabeled",editor:{buffer:10,fps:30,loop:!0,volume:.75,precision:3,autoplay:!1},cast:{label:"Cast",quantize:10,color:Ft,gain:.75,buffer:10},mash:{label:"Mash",quantize:10,color:Ft,gain:.75,buffer:10},definition:{image:{duration:2},textcontainer:{duration:3},shape:{duration:3},visible:{duration:3},video:{fps:0},videosequence:{pattern:"%.jpg",fps:10,increment:1,begin:1,padding:0},videostream:{duration:10}}};function Gr(t){return class extends t{constructor(...e){super(...e);const[t]=e,{container:i}=t;i&&(this.container=!0)}alphamergeCommandFilters(e){const t=[],{videoRate:i,outputSize:n,track:s,filterInput:r}=e;x(r),b(i),Ei(n);const o={videoRate:0,duration:0,filterInput:r,chainInput:`content-${s}`},{alphamergeFilter:a}=this;return t.push(...a.commandFilters(o)),t}_alphamergeFilter;get alphamergeFilter(){return this._alphamergeFilter||=Vr("alphamerge")}amixCommandFilters(e){const{chainInput:t,filterInput:i}=e;x(t),x(i);const n=[],s={inputs:[t,i],ffmpegFilter:"amix",options:{normalize:0},outputs:[]};return n.push(s),n}canColor(e){return!1}canColorTween(e){return!1}_clip;get clip(){return this._clip}set clip(e){this._clip=e}get clipped(){return!!this._clip}colorBackCommandFilters(e,t){const{contentColors:i=[],videoRate:n,outputSize:s,duration:r}=e;Ei(s);const o=Ri(s),[a=Ct,c=Ct]=i,l=t||Tn(Et(a)||"back"),{colorFilter:u}=this,h={videoRate:n,duration:r};u.setValue(a,"color"),u.setValue(c,`color${ui}`),u.setValue(o.width,"width"),u.setValue(o.height,"height"),u.setValue(o.width,`width${ui}`),u.setValue(o.height,`height${ui}`);const d=u.commandFilters(h);if(Vi(o,s))en(d).outputs=[l];else{const e=en(en(d).outputs);x(e,"crop input");const t={inputs:[e],ffmpegFilter:"crop",options:{w:s.width,h:s.height,exact:1},outputs:[l]};d.push(t)}return d}_colorFilter;get colorFilter(){return this._colorFilter||=Vr("color")}visibleCommandFiles(e){const t={...e,audible:!1,visible:!0};return this.fileCommandFiles(t)}commandFilters(e,t,i=!1){const n=[],{filterInput:s=""}=e;let r=s;const o=this.initialCommandFilters(e,t,i);return o.length&&(n.push(...o),r=en(en(o).outputs)),i?n.push(...this.containerCommandFilters({...e,filterInput:r},t)):n.push(...this.contentCommandFilters({...e,filterInput:r},t)),n}container=!1;containerColorCommandFilters(e){const t=[],{contentColors:i=[],containerRects:n,videoRate:s,duration:r}=e;F(n,"containerRects");const[o,a]=n,c={videoRate:s,duration:r},{colorFilter:l}=this,[u,h]=i;return l.setValue(u||St,"color"),l.setValue(h,`color${ui}`),l.setValue(o.width,"width"),l.setValue(o.height,"height"),l.setValue(a.width,`width${ui}`),l.setValue(a.height,`height${ui}`),t.push(...l.commandFilters(c)),t}containerCommandFilters(e,t){return[]}containerFinalCommandFilters(e){return[]}contentCommandFilters(e,t){return[]}copyCommandFilter(e,t,i="content"){return{inputs:[e],ffmpegFilter:"copy",options:{},outputs:[`${i}-${t}`]}}_cropFilter;get cropFilter(){return this._cropFilter||=Vr("crop")}definitionTime(e,t){const{fps:i}=t,n=e.scaleToFps(i),{startTime:s,endTime:r}=t,o=Math.max(Math.min(n.frame,r.frame),s.frame);return n.withFrame(o-s.frame)}frames(e){return jr(qr.duration,e).frame}fileCommandFiles(e){const t=[],i=this.fileUrls(e);let n=0;return t.push(...i.map(((e,t)=>{const{input:i}=e,s=t&&i?`${this.id}-${n}`:this.id,r={...e,inputId:s};return i&&n++,r}))),t}fileUrls(e){return[]}hasIntrinsicSizing=!1;hasIntrinsicTiming=!1;initialCommandFilters(e,t,i=!1){throw new Error(mn.unimplemented)}intrinsicRect(e=!1){throw new Error(mn.unimplemented)}intrinsicsKnown(e){return!0}intrinsicGraphFile(e){const{editing:t,size:i,duration:n}=e,r=Mr(),o={editing:t,time:r.startTime,clipTime:r,quantize:r.fps,visible:i,audible:n},[a]=this.fileUrls(o);return s(a),a}get isDefault(){return!1}mutable(){return!1}overlayCommandFilters(e,t){x(e,"bottomInput"),x(t,"topInput");const i=[],n={filterInput:t,chainInput:e,videoRate:0,duration:0},{overlayFilter:s}=this;s.setValue(0,"x"),s.setValue(0,"y"),i.push(...s.commandFilters(n));return en(i).outputs=[Tn(t)],i}_overlayFilter;get overlayFilter(){return this._overlayFilter||=Vr("overlay")}scaleCommandFilters(e){const{time:t,containerRects:i,filterInput:n,videoRate:s}=e;let r=n;x(r,"filterInput"),F(i,"containerRects");const[o,a]=i;Ki(o),Ki(a);const c=k(t)?t.lengthSeconds:0,l=[],{scaleFilter:u}=this,h={duration:c,videoRate:s,filterInput:r};return u.setValue(o.width,"width"),u.setValue(o.height,"height"),u.setValue(a.width,`width${ui}`),u.setValue(a.height,`height${ui}`),l.push(...u.commandFilters(h)),l}_scaleFilter;get scaleFilter(){return this._scaleFilter||=Vr("scale")}selectables(){return[this,...this.clip.selectables()]}selectType=e.SelectType.None;selectedItems(t){const i=[],{container:n,clip:s,selectType:r,definition:o}=this,{id:a}=o,{timing:c,sizing:l}=s,u=n?e.DataType.ContainerId:e.DataType.ContentId,h=s.properties.find((e=>e.type===u));ln(h);const{name:d}=h,p={timing:c,sizing:l,[d]:a},m={...p},f=n?e.Timing.Container:e.Timing.Content,g=n?e.Sizing.Container:e.Sizing.Content,y=c===f,v=l===g;i.push({selectType:r,property:h,value:a,changeHandler:(i,r)=>{x(r);const o={...m,[d]:r};if(y||v){const t=vt.fromId(r),{type:i}=t;y&&!Ie(i)&&(o.timing=e.Timing.Custom),v&&!Fe(i)&&(o.sizing=n?e.Sizing.Content:e.Sizing.Container)}const a={type:e.ActionType.ChangeMultiple,property:i,target:s,redoValues:o,undoValues:p};t.create(a)}});const{properties:T}=this,b=T.filter((e=>this.selectedProperty(e)));return b.forEach((e=>{i.push(...this.selectedProperties(t,e))})),i}selectedProperties(t,i){const n=[],{name:s,tweenable:r,type:o}=i,{selectType:a}=this,c=this.value(s),l=this,u=o===e.DataType.Frame?e.ActionType.ChangeFrame:e.ActionType.Change,h={selectType:a,property:i,value:c,changeHandler:(e,i)=>{x(e),t.create({type:u,property:e,target:l,redoValue:i,undoValue:c})}};if(n.push(h),r){const e=[s,ui].join(""),r=this,o=this.value(e),c={selectType:a,property:i,value:o,name:e,changeHandler:(e,i)=>{t.create({property:e,target:r,redoValue:i,undoValue:o})}};n.push(c)}return n}selectedProperty(e){const{name:t}=e;switch(t){case"muted":return this.mutable();case"opacity":return this.container}return!0}tween(e,t,i){const n=this.value(e),s=this.value(`${e}${ui}`);if(a(s))return n;const{frame:r,frames:o}=i,{frame:c}=t,u=c-r;return m(n)?(l(s),As(n,s,u,o)):(x(n),x(s),Es(n,s,u,o))}tweenPoints(e,t){const[i,n]=this.tweenValues("x",e,t),[s,r]=this.tweenValues("y",e,t);l(i),l(s);const o={x:i,y:s};return[o,Ms(o,{x:n,y:r})]}tweenRects(e,t){const[i,n]=this.tweenSizes(e,t),[s,r]=this.tweenPoints(e,t);return[{...s,...i},{...r,...n}]}tweenSizes(e,t){const[i,n]=this.tweenValues("width",e,t),[s,r]=this.tweenValues("height",e,t);l(i),l(s);const o={width:i,height:s};return[o,Ns(o,{width:n,height:r})]}tweenValues(e,t,i){const n=[],s=k(t);return n.push(this.tween(e,s?t.startTime:t,i)),s&&n.push(this.tween(e,t.endTime,i)),n}}}const Br=zr(Gr(wn));class Ur extends Br{constructor(...t){super(...t);const[i]=t;this.addProperties(i,un({tweenable:!0,name:"width",type:e.DataType.Percent,group:e.DataGroup.Size,defaultValue:1,max:2})),this.addProperties(i,un({tweenable:!0,name:"height",type:e.DataType.Percent,group:e.DataGroup.Size,defaultValue:1,max:2}))}canColor(e){const{isDefault:t}=this;return!t&&!this.isTweeningColor(e)}visibleCommandFiles(t){const i=[],{isDefault:n,id:s}=this,r=this.requiresAlpha(t),o=this.isTweeningColor(t);if(n&&!r)return i;const{definition:a}=this,{path:c}=a,{contentColors:l=[],containerRects:u,time:h,videoRate:d}=t;D(u,"containerRects");const p=k(h)?h.lengthSeconds:0,[m,f]=u,g={...xi,...zs(m,f)},{width:y,height:v}=g;let[T]=l;r?T=St:o&&(T=Ft);let b="none";n?b=St:r&&(b=Ft);const w=n?g:this.intrinsicRect(),{width:F,height:S}=w,I=`width="${F}" height="${S}"`,x=Gn(w,g),C=[];C.push(`<svg viewBox="0 0 ${y} ${v}" xmlns="${dt}">`),C.push(`<g ${I} transform="${x}" >`),C.push(`<rect ${I} fill="${b}"/>`),n||C.push(`<path d="${c}" fill="${T}"/>`),C.push("</g>"),C.push("</svg>");const P=C.join(""),A={};p&&(A.loop=1,A.framerate=d,A.t=p);const E={type:e.GraphFileType.Svg,file:s,content:P,input:!0,inputId:s,definition:a,options:A};return i.push(E),i}containerColorCommandFilters(e){const t=[],{colorFilter:i,isDefault:n}=this,{contentColors:s,containerRects:r,videoRate:o,duration:a}=e;D(s,"contentColors");const[c,l]=r,[u,h]=s,d=n?c:zs(...r),p={videoRate:o,duration:a};i.setValue(u||St,"color"),i.setValue(h,`color${ui}`),i.setValue(d.width,"width"),i.setValue(d.height,"height");const m=n;return i.setValue(m?l.width:void 0,`width${ui}`),i.setValue(m?l.height:void 0,`height${ui}`),t.push(...i.commandFilters(p)),t}containerCommandFilters(e,t){const i=[],{contentColors:n,commandFiles:s,filterInput:r}=e;let o=r;const a=C(n);if(this.requiresAlpha(e,!!t.size)){x(o,"container input");const{contentColors:n,...s}=e,r={...s,filterInput:o};i.push(...super.containerCommandFilters(r,t))}else if(this.isDefault||a){const{id:t}=this;o||console.log(this.constructor.name,"containerCommandFilters calling commandFilesInput",t),o||=Qs(s,t,!0),x(o,"final input"),i.push(...this.containerFinalCommandFilters({...e,filterInput:o}))}return i}hasIntrinsicSizing=!0;initialCommandFilters(e,t,i=!1){const n=[],{contentColors:s,...r}=e,{commandFiles:o,upload:a,track:c,filterInput:l,containerRects:u,videoRate:h}=r;if(a)return n;let d=l;const p=this.requiresAlpha(e,!!t.size),{isDefault:m}=this,f=t.size?zs(...u):u[0],g=Ri(f),y=`content-${c}`,v=`container-${c}`;if(!t.canColor&&I(d)&&!m)if(p){const e="format",t=Tn(e),i={inputs:[d],ffmpegFilter:e,options:{pix_fmts:"yuv420p"},outputs:[t]};n.push(i),d=t}else if(!Vi(g,f)){const t={...e,contentColors:[Ct,Ct],outputSize:g};n.push(...this.colorBackCommandFilters(t,`${y}-back`));const i=en(en(n).outputs);x(d,"overlay input"),n.push(...this.overlayCommandFilters(i,d)),d=en(en(n).outputs)}if(n.length?en(n).outputs=[y]:I(d)&&y!==d&&n.push(this.copyCommandFilter(d,c)),p){const{id:t}=this,i=Qs(o,t,!0);x(i,"scale input");const s={...e,contentColors:[Ct,Ct],outputSize:f};n.push(...this.colorBackCommandFilters(s,`${v}-back`));const r=en(en(n).outputs);n.push(...this.scaleCommandFilters({...e,filterInput:i})),d=en(en(n).outputs),x(d,"overlay input"),n.push(...this.overlayCommandFilters(r,d)),d=en(en(n).outputs);const a={duration:0,videoRate:h};x(d,"crop input");const{cropFilter:c}=this;c.setValue(f.width,"width"),c.setValue(f.height,"height"),c.setValue(0,"x"),c.setValue(0,"y"),n.push(...c.commandFilters({...a,filterInput:d})),d=en(en(n).outputs),x(d,"format input");const l={inputs:[d],ffmpegFilter:"format",options:{pix_fmts:p?"yuv420p":"yuva420p"},outputs:[v]};n.push(l)}return n}intrinsicRect(e=!1){const{pathHeight:t,pathWidth:i}=this.definition;return{width:i,height:t,...xi}}isTweeningColor(e){const{contentColors:t}=e;if(!C(t))return!1;let[i,n]=t;return i!==n}isTweeningSize(e){const{containerRects:t}=e;if(!C(t))return!1;return!Yi(...t)}pathElement(e){const{definition:t}=this,i=this.intrinsicRect(!0);if(!$i(i)){return Dn(e,"","")}const{path:n}=t,s=zn(n,"");return Bn(s,i,e),s}requiresAlpha(e,t){const{contentColors:i}=e,n=C(i);return this.isDefault?!n&&(u(t)?t:this.isTweeningSize(e)):!n||this.isTweeningColor(e)}}function Wr(t){return class extends t{constructor(...t){super(...t),this.properties.push(un({name:"muted",type:e.DataType.Boolean}))}}}const Hr=Or(Wr(ps));class Jr extends Hr{constructor(...e){super(...e);const[t]=e,{path:i,pathHeight:n,pathWidth:s}=t;i&&(this.path=i),T(s)&&(this.pathWidth=s),T(n)&&(this.pathHeight=n)}definitionIcon(e,t){const i=super.definitionIcon(e,t);if(i)return i;const{pathHeight:n,pathWidth:s,path:r}=this,o={width:s,height:n};if(!$i(o)||!I(r))return;const a=Ni(o,t,!0),c={...a,...Qi(t,a)},l=zn(r);return Bn(l,o,c),Promise.resolve(An(t,l))}instanceFromObject(e={}){return new Ur(this.instanceArgs(e))}path="";pathHeight=0;pathWidth=0;toJSON(){const e=super.toJSON();return this.path&&(e.path=this.path),T(this.pathHeight)&&(e.pathHeight=this.pathHeight),T(this.pathWidth)&&(e.pathWidth=this.pathWidth),e}}const Kr=e=>bi(e)&&"fontId"in e;const Yr=zr(Gr(wn));class Xr extends Yr{constructor(...e){const[t]=e;t.lock||="",super(...e);const{intrinsic:i}=t;Ji(i)&&(this._intrinsicRect=i)}canColor(e){return!0}canColorTween(e){return!0}_colorFilter;get colorFilter(){return this._colorFilter||=Vr("color")}visibleCommandFiles(t){const i=super.visibleCommandFiles(t),{string:n}=this,s={definition:this.font,type:e.GraphFileType.Txt,file:this.id,content:n,inputId:this.id};return i.push(s),i}definitionIds(){return[...super.definitionIds(),this.fontId]}_font;get font(){return this._font||=vt.fromId(this.fontId)}fileUrls(e){return this.font.fileUrls(e)}hasIntrinsicSizing=!0;initialCommandFilters(t,i){const n=[],{contentColors:s=[],outputSize:r,track:o,filterInput:a,containerRects:c,videoRate:l,commandFiles:u,duration:h}=t;let d=a;d&&n.push(this.copyCommandFilter(d,o));const[p,m]=c,{height:f,width:g}=p,y=zs(...c);let v="";const T=!!d||i.size;if(T){const e=d?Ft:xt,i={...t,contentColors:[e,e],outputSize:y};n.push(...this.colorBackCommandFilters(i)),v=en(en(n).outputs)}const b=u.find((t=>t.inputId===this.id&&t.type===e.GraphFileType.Txt));V(b,"text file");const{resolved:w}=b;x(w,"textfile");const F=u.find((t=>t.inputId===this.id&&t.type===e.LoadType.Font));V(F,"font file");const{resolved:S}=F;x(S,"fontfile");const{textFilter:I,lock:C}=this,D=this.intrinsicRect(),P=D.x*(p.width/D.width),[A=St,E]=s;x(A);const z=D.x*(m.width/D.width),O=1e3/D.height,R=Math.round(f*O),k=Math.round(m.height*O),_={x:P,y:0,width:g,height:R,color:A,textfile:w,fontfile:S,stretch:!ke(C),intrinsicHeight:D.height,intrinsicWidth:D.width,[`x${ui}`]:z,[`y${ui}`]:0,[`color${ui}`]:E,[`height${ui}`]:k,[`width${ui}`]:m.width};I.setValues(_);const M={dimensions:r,videoRate:l,duration:h,filterInput:d};if(n.push(...I.commandFilters(M)),T){d=en(en(n).outputs),x(d,"overlay filterInput"),n.push(...this.overlayCommandFilters(v,d)),d=en(en(n).outputs),x(d,"crop filterInput");const e={duration:0,videoRate:l,filterInput:d},{cropFilter:t}=this;t.setValue(y.width,"width"),t.setValue(y.height,"height"),t.setValue(0,"x"),t.setValue(0,"y"),n.push(...t.commandFilters(e))}return n}_intrinsicRect;intrinsicRect(e=!1){return this._intrinsicRect||=this.intrinsicRectInitialize()}intrinsicRectInitialize(){const{family:e}=this.font;x(e);const t=this.string,i={width:0,height:1e3,...xi};if(!t)return i;return rr(t,e,1e3)}intrinsicsKnown(e){const{size:t}=e;return!t||(Ji(this._intrinsicRect)||!!this.font?.family)}pathElement(e){const{string:t,font:i}=this,{family:n}=i,s=globalThis.document.createElementNS(dt,"text");return s.setAttribute("font-family",n),s.setAttribute("font-size",String(1e3)),s.append(t),Bn(s,this.intrinsicRect(!0),e),s}setValue(e,t,i){if(super.setValue(e,t,i),!i)switch(t){case"fontId":delete this._font,delete this._intrinsicRect;break;case"string":delete this._intrinsicRect}}_textFilter;get textFilter(){return this._textFilter||=Vr("text")}toJSON(){const e=super.toJSON();return e.intrinsic=this.intrinsicRect(!0),e}}class Zr extends wn{fileUrls(e){return this.definition.fileUrls(e)}}class Qr extends ps{constructor(...e){super(...e);const[t]=e,{source:i,url:n}=t,s=i||n||"";this.source=i||s,this.url=n||s}family="";fileUrls(t){const{visible:i,editing:n}=t;if(!i)return[];const{url:s,source:r}=this,o=n?s:r;return[{type:e.LoadType.Font,file:o,definition:this}]}instanceFromObject(e={}){return new Zr(this.instanceArgs(e))}loadType=e.LoadType.Font;toJSON(){const e=super.toJSON(),{url:t,source:i}=this;return e.url=t,e.source=i,e}source="";type=e.DefinitionType.Font;url=""}var eo={label:"Butcherman",id:"com.moviemasher.font.butcherman",type:"font",source:"https://fonts.googleapis.com/css2?family=Butcherman"};var to={label:"Croissant One",id:"com.moviemasher.font.croissant-one",type:"font",source:"https://fonts.googleapis.com/css2?family=Croissant+One"};var io={label:"League Spartan",id:"com.moviemasher.font.default",type:"font",source:"https://fonts.googleapis.com/css2?family=League+Spartan"};var no={label:"Germania One",id:"com.moviemasher.font.germania-one",type:"font",source:"https://fonts.googleapis.com/css2?family=Germania+One"};var so={label:"Kenia",id:"com.moviemasher.font.kenia",type:"font",source:"https://fonts.googleapis.com/css2?family=Kenia"};var ro={label:"Luckiest Guy",id:"com.moviemasher.font.luckiest-guy",type:"font",source:"https://fonts.googleapis.com/css2?family=Luckiest+Guy"};var oo={label:"Monoton",id:"com.moviemasher.font.monoton",type:"font",source:"https://fonts.googleapis.com/css2?family=Monoton"};var ao={label:"Oleo Script",id:"com.moviemasher.font.oleo-script",type:"font",source:"https://fonts.googleapis.com/css2?family=Oleo+Script"};var co={label:"Shojumaru",id:"com.moviemasher.font.shojumaru",type:"font",source:"https://fonts.googleapis.com/css2?family=Shojumaru"};var lo={label:"Rubik+Dirt",id:"com.moviemasher.font.rubik-dirt",type:"font",source:"https://fonts.googleapis.com/css2?family=Rubik+Dirt"};const uo=io.id,ho=t=>{const{id:i}=t,n=i&&I(i)?i:uo;return new Qr({...t,type:e.DefinitionType.Font,id:n})},po=ho(io),mo=[po,ho(eo),ho(to),ho(so),ho(no),ho(ro),ho(oo),ho(ao),ho(co),ho(lo)],fo=e=>{const t=mo.find((t=>t.id===e));return t||ho({id:e})},go=e=>{const{definitionId:t=""}=e;return fo(t).instanceFromObject(e)},yo=e=>fo(e).instanceFromObject();lt[e.DefinitionType.Font]={definition:ho,definitionFromId:fo,fromId:yo,instance:go,defaults:mo};const vo=Or(Wr(ps));class To extends vo{constructor(...t){super(...t),this.properties.push(un({name:"string",custom:!0,type:e.DataType.String,defaultValue:"Text"})),this.properties.push(un({name:"fontId",custom:!0,type:e.DataType.FontId,defaultValue:po.id})),this.properties.push(un({name:"height",tweenable:!0,custom:!0,type:e.DataType.Percent,defaultValue:.3,max:2,group:e.DataGroup.Size})),this.properties.push(un({name:"width",tweenable:!0,custom:!0,type:e.DataType.Percent,defaultValue:.8,max:2,group:e.DataGroup.Size}))}instanceArgs(t){const i=t||{};return a(i.lock)&&(i.lock=e.Orientation.V),super.instanceArgs(i)}instanceFromObject(e={}){return new Xr(this.instanceArgs(e))}}var bo={label:"Chat",type:"container",id:"com.moviemasher.container.chat",pathWidth:24,pathHeight:24,path:"M4.929 19.071A9.969 9.969 0 0 1 2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10H2l2.929-2.929zM11 6v12h2V6h-2zM7 9v6h2V9H7zm8 0v6h2V9h-2z"};var wo={label:"Broadcast",type:"container",id:"com.moviemasher.container.broadcast",pathWidth:24,pathHeight:24,path:"M4.929 2.929l1.414 1.414A7.975 7.975 0 0 0 4 10c0 2.21.895 4.21 2.343 5.657L4.93 17.07A9.969 9.969 0 0 1 2 10a9.969 9.969 0 0 1 2.929-7.071zm14.142 0A9.969 9.969 0 0 1 22 10a9.969 9.969 0 0 1-2.929 7.071l-1.414-1.414A7.975 7.975 0 0 0 20 10c0-2.21-.895-4.21-2.343-5.657L19.07 2.93zM7.757 5.757l1.415 1.415A3.987 3.987 0 0 0 8 10c0 1.105.448 2.105 1.172 2.828l-1.415 1.415A5.981 5.981 0 0 1 6 10c0-1.657.672-3.157 1.757-4.243zm8.486 0A5.981 5.981 0 0 1 18 10a5.981 5.981 0 0 1-1.757 4.243l-1.415-1.415A3.987 3.987 0 0 0 16 10a3.987 3.987 0 0 0-1.172-2.828l1.415-1.415zM12 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 2c.58 0 1.077.413 1.184.983L14.5 22h-5l1.316-7.017c.107-.57.604-.983 1.184-.983z"};var Fo={label:"Music",type:"container",id:"com.moviemasher.container.music",pathWidth:24,pathHeight:24,path:"M12 13.535V3h8v2h-6v12a4 4 0 1 1-2-3.465zM10 19a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"};var So={label:"Test",type:"container",id:"com.moviemasher.container.test",pathWidth:1920,pathHeight:1080,path:"M 358.00 980.00 C 215.51 980.00 100.00 864.49 100.00 722.00 L 100.00 358.00 C 100.00 215.51 215.51 100.00 358.00 100.00 L 1562.00 100.00 C 1704.49 100.00 1820.00 215.51 1820.00 358.00 L 1820.00 722.00 C 1820.00 864.49 1704.49 980.00 1562.00 980.00 Z M 358.00 980.00"};var Io={label:"Text",type:"text",id:"com.moviemasher.container.text",fontId:"com.moviemasher.font.default"};const xo=[new Jr({id:yi,...{label:"Rectangle",type:"container"}}),new To(Io),new Jr(bo),new Jr(wo),new Jr(Fo),new Jr(So)],Co=e=>{const{id:t}=e;throw x(t,"containerDefinition id"),"containerDefinition"},Do=e=>{const t=xo.find((t=>t.id===e));return t||Co({id:e})},Po=e=>{const{definitionId:t}=e;if(!t)throw mn.id;return Do(t).instanceFromObject(e)},Ao=e=>Do(e).instanceFromObject({definitionId:e});lt[e.DefinitionType.Container]={definition:Co,definitionFromId:Do,fromId:Ao,instance:Po,defaults:xo};const Eo=`${pt}content.default`,Vo=e=>mi(e)&&Pe(e.type);function zo(e,t){Vo(e)||i(e,"Content",t)}const Oo=e=>gi(e)&&Pe(e.type);function Ro(t){return class extends t{type=e.DefinitionType.Content}}function ko(e){return class extends e{commandFilters(e){const t=[],{videoRate:i,filterInput:n,time:s}=e;x(n);const r=k(s)?s.lengthSeconds:0,{filters:o}=this.definition,a={videoRate:i,duration:r,filterInput:n};return t.push(...o.flatMap((e=>{this.setFilterValues(e);const t=e.commandFilters(a);return t.length&&(a.filterInput=en(en(t).outputs)),t}))),t}setFilterValues(e){const t=e.properties.map((e=>e.name));this.properties.map((e=>e.name)).filter((e=>t.includes(e))).forEach((t=>{const i=this.properties.find((e=>e.name===t));ln(i);const{tweenable:n}=i;if(e.setValue(this.value(t),t),n){const i=`${t}${ui}`;e.setValue(this.value(i),i)}}))}svgFilters(e,t,i,n){const s=[],{filters:r}=this.definition;return s.push(...r.flatMap((e=>(this.setFilterValues(e),e.filterSvgFilter())))),s}}}const _o=ko(wn);class Mo extends _o{_tweenable;get tweenable(){return this._tweenable}set tweenable(e){this._tweenable=e}selectables(){return[this,...this.tweenable.selectables()]}selectType=e.SelectType.None;selectedItems(t){return this.properties.map((i=>{const n=this.value(i.name),s=this;return{value:n,selectType:e.SelectType.None,property:i,changeHandler:(e,i)=>{x(e);const r={target:s,property:e,redoValue:i,undoValue:n};t.create(r)}}}))}}function No(e){return class extends e{constructor(...e){super(...e);const[t]=e,{properties:i,filters:n,initializeFilter:s,finalizeFilter:r}=t;i?.length&&this.properties.push(...i.map((e=>un({...e,custom:!0})))),s&&(this.initializeFilter=Er(s)),r&&(this.finalizeFilter=Er(r)),n&&this.filters.push(...n.map((e=>Er(e))))}filters=[];finalizeFilter;initializeFilter;toJSON(){const e=super.toJSON(),t=this.properties.filter((e=>e.custom));return t.length&&(e.properties=t),this.filters.length&&(e.filters=this.filters),e}}}const $o=No(ps);class jo extends $o{constructor(...e){super(...e),this.properties.push(un({name:"label",defaultValue:""}))}instanceArgs(e){const t=super.instanceArgs(e);return t.label||=this.label,t}instanceFromObject(e={}){return new Mo(this.instanceArgs(e))}type=e.DefinitionType.Effect}var Lo={label:"Chromakey",type:"effect",id:"com.moviemasher.effect.chromakey",properties:[{name:"blend",defaultValue:0,step:.01,min:0,max:1},{name:"similarity",defaultValue:.9,step:.01,min:0,max:1},{name:"color",type:"rgb",defaultValue:"#00FF00"}],filters:[{id:"com.moviemasher.filter.chromakey",parameters:[{name:"color",value:"color",dataType:"string"},{name:"blend",value:"blend",dataType:"string"},{name:"similarity",value:"similarity",dataType:"string"}]}]};var qo={label:"Emboss",type:"effect",id:"com.moviemasher.effect.emboss",properties:[],filters:[{id:"com.moviemasher.filter.convolution",parameters:[{name:"matrix",value:"-2,-1,0,-1,1,1,0,1,2"}]}]};var Go={label:"Grayscale",type:"effect",id:"com.moviemasher.effect.grayscale",filters:[{id:"com.moviemasher.filter.colorchannelmixer",parameters:[{name:"rr",value:.3},{name:"rg",value:.4},{name:"rb",value:.3},{name:"ra",value:0},{name:"gr",value:.3},{name:"gg",value:.4},{name:"gb",value:.3},{name:"ga",value:0},{name:"br",value:.3},{name:"bg",value:.4},{name:"bb",value:.3},{name:"ba",value:0},{name:"ar",value:0},{name:"ag",value:0},{name:"ab",value:0},{name:"aa",value:1}]}]};var Bo={label:"Sepia",type:"effect",id:"com.moviemasher.effect.sepia",filters:[{id:"com.moviemasher.filter.colorchannelmixer",parameters:[{name:"rr",value:.393},{name:"rg",value:.769},{name:"rb",value:.189},{name:"gr",value:.349},{name:"gg",value:.686},{name:"gb",value:.168},{name:"br",value:.272},{name:"bg",value:.534},{name:"bb",value:.131}]}]};var Uo={label:"Sharpen",type:"effect",id:"com.moviemasher.effect.sharpen",properties:[],filters:[{id:"com.moviemasher.filter.convolution",parameters:[{name:"matrix",value:"0,-1,0,-1,5,-1,0,-1,0"}]}]};const Wo=t=>{const{id:i}=t;return x(i),new jo({...t,type:e.DefinitionType.Effect})},Ho=[Wo({label:"Blur",type:"effect",id:"com.moviemasher.effect.blur",filters:[{id:"com.moviemasher.filter.convolution",parameters:[{name:"matrix",value:"1,1,1,1,1,1,1,1,1"},{name:"multiplier",value:"0.11"}]}]}),Wo(Lo),Wo(qo),Wo(Go),Wo(Bo),Wo(Uo)],Jo=e=>{const t=Ho.find((t=>t.id===e));return t||Wo({id:e})},Ko=e=>{const{definitionId:t=""}=e;return Jo(t).instanceFromObject(e)},Yo=e=>Jo(e).instanceFromObject();function Xo(t){return class extends t{constructor(...t){super(...t);const[i]=t,{isDefaultOrAudio:n}=this;n||(this.addProperties(i,un({name:"x",type:e.DataType.Percent,defaultValue:.5,group:e.DataGroup.Point,tweenable:!0})),this.addProperties(i,un({name:"y",type:e.DataType.Percent,defaultValue:.5,group:e.DataGroup.Point,tweenable:!0})),this.addProperties(i,un({name:"lock",type:e.DataType.String,defaultValue:e.Orientation.H,group:e.DataGroup.Size})));const{effects:s}=i;s&&this.effects.push(...s.map((e=>{const t=Ko(e);return t.tweenable=this,t})))}audibleCommandFiles(e){const t={...e,audible:!0,visible:!1};return this.fileCommandFiles(t)}audibleCommandFilters(e){const t=[],{time:i,quantize:n,commandFiles:s,clipTime:r}=e,o=i.isRange?i.lengthSeconds:0,a=o?Math.min(o,r.lengthSeconds):0,{id:c}=this;let l=Qs(s,c,!1);const u="atrim",h=Tn(u),d={},{frame:p}=this.definitionTime(i,r);a&&(d.duration=a),p&&(d.start=jr(p,n).seconds);const m={inputs:[l],ffmpegFilter:u,options:d,outputs:[h]};t.push(m),l=h;const f=1e3*(r.seconds-i.seconds);if(f){const e="adelay",i=Tn(e),n={ffmpegFilter:e,options:{delays:f,all:1},inputs:[l],outputs:[i]};t.push(n),l=i}return t.push(...this.amixCommandFilters({...e,filterInput:l})),t}contentCommandFilters(e,t){return this.effectsCommandFilters(e)}contentSvgFilter(e,t,i,n,s){const{effects:r}=this;if(!r.length)return;const o=this.effects.flatMap((e=>e.svgFilters(t,i,n,s))),a=Nn(o,e);return $n(a,"200%","width"),$n(a,"200%","height"),a}contentRects(e){const{containerRects:t,time:i,timeRange:n,loading:s,editing:r}=e;if(s&&!this.intrinsicsKnown({editing:r,size:!0}))return w(t)?t:[t,t];const{lock:o}=this,a=this.tweenRects(i,n),c=Gs(a,o),l=this.intrinsicRect(r),u=js(l,t,c),[h,d]=u,p=Ls(u,t,c),[m,f]=p;return[Zi(h,m),Zi(d,f)]}contentRect(e,t,i){const n={containerRects:e,time:t,timeRange:i,editing:!0},[s]=this.contentRects(n),{x:r,y:o}=s,a={x:e.x-r,y:e.y-o};return Zi(s,a)}contentPreviewItemPromise(e,t,i,n){return this.itemPromise(e,t,i,n)}definitionIds(){return[...super.definitionIds(),...this.effects.flatMap((e=>e.definitionIds()))]}effectsCommandFilters(e){const t=[],{filterInput:i}=e;let n=i;x(n);const{effects:s}=this;return t.push(...s.flatMap((t=>{const i=t.commandFilters({...e,filterInput:n});return i.length&&(n=en(en(i).outputs)),i}))),t}effects=[];intrinsicRect(e=!1){return Xi}get isDefault(){return"com.moviemasher.content.default"===this.definitionId}get isDefaultOrAudio(){return this.isDefault||this.type===e.DefinitionType.Audio}itemPromise(e,t,i,n){throw new Error(mn.unimplemented)}selectedItems(t){const i=super.selectedItems(t);if(this.isDefaultOrAudio)return i;const{effects:n,selectType:s}=this,r=[...n],o=this,a={selectType:s,value:this.effects,removeHandler:i=>{const s={redoSelection:{...t.selection,effect:void 0},effects:n,undoEffects:r,redoEffects:n.filter((e=>e!==i)),type:e.ActionType.MoveEffect};t.create(s)},moveHandler:(i,s=0)=>{y(s,"index");const a=r.filter((e=>e!==i)),c=r.indexOf(i)<s?s-1:s;a.splice(c,0,i);const l={effects:n,undoEffects:r,redoEffects:a,type:e.ActionType.MoveEffect,effectable:o};t.create(l)},addHandler:(i,s=0)=>{y(s,"index");const o=[...n];o.splice(s,0,i),i.tweenable=this;const a={effects:n,undoEffects:r,redoEffects:o,redoSelection:{...t.selection,effect:i},type:e.ActionType.MoveEffect};t.create(a)}};return i.push(a),i}selectedProperty(e){const{name:t}=e,{isDefaultOrAudio:i}=this;switch(t){case"effects":case"lock":case"width":case"height":case"x":case"y":return!i}return super.selectedProperty(e)}toJSON(){const e=super.toJSON();return e.effects=this.effects,e}}}lt[e.DefinitionType.Effect]={definition:Wo,definitionFromId:Jo,fromId:Yo,instance:Ko,defaults:Ho};const Zo=e=>Vo(e)&&"color"in e,Qo=Xo(Gr(wn));class ea extends Qo{constructor(...t){super(...t);const[i]=t;this.addProperties(i,un({tweenable:!0,name:"color",type:e.DataType.Rgb,defaultValue:this.definition.color,group:e.DataGroup.Color}))}_colorFilter;get colorFilter(){return this._colorFilter||=Vr("color")}contentColors(e,t){const[i,n]=this.tweenValues("color",e,t);x(i);return[i,I(n)?n:i]}contentPreviewItemPromise(e,t,i,n){const{colorFilter:s}=this,[r]=this.tweenValues("color",t,i),{x:o,y:a,width:c,height:l}=e;s.setValues({width:c,height:l,color:r});const u=s.filterSvg();return u.setAttribute("x",String(o)),u.setAttribute("y",String(a)),Promise.resolve(u)}}const ta=Ro(Wr(ps));class ia extends ta{constructor(...e){super(...e);const[t]=e,{color:i}=t;I(i)&&(this.color=i)}color=Ft;instanceFromObject(e={}){return new ea(this.instanceArgs(e))}}const na=[new ia({...{label:"Color",type:"color",id:"com.moviemasher.content.default",color:"#FFFFFF"},id:Eo})],sa=e=>{const{id:t}=e;throw x(t,"contentDefinition id"),"contentDefinition"},ra=e=>{const t=na.find((t=>t.id===e));return t||sa({id:e})},oa=e=>{const{definitionId:t}=e;if(!t)throw mn.id;return ra(t).instanceFromObject(e)},aa=e=>ra(e).instanceFromObject({definitionId:e});lt[e.DefinitionType.Content]={definition:sa,definitionFromId:ra,fromId:aa,instance:oa,defaults:na};class ca{addSource(e,t){this.sourcesById.set(e,t)}_context;get context(){if(!this._context){const e=AudioContext||window.webkitAudioContext;if(!e)throw mn.audibleContext;this._context=new e}return this._context}createBuffer(e){const t=44100*e;return this.context.createBuffer(2,t,44100)}createBufferSource(e){const t=this.context.createBufferSource();return e&&(t.buffer=e),t}createGain(){return this.context.createGain()}get currentTime(){return this.context.currentTime}decode(e){return new Promise(((t,i)=>this.context.decodeAudioData(e,(e=>t(e)),(e=>i(e)))))}deleteSource(e){const t=this.getSource(e);if(!t)return;this.sourcesById.delete(e);const{gainSource:i,gainNode:n}=t;n.disconnect(this.destination),i.disconnect(n),i.stop()}get destination(){return this.context.destination}getSource(e){return this.sourcesById.get(e)}hasSource(e){return this.sourcesById.has(e)}sourcesById=new Map;startAt(e,t,i,n,s,r=!1){const o=this.createGain();t.loop=r,t.connect(o),o.connect(this.destination),t.start(this.currentTime+i,s,n),this.addSource(e,{gainSource:t,gainNode:o})}}const la=new ca,ua={audible:()=>new ca},ha=e=>n(e)&&"composition"in e;function da(e,t){ha(e)||i(e,"Mash",t)}class pa extends hi{constructor(t){super();const{createdAt:i,id:n,icon:s,preloader:r,quantize:o}=t;r&&(this._preloader=r),I(n)&&(this._id=n),I(s)&&(this.icon=s),I(i)&&(this.createdAt=i),T(o)&&(this.quantize=o),this.properties.push(un({name:"label",type:e.DataType.String,defaultValue:""})),this.properties.push(un({name:"color",type:e.DataType.Rgb,defaultValue:Ft})),this.propertiesInitialize(t)}get buffer(){throw new Error(mn.unimplemented+"get buffer")}set buffer(e){throw new Error(mn.unimplemented+"set buffer")}createdAt="";data={};dataPopulate(e){const t=this.properties.map((e=>e.name));Object.entries(e).forEach((([e,i])=>{t.find((t=>t===e))||(this.data[e]=i)}))}destroy(){}_editor;get editor(){return this._editor}set editor(e){this._editor=e}_emitter;get emitter(){return this._emitter}set emitter(e){this._emitter=e,this.emitterChanged()}emitterChanged(){}editedGraphFiles(e){return[]}icon="";_id="";get id(){return this._id||=vn()}set id(t){this._id=t,this.emitter?.emit(e.EventType.Save)}_imageSize={...zi};get imageSize(){return this._imageSize}set imageSize(e){ji(e),this._imageSize=e}loadPromise(e){throw mn.unimplemented}get loading(){return!1}get mashes(){throw mn.unimplemented}_preloader;get preloader(){return this._preloader}putPromise(){throw new Error(mn.unimplemented)}quantize=qr.mash.quantize;reload(){}selectables(){return[]}selectType=e.SelectType.None;selectedItems(e){return[]}svgItems(e){throw mn.unimplemented}toJSON(){const e=super.toJSON();return e.createdAt=this.createdAt,e.quantize=this.quantize,e.id=this.id,this.icon&&(e.icon=this.icon),Object.entries(this.data).forEach((([t,i])=>{a(e[t])&&(e[t]=i)})),e}}const ma=e=>pi(e)&&"contentId"in e;function fa(e,t){ma(e)||i(e,"Clip",t)}const ga=e=>n(e)&&"frameForClipNearFrame"in e;function ya(e,t){ga(e)||i(e,"Track",t)}const va=e=>Oo(e)&&"loadType"in e;const Ta=e=>Vo(e)&&va(e.definition);function ba(e){return class extends e{constructor(...e){super(...e);const[t]=e,{source:i,url:n,bytes:s,mimeType:r}=t,o=i||n||"";this.source=i||o,this.url=n||o,s&&(this.bytes=s),r&&(this.mimeType=r)}bytes=0;loadType;mimeType="";source;toJSON(){const e=super.toJSON();return this.url&&(e.url=this.url),this.source&&(e.source=this.source),this.bytes&&(e.bytes=this.bytes),this.mimeType&&(e.mimeType=this.mimeType),e}url}}function wa(e){return class extends e{}}const Fa=[e.DefinitionType.Image,e.DefinitionType.Video,e.DefinitionType.VideoSequence],Sa=e=>Ta(e);const Ia=e=>va(e);function xa(t){return class extends t{constructor(...t){super(...t);const[i]=t,{container:n}=i,s=n?0:1;this.addProperties(i,un({tweenable:!0,name:"width",type:e.DataType.Percent,group:e.DataGroup.Size,defaultValue:1,max:2,min:s})),this.addProperties(i,un({tweenable:!0,name:"height",type:e.DataType.Percent,group:e.DataGroup.Size,defaultValue:1,max:2,min:s}))}colorMaximize=!0;containerCommandFilters(e,t){const i=[],{commandFiles:n,containerRects:s,filterInput:r,videoRate:o,track:a}=e;let c=r;const l=t.size?zs(...s):s[0],u={...e,contentColors:[Ct,Ct],outputSize:l};i.push(...this.colorBackCommandFilters(u,`container-${a}-back`));const h=en(en(i).outputs),{id:d}=this,p=Qs(n,d,!0);i.push(...this.scaleCommandFilters({...e,filterInput:p})),c=en(en(i).outputs),t.size&&(x(c,"overlay input"),i.push(...this.overlayCommandFilters(h,c)),c=en(en(i).outputs));const m={duration:0,videoRate:o};x(c,"crop input");const{cropFilter:f}=this;return f.setValue(l.width,"width"),f.setValue(l.height,"height"),f.setValue(0,"x"),f.setValue(0,"y"),i.push(...f.commandFilters({...m,filterInput:c})),c=en(en(i).outputs),t.size||(x(c,"overlay input"),i.push(...this.overlayCommandFilters(h,c)),c=en(en(i).outputs)),x(c,"alphamerge input"),i.push(...this.alphamergeCommandFilters({...e,filterInput:c})),c=en(en(i).outputs),i.push(...this.containerFinalCommandFilters({...e,filterInput:c})),i}containerPreviewItemPromise(e,t,i,n){return this.itemPromise(e,t,i,n)}contentCommandFilters(e,t){const i=[],{containerRects:n,visible:s,time:r,videoRate:o,clipTime:a,commandFiles:c,filterInput:l,track:u,upload:h}=e;if(!s)return i;_(a),D(n,"containerRects");const{id:d}=this;let p=l||Qs(c,d,s);const m={containerRects:n,time:r,timeRange:a},f=this.contentRects(m),g=!Yi(...n),[y,v]=f,T=k(r)?r.lengthSeconds:0,b=g?zs(...n):n[0],w=`content-${u}-back`;if(!h){const t={...e,contentColors:[Ft,Ft],outputSize:b};i.push(...this.colorBackCommandFilters(t,w))}const F={...e,filterInput:p,containerRects:f};if(i.push(...this.scaleCommandFilters(F)),h)return i;p=en(en(i).outputs),t.size&&(i.push(...this.overlayCommandFilters(w,p)),p=en(en(i).outputs));const S={duration:T,videoRate:o},{cropFilter:I}=this;return I.setValue(b.width,"width"),I.setValue(b.height,"height"),I.setValue(y.x,"x"),I.setValue(y.y,"y"),I.setValue(v.x,`x${ui}`),I.setValue(v.y,`y${ui}`),i.push(...I.commandFilters({...S,filterInput:p})),p=en(en(i).outputs),t.size||(i.push(...this.overlayCommandFilters(w,p)),p=en(en(i).outputs)),i.push(...super.contentCommandFilters({...e,filterInput:p},t)),i}hasIntrinsicSizing=!0;iconUrl(e,t,i){return this.definition.url}initialCommandFilters(e,t,i=!1){const n=[],{filterInput:s,track:r}=e;return i&&(x(s),n.push(this.copyCommandFilter(s,r))),n}intrinsicRect(e=!1){const t=e?"previewSize":"sourceSize",{[t]:i}=this.definition;ji(i,t);return{...xi,...i}}intrinsicsKnown(e){const{editing:t,size:i}=e;if(!i)return!0;const n=t?"previewSize":"sourceSize",{[n]:s}=this.definition;return $i(s)}itemIconPromise(e,t,i,n){const{clip:s}=this,{preloader:r}=s.track.mash,o=this.iconUrl(Bi(e),t,i),a=ds("image",o),c=ds("svg",a,{...e}),l=n?this.definition:void 0;return r.loadPromise(c,l)}itemPreviewPromise(e,t,i){return this.itemIconPromise(e,t,i,!0)}itemPromise(e,t,i,n){const{container:s}=this,r=s?e:this.contentRect(e,t,i);return n?this.itemIconPromise(r,t,i):this.itemPreviewPromise(r,t,i).then((e=>(xn(e,r),e)))}}}function Ca(e){return class extends e{constructor(...e){super(...e);const[t]=e,{sourceSize:i,previewSize:n}=t;$i(n)&&(this.previewSize=n),$i(i)&&(this.sourceSize=i)}previewSize;sourceSize;toJSON(){const e=super.toJSON(),{sourceSize:t,previewSize:i}=this;return t&&(e.sourceSize=this.sourceSize),i&&(e.previewSize=this.previewSize),e}}}const Da=[e.DefinitionType.Audio,e.DefinitionType.Video,e.DefinitionType.VideoSequence],Pa=e=>Ta(e)&&"startOptions"in e;const Aa=e=>va(e)&&"audibleSource"in e;function Ea(e,t){Aa(e)||i(e,"UpdatableDefinition",t)}function Va(t){return class extends t{constructor(...e){super(...e);const[t]=e,{gain:i}=t;if(h(i))if(r(i))if(i.includes(",")){const e=i.split(",").map((e=>parseFloat(e))),t=e.length/2;for(let i=0;i<t;i+=1)this.gainPairs.push([e[2*i],e[2*i+1]]);this.gain=-1}else this.gain=Number(i);else g(i)&&(this.gain=i)}definitionTime(e,t){const i=super.definitionTime(e,t),{startTrim:n,endTrim:s,definition:r}=this,{duration:o}=r,a=Lr(o,t.fps).frame-(n+s),c=i.frame%a;return i.withFrame(c+n).divide(this.speed)}frames(e){const{definition:t,startTrim:i,endTrim:n}=this;return t.frames(e)-(i+n)}gain=1;gainPairs=[];fileUrls(t){const{editing:i,audible:n,time:s}=t;if(!n||i&&!s.isRange)return[];if(!this.mutable()||this.muted)return[];const{definition:r}=this,o=r.urlAudible(i);return[{type:e.LoadType.Audio,file:o,definition:r,input:!0}]}hasGain(){if(0===this.gain)return!0;if(g(this.gain))return!1;if(2!==this.gainPairs.length)return!1;const[e,t]=this.gainPairs;if(2!==e.length)return!1;if(2!==t.length)return!1;if(Math.max(...e))return!1;const[i,n]=t;return 1===i&&0===n}hasIntrinsicTiming=!0;initialCommandFilters(e,t,i=!1){const n=[],{time:s,quantize:r,commandFiles:o,clipTime:a,videoRate:c,duration:l}=e,{id:u}=this;let h=Qs(o,u,!0);x(h,"filterInput");const d="trim",p=Tn(d),m={};l&&(m.duration=l);const{frame:f}=this.definitionTime(s,a);f&&(m.start=jr(f,r).seconds);const g={inputs:[h],ffmpegFilter:d,options:m,outputs:[p]};if(n.push(g),h=p,l){const e="fps",t=Tn(e),i={ffmpegFilter:e,options:{fps:c},inputs:[h],outputs:[t]};n.push(i),h=t}const y="setpts",v={ffmpegFilter:y,options:{expr:"PTS-STARTPTS"},inputs:[h],outputs:[Tn(y)]};return n.push(v),n}intrinsicsKnown(e){if(!super.intrinsicsKnown(e))return!1;const{duration:t}=e;return!t||T(this.definition.duration)}mutable(){return this.definition.audio}selectedProperty(e){const{name:t}=e;return"gain"===t?this.mutable()&&!this.muted:super.selectedProperty(e)}setValue(e,t,i){if(super.setValue(e,t,i),!i)switch(t){case"startTrim":case"endTrim":case"speed":this.clip.resetTiming(this)}}startOptions(e,t){let i=t.withFrame(this.startTrim).seconds,n=t.seconds-e,s=t.lengthSeconds;return n<0&&(i-=n,s+=n,n=0),{start:n,offset:i,duration:s}}toJSON(){const e=super.toJSON(),{speed:t,gain:i}=this;return 1!==t&&(e.speed=t),1!==i&&(e.gain=i),e}_trimFilter;get trimFilter(){return this._trimFilter||=Vr("trim")}}}function za(t){return class extends t{constructor(...t){super(...t);const[i]=t,{audioUrl:n,audio:s,loop:r,duration:o,waveform:a,loadedAudio:c}=i;(s||n||c)&&(this.audio=!0,I(n)&&(this.audioUrl=n),a&&(this.waveform=a),c&&(this.loadedAudio=c)),T(o)&&(this.duration=o),r&&(this.loop=r,this.properties.push(un({name:"loops",defaultValue:1}))),this.properties.push(un({name:"gain",defaultValue:1,type:e.DataType.Percent,min:0,max:2,step:.01})),this.properties.push(un({name:"speed",defaultValue:1,type:e.DataType.Percent,min:.1,max:2,step:.1,group:e.DataGroup.Timing})),this.properties.push(un({name:"startTrim",defaultValue:0,type:e.DataType.Frame,step:1,min:0,group:e.DataGroup.Timing})),this.properties.push(un({name:"endTrim",defaultValue:0,type:e.DataType.Frame,step:1,min:0,group:e.DataGroup.Timing}))}audibleSource(e){const{loadedAudio:t}=this;if(t)return la.createBufferSource(t);const{audioUrl:i}=this;if(!I(i))return void(this.audio=!1);const n=e.getCache(ds("audio",i));if(!n)return;const{error:s,result:r}=n;return s||!Jn(r)?(this.audio=!1,void(this.audioUrl="")):(this.loadedAudio=r,la.createBufferSource(r))}audio=!1;audioUrl="";duration=0;frames(t){const{duration:i}=this;return i?Lr(this.duration,t,"floor").frame:e.Duration.Unknown}loadedAudio;loop=!1;toJSON(){const e=super.toJSON(),{duration:t,audio:i,loop:n,waveform:s,audioUrl:r,url:o}=this;return t&&(e.duration=t),i&&(e.audio=i),n&&(e.loop=n),s&&(e.waveform=s),o?e.url=o:r&&(e.audioUrl=r),e}urlAudible(e=!1){return e?this.audioUrl||this.url:this.source}waveform}}class Oa{constructor(e){const{buffer:t,gain:i,preloader:n}=e;g(i)&&(this.gain=i),T(t)&&(this.buffer=t),this.preloader=n}adjustClipGain(e,t){const i=e.timeRange(t);this.clipSources(e).forEach((e=>{this.adjustSourceGain(e,i)}))}adjustSourceGain(e,t){const i=la.getSource(e.id);if(!i)return;const{gainNode:n}=i;if(0===this.gain)return void(n.gain.value=0);const s=e.gain;if(g(s))return void(n.gain.value=this.gain*s);const r=k(t)?e.startOptions(this.seconds,t):t,{start:o,duration:a}=r;n.gain.cancelScheduledValues(0),e.gainPairs.forEach((e=>{const[t,i]=e;n.gain.linearRampToValueAtTime(this.gain*i,o+t*a)}))}buffer=qr.mash.buffer;bufferClips(e,t){return!!this.createSources(e,t)&&(this.destroySources(e),!0)}bufferSource;clear(){}clipSources(e){const t=[],{container:i,content:n}=e;return Pa(i)&&!i.muted&&t.push(i),Pa(n)&&!n.muted&&t.push(n),t}createSources(e,t,i){if(!this.playing&&!i)return!1;const n=e.filter((e=>!this.playingClips.includes(e)));if(!n.length)return!0;let s=!0;return n.forEach((e=>{const n=this.clipSources(e),r=e.timeRange(t),o=n.filter((e=>!la.hasSource(e.id)));s&&=o.every((e=>{const t=this.playing?this.seconds:i?.seconds||0,n=e.startOptions(t,r),{start:s,duration:o,offset:a}=n;if(g(s)&&T(o)){const{definition:t,id:i}=e;Ea(t);const r=t.audibleSource(this.preloader);if(!r)return!!s;const{loop:c}=t;la.startAt(i,r,s,o,a,c),this.adjustSourceGain(e,n)}else console.error(this.constructor.name,"createSources",n);return!0}))})),this.playingClips.push(...n),s}destroySources(e=[]){[...this.playingClips].filter((t=>!e.includes(t))).forEach((e=>{this.clipSources(e).forEach((e=>la.deleteSource(e.id)))})),this.playingClips=e}gain=qr.mash.gain;setGain(e,t){this.gain!==e&&(this.gain=e,this.playing&&this.playingClips.forEach((e=>this.adjustClipGain(e,t))))}playing=!1;playingClips=[];preloader;get seconds(){return la.currentTime-this.contextSecondsWhenStarted+this.startedMashAt}startContext(){if(this.bufferSource)throw mn.internal+"bufferSource startContext";if(this.playing)throw mn.internal+"playing";const e=la.createBuffer(this.buffer);this.bufferSource=la.createBufferSource(e),this.bufferSource.loop=!0,this.bufferSource.connect(la.destination),this.bufferSource.start(0)}startPlaying(e,t,i){if(!this.bufferSource)throw mn.internal+"bufferSource startPlaying";if(this.playing)throw mn.internal+"playing";const{seconds:n}=e;return this.playing=!0,this.startedMashAt=n,this.contextSecondsWhenStarted=la.currentTime,!!this.createSources(t,i,e)||(this.stopPlaying(),!1)}startedMashAt=0;contextSecondsWhenStarted=0;stopContext(){this.bufferSource&&(this.bufferSource.stop(),this.bufferSource.disconnect(la.destination),delete this.bufferSource)}stopPlaying(){this.playing&&(this.playing=!1,this.destroySources(),this.startedMashAt=0,this.contextSecondsWhenStarted=0)}}const Ra="BACKCOLOR",ka="SILENCE";class _a{constructor(e){const{upload:t,mash:i,background:n,size:s,time:r,streaming:o,videoRate:a,visible:c}=e;da(i),this.mash=i,this.time=r,this.videoRate=a,this.background=n,this.upload=t,console.log(this.constructor.name,"upload",e.upload),this.size=s,c&&(this.visible=!0),o&&(this.streaming=!0),V(T(this.videoRate),"videoRate"),V(this.time.fps===this.quantize,"time is in mash rate")}_id;get id(){return this._id||=Tn("filtergraph")}get avType(){return this.visible?e.AVType.Video:e.AVType.Audio}background;get commandFilterVisible(){const{duration:e,videoRate:t,background:i,size:n}=this;console.log(this.constructor.name,this.id,"commandFilterVisible size",n);const s={ffmpegFilter:"color",options:{color:i||wt,rate:t,size:`${n.width}x${n.height}`},inputs:[],outputs:[Ra]};return e&&(s.options.duration=e),s}get commandFilterAudible(){const{duration:e}=this,t={ffmpegFilter:"aevalsrc",options:{exprs:0,duration:e},inputs:[],outputs:[ka]};return e&&(t.options.duration=e),t}_clips;get clips(){return this._clips||=this.clipsInitialize}get clipsInitialize(){const{time:e,mash:t,avType:i}=this;return t.clipsInTimeOfType(e,i).sort(sr)}get commandInputs(){return this.inputCommandFiles.map((e=>{const{options:t}=e;return{source:this.preloader.key(e),options:t}}))}_commandFiles;get filterGraphCommandFiles(){return this._commandFiles||=this.commandFilesInitialize}get commandFilesInitialize(){const{time:e,videoRate:t,quantize:i,size:n,clips:s,visible:r,preloader:o}=this,a=s.flatMap((s=>{const o=s.timeRange(i),a={time:e,quantize:i,visible:r,outputSize:n,videoRate:t,clipTime:o};return s.clipCommandFiles(a)}));return a.forEach((e=>{e.resolved=o.key(e)})),a}get commandFilters(){const e=[],{time:t,quantize:i,size:n,clips:s,visible:r,videoRate:o,filterGraphCommandFiles:a,upload:c}=this;console.log(this.constructor.name,"commandFilters upload",c);const l={videoRate:o,time:t,quantize:i,visible:r,outputSize:n,commandFiles:a,chainInput:"",clipTime:Nr(t),track:0,upload:c};r?c||(e.push(this.commandFilterVisible),l.chainInput=Ra):(e.push(this.commandFilterAudible),l.chainInput=ka);const{length:u}=s;return s.forEach(((t,n)=>{l.clipTime=t.timeRange(i),l.track=n,e.push(...t.commandFilters(l));const s=en(e);n<u-1&&(s.outputs.length||s.outputs.push(Tn("clip"))),l.chainInput=en(s.outputs)})),e}get duration(){return this.time.lengthSeconds}get inputCommandFiles(){return this.filterGraphCommandFiles.filter((e=>e.input))}mash;get preloader(){return this.mash.preloader}get quantize(){return this.mash.quantize}size;streaming=!1;time;upload;visible=!1;videoRate}class Ma{args;constructor(t){this.args=t;const{avType:i,times:n,mash:s,...r}=t;console.log(this.constructor.name,"upload",t.upload);const{length:o}=n;if(!o)return void(this.time=jr());const[a]=n,c=[],l=[],u=[];if(n.forEach((e=>{u.push(e.fps),c.push(e.frame),e.isRange&&l.push(e.timeRange.end)})),l.length){const e=Math.max(...u);if(e!==Math.min(...u))throw mn.internal+"timeranges fps";const t=Math.min(...c),i=Math.max(...l);this.time=Mr(t,e,i)}else V(1===o,"just one time"),this.time=a;if(i!==e.AVType.Video){V(1===o||i!==e.AVType.Audio,"single time for avtype audio");const t={...r,time:this.time,mash:s,visible:!1};this.filterGraphAudible=new _a(t)}i!==e.AVType.Audio&&this.filterGraphsVisible.push(...n.map((e=>{const t={...r,time:e,mash:s,visible:!0};return new _a(t)})))}assureDuration(){}assureSize(){}get duration(){return this.time.lengthSeconds}filterGraphsVisible=[];filterGraphAudible;get filterGraphVisible(){return this.filterGraphsVisible[0]}_graphFiles;get fileUrls(){const e=[...this.filterGraphsVisible];return this.filterGraphAudible&&e.push(this.filterGraphAudible),this._graphFiles||=e.flatMap((e=>e.filterGraphCommandFiles))}get graphFilesInput(){return this.fileUrls.filter((e=>e.input))}get loadPromise(){return this.args.mash.preloader.loadFilesPromise(this.fileUrls)}time}class Na{args;constructor(e){this.args=e}get clip(){return this.args.clip}get container(){return this.clip.container}get editor(){return this.preview.editor}get icon(){return!!this.args.icon}get id(){return this.clip.id}pointerDown(){const t={...xi},{editor:i,container:n,timeRange:s,rect:r,clip:o}=this,{rect:a}=i,c=()=>{globalThis.window.removeEventListener("pointermove",h),globalThis.window.removeEventListener("pointermove",u),globalThis.window.removeEventListener("pointerup",l),globalThis.window.removeEventListener("pointerup",d)},l=e=>{er(e),c(),i.dragging=!1,i.redraw()},u=o=>{er(o);const{offE:c,offN:l,offS:u,offW:h}=n,{x:d,y:p,width:m,height:f}=r;let g=a.width-m,y=a.height-f,v=0,T=0;c&&(v-=m,g+=m),h&&(g+=m),l&&(T-=f,y+=f),u&&(y+=f);const{clientX:b,clientY:w}=o,F=b-a.x,S=w-a.y,I=t.x-a.x,x=S-(t.y-a.y-p),C=Ws(F-(I-d),v,v+g),D=Ws(x,T,T+y),P=Us(n),{lastTime:A}=s,E=i.time.equalsTime(A),V=P&&E,z=V?`x${ui}`:"x",O=V?`y${ui}`:"y",R={[z]:n.value(z),[O]:n.value(O)},k={[z]:g?C/g:R[z],[O]:y?D/y:R[O]},_={property:e.DataGroup.Point,target:n,type:e.ActionType.ChangeMultiple,redoValues:k,undoValues:R};i.actions.create(_)},h=e=>{er(e);const{clientX:r,clientY:o}=e;if(!Ii({x:r,y:o},t)){if(Us(n)){const{time:e}=i,t=e.closest(s);if(!e.equalsTime(t))return c(),void i.goToTime(t)}i.dragging=!0,globalThis.window.removeEventListener("pointermove",h),globalThis.window.addEventListener("pointermove",u),u(e)}},d=e=>{if(er(e),!(e instanceof PointerEvent))return;const{clientX:n,clientY:s}=e;t.x=n,t.y=s,globalThis.window.addEventListener("pointermove",h),globalThis.window.addEventListener("pointerup",l),i.selection.clip!==o&&i.selection.set(o)};return d}get preview(){return this.args.preview}get quantize(){return this.preview.quantize}_rect;get rect(){return this._rect||this.rectInitialize}get rectInitialize(){const{time:e,timeRange:t,clip:i,size:n}=this;ji(n,`${this.constructor.name}.rectInitialize size`);const s={size:n,time:e,timeRange:t,editing:!0},r=i.rects(s);return V(Yi(...r)),r[0]}get size(){return this.preview.size}editingSvgItem(e,t){const{container:i,rect:n}=this,s=i.pathElement(n);return s.setAttribute("vector-effect","non-scaling-stroke"),jn(s,e),t||s.addEventListener("pointerdown",this.pointerDown()),s}svgBoundsElement(e,t){const i=[],{rect:n,container:s}=this,{directions:r}=s,{width:o,height:a,x:c,y:l}=n,u={x:c-1,y:l-1,width:o,height:2};i.push(Dn(u,e)),u.y=l+a-1,i.push(Dn(u,e)),u.x=c+o-1,u.height=a,u.width=2,u.y=l,i.push(Dn(u,e)),u.x=c-1,i.push(Dn(u,e));const h={width:o,height:a};return r.forEach((n=>{const s=this.svgHandlePoint(h,n),r={x:c+s.x,y:l+s.y,width:8,height:8},o=Dn(r,[...e,n.toLowerCase()]);i.push(o),t||o.addEventListener("pointerdown",(e=>{console.log("pointerdown",n),this.editor.selection.set(this.clip),er(e)}))})),i}svgHandlePoint(t,i){const{width:n,height:s}=t,r={...xi},[o,a]=String(i).split("");$e(o,i);const c=a||o;switch($e(c),c){case e.Direction.W:r.x=-4;break;case e.Direction.E:r.x=n-4;break;default:r.x=Math.round(n/2)-4}switch(o){case e.Direction.N:r.y=-4;break;case e.Direction.S:r.y=s-4;break;default:r.y=Math.round(s/2)-4}return r}get time(){return this.preview.time}_timeRange;get timeRange(){return this._timeRange||=this.clip.timeRange(this.quantize)}}class $a{constructor(e){const{selectedClip:t,editor:i,time:s,mash:r,background:o,onlyClip:a,size:c}=e;this.mash=r,this.size=c||r.imageSize,this.time=s,this.background=o,this.selectedClip=t,this.onlyClip=a,n(i)&&(this.editor=i)}audible=!1;background;_clips;get clips(){return this._clips||=this.clipsInitialize}get clipsInitialize(){const{mash:t,time:i,onlyClip:n}=this;return n?[n]:t.clipsInTimeOfType(i,e.AVType.Video).sort(sr)}combine=!1;get duration(){return this.time.lengthSeconds}get editing(){return n(this.editor)}editor;get intrinsicSizePromise(){const{clips:e,preloader:t}=this,i={editing:!0,size:!0},n=e.filter((e=>!e.intrinsicsKnown(i))).flatMap((e=>e.intrinsicGraphFiles(i)));return t.loadFilesPromise(n)}get itemsPromise(){const{clips:e,size:t,time:i,onlyClip:n}=this;let s=Promise.resolve([]);const r=!!n;return e.forEach((e=>{s=s.then((n=>e.previewItemsPromise(t,i,r).then((e=>[...n,e]))))})),s}mash;onlyClip;get preloader(){return this.mash.preloader}get quantize(){return this.mash.quantize}size;selectedClip;streaming=!1;_svgItems;time;_trackPreviews;get trackPreviews(){return this._trackPreviews||=this.trackPreviewsInitialize}get trackPreviewsInitialize(){const e=[],{time:t,quantize:i,clips:n}=this,s=t.isRange?void 0:t.scale(i);return n.forEach((n=>{const r=n.timeRange(i).scale(t.fps),o=Math.max(0,t.frame-r.frame),a=r.withFrame(o),c={clip:n,preview:this,tweenTime:s,timeRange:a,icon:!!this.onlyClip};e.push(new Na(c))})),e}get svgItemPromise(){return this.svgItemsPromise.then((e=>{const{length:t}=e;if(1===t)return e[0];const{size:i}=this,n=An(i);return e.forEach((e=>n.appendChild(e))),n}))}get svgItemsPromise(){if(this._svgItems)return Promise.resolve(this._svgItems);return this.intrinsicSizePromise.then((()=>this.itemsPromise.then((e=>this._svgItems=this.tupleItems(e)))))}tupleItems(e){const{clips:t,size:i,editing:n,background:r,selectedClip:o,editor:a}=this,c=[...e];if(r){const e=Dn(i,"",r),t=An(i,e);c.unshift(t)}if(!n||!t.length)return c;s(a);const{dragging:l}=a,{trackPreviews:u}=this,h=u.find((e=>e.clip===o)),d=u.map((e=>{const t=["outline"];return l||e===h||t.push("animate"),e.editingSvgItem(t)}));if(c.push(An(i,d)),!h)return c;const p=["bounds","back"];return c.push(An(i,h.svgBoundsElement(p))),p[1]="fore",c.push(An(i,h.svgBoundsElement(p,!0))),c}visible=!0}const ja=e=>Vo(e)&&Pa(e);class La extends wn{constructor(...e){super(...e);const[t]=e,{container:i,content:n}=t;this.containerInitialize(i||{}),this.contentInitialize(n||{})}assureTimingAndSizing(t,i,n){const{timing:s,sizing:r,containerId:o}=this;let a=s!==t,c=r!==i;return a||=n.hasIntrinsicTiming,c||=n.hasIntrinsicSizing,a||(t===e.Timing.Content&&o?this.timing=e.Timing.Container:this.timing=e.Timing.Custom),c||(i===e.Sizing.Content&&o?this.sizing=e.Sizing.Container:this.sizing=e.Sizing.Preview),!(c&&a)}get audible(){return this.mutable}clipFileUrls(e){const t=[],{quantize:i}=e,{content:n,container:s,frames:r}=this;return T(r)&&(e.clipTime||=this.timeRange(i)),s&&t.push(...s.fileUrls(e)),t.push(...n.fileUrls(e)),t}clipIcon(e,t,i=1){const{container:n}=this;if(!n)return;const{track:s}=this,{quantize:r,imageSize:o}=s.mash;ji(o,"track.mash.imageSize");const a=Ri(Ni(o,e,!0));ji(a,`${this.constructor.name}.clipIcon containedSize`);const c=a.width+i,l=Math.ceil(e.width/c),u=this.timeRange(r),{startTime:h}=u,d=[],{mash:p}=s;let m=0;for(let e=0;e<l;e++){const{copy:e}=h,i=new $a({mash:p,time:e,onlyClip:this,size:a});d.push(i),m+=c,h.frame=u.frame+Ss(m,t,"floor")}let f=Promise.resolve([]);return d.forEach((e=>{f=f.then((t=>e.svgItemPromise.then((e=>[...t,e]))))})),f.then((t=>{const i={...xi},n=An(e);return t.forEach((e=>{xn(e,i),kn(n,e),i.x+=c})),n}))}clipCommandFiles(e){const t=[],{visible:i,quantize:n,outputSize:s,time:r}=e,o=this.timeRange(n),{content:a,container:c}=this,l={...e,clipTime:o};if(i){ji(s),wi(c);const e={size:s,time:r,timeRange:o,loading:!0},i=this.rects(e);l.containerRects=i;const n=Zo(a)?a.contentColors(r,o):void 0,u={...l,outputSize:s,contentColors:n,containerRects:i};if(!n){const e=a.visibleCommandFiles(u);t.push(...e)}const h=c.visibleCommandFiles(u);t.push(...h)}else V(!i,"outputSize && container"),t.push(...this.content.audibleCommandFiles(l));return t}commandFilters(e){const t=[],{visible:i,quantize:n,outputSize:s,time:r}=e,o=this.timeRange(n),a={...e,clipTime:o},{content:c,container:l}=this;if(!i)return this.content.audibleCommandFilters(a);ji(s),wi(l);const u={size:s,time:r,timeRange:o},h=this.rects(u);a.containerRects=h;const d={point:!Ii(...h),size:!Vi(...h)},p=Zo(c)?c.contentColors(r,o):void 0,m=C(p);m&&(d.color=p[0]!==p[1],d.canColor=d.color?l.canColorTween(e):l.canColor(e));const f=r.isRange?r.lengthSeconds:0,g=f?Math.min(f,o.lengthSeconds):0,y={...a,contentColors:p,outputSize:s,containerRects:h,duration:g};return m?d.canColor||(t.push(...l.containerColorCommandFilters(y)),y.filterInput=en(en(t).outputs)):(t.push(...c.commandFilters(y,d)),y.filterInput=en(en(t).outputs)),t.push(...l.commandFilters(y,d,!0)),t}_container;get container(){return this._container||this.containerInitialize()}containerInitialize(t={}){const{containerId:i}=this,n=i||t.definitionId;if(!I(n))return;const s=vt.fromId(n),r={...t,definitionId:n,container:!0},o=s.instanceFromObject(r);return wi(o),this.assureTimingAndSizing(e.Timing.Container,e.Sizing.Container,o),o.clip=this,this.timing===e.Timing.Container&&this._track&&this.resetTiming(o),this._container=o}_content;get content(){return this._content||this.contentInitialize()}contentInitialize(t={}){const{contentId:i}=this,n=i||t.definitionId;x(n);const s=vt.fromId(n),r={...t,definitionId:n},o=s.instanceFromObject(r);if(zo(o),this.assureTimingAndSizing(e.Timing.Content,e.Sizing.Content,o)){const{container:t}=this;t&&this.assureTimingAndSizing(e.Timing.Container,e.Sizing.Container,t)}return o.clip=this,this.timing===e.Timing.Content&&this._track&&this.resetTiming(o),this._content=o}copy(){const e={...this.toJSON(),id:""};return this.definition.instanceFromObject(e)}definitionIds(){const e=[...super.definitionIds(),...this.content.definitionIds()];return this.container&&e.push(...this.container.definitionIds()),e}get endFrame(){return this.frame+this.frames}endTime(e){return jr(this.endFrame,e)}intrinsicsKnown(e){const{content:t,container:i}=this;let n=t.intrinsicsKnown(e);return i&&(n&&=i.intrinsicsKnown(e)),n}intrinsicGraphFiles(e){const{content:t,container:i}=this,n=[];return t.intrinsicsKnown(e)||n.push(t.intrinsicGraphFile(e)),i&&!i.intrinsicsKnown(e)&&n.push(i.intrinsicGraphFile(e)),n}maxFrames(e,t){return 0}get mutable(){const{content:e}=this;if(e.mutable())return!0;const{container:t}=this;if(!t)return!1;return t.mutable()}get notMuted(){const{content:e,muted:t}=this;if(t)return!1;if(e.mutable()&&!e.muted)return!0;const{container:i}=this;return!i?.mutable()||!i.muted}previewItemsPromise(e,t,i){ji(e);const n=this.timeRange(this.track.mash.quantize),r=t||n.startTime,{container:o,content:a}=this;wi(o);const c={size:e,time:r,timeRange:n,editing:!0},l=this.rects(c);V(Yi(...l));const[u]=l;return o.containerPreviewItemPromise(u,r,n,i).then((t=>{const c=[t];let l=yn();const h=Sa(o),d=Sa(a)&&!i;if(h&&!i){const e=Dn(u,"","transparent",l);e.setAttribute("vector-effect","non-scaling-stroke;"),c.push(e),l=yn()}return t.setAttribute("id",l),a.contentPreviewItemPromise(u,r,n,i).then((i=>{s(i);const p=In();kn(p,[Dn(u,"","transparent"),i]);const m=[p];jn(p,"contained");const f=On(void 0,p,true);c.push(f);const g=Ln(l);f.appendChild(g),h||(t.setAttribute("vector-effect","non-scaling-stroke;"),g.setAttribute("fill",St));const y=o.containerSvgFilter(t,e,u,r,n);y?c.push(y):t.removeAttribute("filter");const v=a.contentSvgFilter(i,e,u,r,n);v?c.push(v):i.removeAttribute("filter");const T=d?this.svgElement:An();return Un(T,[_n(c),...m]),xn(T,e),T}))}))}rectIntrinsic(t,i,n){const s={...t,...xi},{sizing:r}=this;if(i||r===e.Sizing.Preview)return s;const o=r===e.Sizing.Container?this.container:this.content;if(fi(o),!o.intrinsicsKnown({editing:n,size:!0}))return s;return o.intrinsicRect(n)}rects(e){const{size:t,loading:i,editing:n}=e,s=this.rectIntrinsic(t,i,n),{container:r}=this;return wi(r),r.containerRects(e,s)}resetTiming(t,i){const{timing:n}=this,s=this._track;switch(n){case e.Timing.Custom:if(g(this.frames))break;this.frames=qr.duration*(i||s.mash.quantize);break;case e.Timing.Container:{const e=bi(t)?t:this.container;if(!e)break;this.frames=e.frames(i||s.mash.quantize);break}case e.Timing.Content:{const e=Vo(t)?t:this.content;if(!e)break;this.frames=e.frames(i||s.mash.quantize);break}}}selectType=e.SelectType.Clip;selectables(){return[this,...this.track.selectables()]}selectedItems(t){const i=[],{properties:n}=this;return n.filter((e=>this.selectedProperty(e))).forEach((n=>{const{name:s}=n,r="frames"===s||"frame"===s,o=this.value(s),a=this;i.push({value:o,selectType:e.SelectType.Clip,property:n,changeHandler:(i,n)=>{x(i);const s={property:i,target:a,redoValue:n,undoValue:o,type:r?e.ActionType.ChangeFrame:e.ActionType.Change};t.create(s)}})})),i}selectedProperty(t){const{name:i,type:n}=t;switch(n){case e.DataType.ContainerId:case e.DataType.ContentId:return!1}switch(i){case"sizing":return!ja(this.content);case"timing":if(this.content.hasIntrinsicTiming)break;return!!this.container?.hasIntrinsicSizing;case"frame":return!this.track.dense;case"frames":return this.timing===e.Timing.Custom}return!0}setValue(e,t,i){switch(super.setValue(e,t,i),t){case"containerId":this._container&&this.containerInitialize(this._container.toJSON());break;case"contentId":this._content&&this.contentInitialize(this._content.toJSON())}}_svgElement;get svgElement(){return this._svgElement||=An()}updateSvg(e){xn(this.svgElement,e)}time(e){return jr(this.frame,e)}timeRange(e){const{frame:t,frames:i}=this;return y(t,"timeRange frame"),b(i,"timeRange frames"),Mr(this.frame,e,this.frames)}timeRangeRelative(e,t){const i=this.timeRange(t).scale(e.fps),n=Math.max(0,e.frame-i.frame);return e.withFrame(n)}toJSON(){const e=super.toJSON(),{container:t,content:i}=this;return e.content=i,e.contentId=i.definitionId,t?(e.container=t,e.containerId=t.definitionId):e.containerId="",e}toString(){return`[Clip ${this.label}]`}_track;get track(){return this._track}set track(e){this._track=e}get trackNumber(){const{track:e}=this;return e?e.index:-1}set trackNumber(e){e<0&&delete this._track}get visible(){return!!this.containerId}}class qa extends ps{constructor(...t){super(...t),this.properties.push(un({name:"containerId",type:e.DataType.ContainerId,defaultValue:yi})),this.properties.push(un({name:"contentId",type:e.DataType.ContentId,defaultValue:Eo})),this.properties.push(un({name:"label",type:e.DataType.String})),this.properties.push(un({name:"sizing",type:e.DataType.Sizing,defaultValue:e.Sizing.Content})),this.properties.push(un({name:"timing",type:e.DataType.Timing,defaultValue:e.Timing.Content,group:e.DataGroup.Timing})),this.properties.push(un({type:e.DataType.Frame,group:e.DataGroup.Timing,defaultValue:e.Duration.None,min:0,step:1})),this.properties.push(un({name:"frames",type:e.DataType.Frame,defaultValue:e.Duration.Unknown,min:1,step:1,group:e.DataGroup.Timing}))}audible=!1;instanceArgs(t={}){const i=super.instanceArgs(t),{containerId:n,contentId:s}=i,r=a(s)||s===Eo;let o=a(n)||n===yi;return i.sizing===e.Sizing.Content&&r&&(i.sizing=e.Sizing.Container),i.sizing===e.Sizing.Container&&o&&(i.sizing=e.Sizing.Preview),i.timing===e.Timing.Content&&r&&(i.timing=e.Timing.Container),i.timing===e.Timing.Container&&o&&(i.timing=e.Timing.Custom),i}instanceFromObject(e={}){return new La(this.instanceArgs(e))}streamable=!1;type=e.DefinitionType.Clip;visible=!1}const Ga=new qa({label:"Visible",type:"visible",id:"com.moviemasher.clip.default",containerId:"com.moviemasher.container.default",contentId:"com.moviemasher.content.default"}),Ba=Ga.id,Ua=[Ga],Wa=t=>{const{id:i}=t;return x(i),new qa({...t,type:e.DefinitionType.Clip})},Ha=e=>{const t=Ua.find((t=>t.id===e));return t||Wa({id:e})},Ja=(e={})=>{const{definitionId:t=Ba}=e;if(!t)throw mn.id;return Ha(t).instanceFromObject(e)},Ka=e=>Ha(e).instanceFromObject({definitionId:e});lt[e.DefinitionType.Clip]={definition:Wa,definitionFromId:Ha,fromId:Ka,instance:Ja,defaults:Ua};class Ya extends hi{constructor(e){super();const{clips:t,index:i,dense:n}=e;g(i)&&(this.index=i),this.dense=h(n)?!!n:!this.index,this.properties.push(un({name:"dense",defaultValue:!1})),this.propertiesInitialize(e),t&&this.clips.push(...t.map((e=>{const t=Ja(e);return t.track=this,t})))}addClips(e,t=0){let i=t||0;this.dense||(i=0);const n=i,s=this.clips.filter(((t,s)=>{const r=e.includes(t);return n&&r&&s<n&&(i-=1),!r}));s.splice(i,0,...e),this.sortClips(s),tn(this.clips,s)}assureFrame(e){const t=e||this.clips;let i=!1,n=0;const s=[],{dense:r}=this;return t.forEach((e=>{const{frame:t}=e;(r?t!==n:s.some((e=>e.includes(t))))&&(i=!0,e.frame=n),n=e.frame+e.frames,r||s.push(e.timeRange(1))})),i}assureFrames(e,t){const i=h(t);(t||this.clips).forEach((t=>{const{frames:n}=t;T(n)||(t.resetTiming(void 0,e),!T(t.frames)&&i&&(t.frames=Math.floor(qr.duration*e)))}))}clips=[];dense=!1;frameForClipNearFrame(e,t=0){if(this.dense)return t;const i=this.clips.filter((i=>e!==i&&i.endFrame>t));if(!i.length)return t;const n=e.frame,s=e.endFrame-n;let r=t;return i.find((e=>{if(e.frame>=r+s)return!0;r=e.endFrame})),r}get frames(){const{clips:t}=this,{length:i}=t;if(!i)return e.Duration.None;for(const i of t){const{frames:t}=i;switch(t){case e.Duration.Unknown:case e.Duration.Unlimited:return t}}const n=en(t),{frame:s,frames:r}=n;return s+r}_identifier;get identifier(){return this._identifier||=Tn("track")}index=0;_mash;get mash(){const{_mash:e}=this;return da(e),e}set mash(e){this._mash=e}removeClips(e){const t=this.clips.filter((t=>!e.includes(t)));V(t.length!==this.clips.length),e.forEach((e=>e.trackNumber=-1)),this.sortClips(t),tn(this.clips,t)}selectType=e.SelectType.Track;selectables(){return[this,...this.mash.selectables()]}selectedItems(t){return this.properties.map((i=>{const n=this.value(i.name),s=this;return{value:n,property:i,selectType:e.SelectType.Track,changeHandler:(e,i)=>{x(e);const r={target:s,property:e,redoValue:i,undoValue:n};t.create(r)}}}))}sortClips(e){const t=e||this.clips,i=this.assureFrame(t);return t.sort(ir),i}toJSON(){const e=super.toJSON();return e.clips=this.clips,e}}const Xa=e=>new Ya(e),Za={instance:Xa};class Qa extends $a{get clips(){return[]}}class ec extends pa{constructor(e){super(e);const{createdAt:t,icon:i,id:n,label:s,frame:r,preloader:o,rendering:a,tracks:c,...l}=e;this.dataPopulate(l),I(a)&&(this._rendering=a),I(t)&&(this.createdAt=t),T(r)&&(this._frame=r),C(c)&&c.forEach(((e,t)=>{const i={dense:!t,...e,index:t},n=Xa(i);n.mash=this,n.assureFrames(this.quantize),n.sortClips(),this.tracks.push(n)})),this.assureTrack(),this.tracks.sort(nr),this._preview=new Qa({mash:this,time:jr()})}addClipToTrack(e,t=0,i=0,n){const s=w(e)?e:[e],r=this.trackClips(s,t);this.emitIfFramesChange((()=>{r.forEach((e=>{const[t,s]=e,r=this.tracks[t];ya(r,"track"),s.forEach((e=>{const i=e.trackNumber;g(i)&&i!==t&&e.track.removeClips([e]),g(n)&&(e.frame=n),e.track=r})),r.assureFrames(this.quantize,s),r.addClips(s,i)}))}))}addTrack(t={}){g(t.index)||(t.index=this.tracks.length);const i=Xa(t);return i.mash=this,this.tracks.push(i),this.tracks.sort(nr),this.emitter?.emit(e.EventType.Track),i}assureTrack(){if(!this.tracks.length){const e=Xa({dense:!0});e.mash=this,this.tracks.push(e)}}_buffer=qr.mash.buffer;get buffer(){return this._buffer}set buffer(e){if(!T(e))throw mn.invalid.argument+"buffer "+e;this._buffer!==e&&(this._buffer=e,this._composition&&(this.composition.buffer=e))}bufferStart(){this._bufferTimer||(this._bufferTimer=setInterval((()=>{if(this._paused)return;this.loadPromiseUnlessBuffered({editing:!0,audible:!0});const e=this.clipsAudibleInTime(this.timeToBuffer);this.composition.bufferClips(e,this.quantize)}),Math.round(1e3*this.buffer/2)))}bufferStop(){this._bufferTimer&&(clearInterval(this._bufferTimer),delete this._bufferTimer)}_bufferTimer;changeTiming(e,t,i){this.emitIfFramesChange((()=>{e.setValue(i,t)}))}clearDrawInterval(){this.drawInterval&&(clearInterval(this.drawInterval),this.drawInterval=void 0)}clearPreview(){delete this._preview}clipIntersects(e,t){return!e.frames||e.timeRange(this.quantize).intersects(t)}get clips(){return this.tracks.map((e=>e.clips)).flat()}clipsAudibleInTime(e){const{clips:t}=this,i=t.filter((e=>e.mutable&&e.notMuted));return this.filterIntersecting(i,e)}clipsInTime(e){return this.filterIntersecting(this.clips,e)}clipsInTimeOfType(t,i=e.AVType.Both){switch(i){case e.AVType.Both:return this.clipsInTime(t);case e.AVType.Audio:return this.clipsAudibleInTime(t);case e.AVType.Video:return this.clipsVisibleInTime(t)}}get clipsVisible(){return this.clips.filter((e=>e.container))}clipsVisibleInTime(e){return this.filterIntersecting(this.clipsVisible,e)}compositeVisible(t){this.drawingTime=t,this.clearPreview(),this.emitter?.emit(e.EventType.Draw)}compositeVisibleRequest(e){requestAnimationFrame((()=>{this.compositeVisible(e)}))}_composition;get composition(){if(!this._composition){const e={buffer:this.buffer,gain:this.gain,preloader:this.preloader};this._composition=new Oa(e)}return this._composition}get definitionIds(){const{clips:e}=this,t=e.flatMap((e=>e.definitionIds()));return[...new Set(t)]}destroy(){this.paused=!0,this.clearDrawInterval()}draw(){const{time:e}=this;this.compositeVisible(e)}drawInterval;drawRequest(){const{time:e}=this;this.compositeVisibleRequest(e)}drawTime(t){const i=t!==this.time;this.drawnTime=t,this.drawRequest(),this.emitter?.emit(i?e.EventType.Time:e.EventType.Loaded)}drawWhilePlayerNotPlaying(){const e=performance.now();if(e-this.drawnSeconds<1/this.quantize)return;this.drawnSeconds=e;const{time:t}=this;if(!this.clipsVisibleInTime(t).filter((e=>e.definition.streamable)).length)return;this.graphFilesUnloaded({time:t,editing:!0,visible:!0}).length||this.drawRequest()}drawingTime;drawnSeconds=0;drawnTime;get duration(){return this.endTime.seconds}emitIfFramesChange(t){const i=this.frames;t();const{frames:n}=this;i!==n&&(this.emitter?.emit(e.EventType.Duration),this.frame>n&&this.seekToTime(jr(n,this.quantize)))}get endTime(){return jr(this.frames,this.quantize)}filterGraphs(t={}){const{background:i,time:n,avType:s,graphType:r,size:o,videoRate:a,...c}=t,l=n||this.time,u=s||(l.isRange?e.AVType.Both:e.AVType.Video),h={...c,times:this.timeRanges(u,l),avType:u,graphType:r||e.GraphType.Mash,size:o||this.imageSize,videoRate:a||l.fps,mash:this,background:i||this.color};return console.log(this.constructor.name,"filterGraphs filterGraphsOptions",h.upload,t.upload),new Ma(h)}filterIntersecting(e,t){const i=t.scale(this.quantize);return e.filter((e=>this.clipIntersects(e,i)))}_frame=0;get frame(){return this.time.scale(this.quantize,"floor").frame}get frames(){const{tracks:t}=this;if(t.length){const t=this.tracks.map((e=>e.frames));return g(Math.min(...t))?Math.max(0,...t):e.Duration.Unknown}return e.Duration.None}_gain=qr.mash.gain;get gain(){return this._gain}set gain(e){if(!g(e))throw mn.invalid.argument+"gain "+e;this._gain!==e&&(this._gain=e,this._composition&&this.composition.setGain(e,this.quantize))}graphFileOptions(e={}){const{time:t,audible:i,visible:n,editing:s,streaming:r}=e,o=t||this.time,{isRange:a}=o,c=n||!a,l=a&&i,u={editing:s,streaming:r,audible:l,visible:c,time:o,quantize:this.quantize};return V(c||l,"audible || visible"),u}editedGraphFiles(t){const i=this.graphFileOptions(t),{time:n,audible:s,visible:r}=i,{quantize:o}=this;R(n);const a=n.scale(this.quantize),c=s&&r?e.AVType.Both:s?e.AVType.Audio:e.AVType.Video;return this.clipsInTimeOfType(a,c).flatMap((e=>{const t=e.timeRange(o),s={...i,clipTime:t,quantize:o,time:n};return e.clipFileUrls(s)}))}graphFilesUnloaded(e){const t=this.editedGraphFiles(e);if(!t.length)return[];const{preloader:i}=this;return t.filter((e=>!i.loadedFile(e)))}handleDrawInterval(){const{seconds:t}=this.composition,i=this.time.withFrame(this.time.frame);if(t>=this.endTime.seconds)this.loop?this.seekToTime(this.time.withFrame(0)):(this.paused=!0,this.emitter?.emit(e.EventType.Ended));else if(t>=i.seconds){const e=Lr(t,this.time.fps);this.drawTime(e)}}_layer;get layer(){return this._layer}set layer(e){this._layer=e}loadPromise(e={}){return this.loadPromiseUnlessBuffered(e)||Promise.resolve()}loadingPromises=[];get loading(){return!!this.loadingPromises.length}loadPromiseUnlessBuffered(e={}){e.time||=this.timeToBuffer;const t=this.graphFilesUnloaded(e);if(!t.length)return;const i=this.preloader.loadFilesPromise(t),n=i.then((()=>{const e=this.loadingPromises.indexOf(i);if(e<0)throw mn.internal+"couldn't find promise~";this.loadingPromises.splice(e,1)}));return this.loadingPromises.push(i),n}loop=!1;get mashes(){return[this]}_paused=!0;get paused(){return this._paused}set paused(t){const i=t||!this.frames;if(this._paused!==i)if(this._paused=i,i)this.playing=!1,this.bufferStop(),this._bufferTimer&&(clearInterval(this._bufferTimer),delete this._bufferTimer),this.composition.stopContext(),this.emitter?.emit(e.EventType.Pause);else{this.composition.startContext(),this.bufferStart();const t=this.loadPromiseUnlessBuffered({editing:!0,audible:!0,visible:!0});t?t.then((()=>{this.playing=!0})):this.playing=!0,this.emitter?.emit(e.EventType.Play)}}_playing=!1;get playing(){return this._playing}set playing(t){if(this._playing!==t)if(this._playing=t,t){const{quantize:t,time:i}=this,n=this.clipsAudibleInTime(this.timeToBuffer);if(!this.composition.startPlaying(i,n,t)){const e=this.clipsAudibleInTime(this.timeToBuffer);if(!this.composition.startPlaying(i,e,t))return void(this._playing=!1)}this.emitter?.emit(e.EventType.Playing),this.setDrawInterval()}else this.composition.stopPlaying(),this.clearDrawInterval()}_preview;preview(e){return this._preview||=this.previewInitialize(e)}previewInitialize(e){return new $a(this.previewArgs(e))}previewArgs(e={}){const{editor:t}=e,i=t?.selection.clip,n=ma(i)?i:void 0,{drawingTime:s,time:r,quantize:o}=this,c={selectedClip:n,time:(s||r).scale(o),mash:this,...e};return a(e.background)&&(c.background=this.color),c}putPromise(){const{quantize:e,preloader:t}=this,i=this.clips.flatMap((t=>{const{container:i}=t;if(Kr(i)&&!i.intrinsicsKnown({editing:!0,size:!0})){const n={editing:!0,visible:!0,quantize:e,time:t.time(e),clipTime:t.timeRange(e)};return i.fileUrls(n)}return[]}));return t.loadFilesPromise(i)}removeClipFromTrack(e){const t=w(e)?e:[e];this.emitIfFramesChange((()=>{t.forEach((e=>{e.track.removeClips([e])}))}))}removeTrack(t){const i=g(t)?t:this.tracks.length-1;y(i),this.emitIfFramesChange((()=>{this.tracks.splice(i,1)})),this.emitter?.emit(e.EventType.Track)}_rendering="";get rendering(){return this._rendering}set rendering(t){this._rendering=t,this.emitter?.emit(e.EventType.Render)}restartAfterStop(t,i,n){t.equalsTime(this.time)&&(n&&(delete this.seekTime,this.emitter?.emit(e.EventType.Seeked)),this.drawTime(t),i||(this.playing=!0))}reload(){return this.stopLoadAndDraw()}seekTime;seekToTime(t){return this.seekTime!==t&&(this.seekTime=t,this.emitter?.emit(e.EventType.Seeking),this.emitter?.emit(e.EventType.Time)),this.stopLoadAndDraw(!0)}selectType=e.SelectType.Mash;selectables(){const e=[this];return this._layer&&e.push(...this.layer.selectables()),e}selectedItems(t){return this.properties.map((i=>{const n=this.value(i.name),s=this;return{value:n,selectType:e.SelectType.Mash,property:i,changeHandler:(e,i)=>{x(e);const r={property:e,target:s,redoValue:i,undoValue:n};t.create(r)}}}))}setDrawInterval(){this.drawInterval||(this.clearDrawInterval(),this.drawInterval=setInterval((()=>{this.handleDrawInterval()}),500/this.time.fps))}stopLoadAndDraw(e){const{time:t,paused:i,playing:n}=this;n&&(this.playing=!1);const s=this.loadPromiseUnlessBuffered({editing:!0,visible:!0,audible:n});if(s)return s.then((()=>{this.restartAfterStop(t,i,e)}));this.restartAfterStop(t,i,e)}svgItems(e){return this.preview(e).svgItemsPromise}get time(){return this.seekTime||this.drawnTime||jr(this._frame,this.quantize)}get timeRange(){const{endTime:e,time:t}=this,i=e.scale(t.fps);return Nr(t,i.frame)}timeRanges(t,i){const n=i||this.time,{quantize:s}=this,r=n.scale(this.quantize,"floor"),o=r.isRange?r.timeRange.endTime:void 0,a=this.clipsInTimeOfType(n,t),{length:c}=a;if(!c)return[];if(1===c||!r.isRange||t===e.AVType.Audio)return[n];const l=new Set;a.forEach((e=>{l.add(Math.max(e.frame,r.frame)),l.add(Math.min(e.frame+e.frames,o.frame))}));const u=[...l].sort(((e,t)=>e-t));let h=u.shift();return u.map((e=>{const t=Mr(h,s,e-h);return h=e,t}))}get timeToBuffer(){const{time:e,quantize:t,buffer:i,paused:n}=this;return n?jr(e.scale(t,"floor").frame,t):$r(e,Lr(i+e.seconds,e.fps))}toJSON(){const e=super.toJSON();return e.tracks=this.tracks,this._rendering&&(e.rendering=this.rendering),e}trackClips(e,t){if(g(t))return[[t,e]];let i=this.tracks.length-e.length;return e.map((e=>[i++,[e]]))}tracks=[]}const tc=(e={})=>new ec(e),ic=e=>e instanceof ec;class nc extends hi{constructor(t){super(),this.properties.push(un({name:"label",type:e.DataType.String})),this.propertiesInitialize(t)}_cast;get cast(){return this._cast}set cast(e){this._cast=e}_id;get id(){return this._id||=Tn("layer")}get mashes(){throw mn.unimplemented+"mashes"}selectType=e.SelectType.Layer;selectables(){return[this,...this.cast.selectables()]}selectedItems(t){return this.properties.map((i=>{const n=this.value(i.name),s=this;return{value:n,selectType:e.SelectType.Layer,property:i,changeHandler:(e,i)=>{x(e);const r={property:e,target:s,redoValue:i,undoValue:n};t.create(r)}}}))}toJSON(){const e=super.toJSON();return e.type=this.type,e.triggers=this.triggers,e}triggers=[];type}class sc extends nc{constructor(e){super(e);const{label:t,layers:i,collapsed:n}=e;t||(this.label=qr.label),this.collapsed=n,this.layers=i}collapsed;layers;get mashes(){return this.layers.flatMap((e=>e.mashes))}toJSON(){const e=super.toJSON();return e.layers=this.layers,e.collapsed=this.collapsed,e}type=e.LayerType.Folder}class rc extends nc{constructor(e){super(e);const{mash:t}=e;console.log("LayerMashClass",this.label,t.label),this.label||(this.label=t.label),this.mash=t,t.layer=this}get mashes(){return[this.mash]}mash;toJSON(){const e=super.toJSON();return e.mash=this.mash,e}type=e.LayerType.Mash}const oc=e=>n(e)&&"type"in e&&B(e.type),ac=t=>oc(t)&&t.type===e.LayerType.Folder,cc=t=>oc(t)&&t.type===e.LayerType.Mash;e.LayerType.Folder,e.LayerType.Mash;const lc=(e,t)=>{const{preloader:i}=e;e.layers||=[];const n={...e,layers:e.layers.map((e=>hc({preloader:i,...e})))};return new sc(n)},uc=(e,t)=>{const{preloader:i}=e;e.mash||={};const n=tc({preloader:i,...e.mash}),s={...e,mash:n};return new rc(s)},hc=(e,t)=>{if(cc(e))return uc(e);if(ac(e))return lc(e);throw new Error("expected LayerObject")},dc=e=>e instanceof nc;function pc(e){if(!dc(e))throw"expected Layer"}const mc=e=>e instanceof rc;function fc(e){if(!mc(e))throw"expected LayerMash"}const gc=e=>e instanceof sc;function yc(e){if(!gc(e))throw"expected LayerFolder"}const vc=e=>e.flatMap((e=>gc(e)?[e,...vc(e.layers)]:[])),Tc=(t,i)=>i===e.DroppingPosition.After?t+1:t,bc=(e,t)=>{if(t.includes(e))return;return vc(t).find((t=>t.layers.includes(e)))};class wc extends pa{constructor(e){super(e);const{createdAt:t,icon:i,id:n,label:s,definitions:r,layers:o,preloader:a,...c}=e;this.dataPopulate(c),C(o)&&this.layers.push(...o.map((e=>this.createLayer(e))))}addLayer(t,i={}){const{layers:n,index:s}=((t,i)=>{const{layer:n,position:s=e.DroppingPosition.At}=i,r=m(s),o=!!n,a=o&&gc(n),c=r?s:0;if(!o||r)return{index:c,layers:a?n.layers:t};if(a&&s===e.DroppingPosition.At)return{index:0,layers:n.layers};const l=bc(n,t);if(!l)return{index:c,layers:t};const{layers:u}=l,h=u.indexOf(n);if(h<0)throw new Error(mn.internal);return{layers:u,index:Tc(h,s)}})(this.layers,i);n.splice(s,0,t)}_buffer=qr.cast.buffer;get buffer(){return this._buffer}set buffer(e){if(!T(e))throw mn.invalid.argument+"buffer "+e;this._buffer!==e&&(this._buffer=e,this.mashes.forEach((t=>{t.buffer=e})))}createLayer(e){const{preloader:t}=this,i={preloader:t,...e},n=hc(i);return pc(n),n.cast=this,n}destroy(){this.mashes.forEach((e=>e.destroy()))}emitterChanged(){this.mashes.forEach((e=>e.emitter=this.emitter))}editedGraphFiles(e){return this.mashes.flatMap((t=>t.editedGraphFiles(e)))}get imageSize(){return super.imageSize}set imageSize(e){super.imageSize=e;const{imageSize:t}=this;this.mashes.forEach((e=>{e.imageSize=t}))}layers=[];get layerFolders(){return vc(this.layers)}loadPromise(e){return Promise.all(this.mashes.map((t=>t.loadPromise(e)))).then(ht)}get loading(){return this.mashes.some((e=>e.loading))}get mashes(){return this.layers.flatMap((e=>e.mashes))}moveLayer(e,t){const i=this.removeLayer(e);return this.addLayer(e,t),i}putPromise(){return Promise.all(this.mashes.map((e=>e.putPromise()))).then(ht)}reload(){}removeLayer(e){const t=bc(e,this.layers),i=t?.layers||this.layers,n=i.indexOf(e);if(n<0)throw console.error("removeLayer",n,i.length,e.label,t?.label),new Error(mn.internal);return i.splice(n,1),{position:n,layer:t}}selectType=e.SelectType.Cast;selectables(){return[this]}selectedItems(t){return this.properties.map((i=>{const n=this.value(i.name),s=this;return{value:n,selectType:e.SelectType.Cast,property:i,changeHandler:(e,i)=>{x(e);const r={property:e,target:s,redoValue:i,undoValue:n};t.create(r)}}}))}setValue(e,t,i){if(super.setValue(e,t,i),!i&&"color"===t)this.mashes.forEach((n=>n.setValue(e,t,i)))}svgItems(e){const{mashes:t,imageSize:i}=this,n=[],{background:s=this.color}=e,r={...e,color:""},o=Dn(i,"",s);let a=Promise.resolve([o]);return nn(t).forEach((e=>{a=a.then((t=>(n.push(...t),e.svgItems(r))))})),a.then((e=>(n.push(...e),n)))}toJSON(){const e=super.toJSON();return e.layers=this.layers,e}}const Fc=(e={},t)=>{const i={...e,preloader:t};return new wc(i)},Sc=e=>e instanceof wc;function Ic(e){if(!Sc(e))throw new Error("expected Cast")}const xc=e=>ha(e)||Sc(e);class Cc{constructor(e){const{redoSelection:t,type:i,undoSelection:n}=e;this.redoSelection=t,this.type=i,this.undoSelection=n}get cast(){const{cast:e}=this.redoSelection;if(Sc(e))return e;const{cast:t}=this.undoSelection;return Ic(t),t}done=!1;get mash(){const{mash:e}=this.redoSelection;if(ha(e))return e;const{mash:t}=this.undoSelection;return da(t),t}redo(){this.redoAction(),this.done=!0}redoAction(){throw mn.unimplemented+"redoAction"}redoSelection;get selection(){return this.done?this.redoSelection:this.undoSelection}type;undo(){this.undoAction(),this.done=!1}undoAction(){throw mn.unimplemented+"undoAction"}undoSelection}const Dc=e=>e instanceof Cc;function Pc(e){if(!Dc(e))throw new Error("expected Action")}class Ac extends Cc{constructor(e){super(e);const{createTracks:t}=e;this.createTracks=t}createTracks;redoAction(){for(let e=0;e<this.createTracks;e+=1)this.mash.addTrack()}undoAction(){for(let e=0;e<this.createTracks;e+=1)this.mash.removeTrack()}}class Ec extends Ac{constructor(e){super(e);const{clips:t,insertIndex:i,trackIndex:n,redoFrame:s,undoFrame:r}=e;this.clips=t,this.insertIndex=i,this.trackIndex=n,this.redoFrame=s,this.undoFrame=r}clips;insertIndex;trackIndex;get track(){return this.mash.tracks[this.trackIndex]}redoAction(){super.redoAction();const{mash:e,redoFrame:t,trackIndex:i,insertIndex:n,clips:s}=this;e.addClipToTrack(s,i,n,t)}redoFrame;undoAction(){const{mash:e,clips:t}=this;e.removeClipFromTrack(t),super.undoAction()}undoFrame}class Vc extends Cc{constructor(e){super(e);const{effect:t,effects:i,index:n}=e;this.effect=t,this.effects=i,this.index=n}effect;effects;index;redoAction(){this.effects.splice(this.index,0,this.effect)}undoAction(){this.effects.splice(this.index,1)}}const zc=e=>n(e)&&"target"in e&&"property"in e;class Oc extends Cc{constructor(e){super(e);const{property:t,redoValue:i,target:n,undoValue:s}=e;this.property=t,this.redoValue=i,this.target=n,this.undoValue=s}property;redoValue;target;undoValue;get redoValueNumeric(){return Number(this.redoValue)}get undoValueNumeric(){return Number(this.undoValue)}redoAction(){this.target.setValue(this.redoValue,this.property)}undoAction(){this.target.setValue(this.undoValue,this.property)}updateAction(e){const{redoValue:t}=e;this.redoValue=t,this.redo()}}const Rc=e=>e instanceof Oc;class kc extends Oc{constructor(e){super(e)}redoAction(){this.mash.changeTiming(this.target,this.property,this.redoValueNumeric)}undoAction(){this.mash.changeTiming(this.target,this.property,this.undoValueNumeric)}}class _c extends Ac{constructor(e){super(e);const{clip:t,insertIndex:i,redoFrame:n,trackIndex:s,undoFrame:r,undoInsertIndex:o,undoTrackIndex:a}=e;this.clip=t,this.insertIndex=i,this.redoFrame=n,this.trackIndex=s,this.undoFrame=r,this.undoInsertIndex=o,this.undoTrackIndex=a}clip;insertIndex;trackIndex;undoTrackIndex;undoInsertIndex;undoFrame;redoFrame;addClip(e,t,i){this.mash.addClipToTrack(this.clip,e,t,i)}redoAction(){super.redoAction(),this.addClip(this.trackIndex,this.insertIndex,this.redoFrame)}undoAction(){this.addClip(this.undoTrackIndex,this.undoInsertIndex,this.undoFrame),super.undoAction()}}class Mc extends Cc{constructor(e){super(e);const{effects:t,redoEffects:i,undoEffects:n}=e;this.effects=t,this.redoEffects=i,this.undoEffects=n}effects;redoEffects;redoAction(){this.effects.splice(0,this.effects.length,...this.redoEffects)}undoAction(){this.effects.splice(0,this.effects.length,...this.undoEffects)}undoEffects}class Nc extends Cc{constructor(e){super(e);const{clip:t,index:i,track:n}=e;this.clip=t,this.index=i,this.track=n}track;clip;index;get trackIndex(){return this.track.index}redoAction(){this.mash.removeClipFromTrack(this.clip)}undoAction(){this.mash.addClipToTrack(this.clip,this.trackIndex,this.index)}}class $c extends Cc{constructor(e){super(e);const{layerAndPosition:t}=e;t&&(this.layerAndPosition=t)}layerAndPosition;get layer(){const{layer:e}=this.redoSelection;return pc(e),e}redoAction(){this.cast.addLayer(this.layer,this.layerAndPosition)}undoAction(){this.cast.removeLayer(this.layer)}}class jc extends Cc{get layer(){const{layer:e}=this.redoSelection;return pc(e),e}layerAndPosition;redoAction(){this.layerAndPosition=this.cast.removeLayer(this.layer)}undoAction(){this.cast.addLayer(this.layer,this.layerAndPosition)}}class Lc extends $c{get layer(){const{layer:e}=this.redoSelection;return pc(e),e}undoLayerAndPosition;redoAction(){this.undoLayerAndPosition=this.cast.moveLayer(this.layer,this.layerAndPosition)}undoAction(){this.cast.moveLayer(this.layer,this.undoLayerAndPosition)}}class qc extends Oc{constructor(e){const{redoValues:t,undoValues:i}=e;super(e),this.undoValues=i,this.redoValues=t}redoAction(){const{target:e,redoValues:t}=this;Object.entries(t).forEach((([t,i])=>{e.setValue(i,t)}))}redoValues;undoAction(){const{target:e,undoValues:t}=this;Object.entries(t).forEach((([t,i])=>{e.setValue(i,t)}))}updateAction(e){const{redoValues:t}=e;this.redoValues=t,this.redo()}undoValues}const Gc=t=>{const{type:i}=t;if(!I(i))throw mn.type+JSON.stringify(t);switch(i){case e.ActionType.AddClipToTrack:return new Ec(t);case e.ActionType.AddEffect:return new Vc(t);case e.ActionType.AddLayer:return new $c(t);case e.ActionType.AddTrack:return new Ac(t);case e.ActionType.Change:return new Oc(t);case e.ActionType.ChangeFrame:return new kc(t);case e.ActionType.ChangeMultiple:return new qc(t);case e.ActionType.MoveClip:return new _c(t);case e.ActionType.MoveEffect:return new Mc(t);case e.ActionType.MoveLayer:return new Lc(t);case e.ActionType.RemoveClip:return new Nc(t);case e.ActionType.RemoveLayer:return new jc(t);default:throw mn.type+i}},Bc={createFromObject:Gc};class Uc{editor;constructor(e){this.editor=e}add(e){const t=this.instances.length-(this.index+1);g(t)&&this.instances.splice(this.index+1,t),this.instances.push(e)}get canRedo(){return this.index<this.instances.length-1}get canSave(){return this.canUndo}get canUndo(){return this.index>-1}create(t){const{editor:i}=this,{undoSelection:n,redoSelection:s,type:r=e.ActionType.Change,...o}=t,a={...o,type:r,undoSelection:n||{...i.selection.object},redoSelection:s||{...i.selection.object}};if(zc(t)&&this.currentActionLast){const{currentAction:e}=this;if(Rc(e)){const{target:n,property:s}=t;if(e.target===n&&e.property===s)return e.updateAction(t),void i.handleAction(e)}}const c=Gc(a);this.add(c),i.handleAction(this.redo())}get currentAction(){return this.instances[this.index]}get currentActionLast(){return this.canUndo&&!this.canRedo}destroy(){this.index=-1,this.instances.splice(0,this.instances.length)}index=-1;instances=[];redo(){this.index+=1;const e=this.currentAction;return Pc(e),e.redo(),e}reusableChangeAction(e,t){if(!this.currentActionLast)return;const i=this.currentAction;return Rc(i)&&i.target===e&&i.property===t?i:void 0}save(){this.instances.splice(0,this.index+1),this.index=-1}get selection(){return this.editor.selection}undo(){const e=this.currentAction;return Pc(e),this.index-=1,e.undo(),e}}const Wc=e=>n(e)&&"cast"in e,Hc=e=>n(e)&&"mash"in e;function Jc(e,t){Hc(e)||i(e,"MashData",t)}class Kc extends EventTarget{dispatch(e,t){this.dispatchEvent(this.event(e,t))}emit(e,t){if(!this.trapped.has(e))return void this.dispatch(e,t);const i=this.trapped.get(e);i&&i(this.event(e,t))}event(e,t){return new CustomEvent(e,t?{detail:t}:void 0)}trap(e,t){this.trapped.has(e)||this.trapped.set(e,t||null)}trapped=new Map}const Yc=t=>pi(t)&&t.type===e.DefinitionType.Effect;function Xc(e){if(!Yc(e))throw new Error("expected Effect")}const Zc=t=>gt(t)&&t.type===e.DefinitionType.Font;class Qc{constructor(e){this.endpoint=e||{}}absoluteUrl(e){return e}browsing=!0;cacheGet(e,t){const i=this.key(e),n=this.cacheKey(e),s=this.loaderCache.get(n);if(s||!t)return s;const{definition:r,type:o}=e,a=[];gt(r)&&a.push(r);const c={loaded:!1,definitions:a};return this.cacheSet(n,c),c.promise=this.cachePromise(i,e,c).then((e=>(c.loaded=!0,c.result=e,e))).catch((e=>(c.error=e,c.loaded=!0,e))),c}cacheKey(e){const{type:t}=e;return`${t}:/${this.key(e)}`}cachePromise(e,t,i){const n={loaderPath:this.cacheKey(t),urlOrLoaderPath:e,loaderType:t.type};return this.filePromise(n)}cacheSet(e,t){const i=r(e)?e:this.cacheKey(e);this.loaderCache.set(i,t)}endpoint;filePromise(e){throw mn.unimplemented+"filePromise"}flushFilesExcept(e=[]){const t=e.map((e=>this.cacheKey(e)));[...this.loaderCache.keys()].filter((e=>!t.includes(e))).forEach((e=>{this.loaderCache.get(e)&&this.loaderCache.delete(e)}))}getCache(e){const t=this.parseUrlPath(e).pop();return s(t),this.loaderCache.get(t.loaderPath)}getError(e){return this.cacheGet(e)?.error}getFile(e){const t=this.cacheGet(e),i=t?.result;if(i)return i;{const{type:i}=e,n=`${i}-${this.key(e)}`;t?console.trace(this.constructor.name,`getFile NO RESULT files.${n} for`,e.definition?.label):console.trace(this.constructor.name,`getFile NOTHING AT files.${n} for`,e.definition?.label,this.loaderCache.keys())}}getLoaderCache(t,i,n){const{loaderPath:s,loaderType:r}=t,o=this.loaderCache.get(s);if(o||!i)return o;const a=[];gt(n)&&a.push(n);const c={loaded:!1,definitions:a};return r!==e.GraphFileType.Svg&&this.setLoaderCache(s,c),c.promise=this.filePromise(t).then((e=>(c.loaded=!0,c.result=e,e))).catch((e=>(c.error=e,c.loaded=!0,e))),c}imagePromise(e){const t=new Image;return t.src=e,t.decode().then((()=>t))}info(e){e||console.trace(this.constructor.name,"info NO loaderPath");const t=this.parseUrlPath(e);t.reverse();for(const e of t){const t=this.loaderCache.get(e.urlOrLoaderPath);if(!t)continue;const{loadedInfo:i}=t;if(P(i))return i}}key(e){throw mn.unimplemented+"key"}lastCssUrl(e){const t=[...e.matchAll(/url\(([^)]+)\)(?!.*\1)/g)];return en(en(t))}loadFilesPromise(e){const t=e.map((e=>this.loadGraphFilePromise(e)));return Promise.all(t).then(ht)}loadPromise(e,t){const i=this.loaderCache.get(e);if(i){const{promise:e,result:t,loaded:n,error:r}=i;return n||r?Promise.resolve(t):(s(e),e)}const n=this.parseUrlPath(e);n.reverse();const r=n.shift();s(r);let o=this.loaderFilePromise(r,t);return n.forEach((e=>{o=o.then((()=>this.loaderFilePromise(e)))})),o.then((e=>e))}loadGraphFilePromise(e){const{type:t,file:i,definition:n}=e,s=`${t}:/${i}`;return this.loadPromise(s,n)}loadedFile(e){return!!this.cacheGet(e)?.loaded}loaderCache=new Map;loaderFilePromise(e,t){let i=this.getLoaderCache(e,!0,t);s(i);const{promise:n,result:r,loaded:o,error:a}=i;return r&&o&&!a?Promise.resolve(r):(s(n),n)}media(e){const t=this.loaderCache.get(e);if(t){const{result:e,loaded:i,error:n}=t;if(i||n)return e}}parseUrlPath(e){x(e);return ls(e,this.endpoint).map((e=>{const[t,i,n]=e,s=`${t}:${i}/${n}`;Yn(t);return{loaderPath:s,urlOrLoaderPath:n,loaderType:t,options:us(i)}}))}setLoaderCache(e,t){this.loaderCache.set(e,t)}sourceUrl(t){const i=this.cacheGet(t);if(!i?.loaded)return this.key(t);const{type:n}=t,{result:r}=i;switch(s(r),n){case e.LoadType.Image:case e.LoadType.Video:return r.src}return""}updateDefinitionDuration(e,t,i){const{duration:n}=e;T(n)||(e.duration=t),i&&(e.audio=!0)}updateDefinitionSize(e,t){const i=this.browsing?"previewSize":"sourceSize",{[i]:n}=e;Vi(t,n)||(e[i]=t)}updateDefinitionFamily(e,t){const{family:i}=e;i||(e.family=t)}updateCache(e,t){e.loadedInfo||={};const{definitions:i,loadedInfo:n}=e,{duration:s,width:r,height:o,audible:a,family:c}=t,l={width:r,height:o},u=T(s),h=$i(l);h&&(n.width||=l.width,n.height||=l.height),u&&(a&&(n.audible=!0),n.duration||=s),c&&(n.family||=c),i.forEach((e=>{h&&Ia(e)&&this.updateDefinitionSize(e,l),u&&Aa(e)&&this.updateDefinitionDuration(e,s,a),c&&Zc(e)&&this.updateDefinitionFamily(e,c)}))}updateLoaderFile(e,t){const i=this.getLoaderCache(e);s(i),this.updateCache(i,t)}updateDefinitions(e,t){const i=this.cacheGet(e);s(i),this.updateCache(i,t)}videoPromise(e){return new Promise(((t,i)=>{const n=this.videoFromUrl(e);n.oncanplay=()=>{n.oncanplay=null,n.onerror=null;const{videoWidth:e,clientWidth:i,videoHeight:s,clientHeight:r}=n,o=e||i,a=s||r;n.width=o,n.height=a,t(n)},n.onerror=i,n.autoplay=!1,n.load()}))}videoFromUrl(e){if(!globalThis.document)throw"wrong environment";const t=globalThis.document.createElement("video");return t.src=e,t}}class el extends Qc{constructor(e){super(e);const[t,i]=this.canvasContext({width:1,height:1});i.fillRect(0,0,1,1),this.svgImagePromise(t.toDataURL()).then((()=>{this.svgImageEmitsLoadEvent=!0}))}absoluteUrl(e){return ss(this.endpoint,e)}arrayBufferPromise(e){return fetch(e).then((e=>e.arrayBuffer()))}audioBufferPromise(e){return la.decode(e)}audioInfo(e){const{duration:t}=e;return{duration:t,audible:!0}}audioPromise(e){x(e,"url");return(e.startsWith("blob:")?this.blobAudioPromise(e):this.arrayBufferPromise(e)).then((e=>this.audioBufferPromise(e)))}blobAudioPromise(e){return fetch(e).then((e=>e.blob())).then((e=>new Promise(((t,i)=>{const n=new FileReader;n.onload=()=>{t(n.result)},n.onerror=i,n.readAsArrayBuffer(e)}))))}svgImageEmitsLoadEvent=!1;canvas(e){const{width:t,height:i}=e,n=document.createElement("canvas");return n.height=i,n.width=t,n}canvasContext(e){const t=this.canvas(e),i=t.getContext("2d");return V(i),[t,i]}filePromise(t){const{loaderType:i}=t;switch(i){case e.LoadType.Audio:return this.requestAudio(t);case e.LoadType.Font:return this.requestFont(t);case e.LoadType.Image:return this.requestImage(t);case e.LoadType.Video:return this.requestVideo(t);case e.GraphFileType.Svg:return this.requestSvgImage(t)}throw mn.invalid.type+i}filePromises(t,i){return t.map((t=>{const{name:n,type:s}=t,r=s.split("/").shift(),o={label:n,error:""};if(!ge(r))return Promise.resolve({...o,error:"import.type",value:r});const a=yn(),c=ds("object",a),l=URL.createObjectURL(t),u={type:r,label:n,url:ds(r,c),source:l,id:vn()},h=r===e.LoadType.Audio,d=r===e.LoadType.Image,p=h||r===e.LoadType.Video,m=r===e.LoadType.Image||r===e.LoadType.Video;return this.mediaPromise(r,l).then((e=>{const t=this.mediaInfo(e);if(p){const{duration:e}=t;if(!T(e))return{...o,error:"import.duration",value:e};u.audio=!0,u.duration=e,u.audioUrl=m?ds("video",c):c}if(m){const n=Bi(t);if(!$i(n))return{...o,error:"import.size",value:Wi(n)};const s=i?Ni(n,i,!0):n,{width:r,height:a}=s;u.previewSize=s,d?(u.icon=ds("image",c,{width:r,height:a}),u.loadedImage=e):(u.icon=ds("video",c,{fps:10}),u.loadedVideo=e)}else u.loadedAudio=e;return this.loadLocalFile(e,c,t),u}))}))}fontFamily(e){return e.replaceAll(/[^a-z0-9]/gi,"_")}imageInfo(e){return Bi(e)}key(e){const{file:t,type:i}=e;return pe(i)?ss(this.endpoint,t):t}loadLocalFile(e,t,i){const n={definitions:[],result:e,loadedInfo:i,promise:Promise.resolve(e),loaded:!0};this.setLoaderCache(t,n)}mediaInfo(e){return Wn(e)?this.videoInfo(e):Hn(e)?this.imageInfo(e):this.audioInfo(e)}mediaPromise(t,i){switch(me(t),x(i,"url"),t){case e.LoadType.Audio:return this.audioPromise(i);case e.LoadType.Image:return this.imagePromise(i);case e.LoadType.Video:return this.videoPromise(i)}throw mn.internal}requestAudio(e){const{urlOrLoaderPath:t,options:i}=e;return x(t,"urlOrLoaderPath"),es(t)?this.audioPromise(t).then((t=>(s(t),this.updateLoaderFile(e,this.audioInfo(t)),t))):t.startsWith("video:")?this.requestVideoAudio(e):this.loadPromise(t)}requestFont(t){const{urlOrLoaderPath:i}=t,n=fetch(i).then((t=>{const i=t.headers.get("content-type");return!I(i)||i.startsWith(e.LoadType.Font)?t.arrayBuffer():(V(i.startsWith("text/css")),t.text().then((e=>this.arrayBufferPromise(this.lastCssUrl(e)))))})),s=this.fontFamily(i);return n.then((e=>new FontFace(s,e).load())).then((e=>{const{fonts:i}=globalThis.document;return i.add(e),i.ready.then((()=>{const i={family:s};return this.updateLoaderFile(t,i),e}))}))}requestImage(e){const{urlOrLoaderPath:t}=e;return es(t)?this.imagePromise(t).then((t=>{const{width:i,height:n}=t,s={width:i,height:n};return this.updateLoaderFile(e,s),t})):this.requestLoadedImage(e)}requestLoadedImage(t){const{urlOrLoaderPath:i,options:n}=t,s=this.loadPromise(i);return i.split(":").shift()===e.LoadType.Video||n?s.then((e=>{const t=Bi(e),i=$i(n)?Ni(t,n):t,{width:s,height:r}=i,[o,a]=this.canvasContext(i);return a.drawImage(e,0,0,s,r),this.imagePromise(o.toDataURL())})):s}requestSvgImage(e){const{urlOrLoaderPath:t,options:i}=e;return this.sourcePromise(t).then((e=>{const t=this.svgImagePromise(e);return i?t.then((e=>{const{lock:t,...n}=i,s=ke(t)?t:void 0;return En(e,n,s),e})):t}))}requestVideo(e){const{urlOrLoaderPath:t,options:i}=e;Qn(t);const n=es(t);return i?this.seekingVideoPromise(t,i):n?this.videoPromise(t).then((t=>{const i=this.videoInfo(t);return this.updateLoaderFile(e,i),t})):this.loadPromise(t)}requestVideoAudio(e){const{urlOrLoaderPath:t}=e;return this.loadPromise(t).then((e=>{const{src:t}=e;return x(t),this.audioPromise(t)}))}seek(e,t){if(!t)throw mn.internal+"seek";t.currentTime=e.seconds}seekNeeded(e,t){const{currentTime:i}=t;if(!i&&!e.frame)return!0;return!Lr(i,e.fps).equalsTime(e)}seekPromise(e,t,i){const n=new Promise((n=>{if(!this.seekNeeded(t,i))return this.seekingPromises.delete(e),n(i);i.onseeked=()=>{i.onseeked=null,this.seekingPromises.delete(e),n(i)},this.seek(t,i)})),s=this.seekingPromises.get(e);return this.seekingPromises.set(e,n),s?s.then((()=>n)):n}copyVideoPromise(e,t){s(t);const i=e.split(":").pop();x(i);const n=this.seekingVideos.get(i);if(n)return Promise.resolve(n);const r=this.seekingVideoPromises.get(i);if(r)return r;const o=this.sourcePromise(e).then((e=>this.videoPromise(e).then((e=>this.seekPromise(i,Lr(1),e).then((()=>(this.seekingVideos.set(i,e),e)))))));return this.seekingVideoPromises.set(i,o),o}seekingVideoPromise=(e,t)=>{s(t);const i=e.split(":").pop();return x(i),this.copyVideoPromise(e,t).then((e=>{const{frame:n=0,fps:s}=t;y(n),y(s);const r=jr(n,s);return this.seekPromise(i,r,e)}))};seekingVideoPromises=new Map;seekingPromises=new Map;seekingVideos=new Map;sourcePromise(e){return es(e)?Promise.resolve(e):this.loadPromise(e).then((e=>{s(e);const{src:t}=e;return x(t),t}))}_svgElement;get svgElement(){return this._svgElement||=An()}set svgElement(e){this._svgElement=e}svgImagePromise(e){return new Promise(((t,i)=>{const n=Vn(),s=()=>{n.removeEventListener("error",r),n.removeEventListener("load",o)},r=e=>{s(),i(e)},o=()=>{s(),t(n)};n.addEventListener("error",r,{once:!0}),n.addEventListener("load",o,{once:!0}),this.svgImageEmitsLoadEvent||this.svgElement.appendChild(n),$n(n,e,"href")}))}videoInfo(e){const{duration:t,videoWidth:i,clientWidth:n,videoHeight:s,clientHeight:r}=e,o=i||n,a=s||r,c=e;let l=c.mozHasAudio;l||=Boolean(c.webkitAudioDecodedByteCount),l||=Boolean(c.audioTracks?.length),l||console.log(Object.values(e));return{width:o,height:a,duration:t,audible:l}}}class tl{get[e.SelectType.None](){}get[e.SelectType.Cast](){const{cast:e}=this._object;if(Sc(e))return e}get[e.SelectType.Clip](){const{clip:e}=this._object;if(ma(e))return e}get[e.SelectType.Layer](){const{layer:e}=this._object;if(dc(e))return e}get[e.SelectType.Mash](){const{mash:e}=this._object;if(ha(e))return e;const{layer:t}=this;return mc(t)?t.mash:void 0}get[e.SelectType.Track](){const{clip:e,track:t}=this._object;return ga(t)?t:ma(e)?e.track:void 0}get[e.SelectType.Container](){const{clip:e}=this._object;if(ma(e))return e.container}get[e.SelectType.Content](){const{clip:e}=this._object;if(ma(e))return e.content}get[e.SelectType.Effect](){const{effect:e}=this._object;if(Yc(e))return e}_editor;get editor(){return this._editor}set editor(e){this._editor=e}_focus=e.SelectType.Mash;get focus(){return this._focus}set focus(e){this._focus=e}get(e){return this[e]}unset(e){const t=this.object[e];if(!t)return;const i=t.selectables();V(i[0]===t),i.shift(),this.object=this.selectionFromSelectables(i)}set(e){const{selectType:t}=e;this.object={[t]:e}}_object={};get object(){return Object.fromEntries(Z.map((e=>[e,this.get(e)])))}set object(t){const i=this.selectionPopulated(t),{object:n}=this;this.clear(),Object.assign(this._object,i);const{object:s}=this,{mash:r,cast:o,clip:a}=n,{mash:c,cast:l,clip:u}=s;u!==a&&(ma(u)&&g(u.trackNumber)&&u.track.mash.clearPreview(),ma(a)&&g(a.trackNumber)&&a.track.mash.clearPreview()),Object.assign(this._object,i),this.editor.eventTarget.emit(e.EventType.Selection),l!==o&&this.editor.eventTarget.emit(e.EventType.Cast),c!==r&&(this.editor.eventTarget.emit(e.EventType.Mash),this.editor.eventTarget.emit(e.EventType.Track),this.editor.eventTarget.emit(e.EventType.Duration))}clear(){Z.forEach((e=>{delete this._object[e]}))}selectionFromSelectables(e){return Object.fromEntries(e.map((e=>[e.selectType,e])))}selectionPopulated(e){const{mash:t,object:i}=this,{cast:n}=i,{clip:s,track:r,layer:o,cast:a,mash:c,effect:l}=e,u=l||s||r||c||o||a||n||t;return V(u,"target"),this.selectionFromSelectables(u.selectables())}get selectTypes(){const t=[],{mash:i,object:n}=this,{clip:s,track:r,cast:o,layer:a,effect:c}=n;return o&&(t.push(e.SelectType.Cast),a&&t.push(e.SelectType.Layer)),i?(o||t.push(e.SelectType.Mash),r?(t.push(e.SelectType.Track),ma(s)?(t.push(e.SelectType.Clip),t.push(e.SelectType.Content),Yc(c)&&t.push(e.SelectType.Effect),I(s.containerId)&&t.push(e.SelectType.Container),t):t):t):t}selectedItems(e=Z){const{selectTypes:t,object:i}=this,{clip:n}=i,s=t.filter((t=>e.includes(t)));return s.flatMap((e=>{let t=i[e];return te(e)&&ma(n)&&(t=n[e]),V(t,e),t.selectedItems(this.editor.actions)}))}}const il=()=>new tl,nl=t=>gt(t)&&t.type===e.DefinitionType.Video,sl=t=>pi(t)&&t.definition.type===e.DefinitionType.Video;const rl=t=>gt(t)&&t.type===e.DefinitionType.Image;class ol{constructor(e){const{autoplay:t,precision:i,loop:n,fps:s,volume:r,buffer:o,endpoint:a,preloader:c,editType:l,readOnly:h,dimensions:d,edited:p}=e;J(l)&&(this._editType=l),h&&(this.readOnly=!0),this.editing=!this.readOnly,u(t)&&(this.autoplay=t),m(i)&&(this.precision=i),u(n)&&(this._loop=n),m(s)&&(this._fps=s),m(r)&&(this._volume=r),m(o)&&(this._buffer=o),$i(d)&&(this._rect={...xi,...d}),this.actions=new Uc(this),this.preloader=c||new el(a),p&&this.load(p)}actions;add(t,i){const n=w(t)?t:[t];if(!n.length)return Promise.resolve([]);const s=n.map((e=>(A(e),vt.fromObject(e))));if(!i)return Promise.resolve(s);const r=s.map((t=>{const{id:i,type:n}=t,s={};return Oo(t)?s.contentId=i:s.containerId=i,n===e.DefinitionType.Audio&&(s.containerId=""),Ga.instanceFromObject(s)})),o={editing:!0,duration:!0},a=r.filter((e=>e.intrinsicsKnown(o))).flatMap((e=>e.intrinsicGraphFiles(o))),{preloader:c}=this;return c.loadFilesPromise(a).then((()=>this.addClip(r,i).then((()=>s))))}addClip(t,i){const{clip:n=0,track:s=0}=i,r=w(t)?t:[t],[o]=r;if(!o)return Promise.resolve();return this.assureMash(t).then((()=>{const{mash:t}=this.selection;da(t);const{tracks:i}=t,{length:a}=i;b(a);const c=g(s),l=c?i[s]:void 0,u=l?.clips||[],h=l?.dense,d={...this.selection.object,clip:o},p=c?0:r.length,m={clips:r,type:e.ActionType.AddClipToTrack,trackIndex:s,redoSelection:d,createTracks:p};if(h){const e=g(n)?n:u.length;m.insertIndex=e}else if(p)m.redoFrame=g(n)?n:0;else{ya(l);const e=g(n)?n:l.frames;m.redoFrame=l.frameForClipNearFrame(o,e)}return this.actions.create(m),this.loadMashAndDraw()}))}addEffect(t,i=0){const{clip:n}=this.selection;if(!ma(n))throw console.error(this.constructor.name,"addEffect expected effectable selection"),mn.selection+"effectable";const{content:s}=n;zo(s);const{effects:r}=s;if(!r)throw mn.selection;const o=[...r],a=[...r];a.splice(i,0,t);const c={effects:r,undoEffects:o,redoEffects:a,redoSelection:{...this.selection.object,effect:t},type:e.ActionType.MoveEffect};return this.actions.create(c),this.loadMashAndDraw()}addFiles(t,i){const{preloader:n,eventTarget:r,rect:o}=this;let a=Promise.resolve([]);return n.filePromises(t,o).forEach((t=>{a=a.then((i=>{const o={id:Tn("activity"),type:e.ActivityType.Analyze};return r.emit(e.EventType.Activity,o),t.then((t=>{const a={...o},{label:c}=t;if(a.label=c,ft(t)){i.push(t);const{url:r,type:o}=t;x(r);const c=n.info(r);s(c),a.type=e.ActivityType.Complete,a.value=c}else{const{error:i,value:n}=t;a.type=e.ActivityType.Error,a.error=i,a.value=n}return r.emit(e.EventType.Activity,a),i}))}))})),a.then((t=>this.add(t,i).then((t=>{if(t.length){const i=sn(t.map((e=>e.type)));this.eventTarget.emit(e.EventType.Added,{definitionTypes:i})}return t}))))}addFolder(t,i){const{cast:n}=this.selection;Ic(n);const s=n.createLayer({type:e.LayerType.Folder,label:t});yc(s);const r={cast:n,layer:s},o={type:e.ActionType.AddLayer,redoSelection:r,layerAndPosition:i};this.actions.create(o)}addMash(t,i){const{cast:n}=this.selection;Ic(n);const s=t?.mashObject||{},r=t?.definitionObjects||[];vt.define(...r);const o={type:e.LayerType.Mash,mash:s},a=n.createLayer(o);fc(a);const{mash:c}=a;this.configureMash(c);const l={cast:n,layer:a,mash:c},u={type:e.ActionType.AddLayer,redoSelection:l,layerAndPosition:i};this.actions.create(u)}addTrack(){const{mash:t,cast:i}=this.selection,n={mash:t,cast:i};this.actions.create({redoSelection:n,type:e.ActionType.AddTrack,createTracks:1})}assureMash(t){const{selection:i,editType:n}=this,{mash:s}=i;if(!ha(s)){const i=w(t)?t[0]:t,{label:s}=i.content.definition,r={label:s};if(n===e.EditType.Mash)return this.load({mash:r});this.addMash({mashObject:r,definitionObjects:[]})}return Promise.resolve()}autoplay=qr.editor.autoplay;_buffer=qr.editor.buffer;get buffer(){return this._buffer}set buffer(e){const t=Number(e);if(this._buffer!==t){this._buffer=t;const{edited:e}=this;e&&(e.buffer=t)}}can(t){const{selection:i}=this,{track:n,clip:s,mash:r,layer:o}=i;switch(t){case e.MasherAction.Save:return this.actions.canSave;case e.MasherAction.Undo:return this.actions.canUndo;case e.MasherAction.Redo:return this.actions.canRedo;case e.MasherAction.Remove:return!!(s||n||o);case e.MasherAction.Render:return!!r?.id;default:throw mn.argument+"can"}}castDestroy(){const{cast:e}=this.selection;return!!e&&(e.destroy(),this.preloader.flushFilesExcept(),!0)}clearActions(){this.actions.instances.length&&(this.actions=new Uc(this),this.eventTarget.emit(e.EventType.Action))}get clips(){return this.selection.mash.clips}configureCast(e){return this.configureEdited(e),e.loadPromise({editing:!0,visible:!0}).then((()=>{this.selection.set(e),this.handleDraw()}))}configureEdited(e){e.editor=this;const{rect:t}=this;$i(t)&&(e.imageSize=Bi(t)),e.emitter=this.eventTarget}configureMash(e){return e.buffer=this.buffer,e.gain=this.gain,e.loop=this.loop,this.configureEdited(e),e.loadPromise({editing:!0,visible:!0}).then((()=>{this.selection.set(e),this.handleDraw()}))}create(){this.load({[this.editType]:{}})}get currentTime(){const{mash:e}=this.selection;return e&&e.drawnTime?e.drawnTime.seconds:0}dataPutRequest(){const{edited:e,editType:t}=this;s(e),K(t);const{label:i}=e;if(!I(i)){const i=qr[t].label;x(i,"defaultLabel"),e.setValue(i,"label")}return e.putPromise().then((()=>{if(ha(e))return{mash:e.toJSON(),definitionIds:e.definitionIds};if(Sc(e))return{cast:e.toJSON(),definitionIds:Object.fromEntries(e.mashes.map((e=>[e.id,e.definitionIds])))};throw new Error(mn.internal)}))}define(e){(Array.isArray(e)?e:[e]).forEach((e=>{const{id:t,type:i}=e;if(x(t,"define id"),vt.fromId(t))return void console.warn(this.constructor.name,"define NOT redefining",t);be(i);const n=ut[i].definition(e);vt.install(n)}))}get definitions(){const{mashes:e}=this,t=[...new Set(e.flatMap((e=>e.definitionIds)))].map((e=>vt.fromId(e)));return t}get definitionsUnsaved(){const{definitions:e}=this;return e.filter((e=>{const{type:t,id:i}=e;return!!pe(t)&&bn(i)}))}destroy(){this.castDestroy()||this.mashDestroy()}dragging=!1;drawTimeout;get duration(){return this.selection.mash?.duration||0}_editType;get editType(){return this._editType||(this._editType=this.editingCast?e.EditType.Cast:e.EditType.Mash),this._editType}get edited(){return this.selection.cast||this.selection.mash}editedData;editing;get editingCast(){return!!this.selection.cast}get endTime(){const{mash:e}=this.selection;return e?e.endTime.scale(this.fps,"floor"):jr()}eventTarget=new Kc;_fps=qr.editor.fps;get fps(){return this._fps||this.selection.mash?.quantize||qr.editor.fps}set fps(t){const i=Number(t);this._fps!==i&&(this._fps=i,this.eventTarget.emit(e.EventType.Fps),this.time=this.time.scale(this.fps))}get frame(){return this.time.frame}set frame(e){this.goToTime(jr(Number(e),this.fps))}get frames(){return this.endTime.frame}get gain(){return this.muted?0:this.volume}goToTime(e){const{fps:t,time:i}=this,{frame:n}=i,s=e?e.scaleToFps(t):jr(0,t),{frame:r}=s,{frame:o}=this.endTime,a=o-1,c=a<1?0:Math.min(r,a);if(e&&n===c)return Promise.resolve();const l=this.selection.mash?.seekToTime(jr(c,t));return l||Promise.resolve()}handleAction(t){const{edited:i}=this;V(i);const{selection:n}=t,{mash:s}=n;if(ha(s)&&(s.clearPreview(),t instanceof Oc)){const{property:e,target:i}=t;if("gain"===e)ma(i)&&s.composition.adjustClipGain(i,s.quantize)}this.selection.object=n;(i.reload()||Promise.resolve()).then((()=>{s||this.handleDraw(),this.eventTarget.emit(e.EventType.Action,{action:t})}))}handleDraw(t){!this.drawTimeout&&this.edited?.loading&&(this.drawTimeout=setTimeout((()=>{this.eventTarget.dispatch(e.EventType.Draw),delete this.drawTimeout}),10))}load(e){return this.editedData=e,this.loadEditedData()}loadCastData(t={}){const{cast:i={},definitions:n=[]}=t;vt.undefineAll(),vt.define(...n),this.eventTarget.trap(e.EventType.Draw,this.handleDraw.bind(this));const s=Fc(i,this.preloader);return this.configureCast(s)}loadEditedData(){const{rect:e,editedData:t}=this;return $i(e)?(s(t),delete this.editedData,this.destroy(),this.paused=!0,this.clearActions(),this.selection.clear(),Wc(t)?this.loadCastData(t):(Jc(t),this.loadMashData(t).then((()=>this.goToTime().then((()=>{const{edited:e}=this;ha(e)&&e.clearPreview(),this.autoplay&&(this.paused=!1)})))))):Promise.resolve()}loadMashAndDraw(){const{mash:e}=this.selection;if(!e)throw new Error(mn.selection);const t={editing:!0,visible:!0};return this.paused||(t.audible=!0),e.loadPromise(t).then((()=>{e.draw()}))}loadMashData(e={}){const{mash:t={},definitions:i=[]}=e;vt.undefineAll(),vt.define(...i);const n=tc({...t,preloader:this.preloader});return this.mashDestroy(),this.configureMash(n)}_loop=qr.editor.loop;get loop(){return this._loop}set loop(e){const t=!!e;this._loop=t;const{mash:i}=this.selection;i&&(i.loop=t)}mashDestroy(){const{mash:e}=this.selection;return!!e&&(e.destroy(),this.preloader.flushFilesExcept(),!0)}get mashes(){const{edited:e}=this;return e?Sc(e)?e.mashes:[e]:[]}move(e,t={}){if(A(e,"clip"),ma(e))return void this.moveClip(e,t);Xc(e);const{clip:i=0}=t;this.moveEffect(e,i)}moveClip(t,i={}){fa(t);const{clip:n=0,track:s=0}=i;y(n);const{mash:r}=this.selection;da(r);const{tracks:o}=r,{trackNumber:a}=t,c={clip:t,trackIndex:s,undoTrackIndex:a,type:e.ActionType.MoveClip},l=!g(s);l&&(c.createTracks=1);const u=g(a)&&o[a].dense,h=g(s)&&o[s].dense,d=l?-1:o[s].clips.indexOf(t);if(h&&(c.insertIndex=n),u&&(c.undoInsertIndex=d,n<d&&(c.undoInsertIndex+=1)),!h||!u){const{frame:e}=t,i=(l?0:o[s].frameForClipNearFrame(t,n))-e;if(!i&&s===a)return;c.undoFrame=e,c.redoFrame=e+i}this.actions.create(c)}moveEffect(t,i=0){if(!g(i))throw mn.argument+"index";const{clip:n}=this.selection;if(!n)throw mn.selection;fa(n);const s=n.content;zo(s);const{effects:r}=s,o=[...r],a=o.filter((e=>e!==t)),c=o.indexOf(t)<i?i-1:i;a.splice(c,0,t);const l={effects:r,undoEffects:o,redoEffects:a,type:e.ActionType.MoveEffect,effectable:s};this.actions.create(l)}moveLayer(t,i){const{cast:n}=this.selection;Ic(n),pc(t);const s={cast:n,layer:t},r={type:e.ActionType.MoveLayer,redoSelection:s,layerAndPosition:i};this.actions.create(r)}moveTrack(){console.debug(this.constructor.name,"moveTrack coming soon...")}_muted=!1;get muted(){return this._muted}set muted(e){const t=!!e;if(this._muted!==t){this._muted=t;const{mash:e}=this.selection;e&&(e.gain=this.gain)}}pause(){this.paused=!0}get paused(){const{mash:e}=this.selection;return!e||e.paused}set paused(e){const{mash:t}=this.selection;t&&(t.paused=e),e&&this.redraw()}play(){this.paused=!1}get position(){let e=0;return this.time.frame&&(e=this.time.seconds/this.duration,1!==e&&(e=parseFloat(e.toFixed(this.precision)))),e}set position(e){this.goToTime(Lr(this.duration*Number(e),this.fps))}get positionStep(){return parseFloat(`0.${"0".repeat(this.precision-1)}1`)}precision=qr.editor.precision;preloader;readOnly=!1;_rect={...Xi};get rect(){return this._rect}set rect(t){ji(t);const{editedData:i,rect:n}=this;if(Yi(n,t))return;this._rect=t;(i?this.loadEditedData():Promise.resolve()).then((()=>{const{edited:i,rect:n,eventTarget:s}=this;xc(i)&&(i.imageSize=Bi(n),s.emit(e.EventType.Resize,{rect:t}),this.redraw())}))}redo(){this.actions.canRedo&&this.handleAction(this.actions.redo())}redraw(){const{edited:t}=this;t&&(t.mashes.forEach((e=>{e.clearPreview()})),this.eventTarget.dispatch(e.EventType.Draw))}removeClip(t){const{mash:i}=this.selection;if(!i)throw new Error(mn.selection);const{track:n}=t,s={redoSelection:{...this.selection,clip:void 0},clip:t,track:n,index:n.clips.indexOf(t),type:e.ActionType.RemoveClip};this.actions.create(s)}removeEffect(t){const{clip:i}=this.selection;if(!i)throw mn.selection;fa(i);const{content:n}=i;zo(n);const{effects:s}=n,r=[...s],o=s.filter((e=>e!==t)),a={...this.selection.object};delete a.effect;const c={redoSelection:a,effects:s,undoEffects:r,redoEffects:o,type:e.ActionType.MoveEffect};this.actions.create(c)}removeLayer(t){const{cast:i}=this.selection;Ic(i);const n={cast:i,layer:t};this.actions.create({type:e.ActionType.RemoveLayer,redoSelection:n})}removeTrack(e){console.debug(this.constructor.name,"removeTrack coming soon...")}saved(t){if(t){const{edited:e}=this;V(e),Object.entries(t).forEach((([t,i])=>{if(e.id===t)return void(e.id=i);if(vt.installed(t))return void vt.updateDefinitionId(t,i);Ic(e);const n=e.mashes.find((e=>e.id===t));da(n),n.id=i}))}this.actions.save(),this.eventTarget.emit(e.EventType.Action)}_selection;get selection(){if(this._selection)return this._selection;const e=il();return e.editor=this,this._selection=e}get svgElement(){return this.preloader.svgElement}set svgElement(e){this.preloader.svgElement=e}svgItems(e){const{edited:t}=this;if(!t)return Promise.resolve([An(this.rect)]);const i={};return e&&this.paused&&(i.editor=this),t.svgItems(i)}get time(){return this.selection.mash?.time||jr(0,this.fps)}set time(e){this.goToTime(e)}get timeRange(){return this.selection.mash?.timeRange||Mr(0,this.fps)}undo(){const{canUndo:e}=this.actions;e&&this.handleAction(this.actions.undo())}updateDefinition(e,t){const{id:i,type:n}=e,s=e.id||t.id;x(s);const r=t||vt.fromId(i),{id:o,type:a}=r,c=o!==s,l=Te(n)&&a!==n;if(l){const t=ut[n].definition(e);vt.updateDefinition(r,t)}else c&&(vt.updateDefinitionId(r.id,s),Object.assign(r,e),nl(r)?delete r.loadedVideo:Aa(r)?delete r.loadedAudio:rl(r)&&delete r.loadedImage);const{edited:u}=this;if(!u||!l&&!c)return Promise.resolve();return this.mashes.flatMap((e=>e.tracks)).flatMap((e=>e.clips)).forEach((e=>{e.containerId===o&&e.setValue(i,"containerId"),e.contentId===o&&e.setValue(i,"contentId")})),this.loadMashAndDraw()}_volume=qr.editor.volume;get volume(){return this._volume}set volume(t){const i=Number(t);if(this._volume!==i){if(!g(i))throw mn.invalid.volume;this._volume=i,T(i)&&(this.muted=!1);const{mash:t}=this.selection;t&&(t.gain=this.gain),this.eventTarget.emit(e.EventType.Volume)}}}e.editorSingleton=void 0;const al=(e={})=>({autoplay:qr.editor.autoplay,precision:qr.editor.precision,loop:qr.editor.loop,fps:qr.editor.fps,volume:qr.editor.volume,buffer:qr.editor.buffer,...e}),cl={abs:Math.abs,ceil:Math.ceil,eq:(e,t)=>Number(e)===Number(t),floor:Math.floor,gt:(e,t)=>Number(e)>Number(t),gte:(e,t)=>Number(e)>=Number(t),if:(e,t,i)=>e?t:i,includes:(e,...t)=>t.includes(e),lt:(e,t)=>Number(e)<Number(t),lte:(e,t)=>Number(e)<=Number(t),max:Math.max,min:Math.min,number:Number,rgb:(e,t,i)=>Rt({r:e,g:t,b:i}),rgba:(e,t,i,n)=>kt({r:e,g:t,b:i,a:n}),round:Math.round,string:String},ll=Object.keys(cl),ul=/\\b[a-z]\\b/i,hl=e=>new RegExp(`\\b${e}\\b`,"g");class dl{constructor(e,t){this.expressions.push(e),this.evaluation=t}args={};execute(e){if(this.resolved)return;const{expression:t,args:i}=this;let n=(e=>{let t=e.replaceAll(" or ","||").replaceAll(" and ","&&");return t=t.replaceAll(" ",""),t})(t);if(n.match(ul))throw mn.eval.string+n;const s=[],o=[];Object.entries(i).forEach((([e,t])=>{s.push(e),o.push(t)}));const a=`return ${n}`;try{const t=new Function(...s,a)(...o);if(this.expressions.push(String(t)),E(t))this.resolved=!0,this._result=Number(t),this.log(e||"executed");else if(!r(t))throw mn.eval.string}catch(e){s.filter((e=>e.startsWith("_"))).forEach((e=>{n=n.replaceAll(hl(e),e.slice(1))})),this.expressions.push(n),this.log("execute failure")}}get expression(){const{expressions:e}=this,{length:t}=e;return e[t-1]}expressions=[];evaluation;evaluations=[];log(e,t){const i=[this.resolved?"* ":"- "];i.push(e),t&&i.push(`${t}:`);const[n,s]=this.expressions.slice(-2);i.push(n," -> ",s),this._logs.push(i.join(" "))}_logs=[];get logs(){return this.logsIndented()}logsIndented(e=0){const t=" ".repeat(2*e);return[`${t}Evaluation: ${this.expressions[0]}`,...this._logs.map((e=>`${t}${e}`)),...this.evaluations.flatMap((t=>t.logsIndented(e+1)))]}get rootExpression(){return this.evaluation?this.evaluation.rootExpression:this.expressions[0]}replaceAll(e,t,i){if(this.resolved)return!0;const{expression:n}=this,s=n===e,r=s?void 0:hl(e);if(s||r.test(n)){const o=t(this),a=String(o);if(E(o)&&s)return this.expressions.push(a),this.resolved=!0,this._result=Number(o),this.log(i||"resolved",e),!0;const c=s?a:n.replaceAll(r,a);this.expressions.push(c),this.log(i||"evaluated",e)}return!1}replaceMethods(e){if(this.resolved)return;const{args:t}=this;ll.forEach((i=>{const n=(e=>new RegExp(`\\b${e}\\b\\(`,"g"))(i),{expression:s}=this;if(n.test(s)){const n=`_${i}`;t[n]=cl[i];const r=hl(i);this.expressions.push(s.replaceAll(r,n)),this.log(e||"method",i)}}))}resolved=!1;_result;get result(){return M(this._result)?this._result:this.expression}}const pl=e=>{const{condition:t}=e;if(h(e.is))return`${t}==${e.is}`;const i=e.in;if(a(i))return String(t).trim();const n=(e=>r(e)?String(e).split(","):e)(i),s=r(n[0]),o=n.map((e=>s?`"${e}"`:e));return`(includes(${s?"string":"number"}(${t}),${o.join(",")}))`},ml={out_height_scaled:"if(gt(out_width, out_height), scale * out_height, out_height + ((scale - 1.0) * out_width))",out_width_scaled:"if(gt(out_height, out_width), scale * out_width, out_width + ((scale - 1.0) * out_height))"};const fl=Va(wa(Xo(Gr(wn))));class gl extends fl{contentPreviewItemPromise(e,t,i,n){return Promise.resolve(Dn(e,"","currentColor"))}mutable(){return!0}}const yl=za(ba(Ro(Wr(ps))));class vl extends yl{constructor(...e){super(...e);const[t]=e,{audioUrl:i,url:n}=t;!i&&n&&(this.audioUrl=n)}instanceFromObject(e={}){return new gl(this.instanceArgs(e))}type=e.DefinitionType.Audio;loadType=e.LoadType.Audio}const Tl=e=>{const{id:t}=e;if(!t)throw mn.id;return new vl(e)},bl=e=>Tl({id:e}),wl=e=>Tl(e).instanceFromObject(e),Fl=e=>wl({id:e});lt[e.DefinitionType.Audio]={definition:Tl,definitionFromId:bl,fromId:Fl,instance:wl};const Sl=xa(wa(Xo(zr(Gr(wn)))));class Il extends Sl{visibleCommandFiles(e){const t=[],{visible:i,time:n,videoRate:s}=e;if(!i)return t;const r=this.fileUrls(e),[o]=r,a=k(n)?n.lengthSeconds:0,c={loop:1,framerate:s};a&&(c.t=a);const{id:l}=this,u={...o,inputId:l,options:c};return t.push(u),t}fileUrls(t){const{visible:i,editing:n}=t,s=[];if(!i)return s;const{definition:r}=this,{url:o,source:a}=r,c=n?o:a;x(c,n?"url":"source");const l={input:!0,type:e.LoadType.Image,file:c,definition:r};return s.push(l),s}}const xl=Ca(ba(Ro(Or(Wr(ps)))));class Cl extends xl{constructor(...e){super(...e);const[t]=e,{loadedImage:i}=t;i&&(this.loadedImage=i)}definitionIcon(e,t){const i=super.definitionIcon(e,t);if(i)return i;const{url:n}=this;return this.urlIcon(n,e,t)}instanceFromObject(e={}){return new Il(this.instanceArgs(e))}loadType=e.LoadType.Image;loadedImage;type=e.DefinitionType.Image}const Dl=e=>{const{id:t}=e;return x(t,"imageDefinition id"),new Cl(e)},Pl=e=>Dl({id:e}),Al=e=>Dl(e).instanceFromObject(e),El=e=>Al({id:e});lt[e.DefinitionType.Image]={definition:Dl,definitionFromId:Pl,fromId:El,instance:Al};const Vl=Va(xa(wa(Xo(Gr(wn)))));class zl extends Vl{_foreignElement;get foreignElement(){return this._foreignElement||=this.foreignElementInitialize}get foreignElementInitialize(){return globalThis.document.createElementNS(dt,"foreignObject")}fileUrls(t){const i=[],{editing:n,time:s,audible:r,visible:o,icon:a}=t,{definition:c}=this,{url:l,source:u}=c,h=n?l:u;if(x(h,n?"url":"source"),o&&!a){const t={input:!0,type:e.LoadType.Video,file:h,definition:c};i.push(t)}if(r){if((!c.duration||this.mutable())&&!this.muted){const t={input:!0,type:e.LoadType.Audio,definition:c,file:this.definition.urlAudible(n)};i.push(t)}}return i}itemPreviewPromise(e,t,i){const{_foreignElement:n,_loadedVideo:s}=this,r=!!n;return r||s?(this.updateForeignElement(e,t,i,r),Promise.resolve(this.foreignElement)):this.loadVideoPromise.then((()=>(this.updateForeignElement(e,t,i),Promise.resolve(this.foreignElement))))}iconUrl(e,t,i){const n=Bi(this.intrinsicRect(!0)),s=Ni(n,e),{width:r,height:o}=s,a=this.definitionTime(t,i),{frame:c}=a,{fps:l}=i,{definition:u}=this,{url:h}=u,d=ds("video",h,{frame:c,fps:l});return ds("image",d,{width:r,height:o})}_loadedVideo;get loadedVideo(){return this._loadedVideo}get loadVideoPromise(){const{_loadedVideo:e}=this;if(e)return Promise.resolve(e);const{definition:t}=this,{loadedVideo:i}=t;if(i)return this._loadedVideo=i.cloneNode(),Promise.resolve(this._loadedVideo);const{preloader:n}=this.clip.track.mash,s=this.intrinsicGraphFile({editing:!0,size:!0}),{file:r}=s,o=ds("video",r);return n.loadPromise(o).then((e=>(t.loadedVideo=e,this._loadedVideo=e.cloneNode())))}updateVideo(e,t,i){const{loadedVideo:n}=this,{currentTime:s}=n,r=this.definitionTime(t,i),o=t.isRange?1:1/t.fps,{seconds:a}=r;Math.abs(a-s)>o&&(n.currentTime=a);const{width:c,height:l}=e;return n.width=c,n.height=l,n}updateForeignElement(e,t,i,n){const{foreignElement:s,loadedVideo:r}=this;n||s.appendChild(r),xn(s,e),this.updateVideo(e,t,i)}}const Ol=za(Ca(ba(Ro(Wr(ps)))));class Rl extends Ol{constructor(...e){super(...e);const[t]=e,{loadedVideo:i}=t;i&&(this.loadedVideo=i)}instanceFromObject(e={}){return new zl(this.instanceArgs(e))}loadType=e.LoadType.Video;loadedVideo;pattern="%.jpg";toJSON(){const e=super.toJSON();return e.url=this.url,this.source&&(e.source=this.source),e}type=e.DefinitionType.Video}const kl=e=>{const{id:t}=e;return x(t),new Rl(e)},_l=e=>kl({id:e}),Ml=e=>kl(e).instanceFromObject(e),Nl=e=>Ml({id:e});lt[e.DefinitionType.Video]={definition:kl,definitionFromId:_l,fromId:Nl,instance:Ml};const $l=Va(xa(wa(Xo(zr(Gr(wn))))));class jl extends $l{visibleCommandFiles(e){const t=super.visibleCommandFiles(e),{streaming:i,visible:n}=e;return n&&i?(t.forEach((e=>{const{options:t={}}=e;t.loop=1,t.re="",e.options=t})),t):t}fileUrls(t){const{time:i,clipTime:n,editing:s,visible:r}=t,o=this.definitionTime(i,n),a={...t,time:o},c=super.fileUrls(a);if(r){const{definition:t}=this;if(s){const i=t.framesArray(o).map((i=>({type:e.LoadType.Image,file:t.urlForFrame(i),input:!0,definition:t})));i.push(...i)}else{const i={type:e.LoadType.Video,file:t.source,definition:t,input:!0};c.push(i)}}return c}iconUrl(e,t,i){const n=this.definitionTime(t,i),{definition:s}=this,r=s.framesArray(n),[o]=r;return s.urlForFrame(o)}speed=1;toJSON(){const e=super.toJSON();return 1!==this.speed&&(e.speed=this.speed),e}}const Ll=za(Ca(ba(Ro(Wr(ps)))));class ql extends Ll{constructor(...e){super(...e);const[t]=e,{padding:i,begin:n,fps:s,increment:r,pattern:o}=t;if(g(n)&&(this.begin=n),s&&(this.fps=s),r&&(this.increment=r),o&&(this.pattern=o),i)this.padding=i;else{const e=this.begin+(this.increment*this.framesMax-this.begin);this.padding=String(e).length}}begin=qr.definition.videosequence.begin;fps=qr.definition.videosequence.fps;framesArray(e){const{duration:t,fps:i}=this;return e.durationFrames(t,i)}get framesMax(){const{fps:e,duration:t}=this;return Math.floor(e*t)-2}increment=qr.definition.videosequence.increment;instanceFromObject(e={}){return new jl(this.instanceArgs(e))}loadType=e.LoadType.Image;padding;pattern="%.jpg";toJSON(){const e=super.toJSON(),{videosequence:t}=qr.definition,{pattern:i,increment:n,begin:s,fps:r,padding:o}=this;return i!==t.pattern&&(e.pattern=i),n!==t.increment&&(e.increment=n),s!==t.begin&&(e.begin=s),r!==t.fps&&(e.fps=r),o!==t.padding&&(e.padding=o),e}type=e.DefinitionType.VideoSequence;urlForFrame(e){const{increment:t,begin:i,padding:n,url:s,pattern:r}=this;let o=String(e*t+i);return n&&(o=o.padStart(n,"0")),(s+r).replaceAll("%",o)}}const Gl=e=>{const{id:t}=e;return x(t),new ql(e)},Bl=e=>Gl({id:e}),Ul=e=>Gl(e).instanceFromObject(e),Wl=e=>Ul({id:e});lt[e.DefinitionType.VideoSequence]={definition:Gl,definitionFromId:Bl,fromId:Wl,instance:Ul};class Hl{args;constructor(e){this.args=e,console.log(this.constructor.name,"upload",this.args.upload)}assureClipFrames(){const{durationClips:e,args:t}=this,{quantize:i}=t.mash;e.forEach((e=>{const{content:t}=e,{definition:n}=t;if(Aa(n)){const t=n.frames(i);t&&(e.frames=t)}}))}_avType=e.AVType.Both;get avType(){return this._avType}get avTypeNeededForClips(){const{avType:t}=this;if(t!==e.AVType.Both)return t;const{renderingClips:i}=this,n=new Set;if(i.forEach((t=>{t.audible&&n.add(e.AVType.Audio),t.visible&&n.add(e.AVType.Video)})),2===n.size)return t;const[s]=n;return s}_commandOutput;get commandOutput(){if(this._commandOutput)return this._commandOutput;const e={...this.args.commandOutput.options},t={...this.args.commandOutput,options:e};return this._commandOutput=t}get duration(){return this.timeRange.lengthSeconds}_durationClips;get durationClips(){return this._durationClips||=this.durationClipsInitialize}get durationClipsInitialize(){const{mash:e}=this.args,{frames:t}=e;if(g(t))return[];const{clips:i}=e,n={duration:!0};return i.filter((e=>!e.intrinsicsKnown(n)))}get endTime(){return this.args.endTime||this.args.mash.endTime}get filterGraphs(){const{filterGraphsOptions:e}=this;return console.log(this.constructor.name,"filterGraphs",e.upload),this.args.mash.filterGraphs(e)}get filterGraphsOptions(){const{timeRange:e,graphType:t,videoRate:i,args:n}=this,{upload:s}=n,r={time:e,graphType:t,videoRate:i,size:this.sizeCovered(),avType:this.avTypeNeededForClips,upload:s};return console.log(this.constructor.name,"filterGraphsOptions upload",s,r.upload),r}graphType=e.GraphType.Mash;get mashDurationPromise(){const e=this.durationClips;if(!e.length)return console.log(this.constructor.name,"mashDurationPromise no durationClips"),Promise.resolve();const{mash:t}=this.args,i={duration:!0},n=e.flatMap((e=>e.intrinsicGraphFiles(i))),{preloader:s}=t;return console.log(this.constructor.name,"mashDurationPromise files",n.map((e=>e.file))),s.loadFilesPromise(n)}get mashSize(){const{visibleGraphFiles:e}=this,t=e.map((e=>e.definition)).filter((e=>Ia(e))),i=[...new Set(t)].filter((e=>e.sourceSize));if(!i.length)return;const n=i.map((e=>e.sourceSize));return{width:Math.max(...n.map((e=>e.width))),height:Math.max(...n.map((e=>e.height)))}}get outputCover(){return!!this.args.commandOutput.cover}get outputSize(){const{width:t,height:i}=this.args.commandOutput;if(!t||!i){if(this.avType===e.AVType.Audio)return{width:0,height:0};throw console.error(this.constructor.name,"outputSize",this.args.commandOutput),mn.invalid.size+this.outputType+".outputSize for avType "+this.avType}return{width:t,height:i}}outputType;get preloadPromise(){return this.filterGraphs.loadPromise}get renderingClips(){return this.args.mash.clipsInTimeOfType(this.timeRange,this.avType)}renderingDescriptionPromise(t){let i=this.mashDurationPromise;return i=i.then((()=>{this.assureClipFrames()})),i=i.then((()=>this.sizePromise)),i=i.then((()=>this.preloadPromise)),i.then((()=>{this.assureClipFrames();const{commandOutput:t}=this,i={commandOutput:t},n=this.avTypeNeededForClips,{filterGraphs:s}=this;if(n!==e.AVType.Audio){const{filterGraphsVisible:t}=s,n=t.map((t=>{const{commandFilters:i,commandInputs:n,duration:s}=t;return{inputs:n,commandFilters:i,duration:s,avType:e.AVType.Video}}));i.visibleCommandDescriptions=n}if(n!==e.AVType.Video){const{filterGraphAudible:t,duration:n}=s;if(t){const{commandFilters:s,commandInputs:r}=t,o={inputs:r,commandFilters:s,duration:n,avType:e.AVType.Audio};i.audibleCommandDescription=o}}return i}))}get renderingDescription(){const{commandOutput:t}=this,i={commandOutput:t},n=this.avTypeNeededForClips,{filterGraphs:s}=this;if(n!==e.AVType.Audio){const{filterGraphsVisible:t}=s,n=t.map((t=>{const{commandFilters:i,commandInputs:n,duration:s}=t;return{inputs:n,commandFilters:i,duration:s,avType:e.AVType.Video}}));i.visibleCommandDescriptions=n}if(n!==e.AVType.Video){const{filterGraphAudible:t,duration:n}=s;if(t){const{commandFilters:s,commandInputs:r}=t,o={inputs:r,commandFilters:s,duration:n,avType:e.AVType.Audio};i.audibleCommandDescription=o}}return i}get startTime(){if(this.args.startTime)return this.args.startTime;const{quantize:e,frame:t}=this.args.mash;return jr(t,e)}sizeCovered(){const{outputSize:e,outputCover:t}=this;if(!t)return e;const{mashSize:i}=this;if(!Ai(i))return e;const{width:n,height:s}=i;return b(n),b(s),Ni(i,e)}get sizePromise(){if(this.avType===e.AVType.Audio||!this.outputCover)return Promise.resolve();const{visibleGraphFiles:t}=this;if(!t.length)return Promise.resolve();const{preloader:i}=this.args.mash;return i.loadFilesPromise(t)}get timeRange(){return $r(this.startTime,this.endTime)}get videoRate(){return this.args.commandOutput.videoRate||0}get visibleGraphFiles(){const{timeRange:t,args:i}=this,{mash:n}=i,s=n.clipsInTimeOfType(t,e.AVType.Video),r={size:!0};return s.filter((e=>!e.intrinsicsKnown(r))).flatMap((e=>e.intrinsicGraphFiles(r)))}}class Jl extends Hl{_avType=e.AVType.Audio;outputType=e.OutputType.Audio;get renderingDescription(){const{renderingClips:e}=this;return e.some((e=>!e.mutable))?{commandOutput:this.commandOutput}:super.renderingDescription}}class Kl extends Hl{_avType=e.AVType.Video;get endTime(){}get filterGraphsOptions(){const{args:e,graphType:t,avType:i,startTime:n}=this,{mash:s,upload:r}=e,{quantize:o}=s;return{time:n,graphType:t,videoRate:o,size:this.sizeCovered(),avType:i,upload:r}}outputType=e.OutputType.Image;get startTime(){const{commandOutput:e,mash:t}=this.args,{offset:i}=e;return i||t.frames<0?jr(0,t.quantize):t.timeRange.positionTime(Number(i||0),"ceil")}}class Yl extends Jl{_avType=e.AVType.Video;outputType=e.OutputType.ImageSequence}class Xl extends Jl{get avType(){return this.args.commandOutput.mute?e.AVType.Video:e.AVType.Both}get outputCover(){return!!this.args.commandOutput.cover}outputType=e.OutputType.Video}class Zl extends Hl{_avType=e.AVType.Audio;outputType=e.OutputType.Waveform;get sizePromise(){return Promise.resolve()}}const Ql=e=>new Jl(e),eu=e=>new Kl(e),tu=e=>new Xl(e),iu=e=>new Yl(e),nu=e=>new Zl(e),su={[e.OutputType.Audio]:Ql,[e.OutputType.Image]:eu,[e.OutputType.Video]:tu,[e.OutputType.ImageSequence]:iu,[e.OutputType.Waveform]:nu};class ru{constructor(e){this.args=e}args;streamingDescription(t){const{mashes:i}=this.args,n=i.map((e=>e.preloader.loadFilesPromise(e.editedGraphFiles({audible:!0,visible:!0,streaming:!0}))));let s=Promise.all(n).then((()=>{const t=[],n=[],s=[],r=e.AVType.Both;i.forEach((i=>{const o={size:this.outputSize,videoRate:this.args.commandOutput.videoRate,graphType:e.GraphType.Cast,avType:r},a=i.filterGraphs(o),{filterGraphVisible:c}=a;s.push(...c.commandInputs),t.push(...a.fileUrls.filter((e=>e.input))),n.push(...c.commandFilters)}));const o={...this.args.commandOutput.options},a={...this.args.commandOutput,options:o};return{inputs:s,commandFilters:n,commandOutput:a,avType:r}}));return s}mashes=[];get outputSize(){const{width:e,height:t}=this.args.commandOutput;return{width:e,height:t}}}var ou={options:{},audioBitrate:160,audioCodec:"libmp3lame",audioChannels:2,audioRate:44100,extension:"mp3",outputType:"audio"};var au={options:{},width:320,height:240,extension:"jpg",outputType:"image",cover:!0,offset:0};var cu={options:{g:60,level:41,movflags:"faststart"},width:1920,height:1080,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,g:0,format:"mp4",extension:"mp4",outputType:"video",cover:!1};var lu={options:{},format:"image2",width:320,height:240,videoRate:10,extension:"jpg",outputType:"imagesequence",cover:!1};var uu={options:{},width:320,height:240,forecolor:"#000000",backcolor:"#00000000",audioBitrate:160,audioCodec:"aac",audioChannels:2,audioRate:44100,extension:"png",outputType:"waveform"};var hu={width:320,height:240,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,format:"mdash",extension:"dash",streamingFormat:"mdash",options:{hls_delete_threshold:10,g:60}};var du={width:320,height:240,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,format:"hls",extension:"m3u8",streamingFormat:"hls",options:{hls_segment_filename:"%06d.ts",hls_time:6,hls_list_size:10,hls_flags:"delete_segments",hls_delete_threshold:10,g:60}};var pu={width:320,height:240,videoRate:30,videoBitrate:2e3,audioBitrate:160,audioCodec:"aac",videoCodec:"libx264",audioChannels:2,audioRate:44100,format:"flv",extension:"flv",streamingFormat:"rtmp",options:{g:60}};const mu=e=>({...ou,...e||{}}),fu=e=>({...cu,...e||{}}),gu=e=>({...lu,...e||{}}),yu=e=>({...uu,...e||{}}),vu=e=>{const t=e||{};return{...au,...t}},Tu=t=>{const{outputType:i}=t;switch(i){case e.OutputType.Audio:return mu(t);case e.OutputType.Image:return vu(t);case e.OutputType.Video:return fu(t);case e.OutputType.ImageSequence:return gu(t);case e.OutputType.Waveform:return yu(t)}},bu={[e.OutputFormat.AudioConcat]:e.OutputType.Audio,[e.OutputFormat.Mdash]:e.OutputType.Video,[e.OutputFormat.Flv]:e.OutputType.Video,[e.OutputFormat.Hls]:e.OutputType.Video,[e.OutputFormat.Jpeg]:e.OutputType.Image,[e.OutputFormat.Mp3]:e.OutputType.Audio,[e.OutputFormat.Mp4]:e.OutputType.Video,[e.OutputFormat.Png]:e.OutputType.Image,[e.OutputFormat.Rtmp]:e.OutputType.Video,[e.OutputFormat.VideoConcat]:e.OutputType.Video},wu={[e.OutputType.Audio]:e.OutputFormat.Mp3,[e.OutputType.Image]:e.OutputFormat.Png,[e.OutputType.Video]:e.OutputFormat.Mp4,[e.OutputType.ImageSequence]:e.OutputFormat.Jpeg,[e.OutputType.Waveform]:e.OutputFormat.Png},Fu=e=>({...du,...e||{}}),Su=e=>({...hu,...e||{}}),Iu=e=>({...pu,...e||{}});e.Action=Cc,e.ActionFactory=Bc,e.Actions=Uc,e.AddClipToTrackAction=Ec,e.AddEffectAction=Vc,e.AddLayerAction=$c,e.AddTrackAction=Ac,e.AlphamergeFilter=Sr,e.Anchors=Le,e.ApiVersion="5.1.0",e.AudibleContext=ca,e.AudibleContextInstance=la,e.AudioClass=gl,e.AudioDefinitionClass=vl,e.AudioOutputClass=Jl,e.AudioPreview=Oa,e.BrowserLoaderClass=el,e.CastClass=wc,e.ChangeAction=Oc,e.ChangeFramesAction=kc,e.ChangeMultipleAction=qc,e.ChromaKeyFilter=gs,e.ClassButton="button",e.ClassCollapsed="collapsed",e.ClassDisabled="disabled",e.ClassDropping="dropping",e.ClassDroppingAfter="dropping-after",e.ClassDroppingBefore="dropping-before",e.ClassSelected="selected",e.ClipClass=La,e.ClipDefinitionClass=qa,e.ClipSelectTypes=ee,e.ColorChannelMixerFilter=Ys,e.ColorContentClass=ea,e.ColorContentDefinitionClass=ia,e.ColorFilter=Js,e.ColorizeFilter=Hs,e.Colors=At,e.ContainerDefinitionMixin=Or,e.ContainerMixin=zr,e.ContainerTypes=xe,e.ContentDefinitionMixin=Ro,e.ContentMixin=Xo,e.ContentTypes=De,e.ContextFactory=ua,e.ConvolutionFilter=or,e.CropFilter=gr,e.DataGroups=on,e.DataTypes=Ee,e.Default=qr,e.DefaultContainerId=yi,e.DefaultContentId=Eo,e.Defined=vt,e.DefinitionBase=ps,e.DefinitionTypes=ve,e.DirectionLabels=["top","right","bottom","left","top right","bottom right","bottom left","top left"],e.Directions=Me,e.EditTypes=H,e.EditedClass=pa,e.EditorClass=ol,e.EditorSelectionClass=tl,e.EffectClass=Mo,e.EffectDefinitionClass=jo,e.Emitter=Kc,e.EmptyMethod=ht,e.Endpoints=ct,e.Errors=mn,e.Evaluation=dl,e.Evaluator=class{constructor(e){const{tweenTime:t,timeRange:i,instance:n,editing:s,filter:r}=e;this.tweenTime=t,this.outputSize=e.outputSize,this.editing=!!s,Object.entries(ml).forEach((([e,t])=>{this.setExpression(e,t)}));const{height:o,width:a}=this.outputSize;this.setExpression("out_size",`${a}x${o}`),i&&(this.timeRange=i),n&&(this.instance=n),r&&(this.filter=r)}get customProperties(){const e={};return this.filterCustomProperties.forEach((t=>{e[t.name]=t})),this.instanceCustomProperties.forEach((t=>{e[t.name]=t})),Object.values(e)}evaluateBooleanValue(e){if(u(e))return e;if(m(e))return!!e;switch(e){case"true":return!0;case"false":case"":return!1}return!1}evaluateConditionals(e,t,i){const n=t.find((t=>{const n=pl(t);if(E(n))return!!Number(n);switch(n){case"true":return!0;case"false":case"":return!1}const s=new dl(n,e);this.evaluateEvaluation(s,i);const{result:r}=s;return i&&this.logDebug(s),this.evaluateBooleanValue(r)}));j(n,mn.eval.conditionTruth);const{value:s}=n;if(a(s))throw mn.eval.conditionValue;return s}evaluateEvaluation(e,t){this.expandEvaluation(e,t),e.execute()}expandParameter(e,t,i){let n=!1;const{name:s}=t;return e.replaceAll(s,(e=>(n=!0,this.parameterConditionalValue(e,t,i))),"expandParameter"),n&&this.expandEvaluationProperties(e),n}expandEvaluation(e,t){this.exampleEvaluationParameters(e,t),this.expandEvaluationExpressions(e),this.expandEvaluationNumbers(e),this.populateEvaluationArgs(e),this.expandEvaluationMethods(e)}expandEvaluationExpressions(e){if(!e.resolved)for(const t of this.expressions.entries()){const[i,n]=t;e.replaceAll(i,(()=>n),"expandEvaluationExpressions")}}expandEvaluationMethods(e){e.resolved||e.replaceMethods()}expandEvaluationNumbers(e){if(!e.resolved){for(const t of this.customProperties){const{name:i,type:n}=t;if(!oi(n)&&e.replaceAll(i,(()=>this.instanceCustomProperties.includes(t)?this.instance.value(i):this.filter.value(i)),"expandEvaluationNumbers.properties"))break}for(const t of this.numbers.entries()){const[i,n]=t;if(e.replaceAll(i,(()=>n),"expandEvaluationNumbers.numbers"))break}}}exampleEvaluationParameters(e,t){if(e.resolved)return;const i=[];for(const n of this.parameterInstances){const{name:s}=n;e.rootExpression!==s&&!i.includes(s)&&this.expandParameter(e,n,t)&&i.push(s)}}expandEvaluationProperties(e){for(const t of this.customProperties){const{name:i}=t;e.replaceAll(i,(()=>this.instanceCustomProperties.includes(t)?this.instance.value(i):this.filter.value(i)),"expandEvaluationProperties")}}expressions=new Map;_filter;get filter(){return this._filter}set filter(e){e&&(this._filter=e,this.parameterInstances=this.filter.parametersDefined,this.filterCustomProperties=[...this.filter.propertiesCustom],this.numbersInitialize())}editing;filterCustomProperties=[];get(e){return this.numbers.has(e)?this.numbers.get(e):""}logDebug(e){console.debug(this.filter.definitionId,`\n${e.logs.join("\n")}`)}label="createVisibleContext";_instance;get instance(){return this._instance}set instance(e){this._instance=e,this.instanceCustomProperties=[...this.instance.propertiesCustom]}numbers=new Map;numbersInitialize(){this.numbers.clear();const{height:e,width:t}=this.outputSize,{lengthSeconds:i,fps:n}=this.timeRange;this.setNumber("out_height",e),this.setNumber("out_width",t),this.setNumber("out_duration",i),this.setNumber("out_rate",n),this.editing&&this.setNumber("t",this.position)}outputSize;parameterInstance(e){return this.parameterInstances.find((t=>t.name===e))}parameterNumber(e,t){const i=this.parameter(e,t),n=Number(i);if(p(n))throw mn.eval.number+`${e} ≠ ${i}`;return n}parameter(e,t){const i=this.parameterInstance(e);if(!i)throw mn.eval.string+e;const n=new dl(e);return this.expandParameter(n,i,t),this.evaluateEvaluation(n,t),t&&this.logDebug(n),n.result}parameterValue(e,t){const i=this.parameterInstance(e);if(!i)throw mn.eval.string+e;const n=new dl(e);return this.expandParameter(n,i,t),t&&this.logDebug(n),n.result}get parameters(){const e={};return this.parameterInstances.forEach((t=>{const{name:i}=t;e[i]=this.parameter(i)})),e}get parameterValues(){const e={};return this.parameterInstances.forEach((t=>{const{name:i}=t;e[i]=this.parameterValue(i)})),e}parameterConditionalValue(e,t,i){let n=t.value;if(Array.isArray(n)&&(n=this.evaluateConditionals(e,n,i)),E(n))return Number(n);if(!n)return n;const{values:s}=t,r=s?.find((e=>e===n));return r||n}parameterInstances=[];populateEvaluationArgs(e){if(e.resolved)return;const{args:t}=e;for(const i of this.customProperties){const{name:n}=i;e.replaceAll(n,(()=>{const e=`_${n}`;return this.instanceCustomProperties.includes(i)?t[e]=this.instance.value(n):t[e]=this.filter.value(n),e}),"populateEvaluationArgs.properties")}}get position(){return this.timeRange.position}instanceCustomProperties=[];propertyValue(e){const t=this.instance.value(e);return d(t,e),u(t)?t?1:0:t}setExpression(e,t){this.expressions.set(e,t)}setNumber(e,t){this.numbers.set(e,t)}_timeRange;get timeRange(){return this._timeRange}set timeRange(e){this._timeRange=e}tweenTime},e.EventTypes=We,e.ExtDash="dash",e.ExtHls="m3u8",e.ExtJpeg="jpg",e.ExtJson="json",e.ExtPng="png",e.ExtRtmp="flv",e.ExtText="txt",e.ExtTs="ts",e.Factories=lt,e.Factory=ut,e.FillTypes=ae,e.FilterClass=ms,e.FilterDefinitionClass=fs,e.FilterGraphClass=_a,e.FilterGraphInputAudible=ka,e.FilterGraphInputVisible=Ra,e.FilterGraphsClass=Ma,e.FilterIdPrefix=Cr,e.FontClass=Zr,e.FontDefinitionClass=Qr,e.FpsFilter=wr,e.GraphFileTypes=le,e.IdPrefix=pt,e.IdSuffix=mt,e.ImageClass=Il,e.ImageDefinitionClass=Cl,e.ImageOutputClass=Kl,e.ImageSequenceOutputClass=Yl,e.InstanceBase=wn,e.LayerClass=nc,e.LayerFolderClass=sc,e.LayerMashClass=rc,e.LayerTypes=G,e.LoadTypes=de,e.LoaderClass=Qc,e.MashClass=ec,e.ModularDefinitionMixin=No,e.ModularMixin=ko,e.MoveClipAction=_c,e.MoveEffectAction=Mc,e.MoveLayerAction=Lc,e.NamespaceLink="http://www.w3.org/1999/xlink",e.NamespaceSvg=dt,e.NamespaceXhtml="http://www.w3.org/1999/xhtml",e.NonePreview=Qa,e.OpacityFilter=Tr,e.Orientations=Re,e.OutputFactory=su,e.OutputFilterGraphPadding=6,e.OutputTypes=re,e.OverlayFilter=yr,e.Parameter=fn,e.PointZero=xi,e.PreloadableDefinitionMixin=ba,e.PreloadableMixin=wa,e.PreviewClass=$a,e.PropertiedClass=hi,e.PropertyTweenSuffix=ui,e.PropertyTypesNumeric=si,e.RectZero=Xi,e.RemoveClipAction=Nc,e.RemoveLayerAction=jc,e.RenderingOutputClass=Hl,e.ScaleFilter=vr,e.SelectTypes=Z,e.ServerTypes=Xe,e.SetptsFilter=Fr,e.SetsarFilter=br,e.ShapeContainerClass=Ur,e.ShapeContainerDefinitionClass=Jr,e.SizeIcon=Gi,e.SizeOutput=Li,e.SizePreview=qi,e.SizeZero=zi,e.SizingDefinitionTypes=we,e.Sizings=it,e.StreamingOutputClass=ru,e.TextContainerClass=Xr,e.TextContainerDefinitionClass=To,e.TextContainerId=vi,e.TextFilter=xr,e.TimeClass=kr,e.TimeRangeClass=_r,e.TimingDefinitionTypes=Se,e.Timings=et,e.TrackClass=Ya,e.TrackFactory=Za,e.TrackPreviewClass=Na,e.TrackPreviewHandleSize=8,e.TrackPreviewLineSize=2,e.TriggerTypes=Ge,e.TrimFilter=Ir,e.TweenableDefinitionMixin=Wr,e.TweenableMixin=Gr,e.UpdatableDurationDefinitionMixin=za,e.UpdatableDurationDefinitionTypes=Da,e.UpdatableDurationMixin=Va,e.UpdatableSizeDefinitionMixin=Ca,e.UpdatableSizeDefinitionType=Fa,e.UpdatableSizeMixin=xa,e.UploadTypes=fe,e.VideoClass=zl,e.VideoDefinitionClass=Rl,e.VideoOutputClass=Xl,e.VideoSequenceClass=jl,e.VideoSequenceDefinitionClass=ql,e.VideoStreamOutputClass=class extends ru{},e.WaveformOutputClass=Zl,e.actionInstance=Gc,e.arrayLast=en,e.arrayReversed=nn,e.arraySet=tn,e.arrayUnique=sn,e.assertAboveZero=b,e.assertAction=Pc,e.assertArray=F,e.assertBoolean=function(e,t){u(e)||i(e,"Boolean",t)},e.assertCast=Ic,e.assertChangeAction=function(e){if(!Rc(e))throw new Error("expected ChangeAction")},e.assertClip=fa,e.assertContainer=wi,e.assertContainerObject=function(e){Ti(e)||i(e,"ContainerObject")},e.assertContainerType=function(e){if(!Ce(e))throw new Error("expected ContainerType")},e.assertContent=zo,e.assertContentType=function(e){if(!Pe(e))throw new Error("expected ContentType")},e.assertConvolutionServerFilter=cr,e.assertDataGroup=function(e,t){an(e)||i(e,"DataGroup",t)},e.assertDataType=ze,e.assertDefined=d,e.assertDefinition=yt,e.assertDefinitionType=be,e.assertDirection=$e,e.assertEditType=K,e.assertEdited=function(e){xc(e)||i(e,"Edited")},e.assertEffect=Xc,e.assertFontDefinition=function(e){if(!Zc(e))throw new Error("expected FontDefinition")},e.assertLayer=pc,e.assertLayerFolder=yc,e.assertLayerMash=fc,e.assertLayerType=function(e){if(!B(e))throw new Error("expected LayerType")},e.assertLoadType=me,e.assertLoaderPath=function(e,t){Xn(e)||i(e,"LoaderPath",t)},e.assertLoaderType=Yn,e.assertMash=da,e.assertMashClass=function(e){if(!ic(e))throw new Error("expected MashClass")},e.assertMashData=Jc,e.assertNumber=l,e.assertObject=s,e.assertPoint=Si,e.assertPopulatedArray=D,e.assertPopulatedObject=A,e.assertPopulatedString=x,e.assertPositive=y,e.assertPreloadable=function(e){if(!Ta(e))throw new Error("expected Preloadable")},e.assertPreloadableDefinition=function(e){if(!va(e))throw new Error("expected PreloadableDefinition")},e.assertProperty=ln,e.assertRect=Ki,e.assertRgb=function(e,t){z(e)||i(e,"Rgb",t)},e.assertSelectType=function(e,t){Q(e)||i(e,"SelectType",t)},e.assertSize=Ei,e.assertSizeAboveZero=ji,e.assertString=o,e.assertTextContainer=function(e){if(!Kr(e))throw new Error("expected TextContainer")},e.assertTime=R,e.assertTimeRange=_,e.assertTrack=ya,e.assertTrue=V,e.assertTweenable=fi,e.assertTweenableDefinition=function(e){if(!gi(e))throw new Error("expected TweenableDefinition")},e.assertUpdatableDuration=function(e,t){Pa(e)||i(e,"Updatable",t)},e.assertUpdatableDurationDefinition=Ea,e.assertUpdatableSize=function(e){Sa(e)||i(e,"UpdatableSize")},e.assertUpdatableSizeDefinition=function(e){Ia(e)||i(e,"UpdatableSizeDefinition")},e.assertValue=function(e,t){M(e)||i(e,"Value",t)},e.assertValueObject=j,e.assertVideo=function(e){if(!sl(e))throw new Error("expected Video")},e.audioDefinition=Tl,e.audioDefinitionFromId=bl,e.audioFromId=Fl,e.audioInstance=wl,e.castInstance=Fc,e.centerPoint=Qi,e.clipDefault=Ga,e.clipDefaultId=Ba,e.clipDefaults=Ua,e.clipDefinition=Wa,e.clipDefinitionFromId=Ha,e.clipFromId=Ka,e.clipInstance=Ja,e.colorAlpha=Kt,e.colorAlphaColor=e=>{const t=ei(e);return{alpha:t.a,color:Rt(t)}},e.colorBlack=Ft,e.colorBlackOpaque=Ct,e.colorBlackTransparent=xt,e.colorBlue="#0000FF",e.colorFromRgb=e=>{const{r:t,g:i,b:n}=e;return`rgb(${t},${i},${n})`},e.colorFromRgba=e=>{const{r:t,g:i,b:n,a:s}=e;return`rgb(${t},${i},${n},${s})`},e.colorGreen=Dt,e.colorHexRegex=Lt,e.colorHexToRgb=Xt,e.colorHexToRgba=Yt,e.colorName=Et,e.colorRed="#FF0000",e.colorRgb=ti,e.colorRgbDifference=e=>{const{r:t,g:i,b:n}=e;return{...e,r:255-t,g:255-i,b:255-n}},e.colorRgbKeys=Tt,e.colorRgbRegex=$t,e.colorRgbToHex=Rt,e.colorRgbToYuv=Nt,e.colorRgba=ii,e.colorRgbaKeys=bt,e.colorRgbaRegex=jt,e.colorRgbaToHex=kt,e.colorRgbaToRgba=Zt,e.colorRgbaTransparent=ni,e.colorServer=e=>Bt(e)?`${e.slice(0,7)}@0x${e.slice(-2)}`:e,e.colorStrip=qt,e.colorToRgb=Qt,e.colorToRgba=ei,e.colorTransparent=wt,e.colorValid=Gt,e.colorValidHex=Bt,e.colorValidRgb=Wt,e.colorValidRgba=Ut,e.colorWhite=St,e.colorWhiteOpaque="#FFFFFFFF",e.colorWhiteTransparent=It,e.colorYellow="#FFFF00",e.colorYuvBlend=Mt,e.colorYuvDifference=_t,e.colorYuvToRgb=e=>{const t=Ot(e);return zt({r:t.y+1.4075*(t.v-128),g:t.y-.3455*(t.u-128)-.7169*(t.v-128),b:t.y+1.779*(t.u-128)})},e.commandFilesInput=Qs,e.commandFilesInputIndex=Zs,e.containerDefaults=xo,e.containerDefinition=Co,e.containerDefinitionFromId=Do,e.containerFromId=Ao,e.containerInstance=Po,e.contentDefaults=na,e.contentDefinition=sa,e.contentDefinitionFromId=ra,e.contentFromId=aa,e.contentInstance=oa,e.editorArgs=al,e.editorInstance=(t={})=>e.editorSingleton=new ol(al(t)),e.editorSelectionInstance=il,e.effectDefaults=Ho,e.effectDefinition=Wo,e.effectDefinitionFromId=Jo,e.effectFromId=Yo,e.effectInstance=Ko,e.eventStop=er,e.fetchCallback=e=>{const{endpoint:t,request:i}=e,n=i||{},s="Content-Type",r="application/json";switch(n.method||="POST",n.headers||={},n.headers[s]||=r,n.headers[s]){case r:n.body=JSON.stringify(n.body);break;case"multipart/form-data":{const e=new FormData;Object.entries(n.body).forEach((([t,i])=>{a(i)||e.set(t,i instanceof Blob?i:String(i))})),n.body=e,delete n.headers[s];break}}const o=ss(t);return fetch(o,n).then((e=>e.json()))},e.filterDefaults=Dr,e.filterDefinition=Pr,e.filterDefinitionFromId=Ar,e.filterFromId=Vr,e.filterInstance=Er,e.fontDefault=po,e.fontDefaults=mo,e.fontDefinition=ho,e.fontDefinitionFromId=fo,e.fontFromId=yo,e.fontInstance=go,e.getChunksFromString=Ht,e.hex256=Jt,e.idGenerate=Tn,e.idGenerateString=yn,e.idIsTemporary=bn,e.idPrefixSet=e=>{gn.prefix=e},e.idTemporary=vn,e.imageDefinition=Dl,e.imageDefinitionFromId=Pl,e.imageFromId=El,e.imageInstance=Al,e.isAboveZero=T,e.isAction=Dc,e.isActionEvent=e=>t(e)&&e.detail,e.isActionInit=e=>Dc(e.action),e.isArray=w,e.isAudio=ja,e.isAudioDefinition=t=>gt(t)&&t.type===e.DefinitionType.Audio,e.isBelowOne=v,e.isBoolean=u,e.isCast=Sc,e.isCastData=Wc,e.isChangeAction=Rc,e.isChangeActionObject=zc,e.isClip=ma,e.isClipObject=e=>di(e),e.isClipSelectType=te,e.isColorContent=Zo,e.isContainer=bi,e.isContainerDefinition=e=>gi(e)&&Ce(e.type),e.isContainerObject=Ti,e.isContainerType=Ce,e.isContent=Vo,e.isContentDefinition=Oo,e.isContentType=Pe,e.isConvolutionServerFilter=ar,e.isCustomEvent=t,e.isDataGroup=an,e.isDataType=Ve,e.isDefined=h,e.isDefinition=gt,e.isDefinitionObject=ft,e.isDefinitionType=Te,e.isDirection=Ne,e.isEditType=J,e.isEdited=xc,e.isEffect=Yc,e.isEffectDefinition=t=>gt(t)&&t.type===e.DefinitionType.Effect,e.isEventType=e=>We.includes(e),e.isFillType=e=>ae.includes(e),e.isFloat=e=>m(e)&&!f(e),e.isFontDefinition=Zc,e.isGraphFileType=ue,e.isImageDefinition=rl,e.isInstance=pi,e.isInstanceObject=di,e.isInteger=f,e.isLayer=dc,e.isLayerFolder=gc,e.isLayerFolderObject=ac,e.isLayerMash=mc,e.isLayerMashObject=cc,e.isLayerObject=oc,e.isLayerType=B,e.isLoadType=pe,e.isLoadedAudio=Jn,e.isLoadedImage=Hn,e.isLoadedVideo=Wn,e.isLoaderPath=Xn,e.isLoaderType=Kn,e.isMash=ha,e.isMashAndDefinitionsObject=e=>n(e)&&"mashObject"in e&&"definitionObjects"in e,e.isMashClass=ic,e.isMashData=Hc,e.isMethod=e=>"function"==typeof e,e.isNan=p,e.isNumber=m,e.isNumberOrNaN=c,e.isNumeric=E,e.isObject=n,e.isOrientation=ke,e.isPoint=Fi,e.isPopulatedArray=C,e.isPopulatedObject=P,e.isPopulatedString=I,e.isPositive=g,e.isPreloadable=Ta,e.isPreloadableDefinition=va,e.isPropertied=e=>e instanceof hi,e.isProperty=cn,e.isRect=Ji,e.isRgb=z,e.isSelectType=Q,e.isSelectedProperty=tr,e.isShapeContainer=e=>bi(e)&&"path"in e,e.isSize=Ai,e.isSizingDefinitionType=Fe,e.isString=r,e.isTextContainer=Kr,e.isTime=O,e.isTimeRange=k,e.isTimingDefinitionType=Ie,e.isTrack=ga,e.isTriggerType=e=>Ge.includes(e),e.isTrueValue=N,e.isTweenable=mi,e.isTweenableDefinition=gi,e.isUndefined=a,e.isUpdatableDuration=Pa,e.isUpdatableDurationDefinition=Aa,e.isUpdatableDurationType=e=>Te(e)&&Da.includes(e),e.isUpdatableSize=Sa,e.isUpdatableSizeDefinition=Ia,e.isUpdatableSizeType=e=>Te(e)&&Fa.includes(e),e.isUploadType=ge,e.isValue=M,e.isValueObject=$,e.isVideo=sl,e.isVideoDefinition=nl,e.layerFolderInstance=lc,e.layerInstance=hc,e.layerMashInstance=uc,e.mashInstance=tc,e.outputDefaultAudio=mu,e.outputDefaultDash=Su,e.outputDefaultFormatByType=wu,e.outputDefaultHls=Fu,e.outputDefaultImage=vu,e.outputDefaultImageSequence=gu,e.outputDefaultPng=t=>{const i=t||{};return{...au,...i,format:e.OutputFormat.Png}},e.outputDefaultPopulate=Tu,e.outputDefaultRendering=(e,t)=>Tu({...t,outputType:e}),e.outputDefaultRtmp=Iu,e.outputDefaultStreaming=t=>{const{format:i}=t;switch(i){case e.OutputFormat.Mdash:return Su(t);case e.OutputFormat.Rtmp:return Iu(t);case e.OutputFormat.Hls:default:return Fu(t)}},e.outputDefaultTypeByFormat=bu,e.outputDefaultVideo=fu,e.outputDefaultWaveform=yu,e.outputInstanceAudio=Ql,e.outputInstanceImage=eu,e.outputInstanceVideo=tu,e.outputInstanceVideoSequence=iu,e.outputInstanceWaveform=nu,e.pixelColor=Fs,e.pixelFromFrame=(e,t,i="ceil")=>{if(!e||!t)return 0;return vs(e*t,i)},e.pixelNeighboringRgbas=ws,e.pixelPerFrame=(e,t,i=1)=>{if(!e||!t)return 0;const n=t/e,s=Math.min(1,n),r=Math.max(1,n);return 1===i?r:i?s+(r-s)*i:s},e.pixelRgbaAtIndex=Ts,e.pixelToFrame=Ss,e.pixelsMixRbg=xs,e.pixelsMixRbga=Is,e.pixelsRemoveRgba=(e,t,i,n=0,s=0,r=!1)=>{Cs(e,t,i,ni,n,s)},e.pixelsReplaceRgba=Cs,e.pointCopy=Ci,e.pointNegate=e=>{const{x:t,y:i}=e;return{x:-t,y:-i}},e.pointRound=Di,e.pointString=Pi,e.pointValueString=e=>{const{x:t,y:i}=e;return`${t},${i}`},e.pointsEqual=Ii,e.propertyInstance=un,e.propertyTypeCoerce=li,e.propertyTypeDefault=ai,e.propertyTypeIsString=oi,e.propertyTypeValid=ci,e.rectCopy=e=>({...Ci(e),...Bi(e)}),e.rectFromSize=Zi,e.rectRound=e=>({...ki(e),...Di(e)}),e.rectString=e=>{const t=[];return Ai(e)&&t.push(Wi(e)),Fi(e)&&t.push(Pi(e)),t.join(";")},e.rectsEqual=Yi,e.rectsFromSizes=(e,t)=>{const i=t||[xi,xi],[n,s]=e,[r,o]=i;return[Zi(n,r),Zi(s,o)]},e.rgbNumeric=zt,e.rgbValue=Vt,e.roundMethod=ys,e.roundWithMethod=vs,e.selectedPropertiesScalarObject=e=>Object.fromEntries(Object.entries(e).map((e=>[e[0],e[1].value]))),e.selectedPropertyObject=(e,t,i)=>{const n=e.filter((e=>!!tr(e)&&(e.property.group===t&&e.selectType===i)));return Object.fromEntries(n.map((e=>{const{name:t,property:i}=e,{name:n}=i;return[t||n,e]})))},e.sizeAboveZero=$i,e.sizeCeil=_i,e.sizeCopy=Bi,e.sizeCover=Ni,e.sizeEven=Ri,e.sizeFloor=e=>{const{width:t,height:i}=e;return{width:Math.max(2,Math.floor(t)),height:Math.max(2,Math.floor(i))}},e.sizeFromElement=e=>{const t={width:Number(e.getAttribute("width")),height:Number(e.getAttribute("height"))};return ji(t),t},e.sizeLock=Ui,e.sizeLockNegative=Hi,e.sizeRound=ki,e.sizeScale=Mi,e.sizeString=Wi,e.sizedEven=Oi,e.sizesEqual=Vi,e.sortByFrame=ir,e.sortByIndex=nr,e.sortByLabel=(e,t)=>e.label<t.label?-1:e.label>t.label?1:0,e.sortByTrack=sr,e.stringFamilySizeRect=rr,e.stringPluralize=(e,t,i="s")=>I(t)?`${e} ${t}${1===e?"":i}`:t,e.stringSeconds=(e,t=0,i=0)=>{const n=[];let s=2,r=3600,o=!1;const a=i||e;return a>=r&&(e>=r?(n.push(String(Math.floor(e/r)).padStart(s,"0")),o=!0,e%=r):n.push("00:")),r=60,(o||a>=r)&&(o&&n.push(":"),e>=r?(n.push(String(Math.floor(e/r)).padStart(s,"0")),o=!0,e%=r):n.push("00:")),r=1,o||a>=r?(o&&n.push(":"),e>=r?(n.push(String(Math.floor(e/r)).padStart(s,"0")),o=!0,e%=r):n.push("00")):n.push("00"),t>1&&(10===t&&(s=1),n.push("."),e?(e=1===s?Math.round(10*e)/10:Math.round(100*e)/100,e=Number(String(e).slice(2)),n.push(String(e).padEnd(s,"0"))):n.push("0".padStart(s,"0"))),n.join("")},e.svgAddClass=jn,e.svgAppend=kn,e.svgDefsElement=_n,e.svgDifferenceDefs=(e,t)=>{const i=yn(),n=Rn({filter:"feBlend",mode:"difference"});$n(n,i,"in"),$n(n,"SourceGraphic","in2");const s=Mn(e,i),r=Nn([s,n],t,xi);return $n(r,"100%","width"),$n(r,"100%","height"),r},e.svgElement=An,e.svgFeImageElement=Mn,e.svgFilter=Rn,e.svgFilterElement=Nn,e.svgFunc=(e,t)=>{const i=globalThis.document.createElementNS(dt,e);return $n(i,t,"tableValues"),$n(i,"discrete","type"),i},e.svgGroupElement=In,e.svgId=Fn,e.svgImageElement=Vn,e.svgMaskElement=On,e.svgPathElement=zn,e.svgPatternElement=(e,t,i)=>{const n=globalThis.document.createElementNS(dt,"pattern");return $n(n,t),Pn(n,e),$n(n,"userSpaceOnUse","patternUnits"),kn(n,i),n},e.svgPolygonElement=Dn,e.svgRectPoints=Cn,e.svgSet=$n,e.svgSetBox=Pn,e.svgSetChildren=Un,e.svgSetDimensions=xn,e.svgSetDimensionsLock=En,e.svgSetTransform=qn,e.svgSetTransformPoint=(e,t)=>{Si(t);const{x:i,y:n}=t;(i||n)&&qn(e,`translate(${i}, ${n})`)},e.svgSetTransformRects=Bn,e.svgTransform=Gn,e.svgUrl=Sn,e.svgUseElement=Ln,e.throwError=i,e.timeEqualizeRates=Rr,e.timeFromArgs=jr,e.timeFromSeconds=Lr,e.timeRangeFromArgs=Mr,e.timeRangeFromSeconds=(e=0,t=1)=>Mr(e,1,t),e.timeRangeFromTime=Nr,e.timeRangeFromTimes=$r,e.trackInstance=Xa,e.tweenColorStep=Es,e.tweenColors=(e,t,i)=>{x(e);const n=[e];if(I(t)&&i>1)for(let s=1;s<i;s++)n.push(Es(e,t,s,i));return n},e.tweenCoverPoints=Ls,e.tweenCoverSizes=js,e.tweenInputTime=(e,t,i,n,s)=>{if(n){if(!t)return i?e.startTime:e.lastTime;if(s){if(i)return e.lastTime}else if(!i)return e.startTime}},e.tweenMaxSize=zs,e.tweenMinMax=Ws,e.tweenMinSize=(e,t)=>{const{width:i,height:n}=e;return!Ai(t)||Vi(e,t)?{width:i,height:n}:{width:Math.min(i,t.width),height:Math.min(n,t.height)}},e.tweenNumberObject=ks,e.tweenNumberStep=As,e.tweenOption=Os,e.tweenOverPoint=Ms,e.tweenOverRect=_s,e.tweenOverSize=Ns,e.tweenPad=Ps,e.tweenPosition=Rs,e.tweenRectLock=qs,e.tweenRects=(e,t,i)=>{const n=[e];if(t&&i>1)for(let s=1;s<i;s++)n.push(Vs(e,t,s,i));return n},e.tweenRectsLock=Gs,e.tweenScaleSizeRatioLock=Bs,e.tweenScaleSizeToRect=$s,e.tweenableRects=(e,t)=>!!Ji(t)&&(e.x!==t.x||(e.y!==t.y||(e.width!==t.width||e.height!==t.height))),e.tweeningPoints=Us,e.urlCombine=is,e.urlEndpoint=Zn,e.urlForEndpoint=ss,e.urlFromEndpoint=ns,e.urlHasProtocol=ts,e.urlIsHttp=es,e.urlIsObject=Qn,e.urlIsRootProtocol=rs,e.urlOptions=hs,e.urlOptionsObject=us,e.urlParse=as,e.urlPrependProtocol=ds,e.urlProtocol=os,e.urlsAbsolute=ls,e.urlsParsed=cs,e.videoDefinition=kl,e.videoDefinitionFromId=_l,e.videoFromId=Nl,e.videoInstance=Ml,e.videoSequenceDefinition=Gl,e.videoSequenceDefinitionFromId=Bl,e.videoSequenceFromId=Wl,e.videoSequenceInstance=Ul,e.yuvNumeric=Ot,Object.defineProperty(e,"__esModule",{value:!0})}));
