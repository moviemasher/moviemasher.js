ARG DIR_ROOT=/app
FROM node:18 as node
ARG DIR_ROOT
WORKDIR ${DIR_ROOT}

# the root package.json (for version, shared dependencies, )
COPY package.json ${DIR_ROOT}/package.json

# copy just the core packages (for their package.json files)
COPY packages/core ${DIR_ROOT}/packages/core
COPY dev/build/core ${DIR_ROOT}/dev/build/core
COPY dev/build/cli.mjs ${DIR_ROOT}/dev/build/cli.mjs
COPY dev/utils ${DIR_ROOT}/dev/utils
COPY dev/dependencies ${DIR_ROOT}/dev/dependencies
RUN node ${DIR_ROOT}/dev/build/cli.mjs package \
  --src=${DIR_ROOT}/dev/build/core/package.json \
  --workspace=packages/core/* \
  --peer=moviemasher.js \
  --dependency=rollup 

FROM node:18 
ARG DIR_ROOT
WORKDIR ${DIR_ROOT}
COPY --from=node ${DIR_ROOT}/package.json ${DIR_ROOT}/package.json
COPY --from=node ${DIR_ROOT}/packages/core/lib/package.json ${DIR_ROOT}/packages/core/lib/package.json

# RUN cat ${DIR_ROOT}/package.json ; exit 1
RUN npm install 

ENTRYPOINT ["npm", "run"]
CMD ["all"]
LABEL org.opencontainers.image.authors="support@moviemasher.com"