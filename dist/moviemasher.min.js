!function(a,b,c){"use strict";"undefined"!=typeof module&&module.exports?module.exports=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("MovieMasher",this,function(){"use strict";var MovieMasher=function(){this.instance_arguments=arguments,this.MovieMasher=MovieMasher,this.initialize()};MovieMasher.prototype.initialize=function(){},MovieMasher.configure=function(a){return Util.isob(a)&&Option.set(a),Option},MovieMasher.find=function(a,b,c){var d;return Util.isob(b)&&(b=b[c||"id"]),b&&(Util.isnt(MovieMasher.registered[a])&&(MovieMasher.registered[a]=[]),d=Util.array_find(MovieMasher.registered[a],b,c),d||(d=Defaults.module_for_type(a,b),d?(MovieMasher.registered[a].push(d),MovieMasher.registered[a].sort(Util.sort_by_label)):console.error("could not find registered "+a,b))),d},MovieMasher.player=function(a){var b=null;return Util.isnt(a)&&(a={}),Util.isob(a)?(b=new Player(a),Players.instances.push(b)):b=Players.instances[a],b},MovieMasher.register=function(a,b){if(Util.isarray(b)||(b=[b]),Util.isob.apply(Util,b)){var c,d,e,f,g,h,i=b.length;if(i)for(e=Util.isnt(MovieMasher.registered[a]),e&&(MovieMasher.registered[a]=[]),h=0;h<i;h++)g=b[h],d=Util.array_find(MovieMasher.registered[a],g),"com.moviemasher."+a+".default"===g.id&&(f=!0,d&&(Util.array_delete(MovieMasher.registered[a],d),d=null)),d||(g.type||(g.type=a),MovieMasher.registered[a].push(g),c=!0);e&&!f&&(g=Defaults.module_for_type(a),g&&(MovieMasher.registered[a].push(g),c=!0,MovieMasher.registered[a].sort(Util.sort_by_label))),c&&MovieMasher.registered[a].sort(Util.sort_by_label)}},MovieMasher.registered={},MovieMasher.supported=!(!Object.defineProperty||!document.createElement("canvas").getContext||!window.AudioContext&&!window.webkitAudioContext);var Action=function(a,b,c,d){this.player=a,this._redo=b,this._undo=c,this._destroy=d,this.undo_selected_clips=this.redo_selected_clips=Util.copy_array(a.selectedClips),this.undo_selected_effects=this.redo_selected_effects=Util.copy_array(a.selectedEffects),this.redo_add_objects=[],this.undo_delete_objects=[],this.undo_add_objects=[],this.redo_delete_objects=[]};!function(a){a.redo=function(){this.player.add_media(this.redo_add_objects),this._redo(),this.player.remove_media(this.redo_delete_objects),this.player.selectedClips=this.redo_selected_clips,this.player.selectedEffects=this.redo_selected_effects,this.player.rebuffer(),this.player.redraw()},a.undo=function(){this.player.add_media(this.undo_add_objects),this._undo(),this.player.remove_media(this.undo_delete_objects),this.player.selectedClips=this.undo_selected_clips,this.player.selectedEffects=this.undo_selected_effects,this.player.rebuffer(),this.player.redraw()},a.destroy=function(){this._destroy&&this._destroy(),delete this._destroy,delete this.player,delete this._redo,delete this._undo,delete this.undo_selected_clips,delete this.redo_selected_clips,delete this.undo_selected_effects,delete this.redo_selected_effects,delete this.redo_add_objects,delete this.undo_delete_objects,delete this.undo_add_objects,delete this.redo_delete_objects}}(Action.prototype),MovieMasher.Action=Action;var Audio={buffer_source:function(a){var b=Audio.get_ctx(),c=b.createBufferSource();return c.buffer=a,c},load:function(a){Loader.load_audio(a)},clip_timing:function(a,b,c){isNaN(b)&&console.error("Audio.clip_timing got NaN for zero_seconds",a);var d,e,f,g={offset:0};return f=new TimeRange(a.frame,c,a.frames),g.start=b+f.seconds,isNaN(g.start)&&console.error("Audio.clip_timing start is NaN",f),g.duration=f.lengthSeconds,a.trim&&(f.frame=a.trim,g.offset=f.seconds),d=Audio.get_ctx().currentTime,d>g.start&&(e=d-g.start,g.start=d,isNaN(g.start)&&console.error("Audio.clip_timing currentTime is NaN"),g.offset+=e,g.duration-=e),g},connect_source:function(a,b,c,d){var e=Audio.get_ctx();a.gainNode=e.createGain(),a.buffer_source.connect(a.gainNode),a.gainNode.connect(e.destination),a.buffer_source.start(b,c,d)},config_gain:function(a,b,c,d,e){a.cancelScheduledValues(0);var f,g,h,i,j;for(j=b.split(","),i=j.length/2,h=0;h<i;h++)g=j[2*h],f=e*j[2*h+1],a[Constant.gain].linearRampToValueAtTime(f,c+g*d)},destroy_sources:function(a){var b,c,d=[],e=Audio.sources.length;for(c=0;c<e;c++)b=Audio.sources[c],a&&-1<a.indexOf(b.clip)?d.push(b):(Audio.disconnect_source(b),delete b.buffer_source);Audio.sources=d},disconnect_source:function(a){var b=Audio.get_ctx();a.buffer_source.disconnect(a.gainNode),a.gainNode.disconnect(b.destination),delete a.gainNode},get_ctx:function(){return Audio.ctx||(window.AudioContext?Audio.ctx=new window.AudioContext:window.webkitAudioContext&&(Audio.ctx=new window.webkitAudioContext)),Audio.ctx},gain_source:function(a){if(a)if(a.player.muted||!a.player.volume)a.gainNode[Constant.gain].value=0;else if(isNaN(Number(a.clip[Constant.gain]))){var b=Audio.clip_timing(a.clip,Audio.zero_seconds(),a.quantize);Audio.config_gain(a.gainNode,a.clip[Constant.gain],b.start,b.duration,a.player.volume)}else a.gainNode[Constant.gain].value=a.clip[Constant.gain]*a.player.volume},media_url:function(a){var b;switch(a.type){case Constant.video:switch(a.audio){case void 0:b=a.source;break;case"0":break;default:b=a.audio}break;case Constant.audio:b=a.url||a.source}return b},start:function(){var a=Audio.get_ctx();Audio.__buffer_source=a.createBufferSource(),Audio.__buffer_source.loop=!0,Audio.__buffer_source.buffer=a.createBuffer(2,44100,44100),Audio.__buffer_source.connect(a.destination),Audio.__buffer_source.start(0)},stop:function(){Audio.destroy_sources(),Audio.__buffer_source&&(Audio.__buffer_source.disconnect(Audio.get_ctx().destination),Audio.__buffer_source=null)},source_for_clip:function(a){return Util.array_find(Audio.sources,{clip:a},"clip")},source_from_clip:function(a,b,c){var d,e,f,g=Audio.media_url(b);return g&&Loader.cached_urls[g]&&(d=c.mash.quantize,e=Audio.clip_timing(a,Audio.zero_seconds(),d),e.duration>0&&!isNaN(e.start)&&(f={},f.clip=a,f.media=b,f.url=g,f.player=c,f.quantize=d,f.buffer_source=Audio.buffer_source(Loader.cached_urls[g]),Constant.audio===b.type&&b.loops&&(Audio.__buffer_source.loop=!0),Audio.connect_source(f,e.start,e.offset,e.duration),Audio.gain_source(f),Audio.sources.push(f))),f},sync:function(a){Audio.__last_seconds=a,Audio.__sync_seconds=Audio.get_ctx().currentTime},time:function(){return Audio.__last_seconds+(Audio.get_ctx().currentTime-Audio.__sync_seconds)},zero_seconds:function(){return Audio.__sync_seconds-Audio.__last_seconds},sources:[],ctx:null,__last_seconds:0,__sync_seconds:0};MovieMasher.Audio=Audio;var Colors={yuv2rgb:function(a){var b,c={};for(b in a)a[b]=parseInt(a[b]);c.r=a.y+1.4075*(a.v-128),c.g=a.y-.3455*(a.u-128)-.7169*(a.v-128),c.b=a.y+1.779*(a.u-128);for(b in c)c[b]=Math.min(255,Math.max(0,Math.floor(c[b])));return c},rgb2hex:function(a){var b,c,d;return b=a.r.toString(16),c=a.g.toString(16),d=a.b.toString(16),b.length<2&&(b="0"+b),c.length<2&&(c="0"+c),d.length<2&&(d="0"+d),"#"+b+c+d},yuv_blend:function(a,b,c,d){var e,f,g,h=0,i=a.length;for(g=0;g<i;g++)e=a[g].u-b.u,f=a[g].v-b.v,h+=Math.sqrt((e*e+f*f)/65025);return h/=Number(i),d>1e-4?255*Math.min(1,Math.max(0,(h-c)/d)):h>c?255:0},rgb2yuv:function(a){var b,c={};for(b in a)a[b]=parseInt(a[b]);c.y=.299*a.r+.587*a.g+.114*a.b,c.u=a.r*-.168736+a.g*-.331264+.5*a.b+128,c.v=.5*a.r+a.g*-.418688+a.b*-.081312+128;for(b in c)c[b]=Math.floor(c[b]);return c}};MovieMasher.Colors=Colors;var Constant={audio:"audio",both:"both",effect:"effect",filter:"filter",font:"font",frame:"frame",freeze:"freeze",gain:"gain",image:"image",merger:"merger",mute_shorthand:"0",mute:"0,0,1,0",property_types:{rgba:{type:String,value:"#000000FF"},rgb:{type:String,value:"#000000"},font:{type:String,value:"com.moviemasher.font.default"},fontsize:{type:Number,value:13},direction4:{type:Number,values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"}],value:0},direction8:{type:Number,values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"},{id:4,identifier:"top_right",label:"Top Right"},{id:5,identifier:"bottom_right",label:"Bottom Right"},{id:6,identifier:"bottom_left",label:"Bottom Left"},{id:7,identifier:"top_left",label:"Top Left"}],value:0},string:{type:String,value:""},pixel:{type:Number,value:0},mode:{type:String,value:"normal",values:[{id:"burn",composite:"color-burn",label:"Color Burn"},{id:"dodge",composite:"color-dodge",label:"Color Dodge"},{id:"darken",composite:"darken",label:"Darken"},{id:"difference",composite:"difference",label:"Difference"},{id:"exclusion",composite:"exclusion",label:"Exclusion"},{id:"hardlight",composite:"hard-light",label:"Hard Light"},{id:"lighten",composite:"lighter",label:"Lighten"},{id:"multiply",composite:"multiply",label:"Multiply"},{id:"normal",composite:"normal",label:"Normal"},{id:"overlay",composite:"overlay",label:"Overlay"},{id:"screen",composite:"screen",label:"Screen"},{id:"softlight",composite:"soft-light",label:"Soft Light"},{id:"xor",composite:"xor",label:"Xor"}]},text:{type:String,value:""}},scaler:"scaler",source:"source",theme:"theme",transition:"transition",video:"video",volume:"volume"};Constant.track_types=[Constant.video,Constant.audio],MovieMasher.Constant=Constant;var Defaults={modules:{font:{label:"Blackout Two AM",id:"com.moviemasher.font.default",type:"font",source:"media/font/default.ttf",family:"Blackout Two AM"},merger:{label:"Top Left",id:"com.moviemasher.merger.default",filters:[{id:"overlay",parameters:[{name:"x",value:"0"},{name:"y",value:"0"}]}]},scaler:{label:"Stretch",id:"com.moviemasher.scaler.default",filters:[{id:"scale",parameters:[{name:"width",value:"mm_width"},{name:"height",value:"mm_height"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]}},module_for_type:function(a,b){var c=Defaults.modules[a];return c&&b&&c.id!==b&&(c=null),c},module_from_type:function(a){var b={},c=Defaults.module_for_type(a);return c?b.id=c.id:console.error("Defaults.module_from_type not found",a),b}};MovieMasher.Defaults=Defaults;var Filter={registered:{},find:function(a){return MovieMasher.find(Constant.filter,a)},load:function(a){var b,c;return c=Filter.find(a),c&&(b=Filter.registered[a],b||Loader.load_filter(c.source)),b},create_drawing:function(a,b,c,d){var e={drawings:[]};return e.container=d,e.label=c,e.canvas=document.createElement("canvas"),e.context=e.canvas.getContext("2d"),1<=a&&(e.canvas.width=a),1<=b&&(e.canvas.height=b),e.container&&(e.span=document.createElement("span"),e.span.setAttribute("alt",e.label),e.container.appendChild(e.span),e.span.appendChild(e.canvas)),e},create_drawing_like:function(a,b){var c=Filter.create_drawing(a.canvas.width,a.canvas.height,b,a.container);return a.drawings.push(c),c},destroy_drawing:function(a){a.container&&(a.container.removeChild(a.span)||console.error("could not find span in container"),a.span.removeChild(a.canvas)||console.error("could not find canvas in span"));var b;for(b in a)a[b]=null},label:function(a){return a.description||a.id},register:function(a,b){Filter.registered[a]=b},rgb_at_pixel:function(a,b){var c=Filter.index_from_pixel(a);return Filter.rgb_at_index(c,b)},array_from_rgb:function(a){return[a.r,a.g,a.b,a.a]},rgb_at_index:function(a,b){var c=null;return a>=0&&a<=b.length-4&&(c={r:b[a],g:b[a+1],b:b[a+2],a:b[a+3]}),c},pixel_from_point:function(a,b){return a.y*b+a.x},point_from_pixel:function(a,b){var c={x:0,y:0};return c.x=a%b,c.y=Math.floor(a/b),c},pixel_from_index:function(a){return a/4},index_from_pixel:function(a){return 4*a},point_from_index:function(a,b){var c=Filter.pixel_from_index(a);return Filter.point_from_pixel(c,b)},safe_pixel:function(a,b,c,d,e){var f=Filter.point_from_pixel(a,d);return f.x=Math.max(0,Math.min(d-1,f.x+b)),f.y=Math.max(0,Math.min(e-1,f.y+c)),Filter.pixel_from_point(f,d)},safe_pixels:function(a,b,c,d){d||(d=3);var e,f,g,h=[],i=Math.floor(d/2);for(f=0;f<d;f++)for(e=0;e<d;e++)g=Filter.safe_pixel(a,e-i,f-i,b,c),h.push(g);return h},rgb_matrix_from_index:function(a,b,c,d,e){var f=Filter.pixel_from_index(a);return Filter.rgb_matrix_from_pixel(f,b,c,d,e)},rgb_matrix_from_pixel:function(a,b,c,d,e){var f,g,h=Filter.safe_pixels(a,c,d,e);for(g=h.length,f=0;f<g;f++)h[f]=Filter.rgb_at_pixel(h[f],b);return h}};MovieMasher.Filter=Filter;var Loader={load_audio:function(a){if(!Loader.requested_urls[a]&&!Loader.cached_urls[a]){var b=new XMLHttpRequest;b.open("GET",a,!0),b.responseType="arraybuffer",b.onload=function(){Audio.get_ctx().decodeAudioData(b.response,function(b){Loader.cached_urls[a]=b,delete Loader.requested_urls[a],Players.draw_delayed()},function(){console.error("problem decoding audio",a)})},Loader.requested_urls[a]=b,b.send()}},load_filter:function(a){Loader.requested_urls[a]||Loader.cached_urls[a]||(Loader.requested_urls[a]=a,$script(a,function(){delete Loader.requested_urls[a],Loader.cached_urls[a]=!0,Players.draw_delayed()}))},load_font:function(a){Loader.requested_urls[a]||Loader.cached_urls[a]||(Loader.requested_urls[a]=a,opentype.load(a,function(b,c){b?console.error("could not find registered font with url",a,b):(Loader.cached_urls[a]=c,delete Loader.requested_urls[a],Players.draw_delayed())}))},load_image:function(a){Loader.requested_urls[a]||Loader.cached_urls[a]||(Loader.requested_urls[a]=new Image,Loader.requested_urls[a].onload=function(){Loader.cached_urls[a]=Loader.requested_urls[a],delete Loader.requested_urls[a],Players.draw_delayed()},Loader.requested_urls[a].crossOrigin="Anonymous",Loader.requested_urls[a].src=a)},load_urls_of_type:function(a){var b,c=!1;for(b in a)if(!Loader.cached_urls[b]&&!Loader.requested_urls[b])switch(c=!0,a[b]){case Constant.font:Loader.load_font(b);break;case Constant.image:Loader.load_image(b);break;case Constant.filter:Loader.load_filter(b);break;case Constant.audio:Loader.load_audio(b);break;default:console.error("cannot load media of unsupported type",a[b],b)}return c},loaded_urls_of_type:function(a){var b,c=!0;for(b in a)if(!Loader.cached_urls[b]){c=!1;break}return c},cached_urls:{},requested_urls:{}};setInterval(function(){var a,b,c=Players.instances.length,d=Loader.cached_urls;for(b=0;b<c;b++)d=Players.instances[b].deleteable_urls(d);for(a in d)delete Loader.cached_urls[a],delete Loader.requested_urls[a]},2e3),MovieMasher.Loader=Loader;var Mash={clip_from_media:function(a){var b,c,d,e,f={id:a.id};if(a.properties)for(b in a.properties)e=a.properties[b],Util.isnt(e.value)?(c=e.type,c&&(d=Constant.property_types[c],d&&(Util.isnt(d.value)?d.type&&(f[b]=new d.type):f[b]=d.value))):f[b]=e.value;return f},clip_has_audio:function(a,b){var c=!1;switch(b.type){case Constant.video:c=!!Audio.media_url(b);break;case Constant.audio:c=b.url||b.source}if(c)switch(a[Constant.gain]){case Constant.mute:case Constant.mute_shorthand:c=!1}return c},clip_time:function(a,b,c,d,e){var f=c.copyTime();f.subtract(new TimeRange(a.frame,d));var g=new TimeRange(a.frames,d);switch(f.min(g),e&&(f.frame+=a.speed?Math.ceil(a.speed):1),b.type){case Constant.video:a.trim&&f.add(new TimeRange(a.trim,d)),a.speed&&f.divide(a.speed,"ceil");break;case Constant.audio:a.trim&&f.add(new TimeRange(a.trim,d))}return f},effect_clips:function(a){var b,c,d,e=[];for(c=a.length,b=0;b<c;b++)d=a[b],Util.isarray(d.effects)&&d.effects.length&&(e=e.concat(d.effects));return e},init_clip:function(a,b,c,d){if(d||(d=0),b&&c&&a&&!Mash.init_media(c)&&(Mash.is_modular_media(c)&&Mash.init_module(c.type,b,c),Constant.effect!==c.type)){switch(Util.isnt(b.track)&&(b.track=d),Util.isnt(b.frame)&&(b.frame=0),c.type){case Constant.video:case Constant.audio:Util.isnt(b[Constant.gain])&&(b[Constant.gain]=1),Util.isnt(b.frames)&&(b.frames=new TimeRange(c.duration,1).scale(a.quantize,"floor").frame),Util.isnt(b.trim)&&(b.trim=0);break;default:Util.isnt(b.frames)&&(b.frames=new TimeRange(Option.mash[c.type+"_seconds"],1).scale(a.quantize).frame)}switch(c.type){case Constant.transition:case Constant.audio:break;default:Util.isnt(b.scaler)&&(b.scaler=c.scaler||Defaults.module_from_type(Constant.scaler)),Util.isnt(b.merger)&&(b.merger=c.merger||Defaults.module_from_type(Constant.merger)),Util.isnt(b.effects)&&(b.effects=c.effects||[]),c=b.scaler,Mash.init_module(Constant.scaler,c,Mash.media_search(Constant.scaler,c.id,a)),c=b.merger,Mash.init_module(Constant.merger,c,Mash.media_search(Constant.merger,c.id,a));var e,f=b.effects.length;for(e=0;e<f;e++)c=b.effects[e],Mash.init_module(Constant.effect,c,Mash.media_search(Constant.effect,c.id,a))}}},init_mash:function(a){Util.copy_ob_scalars(Option.mash.default,a,!0),a.quantize=a.quantize?parseInt(a.quantize):1,Util.isnt(a.id)&&(a.id=Util.uuid());var b,c,d,e,f,g,h,i,j,k,l,m;for(b={},Util.isarray(a.media)||(a.media=[]),l=Constant.track_types.length,m=0;m<l;m++)if(g=Constant.track_types[m],Util.isarray(a[g])||(a[g]=[]),e=a[g],i=e.length){for(h=0;h<i;h++)if(f=Mash.init_track(e[h],h),k=f.clips.length){for(j=0;j<k;j++)d=f.clips[j],c=Mash.media(a,d),Mash.init_clip(a,d,c,h);Mash.media_count_for_clips(a,f.clips,b)}}else e.push(Mash.init_track(g,0));for(g in b)b[g]=b[g].count;return b},init_media:function(a){var b=!Util.isob(a);if(!b)switch(Util.isnt(a.id)&&(a.id=Util.uuid()),a.type){case Constant.video:Util.isnt(a.fps)&&(a.fps=10),Util.isnt(a.duration)&&(a.duration=0),Util.isnt(a.begin)&&(a.begin=1),Util.isnt(a.pattern)&&(a.pattern="%.jpg"),Util.isnt(a.increment)&&(a.increment=1),Util.isnt(a.zeropadding)&&(a.zeropadding=String(a.begin+a.increment*Math.floor(a.fps*a.duration)).length);break;case Constant.transition:Util.isnt(a.to)&&(a.to={}),Util.isnt(a.from)&&(a.from={}),Util.isnt(a.to.scaler)&&(a.to.scaler=Defaults.module_from_type(Constant.scaler)),Util.isnt(a.to.merger)&&(a.to.merger=Defaults.module_from_type(Constant.merger)),Util.isnt(a.from.scaler)&&(a.from.scaler=Defaults.module_from_type(Constant.scaler)),Util.isnt(a.from.merger)&&(a.from.merger=Defaults.module_from_type(Constant.merger))}return b&&console.error("init_media got invalid media",a),b},init_module:function(a,b,c){if(!c)return console.error("could not find media for module",b);if(c.properties){var d;for(d in c.properties)Util.isnt(b[d])&&(b[d]=c.properties[d].value)}},init_track:function(a,b){return Util.isob(a)||(a={type:a}),a.index=b,Util.isarray(a.clips)||(a.clips=[]),a},is_modular_clip:function(a,b){return Mash.is_modular_media(Mash.media(a,b))},is_modular_media:function(a){var b=!1;if(Util.isob(a)&&!Util.isnt(a.type))switch(a.type){case Constant.image:case Constant.audio:case Constant.video:case"frame":break;default:b=!0}return b},is_visual_media:function(a){var b=!1;if(Util.isob(a))switch(a.type){case Constant.image:case Constant.video:case Constant.transition:case Constant.theme:b=!0}return b},length_of_clips:function(a){var b,c=0;return Util.isarray(a)&&a.length&&(b=a[a.length-1],c=b.frame+b.frames),c},loaded_range:function(a,b,c){var d=Mash.urls_for_clips(a,Mash.range_clips(a,b,c),b);return Loader.loaded_urls_of_type(d)},max_frames_for_clip:function(a,b,c){var d=0;switch(b.type){case Constant.audio:case Constant.video:d=Math.floor(b.duration*c)-a.trim}return d},max_trim_for_clip:function(a,b,c){var d=0;switch(b.type){case Constant.audio:case Constant.video:d=Math.floor(b.duration*c)-Option.mash.minframes}return d},media:function(a,b){return Util.array_find(a.media,b)},media_count_for_clips:function(a,b,c){var d,e,f,g,h,i,j,k,l;if(Util.isob(c)&&Util.isarray(b))for(g=b.length,f=0;f<g;f++)if(d=b[f],d||console.error("media_count_for_clips",b),Mash.media_reference(a,d.id,c),l=c[d.id])if(e=l.media){if(Mash.is_modular_media(e))for(k=Mash.properties_for_media(e,Constant.font),i=k.length,h=0;h<i;h++)j=k[h],j=d[j],Mash.media_reference(a,j,c,Constant.font);switch(e.type){case Constant.transition:Mash.media_merger_scaler(a,e.to,c),Mash.media_merger_scaler(a,e.from,c);break;case Constant.effect:case Constant.audio:break;default:Mash.media_merger_scaler(a,d,c),Mash.media_count_for_clips(a,d.effects,c)}}else console.error("could not find media",d.id,l);else console.error("could not find reference")},media_for_clips:function(a,b,c){var d,e,f={},g=[];if(!Util.isnt(b)){Util.isob(c)&&(f[c.id]={media:c,count:1}),Util.isarray(b)||(b=[b]),Mash.media_count_for_clips(a,b,f);for(e in f)d=f[e],d.media?g.push(d.media):console.error("could not find media referenced in mash",e,d.count)}return g},media_merger_scaler:function(a,b,c){Util.isob(b)&&(Util.isob(b[Constant.merger])&&Mash.media_reference(a,b[Constant.merger].id,c,Constant.merger),Util.isob(b[Constant.scaler])&&Mash.media_reference(a,b[Constant.scaler].id,c,Constant.scaler))},media_range:function(a,b,c,d,e){var f=TimeRange.fromTimes(Mash.clip_time(a,b,c,d),Mash.clip_time(a,b,c.endTime,d,e));return f},media_reference:function(a,b,c,d){c[b]?c[b].count++:(c[b]={},c[b].count=1,c[b].media=Mash.media_search(d,b,a))},media_search:function(a,b,c){var d=null;return Util.isnt(b)||(c&&(d=Mash.media(c,b)),d||(d=MovieMasher.find(a,b)),d||(d=Defaults.module_for_type(a))),d},module_clips:function(a){var b,c,d,e,f;for(f=Mash.visual_clips(a),e=Mash.effect_clips(f),d=f.length,c=0;c<d;c++)b=f[c],Mash.is_modular_clip(a,b)&&e.push(b);return e},modules_reference_media:function(a,b){var c,d,e,f,g,h,i,j,k,l=Mash.module_clips(a);if(Util.isob(b)&&(b=b.id),b)for(e=l.length,d=0;d<e;d++){if(k=l[d],k.scaler&&(c=b===k.scaler.id),k.merger&&(c=c||b===k.merger.id),!c&&(j=Mash.media(a,k)))for(g=Mash.properties_for_media(j,Constant.font),i=g.length,h=0;h<i&&(f=g[h],!(c=b===k[f]));h++);if(c)break}return c},properties_for_media:function(a,b){var c,d=[];if(!Util.isnt(b)&&Util.isob(a)&&Util.isob(a.properties))for(c in a.properties)b===a.properties[c].type&&d.push(c);return d},range_clips:function(a,b,c){b=b.copyTimeRange();var d,e,f,g,h,i,j,k,l,m,n,o=[];for(d=new TimeRange(0,a.quantize,1),n=Constant.track_types.length,m=0;m<n;m++)if(e=Constant.track_types[m],e!==Constant.audio||c)for(f=a[e],j=f.length,i=0;i<j;i++)for(g=f[i],l=g.clips.length,k=0;k<l;k++)h=g.clips[k],d.frame=h.frame,d.frames=h.frames,d.intersection(b)&&o.push(h);return o},recalc_clips:function(a){a.length>1&&a.sort(Util.sort_by_frame)},recalc_track:function(a,b){Constant.audio===b.type||b.index?Mash.recalc_clips(b.clips):Mash.recalc_video_clips(a,b.clips)},recalc_video_clips:function(a,b){var c,d,e,f,g=0;for(e=b.length,d=0;d<e;d++)f=b[d],c=Mash.media(a,f),d&&Constant.transition===c.type&&(g-=f.frames),f.frame=g,Constant.transition!==c.type&&(g+=f.frames);Mash.recalc_clips(b)},track_for_clip:function(a,b,c){c||(c=Mash.media(a,b));var d,e,f,g=0;for(e=a[Constant.audio===c.type?Constant.audio:Constant.video],Util.isnt(b.track)?f=e.length:(g=b.track,f=g+1);g<f;g++)if(d=e[g],-1<d.clips.indexOf(b))return d},urls_for_clip:function(a,b,c,d){var e,f,g,h,i,j,k;if(e=a.quantize,Util.isob(d)||(d={}),b&&(b[Constant.merger]&&(f=Mash.media_search(Constant.merger,b[Constant.merger].id,a),Mash.urls_for_media_filters(f,d)),b[Constant.scaler]&&(f=Mash.media_search(Constant.scaler,b[Constant.scaler].id,a),Mash.urls_for_media_filters(f,d)),f=Mash.media(a,b))){switch(f.type){case"frame":case Constant.video:d.image||(d.image={}),Mash.urls_for_video_clip(b,f,c,e,d.image);case Constant.audio:Mash.clip_has_audio(b,f)&&(d.audio||(d.audio={}),d.audio[Audio.media_url(f)]=!0);break;case Constant.image:d[f.type]||(d[f.type]={}),d[f.type][f.url||f.source]=!0;break;default:if(Mash.urls_for_media_filters(f,d),j=Mash.properties_for_media(f,Constant.font),h=j.length)for(g=0;g<h;g++)i=j[g],k=Mash.media_search(Constant.font,b[i],a),k?k.source&&(d.font||(d.font={}),d.font[k.source]=!0):console.warn("could not find font",b[i])}if(Mash.is_visual_media(f)&&Util.isarray(b.effects)&&b.effects.length)for(h=b.effects.length,g=0;g<h;g++)Mash.urls_for_clip(a,b.effects[g],c,d)}return d},urls_for_clips:function(a,b,c,d){return Mash.urls_of_type(Mash.urls_for_clips_by_type(a,b,c),d)},urls_for_clips_by_type:function(a,b,c){c=c.copyTimeRange();var d,e,f,g={};for(f=b.length,e=0;e<f;e++)d=b[e],Mash.urls_for_clip(a,d,c,g);return g},urls_for_media_filters:function(a,b){var c,d,e,f;if(Util.isob(a)&&Util.isob(b)&&a.filters)for(d=a.filters.length,c=0;c<d;c++)e=a.filters[c],f=Filter.find(e.id),f?(b[Constant.filter]||(b[Constant.filter]={}),b[Constant.filter][f.source]=!0):console.warn("filter not registered",e.id)},urls_for_video_clip:function(a,b,c,d,e){e||(e={});var f=c.frames>1;c=Mash.media_range(a,b,c,d,f);var g,h,i,j,k,l=new TimeRange(Math.floor(Number(b.duration)*Number(b.fps)),b.fps),m=l.frame,n=c.copyTimeRange();for(n.minLength(l),k=n.end,j=n.frame;j<=k;j++)l=new TimeRange(j,n.fps),l.scale(b.fps),j!==n.frame&&i===l.frame||(i=l.frame,i=Math.min(i,m-1),g=String(Math.min(i,m)*b.increment+b.begin),b.zeropadding&&(g=Util.pad(g,b.zeropadding,"0")),h=b.url+b.pattern,h=h.replace("%",g),e[h]=!0);return e},urls_of_type:function(a,b){var c,d,e,f={};for(c in a){switch(e=!0,b){case Constant.audio:e=c===Constant.audio;break;case Constant.video:e=c!==Constant.audio}if(e)for(d in a[c])f[d]=c}return f},visual_clips:function(a){var b,c,d,e=[];for(d=a.video.length,c=0;c<d;c++)b=a.video[c],Util.isarray(b.clips)&&b.clips.length&&(e=e.concat(b.clips));return e}};MovieMasher.Mash=Mash;var Option={mash:{minframes:1,quantize:10,transition_seconds:1,frame_seconds:2,image_seconds:2,theme_seconds:3,default:{label:"Untitled Mash",quantize:1,backcolor:"rgb(0,0,0)"}},player:{autoplay:0,buffertime:10,fps:30,loop:1,minbuffertime:1,unbuffertime:1,volume:.75},set:function(a){Util.copy_keys_recursize(a,Option)},timeline:{hscrollpadding:20}};MovieMasher.Option=Option;var Player=function(a){Util.isob(a)||(a={});var b,c,d={};Util.copy_ob_scalars(Option.player,a),this.__drawing={drawings:[]},this.__load_timer=null,this.__moving=!1,this.__muted=!1,this.__paused=!0,this.__stalling=!1,this.__minbuffertime=new TimeRange(a.minbuffertime,1),this.__unbuffertime=new TimeRange(a.unbuffertime,1),this.__buffertime=new TimeRange(a.buffertime,1),this.__time=new TimeRange(0,1),this.__time_drawn=new TimeRange(0,1);for(c in a)switch(b=a[c],c){case"mash":d=b;case"minbuffertime":case"unbuffertime":case"buffertime":case"fps":continue;default:this[c]=b}this.fps=a.fps,this.mash=d};!function(pt){var dp=Object.defineProperty;dp(pt,"action_index",{get:function(){return this.__action_index}}),dp(pt,"autoplay",{get:function(){return this.__autoplay},set:function(a){this.__autoplay=a}}),dp(pt,"buffertime",{get:function(){return this.__buffertime.seconds},set:function(a){this.__buffertime=TimeRange.fromSeconds(a,this.__fps)}}),dp(pt,"canvas_context",{get:function(){return this.__drawing.context},set:function(a){this.__drawing.context=a,this.__drawing.canvas=a?a.canvas:null,this.__mash&&(this.__draw_context(),this.redraw())}}),dp(pt,"canvas_container",{get:function(){return this.__drawing.container},set:function(a){this.__drawing.container=a}}),dp(pt,"currentTime",{get:function(){return this.__time.seconds},set:function(a){this.time=TimeRange.fromSeconds(a,this.__fps)}}),dp(pt,"duration",{get:function(){return this.__mash_length?Number(this.__mash_length)/Number(this.__mash.quantize):0}}),dp(pt,"fps",{get:function(){return this.__fps},set:function(a){a&&(a=Math.round(Number(a)),a&&this.__fps!==a&&(this.__fps=a,this.__time.scale(this.__fps),this.__minbuffertime.scale(this.__fps),this.__unbuffertime.scale(this.__fps),this.__buffertime.scale(this.__fps),this.__time_drawn.scale(this.__fps)))}}),dp(pt,"frame",{get:function(){return this.__time.frame},set:function(a){this.time=new TimeRange(a,this.__time.fps)}}),dp(pt,"frames",{get:function(){return Math.round(Number(this.__mash_length)/Number(this.__mash.quantize)*Number(this.__time.fps))}}),dp(pt,"loop",{get:function(){return this.__loop},set:function(a){this.__loop=a}}),dp(pt,"mash",{get:function(){return this.__mash},set:function(a){this.paused=!0,this.__action_index=-1,this.__action_stack=[],this.__selected_effects=[],this.__mash=a||{},this.__media_references=Mash.init_mash(this.__mash),this.selectedClips=[],this.mash_length_changed(),this.rebuffer(),this.redraw(),this.__autoplay&&(this.paused=!1)}}),dp(pt,"minbuffertime",{get:function(){return this.__minbuffertime.seconds},set:function(a){this.__minbuffertime=TimeRange.fromSeconds(a,this.__fps)}}),dp(pt,"muted",{get:function(){return this.__muted},set:function(a){this.__muted=a,this.__moving&&this.__adjust_gain(Mash.range_clips(this.__mash,this.__time,!0))}}),dp(pt,"paused",{get:function(){return this.__paused},set:function(a){if(this.__mash_length||(a=!0),this.__paused!==a){if(this.__paused=a,this.__paused)Players.stop_playing(),this.__set_moving(!1),this.__buffer_timer&&(clearInterval(this.__buffer_timer),this.__buffer_timer=0);else{if(Players.start_playing(this),!this.__buffer_timer){var b=this;this.__buffer_timer=setInterval(function(){b.rebuffer()},2e3)}this.rebuffer(),this.redraw()}this.__set_stalling(!this.__moving&&!this.__paused)}}}),dp(pt,"position",{get:function(){var a,b=0;return this.__time.frame&&(a=this.duration,a&&(b=this.__time.seconds/a)),b},set:function(a){this.time=new TimeRange(this.duration*a,1)}}),dp(pt,"selectedClip",{get:function(){return 1===this.__selected_clips.length?this.__selected_clips[0]:null},set:function(a){this.selectedClips=Util.isob(a)?[a]:[]}}),dp(pt,"selectedClipOrMash",{get:function(){return this.selectedClip||this.__mash}}),dp(pt,"selectedClips",{get:function(){return this.__selected_clips},set:function(a){var b,c,d,e,f,g;if(Util.isob(a)||(a=[]),a.length){for(g={},f=a.length,e=0;e<f;e++){switch(d=a[e],c=Mash.media(this.__mash,d),b=c.type){case Constant.audio:break;case Constant.effect:continue;default:b="video-"+(d.track||0)}g[b]||(g[b]=[]),g[b].push(d)}for(b in g){a=g[b];break}}this.__selected_clips=a,this.selectedEffects=!1,this.__pristine_clip=Util.copy_ob_scalars(this.selectedClipOrMash),this.selectedClipOrMash.scaler&&(this.__pristine_clip.scaler=Util.copy_ob_scalars(this.selectedClipOrMash.scaler)),this.selectedClipOrMash.merger&&(this.__pristine_clip.merger=Util.copy_ob_scalars(this.selectedClipOrMash.merger))}}),dp(pt,"selectedEffect",{get:function(){return 1===this.__selected_effects.length?this.__selected_effects[0]:null},set:function(a){this.selectedEffects=Util.isob(a)?[a]:[]}}),dp(pt,"selectedEffects",{get:function(){return this.__selected_effects},set:function(a){var b,c,d,e,f,g;if(Util.isarray(a)||(a=[]),a.length&&this.__selected_clips.length<2){if(g=this.selectedClip,f=[],g&&Util.isarray(g.effects))for(d=a.length,c=0;c<d;c++)b=a[c],e=Mash.media(this.__mash,b),e&&Constant.effect===e.type&&-1<g.effects.indexOf(b)&&f.push(b);a=f}this.__selected_effects=a,this.__pristine_effect=Util.copy_ob_scalars(this.selectedEffect)}}),dp(pt,"stalling",{get:function(){return this.__stalling}}),dp(pt,"time",{get:function(){return this.__time},set:function(a){var b=TimeRange.fromSomething(a);b=this.__limit_time(b),this.__time.isEqualToTime(b)||this.__redraw_moving(b)}}),dp(pt,"unbuffertime",{get:function(){return this.__unbuffertime.seconds},set:function(a){this.__unbuffertime=TimeRange.fromSeconds(a,this.__fps)}}),dp(pt,"volume",{get:function(){return this.__gain},set:function(a){this.__gain=a,this.__moving&&this.__adjust_gain(Mash.range_clips(this.__mash,this.__time,!0))}}),pt.add=function(a,b,c,d){var e,f,g;return Mash.init_media(a)||(b||(b=Mash.is_visual_media(a)?Constant.video:a.type),d||(d=0),c||(c=0),g=Mash.clip_from_media(a),g||console.error("add got no clip from media",g,a),Mash.init_clip(this.__mash,g,a,d),e=Constant.effect===b?this.__action_effect_add(g,c):Constant.audio===b||d?this.__action_track_add(a.type,g,d,c):this.__action_video_add(g,d,c),e&&(f=Mash.media_for_clips(this.__mash,g,a),e.redo_add_objects=f,e.undo_delete_objects=f,Constant.effect===a.type?e.redo_selected_effects=[g]:e.redo_selected_clips=[g],this.__action_add(e))),g},pt.add_media=function(a){var b,c,d,e;for(Util.isarray(a)||(a=[a]),e=a.length,d=0;d<e;d++)c=a[d],b=Util.isob(c)?c.id:c,this.__media_references[b]||(this.__media_references[b]=0,Util.array_find(this.__mash.media,c)||this.__mash.media.push(c)),this.__media_references[b]++},pt.addTrack=function(a){this.__action_add(new Action(this,function(){
this.player.__track_create(a)},function(){this.player.__track_delete(a)}))},pt.can=function(a){var b=!1,c=this.__selected_clips.length;switch(a){case"undo":b=this.__action_index>-1;break;case"redo":b=this.__action_index<this.__action_stack.length-1;break;case"adjust":b=c>0,b&&(b=this.__selected_clips[0].track>0);break;case"copy":b=c>0;break;case"cut":case"remove":b=this.__selected_clips.length;break;case"split":b=1===c,b&&(b=this.__canSplitAtTime(this.__selected_clips[0],this.__time));break;case"freeze":b=c>0,b&&(b=Constant.video===Mash.media(this.__mash,this.__selected_clips[0]).type),b&&(b=this.__canSplitAtTime(this.__selected_clips[0],this.__time))}return b},pt.change=function(a,b){var c,d,e,f,g="change-property";if(e=b?this.selectedEffect:this.selectedClipOrMash,f=b?this.__pristine_effect:this.__pristine_clip,a&&e)if(this.__action_index>-1&&this.__action_index===this.__action_stack.length-1&&Util.keys_found_equal({id:g,target:e,property:a},this.__action_stack[this.__action_index]))d=this.__action_stack[this.__action_index],d.value=Util.ob_property(e,a),d._redo(),this.__redraw_moving();else{var h=function(){this.set_property(this.orig_value)},i=function(){this.set_property(this.value)},j=!1;switch(c=Mash.media(this.__mash,e),c&&Mash.is_modular_media(c)&&(j=-1<Mash.properties_for_media(c,Constant.font).indexOf(a)?Constant.font:null),j||(j=".id"===a.substr(-3)?a.substr(0,a.length-3):null),j&&(h=function(){this.change_data(this.orig_value,!0)},i=function(){this.change_data(this.value)}),d=new Action(this,i,h),a){case"frames":d.max=Mash.max_frames_for_clip(e,c,this.__mash.quantize),d.set_property=function(a){a=Math.max(Option.mash.minframes,a),this.max&&(a=Math.min(this.max,a)),Util.set_ob_property(this.target,this.property,a),Mash.recalc_track(this.player.mash,Mash.track_for_clip(this.player.mash,this.target)),this.player.mash_length_changed()};break;case"trim":d.orig_length=Util.ob_property(e,"frames"),d.max=Mash.max_trim_for_clip(e,c,this.__mash.quantize),d.set_property=function(a){a=Math.max(0,a),this.max&&(a=Math.min(this.max,a)),Util.set_ob_property(this.target,this.property,a),a=this.orig_length-(a-this.orig_value),Util.set_ob_property(this.target,"frames",a),Mash.recalc_track(this.player.mash,Mash.track_for_clip(this.player.mash,this.target)),this.player.mash_length_changed()};break;case Constant.gain:d.set_property=function(a){Util.set_ob_property(this.target,this.property,a),Audio.gain_source(Audio.source_for_clip(this.target))};break;default:d.set_property=function(a){Util.set_ob_property(this.target,this.property,a)}}d.target=e,d.id=g,d.property=a,d.value=Util.ob_property(e,a),d.orig_value=Util.ob_property(f,a),j&&(d.is_id=j,d.last_value=d.orig_value,d.change_data=function(a,b){var c=Mash.media_search(this.is_id,a,this.player.mash);return c?(this.player.add_media(c),Constant.font===this.is_id?this.set_property(a):this.target[this.is_id]=b?f[this.is_id]:Mash.clip_from_media(c),this.player.remove_media(Mash.media_search(this.is_id,this.last_value,this.player.mash)),void(this.last_value=a)):console.error("could not find "+this.is_id+" for "+a)}),this.__action_add(d)}},pt.changeEffect=function(a){this.change(a,!0)},pt.deleteable_urls=function(a){var b,c={};for(b in a)this.__needed_urls[b]||(c[b]=!0);return c},pt.destroy=function(){this.mash=null,this.canvas_context=null},pt.did=function(){},pt.mash_length_changed=function(){var a,b,c,d,e,f,g=0;for(c=Constant.track_types.length,d=0;d<c;d++)for(e=Constant.track_types[d],f=this.__mash[e],b=f.length,a=0;a<b;a++)g=Math.max(g,Mash.length_of_clips(f[a].clips));if(this.__mash_length!==g){this.__mash_length=g;var h=new TimeRange(this.__mash_length,this.__mash.quantize);h.scale(this.__fps,"floor"),this.__mash_frames=h.frame,this.frame=Math.max(0,Math.min(this.__mash_frames-1,this.__time.frame))}},pt.media=function(a){return Mash.media(this.__mash,a)},pt.move=function(a,b,c,d){if(!Util.isnt(a,b)&&(Util.isarray(a)||(a=[a]),Util.isob.apply(Util,a))){d||(d=0),c||(c=0);var e;Constant.effect===b?(c=Util.index_after_removal(c,a,this.selectedClipOrMash.effects),-2<c&&(e=this.__action_effects_move(c,a,this.selectedClipOrMash.effects))):Constant.audio===b||d?e=this.__action_clips_move(b,d,c,a):(c=Util.index_after_removal(c,a,this.__mash[b][d].clips),-2<c&&(e=this.__action_video_move(d,c,a))),e&&this.__action_add(e)}},pt.pause=function(){this.paused=!0},pt.play=function(){this.paused=!1},pt.rebuffer=function(){var a,b,c,d,e,f,g,h,i={},j=[];if(this.__mash&&(b=this.__audio_is_on(),c=this.__paused?this.__time.copyTime():new TimeRange(this.__time.frame,this.__time.fps,this.__buffertime.frame),c.intersection(new TimeRange(0,this.__mash.quantize,this.__mash_length))||(c=null),c&&(f=Mash.range_clips(this.__mash,c,b),i=Mash.urls_for_clips(this.__mash,f,c,b?Constant.both:Constant.video),Loader.load_urls_of_type(i),b))){for(h=f.length,g=0;g<h;g++)e=f[g],d=Mash.media(this.__mash,e),Mash.clip_has_audio(e,d)&&(Audio.source_for_clip(e)||(Audio.source_from_clip(e,d,this),a=!0),j.push(e));j.length&&Audio.destroy_sources(j),a&&Players.draw_delayed()}this.__needed_urls=i},pt.redo=function(a){this.__action_index<this.__action_stack.length-1&&(this.__action_index++,this.__action_stack[this.__action_index].redo(),this.did(a),this.__redraw_moving())},pt.redraw=function(){if(this.__drawing.context){var a,b,c,d,e;b=this.__audio_is_on(),c=Mash.range_clips(this.__mash,this.__time,b),a=Mash.urls_for_clips_by_type(this.__mash,c,this.__time),e=Loader.loaded_urls_of_type(Mash.urls_of_type(a,Constant.video)),d=!b||Loader.loaded_urls_of_type(Mash.urls_of_type(a,Constant.audio)),(e&&d)!==this.__moving&&(this.__moving?this.__set_moving(!1):!this.__paused&&Mash.loaded_range(this.__mash,this.__time_drawn.copyTime(this.__buffertime.frame),b)&&this.__set_moving(!0)),e?(this.__time_drawn=this.__time.copyTime(),this.__draw_request(c)):this.__paused&&this.rebuffer()}},pt.remove=function(a,b,c){if(!Util.isnt(a,b)&&(Util.isarray(a)||(a=[a]),Util.isob.apply(Util,a))){c||(c=0);var d,e;Constant.effect===b?(d=this.__action_effects_remove(a,this.selectedClipOrMash.effects),d.redo_selected_effects=[]):(d=Constant.audio===b||c?this.__action_clips_remove(b,c,a):this.__action_video_remove(c,a),d.redo_selected_clips=[]),d&&(e=Mash.media_for_clips(this.__mash,a),d.undo_add_objects=e,d.redo_delete_objects=e,this.__action_add(d))}},pt.remove_media=function(a){var b,c,d,e;for(Util.isarray(a)||(a=[a]),e=a.length,d=0;d<e;d++)c=a[d],b=Util.isob(c)?c.id:c,this.__media_references[b]?this.__media_references[b]--:console.warn("remove_media unreferenced media",b),this.__media_references[b]||(-1===Util.array_delete_ref(this.__mash.media,c)&&console.error("remove_media no mash media",b,this.__mash.media),delete this.__media_references[b])},pt.select=function(a,b){var c,d,e=[],f="__selected_clips",g="selectedClips";if(c=Mash.media(this.__mash,a))if(Constant.effect===c.type&&(f="__selected_effects",g="selectedEffects"),b)switch(d=this[f].indexOf(a),this[f].length){case 0:e.push(a);break;case 1:if(d>-1)break;default:d<0?(e.push(a),e=e.concat(this[f])):(d&&(e=e.concat(this[f].slice(0,d))),d<this[f].length-1&&(e=e.concat(this[f].slice(d+1))))}else{if(-1<this[f].indexOf(a))return;e.push(a)}this[g]=e},pt.selected=function(a){return-2<this.__selected_effects.indexOf(a)+this.__selected_clips.indexOf(a)},pt.selectEffect=function(a,b){return Util.isob(a)?this.select(a,b):void(b||(this.selectedEffect=a))},pt.split=function(){var a=this.selectedClip,b=this.__time.copyTime();if(Util.isob(a)&&this.__canSplitAtTime(a,b)){var c=this.__action_split_clip(a,b);this.__action_add(c)}},pt.freeze=function(){var a=this.selectedClip,b=this.__time.copyTime();if(Util.isob(a)&&this.__canSplitAtTime(a,b)){var c=this.__action_freeze_clip(a,b);this.__action_add(c)}},pt.undo=function(){this.__action_index>-1&&(this.__action_stack[this.__action_index].undo(),this.__action_index--,this.did(),this.__redraw_moving())},pt.uuid=function(){return Util.uuid()},pt.__action_add=function(a){var b,c,d;if(this.__action_index<this.__action_stack.length-1)for(d=this.__action_stack.splice(this.__action_index+1,this.__action_stack.length-(this.__action_index+1)),c=d.length,b=0;b<c;b++)d[b].destroy();this.__action_stack.push(a),this.redo(c)},pt.__action_clips_move=function(a,b,c,d){d.sort(Util.sort_by_frame);var e,f,g,h,i,j,k=d.length;if(h=this.__mash[a][b],g=h,i=d[0],-1===h.clips.indexOf(i)&&(g=Mash.track_for_clip(this.__mash,i),Util.isnt(g)))return console.error("clip not found in tracks",i),!1;for(f=[],j=0;j<k;j++)i=d[j],f.push({clip:i,offset:j?i.frame-d[0].frame:0,frame:i.frame,track:i.track,i:j,index:g.clips.indexOf(i)});return e=new Action(this,function(){if(h!==g)for(f.sort(function(a,b){return b.index-a.index}),j=0;j<k;j++)g.clips.splice(f[j].index,1);for(f.sort(function(a,b){return a.i-b.i}),h!==g&&(h.clips=h.clips.concat(d)),j=k-1;j>-1;j--)i=d[j],i.track=b,i.frame=c+f[j].offset;h!==g&&Mash.recalc_track(this.player.mash,g),Mash.recalc_track(this.player.mash,h),this.player.mash_length_changed()},function(){if(f.sort(function(a,b){return a.index-b.index}),h!==g)for(j=0;j<k;j++)Util.array_delete(h.clips,d[j]);for(j=0;j<k;j++)i=f[j].clip,i.frame=f[j].frame,h!==g&&(g.clips.splice(f[j].index,0,i),i.track=f[j].track);h!==g&&Mash.recalc_track(this.player.mash,g),Mash.recalc_track(this.player.mash,h),this.player.mash_length_changed()})},pt.__action_effects_move=function(a,b,c){var d,e,f=b.length,g=[];for(d=new Action(this,function(){for(g.sort(function(a,b){return b.i-a.i}),e=0;e<f;e++)c.splice(g[e].i,1);for(e=f-1;e>-1;e--)c.splice(a,0,b[e])},function(){for(g.sort(function(a,b){return a.i-b.i}),e=0;e<f;e++)c.splice(a,1);for(e=0;e<f;e++)c.splice(g[e].i,0,g[e].effect)}),e=0;e<f;e++)g.push({i:c.indexOf(b[e]),effect:b[e]});return d},pt.__action_video_move=function(a,b,c){var d,e,f,g,h,i=c.length;if(f=this.__mash.video[a],e=f,g=c[0],-1===f.clips.indexOf(g)&&(e=Mash.track_for_clip(this.__mash,g),!e))return console.error("no track for first clip");for(d=[],h=0;h<i;h++)g=c[h],d.push({clip:g,frame:g.frame,track:g.track,i:h,index:e.clips.indexOf(g)});return new Action(this,function(){for(d.sort(function(a,b){return b.index-a.index}),h=0;h<i;h++)e.clips.splice(d[h].index,1);for(d.sort(function(a,b){return a.i-b.i}),h=i-1;h>-1;h--)g=c[h],f.clips.splice(b,0,g),g.track=a;f!==e&&Mash.recalc_track(this.player.mash,e),Mash.recalc_track(this.player.mash,f),this.player.mash_length_changed()},function(){for(d.sort(function(a,b){return a.index-b.index}),f.clips.splice(b,i),h=0;h<i;h++)g=d[h].clip,e.clips.splice(d[h].index,0,g),g.track=d[h].track,g.frame=d[h].frame;f!==e&&Mash.recalc_track(this.player.mash,e),Mash.recalc_track(this.player.mash,f),this.player.mash_length_changed()})},pt.__action_clips_remove=function(a,b,c){c.sort(Util.sort_by_frame);var d,e,f,g,h,i=c.length;for(f=this.__mash[a][b],g=c[0],e=[],h=0;h<i;h++)g=c[h],e.push({offset:h?g.frame-c[0].frame:0,frame:g.frame,track:g.track,i:h,index:f.clips.indexOf(g)});return d=new Action(this,function(){for(e.sort(function(a,b){return b.index-a.index}),h=0;h<i;h++)f.clips.splice(e[h].index,1);Mash.recalc_track(this.player.mash,f),this.player.mash_length_changed()},function(){for(e.sort(function(a,b){return a.index-b.index}),h=0;h<i;h++)g=c[e[h].i],f.clips.splice(e[h].index,0,g),g.track=e[h].track,g.frame=e[h].frame;Mash.recalc_track(this.player.mash,f),this.player.mash_length_changed()})},pt.__action_effects_remove=function(a,b){var c,d,e=a.length;for(c=new Action(this,function(){for(this.orig.sort(function(a,b){return b.index-a.index}),d=0;d<e;d++)b.splice(this.orig[d].index,1)},function(){for(this.orig.sort(function(a,b){return a.index-b.index}),d=0;d<e;d++)b.splice(this.orig[d].index,0,a[this.orig[d].i])}),c.orig=[],d=0;d<e;d++)c.orig.push({i:d,index:b.indexOf(a[d])});return c},pt.__action_video_remove=function(a,b){var c,d,e,f,g,h=b.length;for(e=this.__mash.video[a],f=b[0],d=[],g=0;g<h;g++)f=b[g],d.push({frame:f.frame,track:f.track,i:g,index:e.clips.indexOf(f)});return c=new Action(this,function(){for(d.sort(function(a,b){return b.index-a.index}),g=0;g<h;g++)e.clips.splice(d[g].index,1);Mash.recalc_track(this.player.mash,e),this.player.mash_length_changed()},function(){d.sort(function(a,b){return a.index-b.index});var a;for(g=0;g<h;g++)a=d[g].index,f=b[d[g].i],e.clips.splice(a,0,f),f.track=d[g].track,f.frame=d[g].frame;Mash.recalc_track(this.player.mash,e),this.player.mash_length_changed()})},pt.__action_effect_add=function(a,b){var c,d,e=this.selectedClipOrMash;return e&&(d=e.effects,c=new Action(this,function(){d.splice(b,0,a)},function(){Util.array_delete(d,a)})),c},pt.__action_freeze_clip=function(a,b){var c=Mash.media(this.__mash,a),d=Util.copy_keys_recursize(a),e=Util.copy_keys_recursize(a),f=2*this.__mash.quantize;b.scale(c.fps),e.freeze=b.frame,e.frames=f,b.scale(this.__mash.quantize);var g=a.frames-(b.frame-a.frame),h=Mash.track_for_clip(this.__mash,a).clips,i=1+h.indexOf(a);d.frames=g,d.frame=a.frame+f+(a.frames-g),d.trim=a.trim+g;var j=new Action(this,function(){h.splice(i,0,d),h.splice(i,0,e),a.frames-=g,Mash.recalc_video_clips(this.player.mash,this.target)},function(){a.frames+=g,h.splice(i,2),Mash.recalc_video_clips(this.player.mash,this.target)});return j.redo_selected_clips=[a],j.target=h,j},pt.__action_split_clip=function(a,b){b.scale(this.__mash.quantize);var c=a.frames,d=Mash.media(this.__mash,a),e=Mash.track_for_clip(this.__mash,a).clips,f=1+e.indexOf(a),g=Util.copy_keys_recursize(a),h=a.frame,i=b.frame,j=i-h,k=c-j;switch(g.frames=k,g.frame=i,d.type){case Constant.audio:case Constant.video:g.trim+=j}var l=new Action(this,function(){e.splice(f,0,g),a.frames=j},function(){a.frames=c,e.splice(f,1)});l.redo_selected_clips=[g],l.undo_selected_clips=[a];var m=Mash.media_for_clips(this.__mash,g,d);return l.redo_add_objects=m,l.undo_delete_objects=m,l},pt.__action_track_add=function(a,b,c,d){var e=new Action(this,function(){for(var a,b=0;b<this.tracks;b++)this.player.__track_create(this.type);a=this.player.mash[this.type][this.index].clips,this.clip.frame=this.frame,a.push(this.clip),Mash.recalc_clips(a),this.player.mash_length_changed()},function(){var a;a=this.player.mash[this.type][this.index].clips,Util.array_delete(a,this.clip);for(var b=0;b<this.tracks;b++)this.player.__track_delete(this.type);Mash.recalc_clips(a),this.player.mash_length_changed()});return e.clip=b,e.frame=d,e.index=c,e.type=Constant.audio===a?a:Constant.video,e.tracks=c+1-this.__mash[e.type].length,e},pt.__action_video_add=function(a,b,c){var d=new Action(this,function(){this.target.splice(this.index,0,this.clip),Mash.recalc_video_clips(this.player.mash,this.target),this.player.mash_length_changed()},function(){Util.array_delete(this.target,this.clip),Mash.recalc_video_clips(this.player.mash,this.target),this.player.mash_length_changed()});return d.clip=a,d.index=c,d.target=this.__mash.video[b].clips,d},pt.__adjust_gain=function(a){var b,c,d,e,f=a.length;for(e=0;e<f;e++)d=a[e],c=Mash.media(this.__mash,d),Mash.clip_has_audio(d,c)&&(b=Audio.source_for_clip(d),Audio.gain_source(b))},pt.__audio_is_on=function(){return!this.__paused&&!this.__muted&&this.__gain},pt.__canSplitAtTime=function(a,b){var c=new TimeRange(a.frame,this.__mash.quantize,a.frames),d=c.intersection(b);return d&&(b=b.copyTime(),b.scale(c.fps),d=b.frame!==c.frame,d&&(d=b.end!==c.end)),d},pt.__delete_drawings=function(a){if(a)for(var b=a.pop();b;)this.__delete_drawings(b.drawings),b!==this.__drawing&&Filter.destroy_drawing(b),b=a.pop()},pt.__draw_context=function(a){a||(a=this.__drawing.context),a&&(a.clearRect(0,0,a.canvas.width,a.canvas.height),a.fillStyle=this.__mash.backcolor,a.fillRect(0,0,a.canvas.width,a.canvas.height))},pt.__draw_layer_clip=function(a,b,c,d){var e,f,g,h,i,j,k=this.__mash.quantize,l=function(a,b,c){return a+"x"+b+" "+c.type+" clip "+(c.label||c.id)};switch(c.type){case Constant.image:e=c.url||c.source,g=Loader.cached_urls[e],g&&(i=g.width,j=g.height,h=Filter.create_drawing(i,j,l(i,j,c),d.container),h.context.drawImage(g,0,0,i,j,0,0,i,j));break;case"frame":case Constant.video:f=a.copyTime(),f.scale(c.fps),f.frames=1;for(e in Mash.urls_for_video_clip(b,c,f,k)){g=Loader.cached_urls[e],g&&(i=g.width,j=g.height,h=Filter.create_drawing(i,j,l(i,j,c),d.container),h.context.drawImage(g,0,0,i,j,0,0,i,j));break}break;case Constant.theme:h=this.__draw_module_filters(a,b,[d],b,c).shift();break;default:console.error(c.type+" unsupported on video track")}return h&&(d.drawings.push(h),d=this.__draw_scale_and_effects(a,b,h)),d},pt.__draw_layer_clips=function(a,b){this.__delete_drawings(this.__drawing.drawings);var c,d,e,f,g,h,i,j,k,l,m,n=a.length;for(g={},f=-1,e=[],m=0;m<n;m++)h=a[m],i=Mash.media(this.__mash,h),g[i.id]=i,Constant.audio!==i.type&&0===h.track&&(Constant.transition===i.type?f=m:e.push(m));if(this.__draw_context(),-1<f){if(l=e.length,0<l){for(j=this.__drawing.canvas.width,k=this.__drawing.canvas.height,m=0;m<l;m++)h=a[e[m]],i=g[h.id],c=Filter.create_drawing(j,k,j+"x"+k+" background for "+i.type+" clip "+(i.label||i.id),this.__drawing.container),this.__drawing.drawings.push(c),this.__draw_context(c.context),d=this.__draw_layer_clip(b,h,i,c),this.__drawings_merge(b,h,h.merger,c,d);h=a[f],this.__draw_transition(this.__drawing.drawings,h,g[h.id],b)}e.push(f)}else e=[];for(m=0;m<n;m++)-1<e.indexOf(m)||(h=a[m],i=g[h.id],Constant.audio!==i.type&&(d=this.__draw_layer_clip(b,h,i,this.__drawing),this.__drawings_merge(b,h,h.merger,this.__drawing,d)))},pt.__draw_transition=function(a,b,c,d){2>a.length&&a.push(this.__drawing);var e=a[0],f=a[1];c.to.filters&&(f=this.__draw_module_filters(d,b,[f],b,c.to).shift()),c.from.filters&&(e=this.__draw_module_filters(d,b,[e],b,c.from).shift()),this.__drawings_merge(d,b,c.from.merger,e,f),this.__drawings_merge(d,b,c.to.merger,this.__drawing,e)},pt.__draw_request=function(a){var b=this;requestAnimationFrame(function(){b.__draw_layer_clips(a,b.__time_drawn)})},pt.__drawings_merge=function(a,b,c,d,e){var f;c?(f=Mash.media_search(Constant.merger,c,this.__mash),f?d=this.__draw_module_filters(a,b,[d,e],c,f).shift():console.error("no merger media",c)):console.error("false merger",b)},pt.__draw_scale_and_effects=function(a,b,c){var d,e;return e=b.scaler,e?(d=Mash.media_search(Constant.scaler,e,this.__mash),d?c=this.__draw_module_filters(a,b,[c],e,d).shift():console.error("no scaler media",e),c||console.error("scaler produced no drawing",e,b)):console.error("no scaler found",b),Util.isarray(b.effects)&&b.effects.length&&(c=this.__draw_effects([c],b,a).shift()),c},pt.__draw_module_filters=function(time,layer_clip,drawings,module,module_media){var __evaluate_scope=function(time,clip,scope,module,filter_config){var eval_key,eval_str,filter,conditional_in,condition,test_bool,parameter,conditional,parameter_name,parameter_value,parameters_array,j,y,i,z,evaluated={};if(filter=Filter.load(filter_config.id))if(scope=Util.copy_ob(scope),parameters_array=filter_config.parameters,parameters_array||(parameters_array=filter.parameters),parameters_array){for(z=parameters_array.length,i=0;i<z;i++)if(parameter=parameters_array[i],parameter_name=parameter.name){if(parameter_value=parameter.value,Util.isarray(parameter_value)){for(test_bool=!1,y=parameter_value.length,j=0;j<y;j++){conditional=parameter_value[j],condition=conditional.condition,conditional.is?condition=condition+"=="+conditional.is:conditional.in&&(conditional_in=conditional.in,Util.isstring(conditional_in)&&(conditional_in=conditional_in.split(",")),condition="(-1 < ["+conditional_in.join(",")+"].indexOf("+(Util.isstring(conditional_in[0])?"String":"Number")+"("+condition+")))"),condition=condition.replace(" or "," || "),condition=condition.replace(" and "," && ");for(eval_key in scope)condition=condition.replace(new RegExp("\\b"+eval_key+"\\b","g"),"scope."+eval_key);eval_str="test_bool = ("+condition+");";try{eval(eval_str)}catch(a){console.error(a.message,eval_str)}if(test_bool){parameter_value=conditional.value;break}}test_bool||console.error("no conditions were true",parameter_value)}if(Util.isstring(parameter_value))for(eval_key in scope)parameter_value=parameter_value.replace(new RegExp("\\b"+eval_key+"\\b","g"),"scope."+eval_key);eval_str="evaluated."+parameter_name+" = "+parameter_value+";";try{eval(eval_str)}catch(a){evaluated[parameter_name]=parameter_value}scope[parameter_name]=evaluated[parameter_name]}}else console.error("no parameters_array found",filter_config);else console.error("filter not found",filter_config.id);return evaluated},ctime,scope,evaluated,filter_config,filter,i,z;if(module_media)if(module_media.filters)if(layer_clip.frames)for(ctime=new TimeRange(0,this.__mash.quantize,this.__mash_length),ctime.frame=layer_clip.frame,ctime.frames=layer_clip.frames,z=module_media.filters.length,i=0;i<z;i++)filter_config=module_media.filters[i],filter=Filter.load(filter_config.id),filter&&(scope=this.__module_scope(time,ctime,drawings,module,module_media),filter.parse&&(scope=filter.parse(drawings,scope,filter_config)),evaluated=__evaluate_scope(time,layer_clip,scope,module,filter_config),filter.render&&(drawings=filter.render(drawings,scope,evaluated,filter_config)));else console.error("invalid layer clip with no frames",layer_clip);else console.error("invalid module media with no filters",module,module_media);else console.error("false media while drawing module filters",module,layer_clip);return drawings},pt.__draw_effects=function(a,b,c){var d,e,f,g;if(b)if(b.frames)if(b.effects)for(g=b.effects.length,f=g-1;f>-1;f--)d=b.effects[f],e=Mash.media(this.__mash,d),e?a=this.__draw_module_filters(c,b,a,d,e):console.error("could not find effect media",d,b,this.__mash.media);else console.error("invalid layer clip with no effects",b);else console.error("invalid layer clip with no frames, so no effects",b);else console.error("false layer clip, so no effects",a);return a},pt.__limit_time=function(a){var b=a.copyTime(),c=new TimeRange(this.__mash_length,this.__mash.quantize);return c.frame=Math.max(0,c.frame-1),b.min(c),b.scale(this.__fps,"floor"),b},pt.__load_timed=function(){if(this.__moving){var a=TimeRange.fromSeconds(Audio.time(),this.__fps,"ceil");a.frame!==this.__limit_time(a).frame?this.__loop?this.frame=0:this.paused=!0:a.isEqualToTime(this.__time_drawn)||(this.__time.setToTime(a),this.redraw())}},pt.__module_scope=function(a,b,c,d,e){if(!this.__drawing.canvas)return{};var f,g,h,i,j,k,l;if(g={},e.properties)for(j in e.properties)f=d[j],Util.isnt(f)?(k=e.properties[j],f=k.value,Util.isnt(f)&&(i=k.type,i&&(h=Constant.property_types[i],h&&(f=h.value)),Util.isnt(f)&&(f=""))):f=d[j],g[j]=f;var m=function(a,b,c){var d=parseFloat(b),e=parseFloat(g[a]),f=e*d;if(c){var h="mm_height"===a?"mm_width":"mm_height",i=parseFloat(g[h]);i>e&&(f=e+(d-1)*i)}return f};return g.mm_vert=function(a,b){return m("mm_height",a,b)},g.mm_horz=function(a,b){return m("mm_width",a,b)},g.mm_cmp=function(a,b,c,d){return a>b?c:d},g.mm_max=Math.max,g.mm_min=Math.min,g.floor=Math.floor,g.ceil=Math.ceil,g.mm_fps=this.__fps,b&&(g.t=g.mm_duration=b.lengthSeconds),b.scale(a.fps),g.mm_t=(a.frame-b.frame)/b.frames,g.mm_width=this.__drawing.canvas.width,g.mm_height=this.__drawing.canvas.height,l=c[c.length-1],l&&l.canvas?(g.mm_input_width=l.canvas.width,g.mm_input_height=l.canvas.height,g.mm_input_dimensions=g.mm_input_width+"x"+g.mm_input_height):console.warn("no drawing?",c),g.mm_dimensions=g.mm_width+"x"+g.mm_height,g},pt.__redraw_moving=function(a){var b=this.__moving;b&&this.__set_moving(!1),a&&this.__time.setToTime(a),this.redraw(),b&&this.__set_moving(!0)},pt.__set_moving=function(a){if(this.__moving!==a){if(this.__moving=a,this.__moving){var b=this;this.__load_timer=setInterval(function(){b.__load_timed()},500/this.__fps),Audio.start(),Audio.sync(this.__time.seconds),this.rebuffer()}else Audio.stop(),Audio.destroy_sources(),clearInterval(this.__load_timer),this.__load_timer=0;this.__set_stalling(!this.__moving&&!this.__paused)}},pt.__set_stalling=function(a){var b=!1;return this.__stalling!==a&&(this.__stalling=a,b=!0),b},pt.__stop_buffer_timer=function(){this.__bufferProcessTimer&&(clearInterval(this.__bufferProcessTimer),this.__bufferProcessTimer=0)},pt.__track_create=function(a){var b=this.__mash[a];b.push(Mash.init_track(a,b.length))},pt.__track_delete=function(a){var b=this.__mash[a].pop();this.__mash_length===Mash.length_of_clips(b.clips)&&this.mash_length_changed()}}(Player.prototype),MovieMasher.Player=Player;var Players={draw_delayed:function(){Players.delayed_timer||(Players.delayed_timer=setTimeout(function(){Players.delayed_timer=0;var a,b=Players.instances.length;for(a=0;a<b;a++)Players.instances[a].redraw()},50))},start_playing:function(a){Players.stop_playing(),Players.current=a},stop_playing:function(){Players.current&&(Players.current.paused=!0,Players.current=null)},instances:[],current:null,delayed_timer:0};MovieMasher.Players=Players;var TimeRange=function(a,b,c){a&&(this.frame=Number(a)||0),b&&(this.fps=Number(b)||0),c&&(this.frames=Math.max(1,Number(c)))};TimeRange.fromTimes=function(a,b){return a.synchronize(b),new TimeRange(a.frame,a.fps,Math.max(1,b.frame-a.frame))},TimeRange.fromSeconds=function(a,b,c){return c||(c="round"),b||(b=1),new TimeRange(Math[c](Number(a)*Number(b)),b)},TimeRange.fromSomething=function(a){var b,c,d;return a?"number"==typeof a?a=new TimeRange.fromSeconds(a):"string"==typeof a&&(a=a.split("-"),b=a.shift(),c=d=1,a.length?(a=a.shift().split("@"),c=a.shift()):(a=b.split("@"),b=a.shift()),a.length&&(d=a.shift()),a=new TimeRange(b,d,c)):a=new TimeRange,a},function(a){a.frames=0,a.frame=0,a.fps=0,Object.defineProperty(a,"end",{get:function(){return this.frame+this.frames},set:function(a){this.frames=Math.max(1,Number(a)-Number(this.frame))}}),Object.defineProperty(a,"endTime",{get:function(){return new TimeRange(this.end,this.fps)}}),Object.defineProperty(a,"description",{get:function(){var a=this.frame;return this.frames&&(a+="-"+this.end),a+="@"+this.fps}}),Object.defineProperty(a,"seconds",{get:function(){return Number(this.frame)/Number(this.fps)},set:function(a){this.setToTime(a)}}),Object.defineProperty(a,"lengthSeconds",{get:function(){return Number(this.frames)/Number(this.fps)}}),Object.defineProperty(a,"timeRange",{get:function(){var a=this.copyTime();return a.frames=1,a}}),a.add=function(a){return this.fps!==a.fps&&(a=a.copyTime(),this.synchronize(a)),this.frame+=a.frame,this},a.setToTime=function(a){return a=TimeRange.fromSomething(a),this.synchronize(a),this.frame=a.frame,a},a.setToTimeRange=function(a){return a=this.setToTime(a),this.frames=a.frames,a},a.copyTime=function(a){return new TimeRange(this.frame,this.fps,a)},a.divide=function(a,b){b||(b="round"),this.frame=Math[b](Number(this.frame)/a)},a.frameForRate=function(a,b){b||(b="round");var c=this.frame;if(a!==this.fps){var d=TimeRange.fromSeconds(this.seconds,this.fps,b);c=d.frame}return c},a.isEqualToTime=function(a){var b=!1;if(a&&a.fps&&this.fps)if(this.fps===a.fps)b=this.frame===a.frame;else{var c=this.copyTime(),d=a.copyTime();c.synchronize(d),b=c.frame===d.frame}return b},a.lessThan=function(a){var b=!1;if(a&&a.fps&&this.fps)if(this.fps===a.fps)b=this.frame<a.frame;else{var c=this.copyTime(),d=a.copyTime();c.synchronize(d),b=c.frame<d.frame}return b},a.max=function(a){a&&(this.synchronize(a),this.frame=Math.max(a.frame,this.frame))},a.min=function(a){a&&(this.synchronize(a),this.frame=Math.min(a.frame,this.frame))},a.multiply=function(a,b){b||(b="round"),this.frame=Math[b](Number(this.frame)*a)},a.ratio=function(a){var b=0;if(a&&a.fps&&this.fps&&a.frame)if(this.fps===a.fps)b=this.frame/a.frame;else{var c=this.copyTime(),d=a.copyTime();c.synchronize(d),b=Number(c.frame)/Number(d.frame)}return b},a.scale=function(a,b){return this.fps!==a&&(b||(b="round"),this.frame=Math[b](Number(this.frame)/(Number(this.fps)/Number(a))),this.frames&&(this.frames=Math.max(1,Math[b](Number(this.frames)/(Number(this.fps)/Number(a))))),this.fps=a),this},a.subtract=function(a){this.fps!==a.fps&&(a=a.copyTime(),this.synchronize(a));var b=a.frame;return b>this.frame&&(b-=b-this.frame),this.frame-=b,b},a.synchronize=function(a,b){if(b||(b="round"),a.fps!==this.fps){var c=this.__lcm(a.fps,this.fps);this.scale(c,b),a.scale(c,b)}},a.__gcd=function(a,b){for(var c;0!==b;)c=b,b=a%b,a=c;return a},a.__lcm=function(a,b){return a*b/this.__gcd(a,b)},a.copyTimeRange=function(){return new TimeRange(this.frame,this.fps,this.frames)},a.touches=function(a){return this.intersection(a,!0)},a.intersection=function(a,b){var c=null,d=this,e=a;d.fps!==e.fps&&(d=d.copyTimeRange(),e=e.copyTimeRange(),d.synchronize(e));var f=Math.max(d.frame,e.frame),g=Math.min(d.end+(d.frames?0:1),e.end+(e.frames?0:1));return(f<g||b&&f===g)&&(c=new TimeRange(f,d.fps,g-f)),c},a.isEqualToTimeRange=function(a){var b=!1;if(a&&a.fps&&this.fps)if(this.fps===a.fps)b=this.frame===a.frame&&this.frames===a.frames;else{var c=this.copyTimeRange(),d=a.copyTimeRange();c.synchronize(d),b=c.frame===d.frame&&c.frames===d.frames}return b},a.maxLength=function(a){this.synchronize(a),this.frames=Math.max(a.frame,this.frames)},a.minLength=function(a){this.synchronize(a),this.frames=Math.min(a.frame,this.frames)}}(TimeRange.prototype),MovieMasher.TimeRange=TimeRange;var Util={array_empty:function(a){for(;a.length>0;)a.pop()},array_add:function(a,b){var c;a&&Util.isarray(a)&&(c=a.indexOf(b),-1===c&&a.push(b))},array_key:function(a,b,c,d){return Util.array_find(a,b,d)[c]},array_find:function(a,b,c){var d,e,f=null;if(a&&Util.isarray(a)&&(Util.isnt(c)&&(c="id"),Util.isob(b)&&(b=b[c]),!Util.isnt(b)))for(e=a.length,d=0;d<e&&(f=a[d],!f||f[c]!==b);d++)f=null;return f},array_delete:function(a,b){var c;Util.isarray(a)&&(c=a.indexOf(b),-1<c&&a.splice(c,1))},array_delete_ref:function(a,b,c){var d,e=-1;return Util.isarray(a)&&(d=this.array_find(a,b,c),d&&(e=a.indexOf(d),-1<e&&a.splice(e,1))),e},array_replace:function(a,b,c){var d=this.array_delete_ref(a,b,c);-1<d?a.splice(d,0,b):a.push(b)},contents_match:function(a,b){var c,d,e=!0;if(a&&b&&a.length===b.length)for(d=a.length,c=0;c<d;c++)if(a[c]!==b[c]){e=!1;break}return e},copy_array:function(a,b){b||(b=[]);var c,d=a.length;for(c=0;c<d;c++)b.push(a[c]);return b},copy_ob:function(a,b){if(!Util.isnt(a)){b||(b={});var c;for(c in a)Util.copy_key_valid(c)&&(b[c]=a[c])}return b},copy_key_valid:function(a){return"$"!==a.substr(0,1)},copy_ob_scalars:function(a,b,c){if(!Util.isnt(a)){Util.isnt(b)&&(b={});var d;for(d in a)Util.copy_key_valid(d)&&(Util.isob(a[d])||c&&!Util.isnt(b[d])||(b[d]=a[d]))}return b},copy_keys_recursize:function(a,b){var c,d;if(Util.isob(a)){Util.isnt(b)&&(b={});for(c in a)Util.copy_key_valid(c)&&(d=a[c],Util.isob(d)?Util.isarray(d)?b[c]=Util.copy_array(d):b[c]=Util.copy_keys_recursize(d,b[c]):b[c]=d)}return b},index_after_removal:function(a,b,c){var d,e,f,g,h=[];for(f=b.length,e=0;e<f;e++)g=c.indexOf(b[e]),h.push(g),-1<g&&a>g&&a--;for(e=0;e<f&&!(d=a+e!==h[e]);e++);return d||(a=-2),a},is:function(a){return!Util.isnt(a)},is_typeof:function(){var a,b,c,d=!1;for(c=arguments.length,b=0;b<c&&(b?d=typeof arguments[b]===a:a=arguments[b],!d);b++);return d},isarray:function(){var a,b,c=!1;for(b=arguments.length,a=0;a<b&&(arguments[a]&&(c=Util.isnt(Array.isArray)?arguments[a]instanceof Array:Array.isArray(arguments[a])),c);a++);return c},isnt:function(){return this.is_typeof.apply(this,this.copy_array(arguments,["undefined"]))},isob:function(){return this.is_typeof.apply(this,this.copy_array(arguments,["object"]))},isstring:function(){return this.is_typeof.apply(this,this.copy_array(arguments,["string"]))},keys_found_equal:function(a,b){var c,d=!0;for(c in a)if(d=a[c]===b[c],!d)break;return d},keys_match:function(a,b){var c,d=!0;for(c in a)if(Util.isnt(b[c])){d=!1;break}if(d)for(c in b)if(Util.isnt(a[c])){d=!1;break}return d},ob_keys:function(a){var b,c=[];if(Util.isob(a))for(b in a)c.push(b);return c},ob_property:function(a,b){var c,d,e=null;if(Util.isob(a)&&!Util.isnt(b)&&b.length)for(b=b.split("."),d=b.length,c=0;c<d;c++){if(a=a[b[c]],Util.isnt(a)){e=null;break}e=a}return e},ob_values:function(a){var b,c=[];if(Util.isob(a))for(b in a)c.push(a[b]);
return c},pad:function(a,b,c){return c=c||"0",a=String(a),a.length>=b?a:new Array(b-a.length+1).join(c)+a},pluralize:function(a,b){return 1!==a&&(b+="s"),b},set_ob_property:function(a,b,c){var d,e;if(Util.isob(a)&&!Util.isnt(b)&&b.length){for(b=b.split("."),e=b.length-1,d=0;d<e;d++)if(a=a[b[d]],!Util.isob(a)){a=null;break}a&&(a[b[d]]=c)}},sort_by_frame:function(a,b){return a.frame-b.frame||a.frames-b.frames},sort_by_label:function(a,b){return a.label<b.label?-1:a.label>b.label?1:0},sort_numeric:function(a,b){return a-b},sort_numeric_desc:function(a,b){return b-a},uuid:function(){return function a(b){return b?(b^16*Math.random()>>b/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a)}()}};return MovieMasher.Util=Util,MovieMasher});