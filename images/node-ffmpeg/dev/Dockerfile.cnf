ARG DIR_ROOT=/app

FROM amazonlinux:2022 AS code
ARG DIR_ROOT

# package JSON files from main and relevant projects
COPY package.json ${DIR_ROOT}/package.json
COPY images/node-ffmpeg/package.json ${DIR_ROOT}/images/node-ffmpeg/package.json
COPY packages/core/lib/package.json ${DIR_ROOT}/packages/core/lib/package.json
COPY packages/core/server/package.json ${DIR_ROOT}/packages/core/server/package.json

COPY packages/core/lib/esm ${DIR_ROOT}/packages/core/lib/esm

COPY packages/core/server/esm ${DIR_ROOT}/packages/core/server/esm


FROM amazonlinux:2022 
ARG DIR_ROOT
ARG OS_INSTALL=''
ARG OS_EXECUTE='npm install -g npm'

ARG INSTALL_NODE='18.12.1'
ARG NPM_INSTALL='--workspace=@moviemasher/node-ffmpeg'

WORKDIR ${DIR_ROOT}
COPY --from=code ${DIR_ROOT} ${DIR_ROOT}
COPY dev/image/sh ${DIR_ROOT}/dev/image/sh
RUN sh ${DIR_ROOT}/dev/image/sh/bases/build-aws2022.sh \
  -n "${NPM_INSTALL}" \
  -e "${OS_EXECUTE}" \
  -o "${OS_INSTALL}" \
  -r "${DIR_ROOT}"\
  -i "${INSTALL_NODE}"

LABEL org.opencontainers.image.authors="support@moviemasher.com"